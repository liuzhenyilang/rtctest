!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.BRTC=t():e.BRTC=t()}(window,(function(){return function(e){var t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(n,r,function(t){return e[t]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=29)}([function(e,t,i){"use strict";i.d(t,"d",(function(){return r})),i.d(t,"a",(function(){return o})),i.d(t,"h",(function(){return s})),i.d(t,"i",(function(){return a})),i.d(t,"f",(function(){return c})),i.d(t,"c",(function(){return u})),i.d(t,"g",(function(){return d})),i.d(t,"e",(function(){return h})),i.d(t,"b",(function(){return p}));var n=i(2);function r(e){return typeof e===n.i}function o(e){return Array.isArray(e)}function s(e){return e!==n.g&&"object"==typeof e}function a(e){return"string"==typeof e}function c(e){return"number"==typeof e&&!isNaN(e)}function u(e){return"boolean"==typeof e}function d(e){return c(e)||a(e)&&!isNaN(parseFloat(e))&&isFinite(+e)}const l={}.hasOwnProperty;function h(e){if(!s(e)||e.nodeType||e===e.window)return!1;if(e.constructor&&!l.call(e,"constructor")&&!l.call(e.constructor.prototype||{},"isPrototypeOf"))return!1;let t;for(t in e);return void 0===t||l.call(e,t)}function p(e){return e instanceof ArrayBuffer}},function(e,t,i){"use strict";(function(e){i.d(t,"b",(function(){return o})),i.d(t,"a",(function(){return s})),i.d(t,"i",(function(){return p})),i.d(t,"c",(function(){return m})),i.d(t,"f",(function(){return v})),i.d(t,"j",(function(){return g})),i.d(t,"d",(function(){return _})),i.d(t,"e",(function(){return y})),i.d(t,"g",(function(){return S})),i.d(t,"h",(function(){return T}));var n=i(2),r=i(3);const o=0,s=4;let a="bjy";const c=typeof console!==n.j?console:n.g,u=/bjy/.test(Object(r.a)(n.b))?2:3,d=n.n&&/edge|msie|trident/i.test(n.n.navigator.userAgent)?n.c:"%c",l=c?d?function(e,t,i,n){n?c.log(d+e,i,t,n):c.log(d+e,i,t)}:function(e,t,i){i?c.log(e,t,i):c.log(e,t)}:n.b;function h(){if(n.e){const e=n.e.BJY_LOG_LEVEL;if(e>=o&&e<=5)return e}return u}function p(t){e.BJY_LOG_LEVEL=t}function f(e){return`background-color:${e};border-radius:12px;color:#fff;font-size:10px;padding:3px 6px;`}function m(e,t){h()<=1&&l((t||a)+" debug",e,f("#999"))}function v(e,t){h()<=2&&l((t||a)+" info",e,f("#2db7f5"))}function g(e,t){h()<=3&&l((t||a)+" warn",e,f("#f90"))}function _(e,t){h()<=s&&l((t||a)+" error",e,f("#ed4014"))}function y(e,t){if(h()<=5)throw new Error(`[${t||a} fatal]: ${e}`)}function S(e,t,i){e===o?function(e,t){h()<=o&&l((t||a)+" trace",e,f("#999"))}(t,i):1===e?m(t,i):2===e?v(t,i):3===e?g(t,i):e===s?_(t,i):5===e&&y(t,i)}function T(e){a=e}}).call(this,i(8))},function(e,t,i){"use strict";(function(e){i.d(t,"l",(function(){return n})),i.d(t,"d",(function(){return r})),i.d(t,"g",(function(){return o})),i.d(t,"m",(function(){return s})),i.d(t,"f",(function(){return a})),i.d(t,"j",(function(){return c})),i.d(t,"i",(function(){return u})),i.d(t,"k",(function(){return d})),i.d(t,"h",(function(){return l})),i.d(t,"n",(function(){return h})),i.d(t,"e",(function(){return p})),i.d(t,"b",(function(){return f})),i.d(t,"a",(function(){return m})),i.d(t,"c",(function(){return v}));const n=!0,r=!1,o=null,s=void 0,a=-1,c="undefined",u="function",d="*",l=".",h=typeof window!==c?window:s,p=(typeof document!==c&&document,typeof e!==c?e:h),f=function(){},m=(Object.freeze({}),Object.freeze([])),v=""}).call(this,i(8))},function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var n=i(2);function r(e,t){return e!=n.g&&e.toString?e.toString():t!==n.m?t:n.c}},function(e,t,i){"use strict";i.d(t,"c",(function(){return o})),i.d(t,"b",(function(){return s})),i.d(t,"d",(function(){return a})),i.d(t,"a",(function(){return c}));var n=i(0),r=i(2);i(3);function o(e,t,i){return n.f(i)?t===i?r.c:e.slice(t,i):e.slice(t)}function s(e,t,i){return e.indexOf(t,i!==r.m?i:0)}function a(e,t){return 0===s(e,t)}function c(e,t){return s(e,t)>=0}},function(e,t,i){(function(t){e.exports=function(){function e(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function i(t){for(var i=1;i<arguments.length;i++){var n=null!=arguments[i]?arguments[i]:{};i%2?e(Object(n),!0).forEach((function(e){u(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):e(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t,i,n,r,o,s){try{var a=e[o](s),c=a.value}catch(e){return void i(e)}a.done?t(c):Promise.resolve(c).then(n,r)}function o(e){return function(){var t=this,i=arguments;return new Promise((function(n,o){var s=e.apply(t,i);function a(e){r(s,n,o,a,c,"next",e)}function c(e){r(s,n,o,a,c,"throw",e)}a(void 0)}))}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function c(e,t,i){return t&&a(e.prototype,t),i&&a(e,i),e}function u(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function d(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&h(e,t)}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function h(e,t){return(h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function f(e,t,i){return(f=p()?Reflect.construct:function(e,t,i){var n=[null];n.push.apply(n,t);var r=new(Function.bind.apply(e,n));return i&&h(r,i.prototype),r}).apply(null,arguments)}function m(e){var t="function"==typeof Map?new Map:void 0;return(m=function(e){if(null===e||(i=e,-1===Function.toString.call(i).indexOf("[native code]")))return e;var i;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return f(e,arguments,l(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),h(n,e)})(e)}function v(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function g(e){var t=p();return function(){var i,n=l(e);if(t){var r=l(this).constructor;i=Reflect.construct(n,arguments,r)}else i=n.apply(this,arguments);return v(this,i)}}function _(e,t,i){return(_="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=l(e)););return e}(e,t);if(n){var r=Object.getOwnPropertyDescriptor(n,t);return r.get?r.get.call(i):r.value}})(e,t,i||e)}function y(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var n,r,o=[],s=!0,a=!1;try{for(i=i.call(e);!(s=(n=i.next()).done)&&(o.push(n.value),!t||o.length!==t);s=!0);}catch(e){a=!0,r=e}finally{try{s||null==i.return||i.return()}finally{if(a)throw r}}return o}}(e,t)||T(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function S(e){return function(e){if(Array.isArray(e))return E(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||T(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function T(e,t){if(e){if("string"==typeof e)return E(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?E(e,t):void 0}}function E(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function b(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=T(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0,r=function(){};return{s:r,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==i.return||i.return()}finally{if(a)throw o}}}}function R(e,t,i,n,r){var o={};return Object.keys(n).forEach((function(e){o[e]=n[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}var I="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==t?t:"undefined"!=typeof self?self:{};function k(e,t){return e(t={exports:{}},t.exports),t.exports}var w,C,A=function(e){return e&&e.Math==Math&&e},D=A("object"==typeof globalThis&&globalThis)||A("object"==typeof window&&window)||A("object"==typeof self&&self)||A("object"==typeof I&&I)||function(){return this}()||Function("return this")(),O=function(e){try{return!!e()}catch(e){return!0}},P=!O((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),x={}.propertyIsEnumerable,M=Object.getOwnPropertyDescriptor,L={f:M&&!x.call({1:2},1)?function(e){var t=M(this,e);return!!t&&t.enumerable}:x},N=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},U={}.toString,V=function(e){return U.call(e).slice(8,-1)},F="".split,j=O((function(){return!Object("z").propertyIsEnumerable(0)}))?function(e){return"String"==V(e)?F.call(e,""):Object(e)}:Object,B=function(e){if(null==e)throw TypeError("Can't call method on "+e);return e},H=function(e){return j(B(e))},G=function(e){return"object"==typeof e?null!==e:"function"==typeof e},q=function(e){return"function"==typeof e?e:void 0},J=function(e,t){return arguments.length<2?q(D[e]):D[e]&&D[e][t]},W=J("navigator","userAgent")||"",z=D.process,$=D.Deno,K=z&&z.versions||$&&$.version,Y=K&&K.v8;Y?C=(w=Y.split("."))[0]<4?1:w[0]+w[1]:W&&(!(w=W.match(/Edge\/(\d+)/))||w[1]>=74)&&(w=W.match(/Chrome\/(\d+)/))&&(C=w[1]);var Q=C&&+C,X=!!Object.getOwnPropertySymbols&&!O((function(){var e=Symbol();return!String(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&Q&&Q<41})),Z=X&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,ee=Z?function(e){return"symbol"==typeof e}:function(e){var t=J("Symbol");return"function"==typeof t&&Object(e)instanceof t},te=function(e,t){try{Object.defineProperty(D,e,{value:t,configurable:!0,writable:!0})}catch(i){D[e]=t}return t},ie=D["__core-js_shared__"]||te("__core-js_shared__",{}),ne=k((function(e){(e.exports=function(e,t){return ie[e]||(ie[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.16.0",mode:"global",copyright:"© 2021 Denis Pushkarev (zloirock.ru)"})})),re=function(e){return Object(B(e))},oe={}.hasOwnProperty,se=Object.hasOwn||function(e,t){return oe.call(re(e),t)},ae=0,ce=Math.random(),ue=function(e){return"Symbol("+String(void 0===e?"":e)+")_"+(++ae+ce).toString(36)},de=ne("wks"),le=D.Symbol,he=Z?le:le&&le.withoutSetter||ue,pe=function(e){return se(de,e)&&(X||"string"==typeof de[e])||(X&&se(le,e)?de[e]=le[e]:de[e]=he("Symbol."+e)),de[e]},fe=pe("toPrimitive"),me=function(e,t){if(!G(e)||ee(e))return e;var i,n=e[fe];if(void 0!==n){if(void 0===t&&(t="default"),i=n.call(e,t),!G(i)||ee(i))return i;throw TypeError("Can't convert object to primitive value")}return void 0===t&&(t="number"),function(e,t){var i,n;if("string"===t&&"function"==typeof(i=e.toString)&&!G(n=i.call(e)))return n;if("function"==typeof(i=e.valueOf)&&!G(n=i.call(e)))return n;if("string"!==t&&"function"==typeof(i=e.toString)&&!G(n=i.call(e)))return n;throw TypeError("Can't convert object to primitive value")}(e,t)},ve=function(e){var t=me(e,"string");return ee(t)?t:String(t)},ge=D.document,_e=G(ge)&&G(ge.createElement),ye=function(e){return _e?ge.createElement(e):{}},Se=!P&&!O((function(){return 7!=Object.defineProperty(ye("div"),"a",{get:function(){return 7}}).a})),Te=Object.getOwnPropertyDescriptor,Ee={f:P?Te:function(e,t){if(e=H(e),t=ve(t),Se)try{return Te(e,t)}catch(e){}if(se(e,t))return N(!L.f.call(e,t),e[t])}},be=function(e){if(!G(e))throw TypeError(String(e)+" is not an object");return e},Re=Object.defineProperty,Ie={f:P?Re:function(e,t,i){if(be(e),t=ve(t),be(i),Se)try{return Re(e,t,i)}catch(e){}if("get"in i||"set"in i)throw TypeError("Accessors not supported");return"value"in i&&(e[t]=i.value),e}},ke=P?function(e,t,i){return Ie.f(e,t,N(1,i))}:function(e,t,i){return e[t]=i,e},we=Function.toString;"function"!=typeof ie.inspectSource&&(ie.inspectSource=function(e){return we.call(e)});var Ce,Ae,De,Oe=ie.inspectSource,Pe=D.WeakMap,xe="function"==typeof Pe&&/native code/.test(Oe(Pe)),Me=ne("keys"),Le=function(e){return Me[e]||(Me[e]=ue(e))},Ne={},Ue=D.WeakMap;if(xe||ie.state){var Ve=ie.state||(ie.state=new Ue),Fe=Ve.get,je=Ve.has,Be=Ve.set;Ce=function(e,t){if(je.call(Ve,e))throw new TypeError("Object already initialized");return t.facade=e,Be.call(Ve,e,t),t},Ae=function(e){return Fe.call(Ve,e)||{}},De=function(e){return je.call(Ve,e)}}else{var He=Le("state");Ne[He]=!0,Ce=function(e,t){if(se(e,He))throw new TypeError("Object already initialized");return t.facade=e,ke(e,He,t),t},Ae=function(e){return se(e,He)?e[He]:{}},De=function(e){return se(e,He)}}var Ge={set:Ce,get:Ae,has:De,enforce:function(e){return De(e)?Ae(e):Ce(e,{})},getterFor:function(e){return function(t){var i;if(!G(t)||(i=Ae(t)).type!==e)throw TypeError("Incompatible receiver, "+e+" required");return i}}},qe=k((function(e){var t=Ge.get,i=Ge.enforce,n=String(String).split("String");(e.exports=function(e,t,r,o){var s,a=!!o&&!!o.unsafe,c=!!o&&!!o.enumerable,u=!!o&&!!o.noTargetGet;"function"==typeof r&&("string"!=typeof t||se(r,"name")||ke(r,"name",t),(s=i(r)).source||(s.source=n.join("string"==typeof t?t:""))),e!==D?(a?!u&&e[t]&&(c=!0):delete e[t],c?e[t]=r:ke(e,t,r)):c?e[t]=r:te(t,r)})(Function.prototype,"toString",(function(){return"function"==typeof this&&t(this).source||Oe(this)}))})),Je=Math.ceil,We=Math.floor,ze=function(e){return isNaN(e=+e)?0:(e>0?We:Je)(e)},$e=Math.min,Ke=function(e){return e>0?$e(ze(e),9007199254740991):0},Ye=Math.max,Qe=Math.min,Xe=function(e,t){var i=ze(e);return i<0?Ye(i+t,0):Qe(i,t)},Ze=function(e){return function(t,i,n){var r,o=H(t),s=Ke(o.length),a=Xe(n,s);if(e&&i!=i){for(;s>a;)if((r=o[a++])!=r)return!0}else for(;s>a;a++)if((e||a in o)&&o[a]===i)return e||a||0;return!e&&-1}},et={includes:Ze(!0),indexOf:Ze(!1)},tt=et.indexOf,it=function(e,t){var i,n=H(e),r=0,o=[];for(i in n)!se(Ne,i)&&se(n,i)&&o.push(i);for(;t.length>r;)se(n,i=t[r++])&&(~tt(o,i)||o.push(i));return o},nt=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],rt=nt.concat("length","prototype"),ot={f:Object.getOwnPropertyNames||function(e){return it(e,rt)}},st={f:Object.getOwnPropertySymbols},at=J("Reflect","ownKeys")||function(e){var t=ot.f(be(e)),i=st.f;return i?t.concat(i(e)):t},ct=function(e,t){for(var i=at(t),n=Ie.f,r=Ee.f,o=0;o<i.length;o++){var s=i[o];se(e,s)||n(e,s,r(t,s))}},ut=/#|\.prototype\./,dt=function(e,t){var i=ht[lt(e)];return i==ft||i!=pt&&("function"==typeof t?O(t):!!t)},lt=dt.normalize=function(e){return String(e).replace(ut,".").toLowerCase()},ht=dt.data={},pt=dt.NATIVE="N",ft=dt.POLYFILL="P",mt=dt,vt=Ee.f,gt=function(e,t){var i,n,r,o,s,a=e.target,c=e.global,u=e.stat;if(i=c?D:u?D[a]||te(a,{}):(D[a]||{}).prototype)for(n in t){if(o=t[n],r=e.noTargetGet?(s=vt(i,n))&&s.value:i[n],!mt(c?n:a+(u?".":"#")+n,e.forced)&&void 0!==r){if(typeof o==typeof r)continue;ct(o,r)}(e.sham||r&&r.sham)&&ke(o,"sham",!0),qe(i,n,o,e)}},_t=function(e){if("function"!=typeof e)throw TypeError(String(e)+" is not a function");return e},yt=function(e,t,i){if(_t(e),void 0===t)return e;switch(i){case 0:return function(){return e.call(t)};case 1:return function(i){return e.call(t,i)};case 2:return function(i,n){return e.call(t,i,n)};case 3:return function(i,n,r){return e.call(t,i,n,r)}}return function(){return e.apply(t,arguments)}},St=Array.isArray||function(e){return"Array"==V(e)},Tt=pe("species"),Et=function(e,t){return new(function(e){var t;return St(e)&&("function"!=typeof(t=e.constructor)||t!==Array&&!St(t.prototype)?G(t)&&null===(t=t[Tt])&&(t=void 0):t=void 0),void 0===t?Array:t}(e))(0===t?0:t)},bt=[].push,Rt=function(e){var t=1==e,i=2==e,n=3==e,r=4==e,o=6==e,s=7==e,a=5==e||o;return function(c,u,d,l){for(var h,p,f=re(c),m=j(f),v=yt(u,d,3),g=Ke(m.length),_=0,y=l||Et,S=t?y(c,g):i||s?y(c,0):void 0;g>_;_++)if((a||_ in m)&&(p=v(h=m[_],_,f),e))if(t)S[_]=p;else if(p)switch(e){case 3:return!0;case 5:return h;case 6:return _;case 2:bt.call(S,h)}else switch(e){case 4:return!1;case 7:bt.call(S,h)}return o?-1:n||r?r:S}},It={forEach:Rt(0),map:Rt(1),filter:Rt(2),some:Rt(3),every:Rt(4),find:Rt(5),findIndex:Rt(6),filterReject:Rt(7)},kt=pe("species"),wt=function(e){return Q>=51||!O((function(){var t=[];return(t.constructor={})[kt]=function(){return{foo:1}},1!==t[e](Boolean).foo}))},Ct=It.map,At=wt("map");gt({target:"Array",proto:!0,forced:!At},{map:function(e){return Ct(this,e,arguments.length>1?arguments[1]:void 0)}});var Dt=It.filter,Ot=wt("filter");gt({target:"Array",proto:!0,forced:!Ot},{filter:function(e){return Dt(this,e,arguments.length>1?arguments[1]:void 0)}});var Pt=Ee.f,xt=O((function(){Pt(1)}));gt({target:"Object",stat:!0,forced:!P||xt,sham:!P},{getOwnPropertyDescriptor:function(e,t){return Pt(H(e),t)}}),k((function(e){var t=function(e){var t=Object.prototype,i=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",s=n.toStringTag||"@@toStringTag";function a(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{a({},"")}catch(e){a=function(e,t,i){return e[t]=i}}function c(e,t,i,n){var r=t&&t.prototype instanceof l?t:l,o=Object.create(r.prototype),s=new b(n||[]);return o._invoke=function(e,t,i){var n="suspendedStart";return function(r,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===r)throw o;return{value:void 0,done:!0}}for(i.method=r,i.arg=o;;){var s=i.delegate;if(s){var a=S(s,i);if(a){if(a===d)continue;return a}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===n)throw n="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n="executing";var c=u(e,t,i);if("normal"===c.type){if(n=i.done?"completed":"suspendedYield",c.arg===d)continue;return{value:c.arg,done:i.done}}"throw"===c.type&&(n="completed",i.method="throw",i.arg=c.arg)}}}(e,i,s),o}function u(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var d={};function l(){}function h(){}function p(){}var f={};a(f,r,(function(){return this}));var m=Object.getPrototypeOf,v=m&&m(m(R([])));v&&v!==t&&i.call(v,r)&&(f=v);var g=p.prototype=l.prototype=Object.create(f);function _(e){["next","throw","return"].forEach((function(t){a(e,t,(function(e){return this._invoke(t,e)}))}))}function y(e,t){var n;this._invoke=function(r,o){function s(){return new t((function(n,s){!function n(r,o,s,a){var c=u(e[r],e,o);if("throw"!==c.type){var d=c.arg,l=d.value;return l&&"object"==typeof l&&i.call(l,"__await")?t.resolve(l.__await).then((function(e){n("next",e,s,a)}),(function(e){n("throw",e,s,a)})):t.resolve(l).then((function(e){d.value=e,s(d)}),(function(e){return n("throw",e,s,a)}))}a(c.arg)}(r,o,n,s)}))}return n=n?n.then(s,s):s()}}function S(e,t){var i=e.iterator[t.method];if(void 0===i){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,S(e,t),"throw"===t.method))return d;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return d}var n=u(i,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,d;var r=n.arg;return r?r.done?(t[e.resultName]=r.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,d):r:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function T(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function E(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function b(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(T,this),this.reset(!0)}function R(e){if(e){var t=e[r];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(i.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:I}}function I(){return{value:void 0,done:!0}}return h.prototype=p,a(g,"constructor",p),a(p,"constructor",h),h.displayName=a(p,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,a(e,s,"GeneratorFunction")),e.prototype=Object.create(g),e},e.awrap=function(e){return{__await:e}},_(y.prototype),a(y.prototype,o,(function(){return this})),e.AsyncIterator=y,e.async=function(t,i,n,r,o){void 0===o&&(o=Promise);var s=new y(c(t,i,n,r),o);return e.isGeneratorFunction(i)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},_(g),a(g,s,"Generator"),a(g,r,(function(){return this})),a(g,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var i in e)t.push(i);return t.reverse(),function i(){for(;t.length;){var n=t.pop();if(n in e)return i.value=n,i.done=!1,i}return i.done=!0,i}},e.values=R,b.prototype={constructor:b,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(E),!e)for(var t in this)"t"===t.charAt(0)&&i.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(i,n){return s.type="throw",s.arg=e,t.next=i,n&&(t.method="next",t.arg=void 0),!!n}for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r],s=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var a=i.call(o,"catchLoc"),c=i.call(o,"finallyLoc");if(a&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(a){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=e,s.arg=t,o?(this.method="next",this.next=o.finallyLoc,d):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),d},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),E(i),d}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var n=i.completion;if("throw"===n.type){var r=n.arg;E(i)}return r}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,i){return this.delegate={iterator:R(e),resultName:t,nextLoc:i},"next"===this.method&&(this.arg=void 0),d}},e}(e.exports);try{regeneratorRuntime=t}catch(e){"object"==typeof globalThis?globalThis.regeneratorRuntime=t:Function("r","regeneratorRuntime = r")(t)}}));let Mt=!0,Lt=!0;function Nt(e,t,i){const n=e.match(t);return n&&n.length>=i&&parseInt(n[i],10)}function Ut(e,t,i){if(!e.RTCPeerConnection)return;const n=e.RTCPeerConnection.prototype,r=n.addEventListener;n.addEventListener=function(e,n){if(e!==t)return r.apply(this,arguments);const o=e=>{const t=i(e);t&&(n.handleEvent?n.handleEvent(t):n(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(n,o),r.apply(this,[e,o])};const o=n.removeEventListener;n.removeEventListener=function(e,i){if(e!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(i))return o.apply(this,arguments);const n=this._eventMap[t].get(i);return this._eventMap[t].delete(i),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,o.apply(this,[e,n])},Object.defineProperty(n,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function Vt(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(Mt=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function Ft(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(Lt=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function jt(){if("object"==typeof window){if(Mt)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function Bt(e,t){Lt&&console.warn(e+" is deprecated, please use "+t+" instead.")}function Ht(e){return"[object Object]"===Object.prototype.toString.call(e)}function Gt(e){return Ht(e)?Object.keys(e).reduce((function(t,i){const n=Ht(e[i]),r=n?Gt(e[i]):e[i],o=n&&!Object.keys(r).length;return void 0===r||o?t:Object.assign(t,{[i]:r})}),{}):e}function qt(e,t,i){const n=i?"outbound-rtp":"inbound-rtp",r=new Map;if(null===t)return r;const o=[];return e.forEach(e=>{"track"===e.type&&e.trackIdentifier===t.id&&o.push(e)}),o.forEach(t=>{e.forEach(i=>{i.type===n&&i.trackId===t.id&&function e(t,i,n){i&&!n.has(i.id)&&(n.set(i.id,i),Object.keys(i).forEach(r=>{r.endsWith("Id")?e(t,t.get(i[r]),n):r.endsWith("Ids")&&i[r].forEach(i=>{e(t,t.get(i),n)})}))}(e,i,r)})}),r}const Jt=jt;function Wt(e,t){const i=e&&e.navigator;if(!i.mediaDevices)return;const n=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach(i=>{if("require"===i||"advanced"===i||"mediaSource"===i)return;const n="object"==typeof e[i]?e[i]:{ideal:e[i]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);const r=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==n.ideal){t.optional=t.optional||[];let e={};"number"==typeof n.ideal?(e[r("min",i)]=n.ideal,t.optional.push(e),e={},e[r("max",i)]=n.ideal,t.optional.push(e)):(e[r("",i)]=n.ideal,t.optional.push(e))}void 0!==n.exact&&"number"!=typeof n.exact?(t.mandatory=t.mandatory||{},t.mandatory[r("",i)]=n.exact):["min","max"].forEach(e=>{void 0!==n[e]&&(t.mandatory=t.mandatory||{},t.mandatory[r(e,i)]=n[e])})}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},r=function(e,r){if(t.version>=61)return r(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=n(e.audio)}if(e&&"object"==typeof e.video){let o=e.video.facingMode;o=o&&("object"==typeof o?o:{ideal:o});const s=t.version<66;if(o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||s)){let t;if(delete e.video.facingMode,"environment"===o.exact||"environment"===o.ideal?t=["back","rear"]:"user"!==o.exact&&"user"!==o.ideal||(t=["front"]),t)return i.mediaDevices.enumerateDevices().then(i=>{let s=(i=i.filter(e=>"videoinput"===e.kind)).find(e=>t.some(t=>e.label.toLowerCase().includes(t)));return!s&&i.length&&t.includes("back")&&(s=i[i.length-1]),s&&(e.video.deviceId=o.exact?{exact:s.deviceId}:{ideal:s.deviceId}),e.video=n(e.video),Jt("chrome: "+JSON.stringify(e)),r(e)})}e.video=n(e.video)}return Jt("chrome: "+JSON.stringify(e)),r(e)},o=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=function(e,t,n){r(e,e=>{i.webkitGetUserMedia(e,t,e=>{n&&n(o(e))})})}.bind(i),i.mediaDevices.getUserMedia){const e=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(t){return r(t,t=>e(t).then(e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach(e=>{e.stop()}),new DOMException("","NotFoundError");return e},e=>Promise.reject(o(e))))}}}function zt(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function $t(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",i=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===i.track.id):{track:i.track};const r=new Event("track");r.track=i.track,r.receiver=n,r.transceiver={receiver:n},r.streams=[t.stream],this.dispatchEvent(r)}),t.stream.getTracks().forEach(i=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===i.id):{track:i};const r=new Event("track");r.track=i,r.receiver=n,r.transceiver={receiver:n},r.streams=[t.stream],this.dispatchEvent(r)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else Ut(e,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function Kt(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){let r=i.apply(this,arguments);return r||(r=t(this,e),this._senders.push(r)),r};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){n.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach(e=>{this._senders.push(t(this,e))})};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach(e=>{const t=this._senders.find(t=>t.track===e);t&&this._senders.splice(this._senders.indexOf(t),1)})}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Yt(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,n]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const r=function(e){const t={};return e.result().forEach(e=>{const i={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(t=>{i[t]=e.stat(t)}),t[i.id]=i}),t},o=function(e){return new Map(Object.keys(e).map(t=>[t,e[t]]))};if(arguments.length>=2){const n=function(e){i(o(r(e)))};return t.apply(this,[n,e])}return new Promise((e,i)=>{t.apply(this,[function(t){e(o(r(t)))},i])}).then(i,n)}}function Qt(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>qt(t,e.track,!0))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),Ut(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>qt(t,e.track,!1))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,i,n;return this.getSenders().forEach(i=>{i.track===e&&(t?n=!0:t=i)}),this.getReceivers().forEach(t=>(t.track===e&&(i?n=!0:i=t),t.track===e)),n||t&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function Xt(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(e=>this._shimmedLocalStreams[e][0])};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){if(!i)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const n=t.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(n)&&this._shimmedLocalStreams[i.id].push(n):this._shimmedLocalStreams[i.id]=[i,n],n};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")});const t=this.getSenders();i.apply(this,arguments);const n=this.getSenders().filter(e=>-1===t.indexOf(e));this._shimmedLocalStreams[e.id]=[e].concat(n)};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],n.apply(this,arguments)};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach(t=>{const i=this._shimmedLocalStreams[t].indexOf(e);-1!==i&&this._shimmedLocalStreams[t].splice(i,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]}),r.apply(this,arguments)}}function Zt(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return Xt(e);const i=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=i.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map(e=>this._reverseStreams[e.id])};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[t.id]){const i=new e.MediaStream(t.getTracks());this._streams[t.id]=i,this._reverseStreams[i.id]=t,t=i}n.apply(this,[t])};const r=e.RTCPeerConnection.prototype.removeStream;function o(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const n=e._reverseStreams[t],r=e._streams[n.id];i=i.replace(new RegExp(r.id,"g"),n.id)}),new RTCSessionDescription({type:t.type,sdp:i})}function s(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const n=e._reverseStreams[t],r=e._streams[n.id];i=i.replace(new RegExp(n.id,"g"),r.id)}),new RTCSessionDescription({type:t.type,sdp:i})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,i){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const n=[].slice.call(arguments,1);if(1!==n.length||!n[0].getTracks().find(e=>e===t))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const r=this.getSenders().find(e=>e.track===t);if(r)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const o=this._streams[i.id];if(o)o.addTrack(t),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const n=new e.MediaStream([t]);this._streams[i.id]=n,this._reverseStreams[n.id]=i,this.addStream(n)}return this.getSenders().find(e=>e.track===t)},["createOffer","createAnswer"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],n={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?i.apply(this,[t=>{const i=o(this,t);e[0].apply(null,[i])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):i.apply(this,arguments).then(e=>o(this,e))}};e.RTCPeerConnection.prototype[t]=n[t]}));const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=s(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=c.get.apply(this);return""===e.type?e:o(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach(i=>{this._streams[i].getTracks().find(t=>e.track===t)&&(t=this._streams[i])}),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function ei(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t]}))}function ti(e,t){Ut(e,"negotiationneeded",e=>{const i=e.target;if(!(t.version<72||i.getConfiguration&&"plan-b"===i.getConfiguration().sdpSemantics)||"stable"===i.signalingState)return e})}var ii=Object.freeze({__proto__:null,shimMediaStream:zt,shimOnTrack:$t,shimGetSendersWithDtmf:Kt,shimGetStats:Yt,shimSenderReceiverGetStats:Qt,shimAddTrackRemoveTrackWithNative:Xt,shimAddTrackRemoveTrack:Zt,shimPeerConnection:ei,fixNegotiationNeeded:ti,shimGetUserMedia:Wt,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then(t=>{const n=i.video&&i.video.width,r=i.video&&i.video.height,o=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:o||3}},n&&(i.video.mandatory.maxWidth=n),r&&(i.video.mandatory.maxHeight=r),e.navigator.mediaDevices.getUserMedia(i)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}}),ni=k((function(e){var t={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},t.splitSections=function(e){return e.split("\nm=").map((function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"}))},t.getDescription=function(e){var i=t.splitSections(e);return i&&i[0]},t.getMediaSections=function(e){var i=t.splitSections(e);return i.shift(),i},t.matchPrefix=function(e,i){return t.splitLines(e).filter((function(e){return 0===e.indexOf(i)}))},t.parseCandidate=function(e){for(var t,i={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},n=8;n<t.length;n+=2)switch(t[n]){case"raddr":i.relatedAddress=t[n+1];break;case"rport":i.relatedPort=parseInt(t[n+1],10);break;case"tcptype":i.tcpType=t[n+1];break;case"ufrag":i.ufrag=t[n+1],i.usernameFragment=t[n+1];break;default:i[t[n]]=t[n+1]}return i},t.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var i=e.type;return t.push("typ"),t.push(i),"host"!==i&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){var t=e.substr(9).split(" "),i={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),i.name=t[0],i.clockRate=parseInt(t[1],10),i.channels=3===t.length?parseInt(t[2],10):1,i.numChannels=i.channels,i},t.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var i=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==i?"/"+i:"")+"\r\n"},t.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},t.parseFmtp=function(e){for(var t,i={},n=e.substr(e.indexOf(" ")+1).split(";"),r=0;r<n.length;r++)i[(t=n[r].trim().split("="))[0].trim()]=t[1];return i},t.writeFmtp=function(e){var t="",i=e.payloadType;if(void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var n=[];Object.keys(e.parameters).forEach((function(t){e.parameters[t]?n.push(t+"="+e.parameters[t]):n.push(t)})),t+="a=fmtp:"+i+" "+n.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){var t="",i=e.payloadType;return void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+i+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){var t=e.indexOf(" "),i={ssrc:parseInt(e.substr(7,t-7),10)},n=e.indexOf(":",t);return n>-1?(i.attribute=e.substr(t+1,n-t-1),i.value=e.substr(n+1)):i.attribute=e.substr(t+1),i},t.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},t.getMid=function(e){var i=t.matchPrefix(e,"a=mid:")[0];if(i)return i.substr(6)},t.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},t.getDtlsParameters=function(e,i){return{role:"auto",fingerprints:t.matchPrefix(e+i,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){var i="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),i},t.parseCryptoLine=function(e){var t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;var t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,i){return t.matchPrefix(e+i,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,i){var n=t.matchPrefix(e+i,"a=ice-ufrag:")[0],r=t.matchPrefix(e+i,"a=ice-pwd:")[0];return n&&r?{usernameFragment:n.substr(12),password:r.substr(10)}:null},t.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},t.parseRtpParameters=function(e){for(var i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=t.splitLines(e)[0].split(" "),r=3;r<n.length;r++){var o=n[r],s=t.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(s){var a=t.parseRtpMap(s),c=t.matchPrefix(e,"a=fmtp:"+o+" ");switch(a.parameters=c.length?t.parseFmtp(c[0]):{},a.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(t.parseRtcpFb),i.codecs.push(a),a.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(a.name.toUpperCase())}}}return t.matchPrefix(e,"a=extmap:").forEach((function(e){i.headerExtensions.push(t.parseExtmap(e))})),i},t.writeRtpDescription=function(e,i){var n="";n+="m="+e+" ",n+=i.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=i.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",i.codecs.forEach((function(e){n+=t.writeRtpMap(e),n+=t.writeFmtp(e),n+=t.writeRtcpFb(e)}));var r=0;return i.codecs.forEach((function(e){e.maxptime>r&&(r=e.maxptime)})),r>0&&(n+="a=maxptime:"+r+"\r\n"),n+="a=rtcp-mux\r\n",i.headerExtensions&&i.headerExtensions.forEach((function(e){n+=t.writeExtmap(e)})),n},t.parseRtpEncodingParameters=function(e){var i,n=[],r=t.parseRtpParameters(e),o=-1!==r.fecMechanisms.indexOf("RED"),s=-1!==r.fecMechanisms.indexOf("ULPFEC"),a=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute})),c=a.length>0&&a[0].ssrc,u=t.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));u.length>0&&u[0].length>1&&u[0][0]===c&&(i=u[0][1]),r.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var t={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&i&&(t.rtx={ssrc:i}),n.push(t),o&&((t=JSON.parse(JSON.stringify(t))).fec={ssrc:c,mechanism:s?"red+ulpfec":"red"},n.push(t))}})),0===n.length&&c&&n.push({ssrc:c});var d=t.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substr(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substr(5),10)*.95-16e3:void 0,n.forEach((function(e){e.maxBitrate=d}))),n},t.parseRtcpParameters=function(e){var i={},n=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute}))[0];n&&(i.cname=n.value,i.ssrc=n.ssrc);var r=t.matchPrefix(e,"a=rtcp-rsize");i.reducedSize=r.length>0,i.compound=0===r.length;var o=t.matchPrefix(e,"a=rtcp-mux");return i.mux=o.length>0,i},t.parseMsid=function(e){var i,n=t.matchPrefix(e,"a=msid:");if(1===n.length)return{stream:(i=n[0].substr(7).split(" "))[0],track:i[1]};var r=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"msid"===e.attribute}));return r.length>0?{stream:(i=r[0].value.split(" "))[0],track:i[1]}:void 0},t.parseSctpDescription=function(e){var i,n=t.parseMLine(e),r=t.matchPrefix(e,"a=max-message-size:");r.length>0&&(i=parseInt(r[0].substr(19),10)),isNaN(i)&&(i=65536);var o=t.matchPrefix(e,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substr(12),10),protocol:n.fmt,maxMessageSize:i};if(t.matchPrefix(e,"a=sctpmap:").length>0){var s=t.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(s[0],10),protocol:s[1],maxMessageSize:i}}},t.writeSctpDescription=function(e,t){var i=[];return i="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&i.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),i.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,i,n){var r=void 0!==i?i:2;return"v=0\r\no="+(n||"thisisadapterortc")+" "+(e||t.generateSessionId())+" "+r+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.writeMediaSection=function(e,i,n,r){var o=t.writeRtpDescription(e.kind,i);if(o+=t.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=t.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":"active"),o+="a=mid:"+e.mid+"\r\n",e.direction?o+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?o+="a=sendrecv\r\n":e.rtpSender?o+="a=sendonly\r\n":e.rtpReceiver?o+="a=recvonly\r\n":o+="a=inactive\r\n",e.rtpSender){var s="msid:"+r.id+" "+e.rtpSender.track.id+"\r\n";o+="a="+s,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+s,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+s,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+t.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+t.localCName+"\r\n"),o},t.getDirection=function(e,i){for(var n=t.splitLines(e),r=0;r<n.length;r++)switch(n[r]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[r].substr(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substr(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){var i=t.splitLines(e)[0].substr(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},t.parseOLine=function(e){var i=t.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var i=t.splitLines(e),n=0;n<i.length;n++)if(i[n].length<2||"="!==i[n].charAt(1))return!1;return!0},e.exports=t}));function ri(e,t,i,n,r){var o=ni.writeRtpDescription(e.kind,t);if(o+=ni.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=ni.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===i?"actpass":r||"active"),o+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?o+="a=sendrecv\r\n":e.rtpSender?o+="a=sendonly\r\n":e.rtpReceiver?o+="a=recvonly\r\n":o+="a=inactive\r\n",e.rtpSender){var s=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=s;var a="msid:"+(n?n.id:"-")+" "+s+"\r\n";o+="a="+a,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+a,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+a,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+ni.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+ni.localCName+"\r\n"),o}function oi(e,t){var i={codecs:[],headerExtensions:[],fecMechanisms:[]},n=function(e,t){e=parseInt(e,10);for(var i=0;i<t.length;i++)if(t[i].payloadType===e||t[i].preferredPayloadType===e)return t[i]},r=function(e,t,i,r){var o=n(e.parameters.apt,i),s=n(t.parameters.apt,r);return o&&s&&o.name.toLowerCase()===s.name.toLowerCase()};return e.codecs.forEach((function(n){for(var o=0;o<t.codecs.length;o++){var s=t.codecs[o];if(n.name.toLowerCase()===s.name.toLowerCase()&&n.clockRate===s.clockRate){if("rtx"===n.name.toLowerCase()&&n.parameters&&s.parameters.apt&&!r(n,s,e.codecs,t.codecs))continue;(s=JSON.parse(JSON.stringify(s))).numChannels=Math.min(n.numChannels,s.numChannels),i.codecs.push(s),s.rtcpFeedback=s.rtcpFeedback.filter((function(e){for(var t=0;t<n.rtcpFeedback.length;t++)if(n.rtcpFeedback[t].type===e.type&&n.rtcpFeedback[t].parameter===e.parameter)return!0;return!1}));break}}})),e.headerExtensions.forEach((function(e){for(var n=0;n<t.headerExtensions.length;n++){var r=t.headerExtensions[n];if(e.uri===r.uri){i.headerExtensions.push(r);break}}})),i}function si(e,t,i){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(i)}function ai(e,t){var i=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));return i||e.addRemoteCandidate(t),!i}function ci(e,t){var i=new Error(t);return i.name=e,i.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],i}function ui(e){const t=e&&e.navigator,i=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return i(e).catch(e=>Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString(){return this.name}}}(e)))}}function di(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)))}function li(e,t){if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){const t=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set(e){t.set.call(this,e);const i=new Event("enabled");i.enabled=e,this.dispatchEvent(i)}})}e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);const i=function(e,t){function i(t,i){i.addTrack(t),i.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function n(t,i,n,r){var o=new Event("track");o.track=i,o.receiver=n,o.transceiver={receiver:n},o.streams=r,e.setTimeout((function(){t._dispatchEvent("track",o)}))}var r=function(i){var n=this,r=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){n[e]=r[e].bind(r)})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",i=JSON.parse(JSON.stringify(i||{})),this.usingBundle="max-bundle"===i.bundlePolicy,"negotiate"===i.rtcpMuxPolicy)throw ci("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(i.rtcpMuxPolicy||(i.rtcpMuxPolicy="require"),i.iceTransportPolicy){case"all":case"relay":break;default:i.iceTransportPolicy="all"}switch(i.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:i.bundlePolicy="balanced"}if(i.iceServers=function(e,t){var i=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var n=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var r="string"==typeof n;return r&&(n=[n]),n=n.filter((function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||i?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(i=!0,!0)})),delete e.url,e.urls=r?n[0]:n,!!n.length}}))}(i.iceServers||[],t),this._iceGatherers=[],i.iceCandidatePoolSize)for(var o=i.iceCandidatePoolSize;o>0;o--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:i.iceServers,gatherPolicy:i.iceTransportPolicy}));else i.iceCandidatePoolSize=0;this._config=i,this.transceivers=[],this._sdpSessionId=ni.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(r.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(r.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),r.prototype.onicecandidate=null,r.prototype.onaddstream=null,r.prototype.ontrack=null,r.prototype.onremovestream=null,r.prototype.onsignalingstatechange=null,r.prototype.oniceconnectionstatechange=null,r.prototype.onconnectionstatechange=null,r.prototype.onicegatheringstatechange=null,r.prototype.onnegotiationneeded=null,r.prototype.ondatachannel=null,r.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},r.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},r.prototype.getConfiguration=function(){return this._config},r.prototype.getLocalStreams=function(){return this.localStreams},r.prototype.getRemoteStreams=function(){return this.remoteStreams},r.prototype._createTransceiver=function(e,t){var i=this.transceivers.length>0,n={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&i)n.iceTransport=this.transceivers[0].iceTransport,n.dtlsTransport=this.transceivers[0].dtlsTransport;else{var r=this._createIceAndDtlsTransports();n.iceTransport=r.iceTransport,n.dtlsTransport=r.dtlsTransport}return t||this.transceivers.push(n),n},r.prototype.addTrack=function(t,i){if(this._isClosed)throw ci("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var n;if(this.transceivers.find((function(e){return e.track===t})))throw ci("InvalidAccessError","Track already exists.");for(var r=0;r<this.transceivers.length;r++)this.transceivers[r].track||this.transceivers[r].kind!==t.kind||(n=this.transceivers[r]);return n||(n=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(i)&&this.localStreams.push(i),n.track=t,n.stream=i,n.rtpSender=new e.RTCRtpSender(t,n.dtlsTransport),n.rtpSender},r.prototype.addStream=function(e){var i=this;if(t>=15025)e.getTracks().forEach((function(t){i.addTrack(t,e)}));else{var n=e.clone();e.getTracks().forEach((function(e,t){var i=n.getTracks()[t];e.addEventListener("enabled",(function(e){i.enabled=e.enabled}))})),n.getTracks().forEach((function(e){i.addTrack(e,n)}))}},r.prototype.removeTrack=function(t){if(this._isClosed)throw ci("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var i=this.transceivers.find((function(e){return e.rtpSender===t}));if(!i)throw ci("InvalidAccessError","Sender was not created by this connection.");var n=i.stream;i.rtpSender.stop(),i.rtpSender=null,i.track=null,i.stream=null,-1===this.transceivers.map((function(e){return e.stream})).indexOf(n)&&this.localStreams.indexOf(n)>-1&&this.localStreams.splice(this.localStreams.indexOf(n),1),this._maybeFireNegotiationNeeded()},r.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var i=t.getSenders().find((function(t){return t.track===e}));i&&t.removeTrack(i)}))},r.prototype.getSenders=function(){return this.transceivers.filter((function(e){return!!e.rtpSender})).map((function(e){return e.rtpSender}))},r.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return!!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},r.prototype._createIceGatherer=function(t,i){var n=this;if(i&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var r=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(r,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var i=!e.candidate||0===Object.keys(e.candidate).length;r.state=i?"completed":"gathering",null!==n.transceivers[t].bufferedCandidateEvents&&n.transceivers[t].bufferedCandidateEvents.push(e)},r.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),r},r.prototype._gather=function(t,i){var n=this,r=this.transceivers[i].iceGatherer;if(!r.onlocalcandidate){var o=this.transceivers[i].bufferedCandidateEvents;this.transceivers[i].bufferedCandidateEvents=null,r.removeEventListener("localcandidate",this.transceivers[i].bufferCandidates),r.onlocalcandidate=function(e){if(!(n.usingBundle&&i>0)){var o=new Event("icecandidate");o.candidate={sdpMid:t,sdpMLineIndex:i};var s=e.candidate,a=!s||0===Object.keys(s).length;if(a)"new"!==r.state&&"gathering"!==r.state||(r.state="completed");else{"new"===r.state&&(r.state="gathering"),s.component=1,s.ufrag=r.getLocalParameters().usernameFragment;var c=ni.writeCandidate(s);o.candidate=Object.assign(o.candidate,ni.parseCandidate(c)),o.candidate.candidate=c,o.candidate.toJSON=function(){return{candidate:o.candidate.candidate,sdpMid:o.candidate.sdpMid,sdpMLineIndex:o.candidate.sdpMLineIndex,usernameFragment:o.candidate.usernameFragment}}}var u=ni.getMediaSections(n._localDescription.sdp);u[o.candidate.sdpMLineIndex]+=a?"a=end-of-candidates\r\n":"a="+o.candidate.candidate+"\r\n",n._localDescription.sdp=ni.getDescription(n._localDescription.sdp)+u.join("");var d=n.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));"gathering"!==n.iceGatheringState&&(n.iceGatheringState="gathering",n._emitGatheringStateChange()),a||n._dispatchEvent("icecandidate",o),d&&(n._dispatchEvent("icecandidate",new Event("icecandidate")),n.iceGatheringState="complete",n._emitGatheringStateChange())}},e.setTimeout((function(){o.forEach((function(e){r.onlocalcandidate(e)}))}),0)}},r.prototype._createIceAndDtlsTransports=function(){var t=this,i=new e.RTCIceTransport(null);i.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var n=new e.RTCDtlsTransport(i);return n.ondtlsstatechange=function(){t._updateConnectionState()},n.onerror=function(){Object.defineProperty(n,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:i,dtlsTransport:n}},r.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var i=this.transceivers[e].iceTransport;i&&(delete i.onicestatechange,delete this.transceivers[e].iceTransport);var n=this.transceivers[e].dtlsTransport;n&&(delete n.ondtlsstatechange,delete n.onerror,delete this.transceivers[e].dtlsTransport)},r.prototype._transceive=function(e,i,n){var r=oi(e.localCapabilities,e.remoteCapabilities);i&&e.rtpSender&&(r.encodings=e.sendEncodingParameters,r.rtcp={cname:ni.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(r.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(r)),n&&e.rtpReceiver&&r.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx})),e.recvEncodingParameters.length?r.encodings=e.recvEncodingParameters:r.encodings=[{}],r.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(r.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(r.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(r))},r.prototype.setLocalDescription=function(e){var t,i,n=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(ci("TypeError",'Unsupported type "'+e.type+'"'));if(!si("setLocalDescription",e.type,n.signalingState)||n._isClosed)return Promise.reject(ci("InvalidStateError","Can not set local "+e.type+" in state "+n.signalingState));if("offer"===e.type)t=ni.splitSections(e.sdp),i=t.shift(),t.forEach((function(e,t){var i=ni.parseRtpParameters(e);n.transceivers[t].localCapabilities=i})),n.transceivers.forEach((function(e,t){n._gather(e.mid,t)}));else if("answer"===e.type){t=ni.splitSections(n._remoteDescription.sdp),i=t.shift();var r=ni.matchPrefix(i,"a=ice-lite").length>0;t.forEach((function(e,t){var o=n.transceivers[t],s=o.iceGatherer,a=o.iceTransport,c=o.dtlsTransport,u=o.localCapabilities,d=o.remoteCapabilities;if(!(ni.isRejected(e)&&0===ni.matchPrefix(e,"a=bundle-only").length||o.rejected)){var l=ni.getIceParameters(e,i),h=ni.getDtlsParameters(e,i);r&&(h.role="server"),n.usingBundle&&0!==t||(n._gather(o.mid,t),"new"===a.state&&a.start(s,l,r?"controlling":"controlled"),"new"===c.state&&c.start(h));var p=oi(u,d);n._transceive(o,p.codecs.length>0,!1)}}))}return n._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?n._updateSignalingState("have-local-offer"):n._updateSignalingState("stable"),Promise.resolve()},r.prototype.setRemoteDescription=function(r){var o=this;if(-1===["offer","answer"].indexOf(r.type))return Promise.reject(ci("TypeError",'Unsupported type "'+r.type+'"'));if(!si("setRemoteDescription",r.type,o.signalingState)||o._isClosed)return Promise.reject(ci("InvalidStateError","Can not set remote "+r.type+" in state "+o.signalingState));var s={};o.remoteStreams.forEach((function(e){s[e.id]=e}));var a=[],c=ni.splitSections(r.sdp),u=c.shift(),d=ni.matchPrefix(u,"a=ice-lite").length>0,l=ni.matchPrefix(u,"a=group:BUNDLE ").length>0;o.usingBundle=l;var h=ni.matchPrefix(u,"a=ice-options:")[0];return o.canTrickleIceCandidates=!!h&&h.substr(14).split(" ").indexOf("trickle")>=0,c.forEach((function(n,c){var h=ni.splitLines(n),p=ni.getKind(n),f=ni.isRejected(n)&&0===ni.matchPrefix(n,"a=bundle-only").length,m=h[0].substr(2).split(" ")[2],v=ni.getDirection(n,u),g=ni.parseMsid(n),_=ni.getMid(n)||ni.generateIdentifier();if(f||"application"===p&&("DTLS/SCTP"===m||"UDP/DTLS/SCTP"===m))o.transceivers[c]={mid:_,kind:p,protocol:m,rejected:!0};else{var y,S,T,E,b,R,I,k,w;!f&&o.transceivers[c]&&o.transceivers[c].rejected&&(o.transceivers[c]=o._createTransceiver(p,!0));var C,A,D=ni.parseRtpParameters(n);f||(C=ni.getIceParameters(n,u),(A=ni.getDtlsParameters(n,u)).role="client"),I=ni.parseRtpEncodingParameters(n);var O=ni.parseRtcpParameters(n),P=ni.matchPrefix(n,"a=end-of-candidates",u).length>0,x=ni.matchPrefix(n,"a=candidate:").map((function(e){return ni.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===r.type||"answer"===r.type)&&!f&&l&&c>0&&o.transceivers[c]&&(o._disposeIceAndDtlsTransports(c),o.transceivers[c].iceGatherer=o.transceivers[0].iceGatherer,o.transceivers[c].iceTransport=o.transceivers[0].iceTransport,o.transceivers[c].dtlsTransport=o.transceivers[0].dtlsTransport,o.transceivers[c].rtpSender&&o.transceivers[c].rtpSender.setTransport(o.transceivers[0].dtlsTransport),o.transceivers[c].rtpReceiver&&o.transceivers[c].rtpReceiver.setTransport(o.transceivers[0].dtlsTransport)),"offer"!==r.type||f)"answer"!==r.type||f||(S=(y=o.transceivers[c]).iceGatherer,T=y.iceTransport,E=y.dtlsTransport,b=y.rtpReceiver,R=y.sendEncodingParameters,k=y.localCapabilities,o.transceivers[c].recvEncodingParameters=I,o.transceivers[c].remoteCapabilities=D,o.transceivers[c].rtcpParameters=O,x.length&&"new"===T.state&&(!d&&!P||l&&0!==c?x.forEach((function(e){ai(y.iceTransport,e)})):T.setRemoteCandidates(x)),l&&0!==c||("new"===T.state&&T.start(S,C,"controlling"),"new"===E.state&&E.start(A)),!oi(y.localCapabilities,y.remoteCapabilities).codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&y.sendEncodingParameters[0].rtx&&delete y.sendEncodingParameters[0].rtx,o._transceive(y,"sendrecv"===v||"recvonly"===v,"sendrecv"===v||"sendonly"===v),!b||"sendrecv"!==v&&"sendonly"!==v?delete y.rtpReceiver:(w=b.track,g?(s[g.stream]||(s[g.stream]=new e.MediaStream),i(w,s[g.stream]),a.push([w,b,s[g.stream]])):(s.default||(s.default=new e.MediaStream),i(w,s.default),a.push([w,b,s.default]))));else{(y=o.transceivers[c]||o._createTransceiver(p)).mid=_,y.iceGatherer||(y.iceGatherer=o._createIceGatherer(c,l)),x.length&&"new"===y.iceTransport.state&&(!P||l&&0!==c?x.forEach((function(e){ai(y.iceTransport,e)})):y.iceTransport.setRemoteCandidates(x)),k=e.RTCRtpReceiver.getCapabilities(p),t<15019&&(k.codecs=k.codecs.filter((function(e){return"rtx"!==e.name}))),R=y.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var M,L=!1;"sendrecv"===v||"sendonly"===v?(L=!y.rtpReceiver,b=y.rtpReceiver||new e.RTCRtpReceiver(y.dtlsTransport,p),L&&(w=b.track,g&&"-"===g.stream||(g?(s[g.stream]||(s[g.stream]=new e.MediaStream,Object.defineProperty(s[g.stream],"id",{get:function(){return g.stream}})),Object.defineProperty(w,"id",{get:function(){return g.track}}),M=s[g.stream]):(s.default||(s.default=new e.MediaStream),M=s.default)),M&&(i(w,M),y.associatedRemoteMediaStreams.push(M)),a.push([w,b,M]))):y.rtpReceiver&&y.rtpReceiver.track&&(y.associatedRemoteMediaStreams.forEach((function(t){var i=t.getTracks().find((function(e){return e.id===y.rtpReceiver.track.id}));i&&function(t,i){i.removeTrack(t),i.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}(i,t)})),y.associatedRemoteMediaStreams=[]),y.localCapabilities=k,y.remoteCapabilities=D,y.rtpReceiver=b,y.rtcpParameters=O,y.sendEncodingParameters=R,y.recvEncodingParameters=I,o._transceive(o.transceivers[c],!1,L)}}})),void 0===o._dtlsRole&&(o._dtlsRole="offer"===r.type?"active":"passive"),o._remoteDescription={type:r.type,sdp:r.sdp},"offer"===r.type?o._updateSignalingState("have-remote-offer"):o._updateSignalingState("stable"),Object.keys(s).forEach((function(t){var i=s[t];if(i.getTracks().length){if(-1===o.remoteStreams.indexOf(i)){o.remoteStreams.push(i);var r=new Event("addstream");r.stream=i,e.setTimeout((function(){o._dispatchEvent("addstream",r)}))}a.forEach((function(e){var t=e[0],r=e[1];i.id===e[2].id&&n(o,t,r,[i])}))}})),a.forEach((function(e){e[2]||n(o,e[0],e[1],[])})),e.setTimeout((function(){o&&o.transceivers&&o.transceivers.forEach((function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))}))}),4e3),Promise.resolve()},r.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()})),this._isClosed=!0,this._updateSignalingState("closed")},r.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},r.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}}),0))},r.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++})),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var i=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",i)}},r.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++)})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var i=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",i)}},r.prototype.createOffer=function(){var i=this;if(i._isClosed)return Promise.reject(ci("InvalidStateError","Can not call createOffer after close"));var n=i.transceivers.filter((function(e){return"audio"===e.kind})).length,r=i.transceivers.filter((function(e){return"video"===e.kind})).length,o=arguments[0];if(o){if(o.mandatory||o.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==o.offerToReceiveAudio&&(n=!0===o.offerToReceiveAudio?1:!1===o.offerToReceiveAudio?0:o.offerToReceiveAudio),void 0!==o.offerToReceiveVideo&&(r=!0===o.offerToReceiveVideo?1:!1===o.offerToReceiveVideo?0:o.offerToReceiveVideo)}for(i.transceivers.forEach((function(e){"audio"===e.kind?--n<0&&(e.wantReceive=!1):"video"===e.kind&&--r<0&&(e.wantReceive=!1)}));n>0||r>0;)n>0&&(i._createTransceiver("audio"),n--),r>0&&(i._createTransceiver("video"),r--);var s=ni.writeSessionBoilerplate(i._sdpSessionId,i._sdpSessionVersion++);i.transceivers.forEach((function(n,r){var o=n.track,s=n.kind,a=n.mid||ni.generateIdentifier();n.mid=a,n.iceGatherer||(n.iceGatherer=i._createIceGatherer(r,i.usingBundle));var c=e.RTCRtpSender.getCapabilities(s);t<15019&&(c.codecs=c.codecs.filter((function(e){return"rtx"!==e.name}))),c.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),n.remoteCapabilities&&n.remoteCapabilities.codecs&&n.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)}))})),c.headerExtensions.forEach((function(e){(n.remoteCapabilities&&n.remoteCapabilities.headerExtensions||[]).forEach((function(t){e.uri===t.uri&&(e.id=t.id)}))}));var u=n.sendEncodingParameters||[{ssrc:1001*(2*r+1)}];o&&t>=15019&&"video"===s&&!u[0].rtx&&(u[0].rtx={ssrc:u[0].ssrc+1}),n.wantReceive&&(n.rtpReceiver=new e.RTCRtpReceiver(n.dtlsTransport,s)),n.localCapabilities=c,n.sendEncodingParameters=u})),"max-compat"!==i._config.bundlePolicy&&(s+="a=group:BUNDLE "+i.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),s+="a=ice-options:trickle\r\n",i.transceivers.forEach((function(e,t){s+=ri(e,e.localCapabilities,"offer",e.stream,i._dtlsRole),s+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===i.iceGatheringState||0!==t&&i.usingBundle||(e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1,s+="a="+ni.writeCandidate(e)+"\r\n"})),"completed"===e.iceGatherer.state&&(s+="a=end-of-candidates\r\n"))}));var a=new e.RTCSessionDescription({type:"offer",sdp:s});return Promise.resolve(a)},r.prototype.createAnswer=function(){var i=this;if(i._isClosed)return Promise.reject(ci("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==i.signalingState&&"have-local-pranswer"!==i.signalingState)return Promise.reject(ci("InvalidStateError","Can not call createAnswer in signalingState "+i.signalingState));var n=ni.writeSessionBoilerplate(i._sdpSessionId,i._sdpSessionVersion++);i.usingBundle&&(n+="a=group:BUNDLE "+i.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),n+="a=ice-options:trickle\r\n";var r=ni.getMediaSections(i._remoteDescription.sdp).length;i.transceivers.forEach((function(e,o){if(!(o+1>r)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?n+="m=application 0 DTLS/SCTP 5000\r\n":n+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?n+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(n+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(n+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var s;e.stream&&("audio"===e.kind?s=e.stream.getAudioTracks()[0]:"video"===e.kind&&(s=e.stream.getVideoTracks()[0]),s&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1}));var a=oi(e.localCapabilities,e.remoteCapabilities);!a.codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,n+=ri(e,a,"answer",e.stream,i._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(n+="a=rtcp-rsize\r\n")}}));var o=new e.RTCSessionDescription({type:"answer",sdp:n});return Promise.resolve(o)},r.prototype.addIceCandidate=function(e){var t,i=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(n,r){if(!i._remoteDescription)return r(ci("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var o=e.sdpMLineIndex;if(e.sdpMid)for(var s=0;s<i.transceivers.length;s++)if(i.transceivers[s].mid===e.sdpMid){o=s;break}var a=i.transceivers[o];if(!a)return r(ci("OperationError","Can not add ICE candidate"));if(a.rejected)return n();var c=Object.keys(e.candidate).length>0?ni.parseCandidate(e.candidate):{};if("tcp"===c.protocol&&(0===c.port||9===c.port))return n();if(c.component&&1!==c.component)return n();if((0===o||o>0&&a.iceTransport!==i.transceivers[0].iceTransport)&&!ai(a.iceTransport,c))return r(ci("OperationError","Can not add ICE candidate"));var u=e.candidate.trim();0===u.indexOf("a=")&&(u=u.substr(2)),(t=ni.getMediaSections(i._remoteDescription.sdp))[o]+="a="+(c.type?u:"end-of-candidates")+"\r\n",i._remoteDescription.sdp=ni.getDescription(i._remoteDescription.sdp)+t.join("")}else for(var d=0;d<i.transceivers.length&&(i.transceivers[d].rejected||(i.transceivers[d].iceTransport.addRemoteCandidate({}),(t=ni.getMediaSections(i._remoteDescription.sdp))[d]+="a=end-of-candidates\r\n",i._remoteDescription.sdp=ni.getDescription(i._remoteDescription.sdp)+t.join(""),!i.usingBundle));d++);n()}))},r.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var i=null;if(this.transceivers.forEach((function(e){e.rtpSender&&e.rtpSender.track===t?i=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(i=e.rtpReceiver)})),!i)throw ci("InvalidAccessError","Invalid selector.");return i.getStats()}var n=[];return this.transceivers.forEach((function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(t){e[t]&&n.push(e[t].getStats())}))})),Promise.all(n).then((function(e){var t=new Map;return e.forEach((function(e){e.forEach((function(e){t.set(e.id,e)}))})),t}))},["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(t){var i=e[t];if(i&&i.prototype&&i.prototype.getStats){var n=i.prototype.getStats;i.prototype.getStats=function(){return n.apply(this).then((function(e){var t=new Map;return Object.keys(e).forEach((function(i){var n;e[i].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(n=e[i]).type]||n.type,t.set(i,e[i])})),t}))}}}));var o=["createOffer","createAnswer"];return o.forEach((function(e){var t=r.prototype[e];r.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"==typeof e[0]&&e[0].apply(null,[t])}),(function(t){"function"==typeof e[1]&&e[1].apply(null,[t])})):t.apply(this,arguments)}})),(o=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(e){var t=r.prototype[e];r.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)}),(function(t){"function"==typeof e[2]&&e[2].apply(null,[t])})):t.apply(this,arguments)}})),["getStats"].forEach((function(e){var t=r.prototype[e];r.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)})):t.apply(this,arguments)}})),r}(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=function(e,t){let i=!1;return(e=JSON.parse(JSON.stringify(e))).filter(e=>{if(e&&(e.urls||e.url)){let t=e.urls||e.url;e.url&&!e.urls&&Bt("RTCIceServer.url","RTCIceServer.urls");const n="string"==typeof t;return n&&(t=[t]),t=t.filter(e=>{if(0===e.indexOf("stun:"))return!1;const t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!i?(i=!0,!0):t&&!i}),delete e.url,e.urls=n?t[0]:t,!!t.length}})}(e.iceServers,t.version),jt("ICE servers after filtering:",e.iceServers)),new i(e)},e.RTCPeerConnection.prototype=i.prototype}function hi(e){e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)&&(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}var pi=Object.freeze({__proto__:null,shimPeerConnection:li,shimReplaceTrack:hi,shimGetUserMedia:ui,shimGetDisplayMedia:di});function fi(e,t){const i=e&&e.navigator,n=e&&e.MediaStreamTrack;if(i.getUserMedia=function(e,t,n){Bt("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(e).then(t,n)},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const e=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])},t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(i){return"object"==typeof i&&"object"==typeof i.audio&&(i=JSON.parse(JSON.stringify(i)),e(i.audio,"autoGainControl","mozAutoGainControl"),e(i.audio,"noiseSuppression","mozNoiseSuppression")),t(i)},n&&n.prototype.getSettings){const t=n.prototype.getSettings;n.prototype.getSettings=function(){const i=t.apply(this,arguments);return e(i,"mozAutoGainControl","autoGainControl"),e(i,"mozNoiseSuppression","noiseSuppression"),i}}if(n&&n.prototype.applyConstraints){const t=n.prototype.applyConstraints;n.prototype.applyConstraints=function(i){return"audio"===this.kind&&"object"==typeof i&&(i=JSON.parse(JSON.stringify(i)),e(i,"autoGainControl","mozAutoGainControl"),e(i,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[i])}}}}function mi(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function vi(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t]}));const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,r,o]=arguments;return n.apply(this,[e||null]).then(e=>{if(t.version<53&&!r)try{e.forEach(e=>{e.type=i[e.type]||e.type})}catch(t){if("TypeError"!==t.name)throw t;e.forEach((t,n)=>{e.set(n,Object.assign({},t,{type:i[t.type]||t.type}))})}return e}).then(r,o)}}function gi(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function _i(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),Ut(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function yi(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){Bt("removeStream","removeTrack"),this.getSenders().forEach(t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)})})}function Si(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function Ti(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],i=e&&"sendEncodings"in e;i&&e.sendEncodings.forEach(e=>{if("rid"in e&&!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const n=t.apply(this,arguments);if(i){const{sender:t}=n,i=t.getParameters();(!("encodings"in i)||1===i.encodings.length&&0===Object.keys(i.encodings[0]).length)&&(i.encodings=e.sendEncodings,t.sendEncodings=e.sendEncodings,this.setParametersPromises.push(t.setParameters(i).then(()=>{delete t.sendEncodings}).catch(()=>{delete t.sendEncodings})))}return n})}function Ei(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function bi(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function Ri(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}var Ii=Object.freeze({__proto__:null,shimOnTrack:mi,shimPeerConnection:vi,shimSenderGetStats:gi,shimReceiverGetStats:_i,shimRemoveStream:yi,shimRTCDataChannel:Si,shimAddTransceiver:Ti,shimGetParameters:Ei,shimCreateOffer:bi,shimCreateAnswer:Ri,shimGetUserMedia:fi,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===i.video?i.video={mediaSource:t}:i.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(i)})}});function ki(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach(i=>t.call(this,i,e)),e.getVideoTracks().forEach(i=>t.call(this,i,e))},e.RTCPeerConnection.prototype.addTrack=function(e,...i){return i&&i.forEach(e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]}),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const i=e.getTracks();this.getSenders().forEach(e=>{i.includes(e.track)&&this.removeTrack(e)})})}}function wi(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach(e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)})})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const i=new Event("addstream");i.stream=t,e.dispatchEvent(i)})}),t.apply(e,arguments)}}}function Ci(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,i=t.createOffer,n=t.createAnswer,r=t.setLocalDescription,o=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(e,t){const n=arguments.length>=2?arguments[2]:arguments[0],r=i.apply(this,[n]);return t?(r.then(e,t),Promise.resolve()):r},t.createAnswer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],r=n.apply(this,[i]);return t?(r.then(e,t),Promise.resolve()):r};let a=function(e,t,i){const n=r.apply(this,[e]);return i?(n.then(t,i),Promise.resolve()):n};t.setLocalDescription=a,a=function(e,t,i){const n=o.apply(this,[e]);return i?(n.then(t,i),Promise.resolve()):n},t.setRemoteDescription=a,a=function(e,t,i){const n=s.apply(this,[e]);return i?(n.then(t,i),Promise.resolve()):n},t.addIceCandidate=a}function Ai(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>i(Di(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,i,n){t.mediaDevices.getUserMedia(e).then(i,n)}.bind(t))}function Di(e){return e&&void 0!==e.video?Object.assign({},e,{video:Gt(e.video)}):e}function Oi(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,i){if(e&&e.iceServers){const t=[];for(let i=0;i<e.iceServers.length;i++){let n=e.iceServers[i];!n.hasOwnProperty("urls")&&n.hasOwnProperty("url")?(Bt("RTCIceServer.url","RTCIceServer.urls"),n=JSON.parse(JSON.stringify(n)),n.urls=n.url,delete n.url,t.push(n)):t.push(e.iceServers[i])}e.iceServers=t}return new t(e,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function Pi(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function xi(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find(e=>"audio"===e.receiver.track.kind);!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const i=this.getTransceivers().find(e=>"video"===e.receiver.track.kind);!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveVideo||i||this.addTransceiver("video")}return t.apply(this,arguments)}}function Mi(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var Li=Object.freeze({__proto__:null,shimLocalStreamsAPI:ki,shimRemoteStreamsAPI:wi,shimCallbacksAPI:Ci,shimGetUserMedia:Ai,shimConstraints:Di,shimRTCIceServerUrls:Oi,shimTrackEventTransceiver:Pi,shimCreateOfferLegacy:xi,shimAudioContext:Mi});function Ni(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const i=new t(e),n=ni.parseCandidate(e.candidate),r=Object.assign(i,n);return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,Ut(e,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t))}function Ui(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const i=function(e){if(!e||!e.sdp)return!1;const t=ni.splitSections(e.sdp);return t.shift(),t.some(e=>{const t=ni.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})},n=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const i=parseInt(t[1],10);return i!=i?-1:i},r=function(e){let i=65536;return"firefox"===t.browser&&(i=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),i},o=function(e,i){let n=65536;"firefox"===t.browser&&57===t.version&&(n=65535);const r=ni.matchPrefix(e.sdp,"a=max-message-size:");return r.length>0?n=parseInt(r[0].substr(19),10):"firefox"===t.browser&&-1!==i&&(n=2147483637),n},s=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){const e=n(arguments[0]),t=r(e),i=o(arguments[0],e);let s;s=0===t&&0===i?Number.POSITIVE_INFINITY:0===t||0===i?Math.max(t,i):Math.min(t,i);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>s}),this._sctp=a}return s.apply(this,arguments)}}function Vi(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const i=e.send;e.send=function(){const n=arguments[0],r=n.length||n.size||n.byteLength;if("open"===e.readyState&&t.sctp&&r>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return i.apply(e,arguments)}}const i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=i.apply(this,arguments);return t(e,this),e},Ut(e,"datachannel",e=>(t(e.channel,e.target),e))}function Fi(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{const i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const i=new Event("connectionstatechange",e);t.dispatchEvent(i)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}function ji(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const i=t.sdp.split("\n").filter(e=>"a=extmap-allow-mixed"!==e.trim()).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:i}):t.sdp=i}return i.apply(this,arguments)}}function Bi(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.addIceCandidate;i&&0!==i.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}var Hi=Object.freeze({__proto__:null,shimRTCIceCandidate:Ni,shimMaxMessageSize:Ui,shimSendThrowTypeError:Vi,shimConnectionState:Fi,removeExtmapAllowMixed:ji,shimAddIceCandidateNullOrEmpty:Bi});!function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const i=jt,n=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;const{navigator:i}=e;if(i.mozGetUserMedia)t.browser="firefox",t.version=Nt(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)t.browser="chrome",t.version=Nt(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(i.mediaDevices&&i.userAgent.match(/Edge\/(\d+).(\d+)$/))t.browser="edge",t.version=Nt(i.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=Nt(i.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}(e),r={browserDetails:n,commonShim:Hi,extractVersion:Nt,disableLog:Vt,disableWarnings:Ft};switch(n.browser){case"chrome":if(!ii||!ei||!t.shimChrome)return i("Chrome shim is not included in this adapter release."),r;if(null===n.version)return i("Chrome shim can not determine version, not shimming."),r;i("adapter.js shimming chrome."),r.browserShim=ii,Bi(e,n),Wt(e,n),zt(e),ei(e,n),$t(e),Zt(e,n),Kt(e),Yt(e),Qt(e),ti(e,n),Ni(e),Fi(e),Ui(e,n),Vi(e),ji(e,n);break;case"firefox":if(!Ii||!vi||!t.shimFirefox)return i("Firefox shim is not included in this adapter release."),r;i("adapter.js shimming firefox."),r.browserShim=Ii,Bi(e,n),fi(e,n),vi(e,n),mi(e),yi(e),gi(e),_i(e),Si(e),Ti(e),Ei(e),bi(e),Ri(e),Ni(e),Fi(e),Ui(e,n),Vi(e);break;case"edge":if(!pi||!li||!t.shimEdge)return i("MS edge shim is not included in this adapter release."),r;i("adapter.js shimming edge."),r.browserShim=pi,ui(e),di(e),li(e,n),hi(e),Ui(e,n),Vi(e);break;case"safari":if(!Li||!t.shimSafari)return i("Safari shim is not included in this adapter release."),r;i("adapter.js shimming safari."),r.browserShim=Li,Bi(e,n),Oi(e),xi(e),Ci(e),ki(e),wi(e),Pi(e),Ai(e),Mi(e),Ni(e),Ui(e,n),Vi(e),ji(e,n);break;default:i("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window});var Gi=[].slice,qi={},Ji=function(e,t,i){if(!(t in qi)){for(var n=[],r=0;r<t;r++)n[r]="a["+r+"]";qi[t]=Function("C,a","return new C("+n.join(",")+")")}return qi[t](e,i)},Wi=Function.bind||function(e){var t=_t(this),i=Gi.call(arguments,1),n=function(){var r=i.concat(Gi.call(arguments));return this instanceof n?Ji(t,r.length,r):t.apply(e,r)};return G(t.prototype)&&(n.prototype=t.prototype),n};gt({target:"Function",proto:!0},{bind:Wi});var zi=Ie.f,$i=Function.prototype,Ki=$i.toString,Yi=/^\s*function ([^ (]*)/;P&&!("name"in $i)&&zi($i,"name",{configurable:!0,get:function(){try{return Ki.call(this).match(Yi)[1]}catch(e){return""}}});var Qi,Xi=function(e){if(ee(e))throw TypeError("Cannot convert a Symbol value to a string");return String(e)},Zi=function(){var e=be(this),t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.sticky&&(t+="y"),t},en=function(e,t){return RegExp(e,t)},tn={UNSUPPORTED_Y:O((function(){var e=en("a","y");return e.lastIndex=2,null!=e.exec("abcd")})),BROKEN_CARET:O((function(){var e=en("^r","gy");return e.lastIndex=2,null!=e.exec("str")}))},nn=Object.keys||function(e){return it(e,nt)},rn=P?Object.defineProperties:function(e,t){be(e);for(var i,n=nn(t),r=n.length,o=0;r>o;)Ie.f(e,i=n[o++],t[i]);return e},on=J("document","documentElement"),sn=Le("IE_PROTO"),an=function(){},cn=function(e){return"<script>"+e+"<\/script>"},un=function(e){e.write(cn("")),e.close();var t=e.parentWindow.Object;return e=null,t},dn=function(){try{Qi=new ActiveXObject("htmlfile")}catch(e){}dn=document.domain&&Qi?un(Qi):function(){var e,t=ye("iframe");if(t.style)return t.style.display="none",on.appendChild(t),t.src=String("javascript:"),(e=t.contentWindow.document).open(),e.write(cn("document.F=Object")),e.close(),e.F}()||un(Qi);for(var e=nt.length;e--;)delete dn.prototype[nt[e]];return dn()};Ne[sn]=!0;var ln=Object.create||function(e,t){var i;return null!==e?(an.prototype=be(e),i=new an,an.prototype=null,i[sn]=e):i=dn(),void 0===t?i:rn(i,t)},hn=O((function(){var e=RegExp(".","string".charAt(0));return!(e.dotAll&&e.exec("\n")&&"s"===e.flags)})),pn=O((function(){var e=RegExp("(?<a>b)","string".charAt(5));return"b"!==e.exec("b").groups.a||"bc"!=="b".replace(e,"$<a>c")})),fn=Ge.get,mn=RegExp.prototype.exec,vn=ne("native-string-replace",String.prototype.replace),gn=mn,_n=function(){var e=/a/,t=/b*/g;return mn.call(e,"a"),mn.call(t,"a"),0!==e.lastIndex||0!==t.lastIndex}(),yn=tn.UNSUPPORTED_Y||tn.BROKEN_CARET,Sn=void 0!==/()??/.exec("")[1];(_n||Sn||yn||hn||pn)&&(gn=function(e){var t,i,n,r,o,s,a,c=this,u=fn(c),d=Xi(e),l=u.raw;if(l)return l.lastIndex=c.lastIndex,t=gn.call(l,d),c.lastIndex=l.lastIndex,t;var h=u.groups,p=yn&&c.sticky,f=Zi.call(c),m=c.source,v=0,g=d;if(p&&(-1===(f=f.replace("y","")).indexOf("g")&&(f+="g"),g=d.slice(c.lastIndex),c.lastIndex>0&&(!c.multiline||c.multiline&&"\n"!==d.charAt(c.lastIndex-1))&&(m="(?: "+m+")",g=" "+g,v++),i=new RegExp("^(?:"+m+")",f)),Sn&&(i=new RegExp("^"+m+"$(?!\\s)",f)),_n&&(n=c.lastIndex),r=mn.call(p?i:c,g),p?r?(r.input=r.input.slice(v),r[0]=r[0].slice(v),r.index=c.lastIndex,c.lastIndex+=r[0].length):c.lastIndex=0:_n&&r&&(c.lastIndex=c.global?r.index+r[0].length:n),Sn&&r&&r.length>1&&vn.call(r[0],i,(function(){for(o=1;o<arguments.length-2;o++)void 0===arguments[o]&&(r[o]=void 0)})),r&&h)for(r.groups=s=ln(null),o=0;o<h.length;o++)s[(a=h[o])[0]]=r[a[1]];return r});var Tn=gn;gt({target:"RegExp",proto:!0,forced:/./.exec!==Tn},{exec:Tn});var En="\t\n\v\f\r                　\u2028\u2029\ufeff",bn="["+En+"]",Rn=RegExp("^"+bn+bn+"*"),In=RegExp(bn+bn+"*$"),kn=function(e){return function(t){var i=Xi(B(t));return 1&e&&(i=i.replace(Rn,"")),2&e&&(i=i.replace(In,"")),i}},wn={start:kn(1),end:kn(2),trim:kn(3)},Cn=wn.trim,An=D.parseFloat,Dn=1/An(En+"-0")!=-1/0?function(e){var t=Cn(Xi(e)),i=An(t);return 0===i&&"-"==t.charAt(0)?-0:i}:An;gt({global:!0,forced:parseFloat!=Dn},{parseFloat:Dn});var On=pe("species"),Pn=RegExp.prototype,xn=function(e,t,i,n){var r=pe(e),o=!O((function(){var t={};return t[r]=function(){return 7},7!=""[e](t)})),s=o&&!O((function(){var t=!1,i=/a/;return"split"===e&&((i={}).constructor={},i.constructor[On]=function(){return i},i.flags="",i[r]=/./[r]),i.exec=function(){return t=!0,null},i[r](""),!t}));if(!o||!s||i){var a=/./[r],c=t(r,""[e],(function(e,t,i,n,r){var s=t.exec;return s===Tn||s===Pn.exec?o&&!r?{done:!0,value:a.call(t,i,n)}:{done:!0,value:e.call(i,t,n)}:{done:!1}}));qe(String.prototype,e,c[0]),qe(Pn,r,c[1])}n&&ke(Pn[r],"sham",!0)},Mn=function(e){return function(t,i){var n,r,o=Xi(B(t)),s=ze(i),a=o.length;return s<0||s>=a?e?"":void 0:(n=o.charCodeAt(s))<55296||n>56319||s+1===a||(r=o.charCodeAt(s+1))<56320||r>57343?e?o.charAt(s):n:e?o.slice(s,s+2):r-56320+(n-55296<<10)+65536}},Ln={codeAt:Mn(!1),charAt:Mn(!0)},Nn=Ln.charAt,Un=function(e,t,i){return t+(i?Nn(e,t).length:1)},Vn=function(e,t){var i=e.exec;if("function"==typeof i){var n=i.call(e,t);if("object"!=typeof n)throw TypeError("RegExp exec method returned something other than an Object or null");return n}if("RegExp"!==V(e))throw TypeError("RegExp#exec called on incompatible receiver");return Tn.call(e,t)};xn("match",(function(e,t,i){return[function(t){var i=B(this),n=null==t?void 0:t[e];return void 0!==n?n.call(t,i):new RegExp(t)[e](Xi(i))},function(e){var n=be(this),r=Xi(e),o=i(t,n,r);if(o.done)return o.value;if(!n.global)return Vn(n,r);var s=n.unicode;n.lastIndex=0;for(var a,c=[],u=0;null!==(a=Vn(n,r));){var d=Xi(a[0]);c[u]=d,""===d&&(n.lastIndex=Un(r,Ke(n.lastIndex),s)),u++}return 0===u?null:c}]}));var Fn=pe("unscopables"),jn=Array.prototype;null==jn[Fn]&&Ie.f(jn,Fn,{configurable:!0,value:ln(null)});var Bn,Hn,Gn,qn=function(e){jn[Fn][e]=!0},Jn={},Wn=!O((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),zn=Le("IE_PROTO"),$n=Object.prototype,Kn=Wn?Object.getPrototypeOf:function(e){return e=re(e),se(e,zn)?e[zn]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?$n:null},Yn=pe("iterator"),Qn=!1;[].keys&&("next"in(Gn=[].keys())?(Hn=Kn(Kn(Gn)))!==Object.prototype&&(Bn=Hn):Qn=!0),(null==Bn||O((function(){var e={};return Bn[Yn].call(e)!==e})))&&(Bn={}),se(Bn,Yn)||ke(Bn,Yn,(function(){return this}));var Xn={IteratorPrototype:Bn,BUGGY_SAFARI_ITERATORS:Qn},Zn=Ie.f,er=pe("toStringTag"),tr=function(e,t,i){e&&!se(e=i?e:e.prototype,er)&&Zn(e,er,{configurable:!0,value:t})},ir=Xn.IteratorPrototype,nr=function(){return this},rr=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,i={};try{(e=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set).call(i,[]),t=i instanceof Array}catch(e){}return function(i,n){return be(i),function(e){if(!G(e)&&null!==e)throw TypeError("Can't set "+String(e)+" as a prototype")}(n),t?e.call(i,n):i.__proto__=n,i}}():void 0),or=Xn.IteratorPrototype,sr=Xn.BUGGY_SAFARI_ITERATORS,ar=pe("iterator"),cr=function(){return this},ur=function(e,t,i,n,r,o,s){!function(e,t,i){var n=t+" Iterator";e.prototype=ln(ir,{next:N(1,i)}),tr(e,n,!1),Jn[n]=nr}(i,t,n);var a,c,u,d=function(e){if(e===r&&m)return m;if(!sr&&e in p)return p[e];switch(e){case"keys":case"values":case"entries":return function(){return new i(this,e)}}return function(){return new i(this)}},l=t+" Iterator",h=!1,p=e.prototype,f=p[ar]||p["@@iterator"]||r&&p[r],m=!sr&&f||d(r),v="Array"==t&&p.entries||f;if(v&&(a=Kn(v.call(new e)),or!==Object.prototype&&a.next&&(Kn(a)!==or&&(rr?rr(a,or):"function"!=typeof a[ar]&&ke(a,ar,cr)),tr(a,l,!0))),"values"==r&&f&&"values"!==f.name&&(h=!0,m=function(){return f.call(this)}),p[ar]!==m&&ke(p,ar,m),Jn[t]=m,r)if(c={values:d("values"),keys:o?m:d("keys"),entries:d("entries")},s)for(u in c)(sr||h||!(u in p))&&qe(p,u,c[u]);else gt({target:t,proto:!0,forced:sr||h},c);return c},dr=Ge.set,lr=Ge.getterFor("Array Iterator"),hr=ur(Array,"Array",(function(e,t){dr(this,{type:"Array Iterator",target:H(e),index:0,kind:t})}),(function(){var e=lr(this),t=e.target,i=e.kind,n=e.index++;return!t||n>=t.length?(e.target=void 0,{value:void 0,done:!0}):"keys"==i?{value:n,done:!1}:"values"==i?{value:t[n],done:!1}:{value:[n,t[n]],done:!1}}),"values");Jn.Arguments=Jn.Array,qn("keys"),qn("values"),qn("entries");var pr=ot.f,fr={}.toString,mr="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],vr={f:function(e){return mr&&"[object Window]"==fr.call(e)?function(e){try{return pr(e)}catch(e){return mr.slice()}}(e):pr(H(e))}},gr=!O((function(){return Object.isExtensible(Object.preventExtensions({}))})),_r=k((function(e){var t=Ie.f,i=!1,n=ue("meta"),r=0,o=Object.isExtensible||function(){return!0},s=function(e){t(e,n,{value:{objectID:"O"+r++,weakData:{}}})},a=e.exports={enable:function(){a.enable=function(){},i=!0;var e=ot.f,t=[].splice,r={};r[n]=1,e(r).length&&(ot.f=function(i){for(var r=e(i),o=0,s=r.length;o<s;o++)if(r[o]===n){t.call(r,o,1);break}return r},gt({target:"Object",stat:!0,forced:!0},{getOwnPropertyNames:vr.f}))},fastKey:function(e,t){if(!G(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!se(e,n)){if(!o(e))return"F";if(!t)return"E";s(e)}return e[n].objectID},getWeakData:function(e,t){if(!se(e,n)){if(!o(e))return!0;if(!t)return!1;s(e)}return e[n].weakData},onFreeze:function(e){return gr&&i&&o(e)&&!se(e,n)&&s(e),e}};Ne[n]=!0})),yr=(_r.enable,_r.fastKey,_r.getWeakData,_r.onFreeze,pe("iterator")),Sr=Array.prototype,Tr={};Tr[pe("toStringTag")]="z";var Er="[object z]"===String(Tr),br=pe("toStringTag"),Rr="Arguments"==V(function(){return arguments}()),Ir=Er?V:function(e){var t,i,n;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(i=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),br))?i:Rr?V(t):"Object"==(n=V(t))&&"function"==typeof t.callee?"Arguments":n},kr=pe("iterator"),wr=function(e){var t=e.return;if(void 0!==t)return be(t.call(e)).value},Cr=function(e,t){this.stopped=e,this.result=t},Ar=function(e,t,i){var n,r,o,s,a,c,u,d,l=i&&i.that,h=!(!i||!i.AS_ENTRIES),p=!(!i||!i.IS_ITERATOR),f=!(!i||!i.INTERRUPTED),m=yt(t,l,1+h+f),v=function(e){return n&&wr(n),new Cr(!0,e)},g=function(e){return h?(be(e),f?m(e[0],e[1],v):m(e[0],e[1])):f?m(e,v):m(e)};if(p)n=e;else{if("function"!=typeof(r=function(e){if(null!=e)return e[kr]||e["@@iterator"]||Jn[Ir(e)]}(e)))throw TypeError("Target is not iterable");if(void 0!==(d=r)&&(Jn.Array===d||Sr[yr]===d)){for(o=0,s=Ke(e.length);s>o;o++)if((a=g(e[o]))&&a instanceof Cr)return a;return new Cr(!1)}n=r.call(e)}for(c=n.next;!(u=c.call(n)).done;){try{a=g(u.value)}catch(e){throw wr(n),e}if("object"==typeof a&&a&&a instanceof Cr)return a}return new Cr(!1)},Dr=function(e,t,i){if(!(e instanceof t))throw TypeError("Incorrect "+(i?i+" ":"")+"invocation");return e},Or=pe("iterator"),Pr=!1;try{var xr=0,Mr={next:function(){return{done:!!xr++}},return:function(){Pr=!0}};Mr[Or]=function(){return this},Array.from(Mr,(function(){throw 2}))}catch(e){}var Lr=function(e,t){if(!t&&!Pr)return!1;var i=!1;try{var n={};n[Or]=function(){return{next:function(){return{done:i=!0}}}},e(n)}catch(e){}return i},Nr=function(e,t,i){var n,r;return rr&&"function"==typeof(n=t.constructor)&&n!==i&&G(r=n.prototype)&&r!==i.prototype&&rr(e,r),e},Ur=function(e,t,i){for(var n in t)qe(e,n,t[n],i);return e},Vr=pe("species"),Fr=function(e){var t=J(e),i=Ie.f;P&&t&&!t[Vr]&&i(t,Vr,{configurable:!0,get:function(){return this}})},jr=Ie.f,Br=_r.fastKey,Hr=Ge.set,Gr=Ge.getterFor,qr=(function(e,t,i){var n=-1!==e.indexOf("Map"),r=-1!==e.indexOf("Weak"),o=n?"set":"add",s=D.Map,a=s&&s.prototype,c=s,u={},d=function(e){var t=a[e];qe(a,e,"add"==e?function(e){return t.call(this,0===e?0:e),this}:"delete"==e?function(e){return!(r&&!G(e))&&t.call(this,0===e?0:e)}:"get"==e?function(e){return r&&!G(e)?void 0:t.call(this,0===e?0:e)}:"has"==e?function(e){return!(r&&!G(e))&&t.call(this,0===e?0:e)}:function(e,i){return t.call(this,0===e?0:e,i),this})};if(mt(e,"function"!=typeof s||!(r||a.forEach&&!O((function(){(new s).entries().next()})))))c=i.getConstructor(t,e,n,o),_r.enable();else if(mt(e,!0)){var l=new c,h=l[o](r?{}:-0,1)!=l,p=O((function(){l.has(1)})),f=Lr((function(e){new s(e)})),m=!r&&O((function(){for(var e=new s,t=5;t--;)e[o](t,t);return!e.has(-0)}));f||((c=t((function(t,i){Dr(t,c,e);var r=Nr(new s,t,c);return null!=i&&Ar(i,r[o],{that:r,AS_ENTRIES:n}),r}))).prototype=a,a.constructor=c),(p||m)&&(d("delete"),d("has"),n&&d("get")),(m||h)&&d(o),r&&a.clear&&delete a.clear}u.Map=c,gt({global:!0,forced:c!=s},u),tr(c,e),r||i.setStrong(c,e,n)}("Map",(function(e){return function(){return e(this,arguments.length?arguments[0]:void 0)}}),{getConstructor:function(e,t,i,n){var r=e((function(e,o){Dr(e,r,t),Hr(e,{type:t,index:ln(null),first:void 0,last:void 0,size:0}),P||(e.size=0),null!=o&&Ar(o,e[n],{that:e,AS_ENTRIES:i})})),o=Gr(t),s=function(e,t,i){var n,r,s=o(e),c=a(e,t);return c?c.value=i:(s.last=c={index:r=Br(t,!0),key:t,value:i,previous:n=s.last,next:void 0,removed:!1},s.first||(s.first=c),n&&(n.next=c),P?s.size++:e.size++,"F"!==r&&(s.index[r]=c)),e},a=function(e,t){var i,n=o(e),r=Br(t);if("F"!==r)return n.index[r];for(i=n.first;i;i=i.next)if(i.key==t)return i};return Ur(r.prototype,{clear:function(){for(var e=o(this),t=e.index,i=e.first;i;)i.removed=!0,i.previous&&(i.previous=i.previous.next=void 0),delete t[i.index],i=i.next;e.first=e.last=void 0,P?e.size=0:this.size=0},delete:function(e){var t=o(this),i=a(this,e);if(i){var n=i.next,r=i.previous;delete t.index[i.index],i.removed=!0,r&&(r.next=n),n&&(n.previous=r),t.first==i&&(t.first=n),t.last==i&&(t.last=r),P?t.size--:this.size--}return!!i},forEach:function(e){for(var t,i=o(this),n=yt(e,arguments.length>1?arguments[1]:void 0,3);t=t?t.next:i.first;)for(n(t.value,t.key,this);t&&t.removed;)t=t.previous},has:function(e){return!!a(this,e)}}),Ur(r.prototype,i?{get:function(e){var t=a(this,e);return t&&t.value},set:function(e,t){return s(this,0===e?0:e,t)}}:{add:function(e){return s(this,e=0===e?0:e,e)}}),P&&jr(r.prototype,"size",{get:function(){return o(this).size}}),r},setStrong:function(e,t,i){var n=t+" Iterator",r=Gr(t),o=Gr(n);ur(e,t,(function(e,t){Hr(this,{type:n,target:e,state:r(e),kind:t,last:void 0})}),(function(){for(var e=o(this),t=e.kind,i=e.last;i&&i.removed;)i=i.previous;return e.target&&(e.last=i=i?i.next:e.state.first)?"keys"==t?{value:i.key,done:!1}:"values"==t?{value:i.value,done:!1}:{value:[i.key,i.value],done:!1}:(e.target=void 0,{value:void 0,done:!0})}),i?"entries":"values",!i,!0),Fr(t)}}),Er?{}.toString:function(){return"[object "+Ir(this)+"]"});Er||qe(Object.prototype,"toString",qr,{unsafe:!0});var Jr=Ln.charAt,Wr=Ge.set,zr=Ge.getterFor("String Iterator");ur(String,"String",(function(e){Wr(this,{type:"String Iterator",string:Xi(e),index:0})}),(function(){var e,t=zr(this),i=t.string,n=t.index;return n>=i.length?{value:void 0,done:!0}:(e=Jr(i,n),t.index+=e.length,{value:e,done:!1})}));var $r={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},Kr=pe("iterator"),Yr=pe("toStringTag"),Qr=hr.values;for(var Xr in $r){var Zr=D[Xr],eo=Zr&&Zr.prototype;if(eo){if(eo[Kr]!==Qr)try{ke(eo,Kr,Qr)}catch(e){eo[Kr]=Qr}if(eo[Yr]||ke(eo,Yr,Xr),$r[Xr])for(var to in hr)if(eo[to]!==hr[to])try{ke(eo,to,hr[to])}catch(e){eo[to]=hr[to]}}}var io=Object.is||function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t};xn("search",(function(e,t,i){return[function(t){var i=B(this),n=null==t?void 0:t[e];return void 0!==n?n.call(t,i):new RegExp(t)[e](Xi(i))},function(e){var n=be(this),r=Xi(e),o=i(t,n,r);if(o.done)return o.value;var s=n.lastIndex;io(s,0)||(n.lastIndex=0);var a=Vn(n,r);return io(n.lastIndex,s)||(n.lastIndex=s),null===a?-1:a.index}]}));var no=pe("match"),ro=function(e){var t;return G(e)&&(void 0!==(t=e[no])?!!t:"RegExp"==V(e))},oo=Ie.f,so=ot.f,ao=Ge.enforce,co=pe("match"),uo=D.RegExp,lo=uo.prototype,ho=/^\?<[^\s\d!#%&*+<=>@^][^\s!#%&*+<=>@^]*>/,po=/a/g,fo=/a/g,mo=new uo(po)!==po,vo=tn.UNSUPPORTED_Y,go=P&&(!mo||vo||hn||pn||O((function(){return fo[co]=!1,uo(po)!=po||uo(fo)==fo||"/a/i"!=uo(po,"i")})));if(mt("RegExp",go)){for(var _o=function(e,t){var i,n,r,o,s,a,c=this instanceof _o,u=ro(e),d=void 0===t,l=[],h=e;if(!c&&u&&d&&e.constructor===_o)return e;if((u||e instanceof _o)&&(e=e.source,d&&(t="flags"in h?h.flags:Zi.call(h))),e=void 0===e?"":Xi(e),t=void 0===t?"":Xi(t),h=e,hn&&"dotAll"in po&&(n=!!t&&t.indexOf("s")>-1)&&(t=t.replace(/s/g,"")),i=t,vo&&"sticky"in po&&(r=!!t&&t.indexOf("y")>-1)&&(t=t.replace(/y/g,"")),pn&&(e=(o=function(e){for(var t,i=e.length,n=0,r="",o=[],s={},a=!1,c=!1,u=0,d="";n<=i;n++){if("\\"===(t=e.charAt(n)))t+=e.charAt(++n);else if("]"===t)a=!1;else if(!a)switch(!0){case"["===t:a=!0;break;case"("===t:ho.test(e.slice(n+1))&&(n+=2,c=!0),r+=t,u++;continue;case">"===t&&c:if(""===d||se(s,d))throw new SyntaxError("Invalid capture group name");s[d]=!0,o.push([d,u]),c=!1,d="";continue}c?d+=t:r+=t}return[r,o]}(e))[0],l=o[1]),s=Nr(uo(e,t),c?this:lo,_o),(n||r||l.length)&&(a=ao(s),n&&(a.dotAll=!0,a.raw=_o(function(e){for(var t,i=e.length,n=0,r="",o=!1;n<=i;n++)"\\"!==(t=e.charAt(n))?o||"."!==t?("["===t?o=!0:"]"===t&&(o=!1),r+=t):r+="[\\s\\S]":r+=t+e.charAt(++n);return r}(e),i)),r&&(a.sticky=!0),l.length&&(a.groups=l)),e!==h)try{ke(s,"source",""===h?"(?:)":h)}catch(e){}return s},yo=function(e){e in _o||oo(_o,e,{configurable:!0,get:function(){return uo[e]},set:function(t){uo[e]=t}})},So=so(uo),To=0;So.length>To;)yo(So[To++]);lo.constructor=_o,_o.prototype=lo,qe(D,"RegExp",_o)}Fr("RegExp");var Eo=RegExp.prototype,bo=Eo.toString,Ro=O((function(){return"/a/b"!=bo.call({source:"a",flags:"b"})})),Io="toString"!=bo.name;(Ro||Io)&&qe(RegExp.prototype,"toString",(function(){var e=be(this),t=Xi(e.source),i=e.flags;return"/"+t+"/"+Xi(void 0===i&&e instanceof RegExp&&!("flags"in Eo)?Zi.call(e):i)}),{unsafe:!0});var ko=function(e,t){var i=[][e];return!!i&&O((function(){i.call(null,t||function(){throw 1},1)}))},wo=et.indexOf,Co=[].indexOf,Ao=!!Co&&1/[1].indexOf(1,-0)<0,Do=ko("indexOf");gt({target:"Array",proto:!0,forced:Ao||!Do},{indexOf:function(e){return Ao?Co.apply(this,arguments)||0:wo(this,e,arguments.length>1?arguments[1]:void 0)}});var Oo=Math.floor,Po="".replace,xo=/\$([$&'`]|\d{1,2}|<[^>]*>)/g,Mo=/\$([$&'`]|\d{1,2})/g,Lo=function(e,t,i,n,r,o){var s=i+e.length,a=n.length,c=Mo;return void 0!==r&&(r=re(r),c=xo),Po.call(o,c,(function(o,c){var u;switch(c.charAt(0)){case"$":return"$";case"&":return e;case"`":return t.slice(0,i);case"'":return t.slice(s);case"<":u=r[c.slice(1,-1)];break;default:var d=+c;if(0===d)return o;if(d>a){var l=Oo(d/10);return 0===l?o:l<=a?void 0===n[l-1]?c.charAt(1):n[l-1]+c.charAt(1):o}u=n[d-1]}return void 0===u?"":u}))},No=pe("replace"),Uo=Math.max,Vo=Math.min,Fo="$0"==="a".replace(/./,"$0"),jo=!!/./[No]&&""===/./[No]("a","$0");xn("replace",(function(e,t,i){var n=jo?"$":"$0";return[function(e,i){var n=B(this),r=null==e?void 0:e[No];return void 0!==r?r.call(e,n,i):t.call(Xi(n),e,i)},function(e,r){var o=be(this),s=Xi(e);if("string"==typeof r&&-1===r.indexOf(n)&&-1===r.indexOf("$<")){var a=i(t,o,s,r);if(a.done)return a.value}var c="function"==typeof r;c||(r=Xi(r));var u=o.global;if(u){var d=o.unicode;o.lastIndex=0}for(var l=[];;){var h=Vn(o,s);if(null===h)break;if(l.push(h),!u)break;""===Xi(h[0])&&(o.lastIndex=Un(s,Ke(o.lastIndex),d))}for(var p,f="",m=0,v=0;v<l.length;v++){h=l[v];for(var g=Xi(h[0]),_=Uo(Vo(ze(h.index),s.length),0),y=[],S=1;S<h.length;S++)y.push(void 0===(p=h[S])?p:String(p));var T=h.groups;if(c){var E=[g].concat(y,_,s);void 0!==T&&E.push(T);var b=Xi(r.apply(void 0,E))}else b=Lo(g,s,_,y,T,r);_>=m&&(f+=s.slice(m,_)+b,m=_+g.length)}return f+s.slice(m)}]}),!!O((function(){var e=/./;return e.exec=function(){var e=[];return e.groups={a:"7"},e},"7"!=="".replace(e,"$<a>")}))||!Fo||jo);var Bo=O((function(){Kn(1)}));gt({target:"Object",stat:!0,forced:Bo,sham:!Wn},{getPrototypeOf:function(e){return Kn(re(e))}});var Ho=J("Reflect","apply"),Go=Function.apply,qo=!O((function(){Ho((function(){}))}));gt({target:"Reflect",stat:!0,forced:qo},{apply:function(e,t,i){return _t(e),be(i),Ho?Ho(e,t,i):Go.call(e,t,i)}});var Jo=function(e,t,i){var n=ve(t);n in e?Ie.f(e,n,N(0,i)):e[n]=i},Wo=pe("isConcatSpreadable"),zo=Q>=51||!O((function(){var e=[];return e[Wo]=!1,e.concat()[0]!==e})),$o=wt("concat"),Ko=function(e){if(!G(e))return!1;var t=e[Wo];return void 0!==t?!!t:St(e)};gt({target:"Array",proto:!0,forced:!zo||!$o},{concat:function(e){var t,i,n,r,o,s=re(this),a=Et(s,0),c=0;for(t=-1,n=arguments.length;t<n;t++)if(Ko(o=-1===t?s:arguments[t])){if(c+(r=Ke(o.length))>9007199254740991)throw TypeError("Maximum allowed index exceeded");for(i=0;i<r;i++,c++)i in o&&Jo(a,c,o[i])}else{if(c>=9007199254740991)throw TypeError("Maximum allowed index exceeded");Jo(a,c++,o)}return a.length=c,a}}),gt({target:"Date",stat:!0},{now:function(){return(new Date).getTime()}});var Yo=Date.prototype,Qo=Yo.toString,Xo=Yo.getTime;"Invalid Date"!=String(new Date(NaN))&&qe(Yo,"toString",(function(){var e=Xo.call(this);return e==e?Qo.call(this):"Invalid Date"}));var Zo=pe("species"),es=function(e,t){var i,n=be(e).constructor;return void 0===n||null==(i=be(n)[Zo])?t:_t(i)},ts=tn.UNSUPPORTED_Y,is=[].push,ns=Math.min;xn("split",(function(e,t,i){var n;return n="c"=="abbc".split(/(b)*/)[1]||4!="test".split(/(?:)/,-1).length||2!="ab".split(/(?:ab)*/).length||4!=".".split(/(.?)(.?)/).length||".".split(/()()/).length>1||"".split(/.?/).length?function(e,i){var n=Xi(B(this)),r=void 0===i?4294967295:i>>>0;if(0===r)return[];if(void 0===e)return[n];if(!ro(e))return t.call(n,e,r);for(var o,s,a,c=[],u=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(e.sticky?"y":""),d=0,l=new RegExp(e.source,u+"g");(o=Tn.call(l,n))&&!((s=l.lastIndex)>d&&(c.push(n.slice(d,o.index)),o.length>1&&o.index<n.length&&is.apply(c,o.slice(1)),a=o[0].length,d=s,c.length>=r));)l.lastIndex===o.index&&l.lastIndex++;return d===n.length?!a&&l.test("")||c.push(""):c.push(n.slice(d)),c.length>r?c.slice(0,r):c}:"0".split(void 0,0).length?function(e,i){return void 0===e&&0===i?[]:t.call(this,e,i)}:t,[function(t,i){var r=B(this),o=null==t?void 0:t[e];return void 0!==o?o.call(t,r,i):n.call(Xi(r),t,i)},function(e,r){var o=be(this),s=Xi(e),a=i(n,o,s,r,n!==t);if(a.done)return a.value;var c=es(o,RegExp),u=o.unicode,d=(o.ignoreCase?"i":"")+(o.multiline?"m":"")+(o.unicode?"u":"")+(ts?"g":"y"),l=new c(ts?"^(?:"+o.source+")":o,d),h=void 0===r?4294967295:r>>>0;if(0===h)return[];if(0===s.length)return null===Vn(l,s)?[s]:[];for(var p=0,f=0,m=[];f<s.length;){l.lastIndex=ts?0:f;var v,g=Vn(l,ts?s.slice(f):s);if(null===g||(v=ns(Ke(l.lastIndex+(ts?f:0)),s.length))===p)f=Un(s,f,u);else{if(m.push(s.slice(p,f)),m.length===h)return m;for(var _=1;_<=g.length-1;_++)if(m.push(g[_]),m.length===h)return m;f=p=v}}return m.push(s.slice(p)),m}]}),!!O((function(){var e=/(?:)/,t=e.exec;e.exec=function(){return t.apply(this,arguments)};var i="ab".split(e);return 2!==i.length||"a"!==i[0]||"b"!==i[1]})),ts);var rs=ot.f,os=Ee.f,ss=Ie.f,as=wn.trim,cs=D.Number,us=cs.prototype,ds="Number"==V(ln(us)),ls=function(e){if(ee(e))throw TypeError("Cannot convert a Symbol value to a number");var t,i,n,r,o,s,a,c,u=me(e,"number");if("string"==typeof u&&u.length>2)if(43===(t=(u=as(u)).charCodeAt(0))||45===t){if(88===(i=u.charCodeAt(2))||120===i)return NaN}else if(48===t){switch(u.charCodeAt(1)){case 66:case 98:n=2,r=49;break;case 79:case 111:n=8,r=55;break;default:return+u}for(s=(o=u.slice(2)).length,a=0;a<s;a++)if((c=o.charCodeAt(a))<48||c>r)return NaN;return parseInt(o,n)}return+u};if(mt("Number",!cs(" 0o1")||!cs("0b1")||cs("+0x1"))){for(var hs,ps=function(e){var t=arguments.length<1?0:e,i=this;return i instanceof ps&&(ds?O((function(){us.valueOf.call(i)})):"Number"!=V(i))?Nr(new cs(ls(t)),i,ps):ls(t)},fs=P?rs(cs):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger,fromString,range".split(","),ms=0;fs.length>ms;ms++)se(cs,hs=fs[ms])&&!se(ps,hs)&&ss(ps,hs,os(cs,hs));ps.prototype=us,us.constructor=ps,qe(D,"Number",ps)}var vs="",gs="5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV",_s="224d130c-7b5c-415b-aaa2-79c2eb5a6df2",ys="DISCONNECTED",Ss="CONNECTING",Ts="RECONNECTING",Es="CONNECTED",bs="publish",Rs="unpublish",Is="subscribe",ks="unsubscribe",ws="uplink-connection",Cs="uplink-reconnection",As="downlink-connection",Ds="downlink-reconnection",Os="setLocalDescription",Ps="setRemoteDescription",xs="iceConnectionState",Ms="stream-initialize",Ls="websocketConnectionState",Ns="websocketReconnectionState",Us="update-stream",Vs="recover-subscription",Fs="start-mix-transcode",js="stop-mix-transcode",Bs="player-error",Hs="unsubscribe",Gs="subscribe_change",qs="manual",Js="preset-layout",Ws="$PLACE_HOLDER_REMOTE$",zs=0,$s=4,Ks="string",Ys="number",Qs="boolean",Xs="object",Zs="audio",ea="video",ta="auxiliary",ia="add",na="remove",ra={unknown:0,wifi:1,"3g":2,"2g":3,"4g":4,wired:5},oa="https://schedule.rtc.qq.com/api/v1/config",sa="LocalStream",aa="RemoteStream",ca="https://web.sdk.qcloud.com/trtc/webrtc/doc/zh-cn/",ua={INVALID_PARAMETER:4096,INVALID_OPERATION:4097,NOT_SUPPORTED:4098,DEVICE_NOT_FOUND:4099,SIGNAL_CHANNEL_SETUP_FAILED:16385,SIGNAL_CHANNEL_ERROR:16386,ICE_TRANSPORT_ERROR:16387,JOIN_ROOM_FAILED:16388,CREATE_OFFER_FAILED:16389,SIGNAL_CHANNEL_RECONNECTION_FAILED:16390,UPLINK_RECONNECTION_FAILED:16391,DOWNLINK_RECONNECTION_FAILED:16392,CLIENT_BANNED:16448,SERVER_TIMEOUT:16449,SUBSCRIPTION_TIMEOUT:16450,PLAY_NOT_ALLOWED:16451,DEVICE_AUTO_RECOVER_FAILED:16452,START_PUBLISH_CDN_FAILED:16453,STOP_PUBLISH_CDN_FAILED:16454,START_MIX_TRANSCODE_FAILED:16455,STOP_MIX_TRANSCODE_FAILED:16456,NOT_SUPPORTED_H264:16457,SWITCH_ROLE_FAILED:16458,API_CALL_TIMEOUT:16459,UNKNOWN:65535},da=function(e){d(i,e);var t=g(i);function i(e){var n,r=e.message,o=e.code,a=void 0===o?ua.UNKNOWN:o,c=e.extraCode,u=void 0===c?0:c;return s(this,i),(n=t.call(this,r+" <".concat(function(e){for(var t in ua)if(ua[t]===e)return t;return"UNKNOWN"}(a)," 0x").concat(a.toString(16),">"))).code_=a,n.extraCode_=u,n.name="RtcError",n.message_=r,n}return c(i,[{key:"getCode",value:function(){return this.code_}},{key:"getExtraCode",value:function(){return this.extraCode_}}]),i}(m(Error)),la=function(e,t){return function(){for(var i=new Array(arguments.length),n=0;n<i.length;n++)i[n]=arguments[n];return e.apply(t,i)}},ha=Object.prototype.toString;function pa(e){return"[object Array]"===ha.call(e)}function fa(e){return void 0===e}function ma(e){return null!==e&&"object"==typeof e}function va(e){return"[object Function]"===ha.call(e)}function ga(e,t){if(null!=e)if("object"!=typeof e&&(e=[e]),pa(e))for(var i=0,n=e.length;i<n;i++)t.call(null,e[i],i,e);else for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.call(null,e[r],r,e)}var _a={isArray:pa,isArrayBuffer:function(e){return"[object ArrayBuffer]"===ha.call(e)},isBuffer:function(e){return null!==e&&!fa(e)&&null!==e.constructor&&!fa(e.constructor)&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)},isFormData:function(e){return"undefined"!=typeof FormData&&e instanceof FormData},isArrayBufferView:function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&e.buffer instanceof ArrayBuffer},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isObject:ma,isUndefined:fa,isDate:function(e){return"[object Date]"===ha.call(e)},isFile:function(e){return"[object File]"===ha.call(e)},isBlob:function(e){return"[object Blob]"===ha.call(e)},isFunction:va,isStream:function(e){return ma(e)&&va(e.pipe)},isURLSearchParams:function(e){return"undefined"!=typeof URLSearchParams&&e instanceof URLSearchParams},isStandardBrowserEnv:function(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&"undefined"!=typeof window&&"undefined"!=typeof document},forEach:ga,merge:function e(){var t={};function i(i,n){"object"==typeof t[n]&&"object"==typeof i?t[n]=e(t[n],i):t[n]=i}for(var n=0,r=arguments.length;n<r;n++)ga(arguments[n],i);return t},deepMerge:function e(){var t={};function i(i,n){"object"==typeof t[n]&&"object"==typeof i?t[n]=e(t[n],i):t[n]="object"==typeof i?e({},i):i}for(var n=0,r=arguments.length;n<r;n++)ga(arguments[n],i);return t},extend:function(e,t,i){return ga(t,(function(t,n){e[n]=i&&"function"==typeof t?la(t,i):t})),e},trim:function(e){return e.replace(/^\s*/,"").replace(/\s*$/,"")}};function ya(e){return encodeURIComponent(e).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var Sa=function(e,t,i){if(!t)return e;var n;if(i)n=i(t);else if(_a.isURLSearchParams(t))n=t.toString();else{var r=[];_a.forEach(t,(function(e,t){null!=e&&(_a.isArray(e)?t+="[]":e=[e],_a.forEach(e,(function(e){_a.isDate(e)?e=e.toISOString():_a.isObject(e)&&(e=JSON.stringify(e)),r.push(ya(t)+"="+ya(e))})))})),n=r.join("&")}if(n){var o=e.indexOf("#");-1!==o&&(e=e.slice(0,o)),e+=(-1===e.indexOf("?")?"?":"&")+n}return e};function Ta(){this.handlers=[]}Ta.prototype.use=function(e,t){return this.handlers.push({fulfilled:e,rejected:t}),this.handlers.length-1},Ta.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},Ta.prototype.forEach=function(e){_a.forEach(this.handlers,(function(t){null!==t&&e(t)}))};var Ea=Ta,ba=function(e,t,i){return _a.forEach(i,(function(i){e=i(e,t)})),e},Ra=function(e){return!(!e||!e.__CANCEL__)},Ia=void 0!==t?t:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function ka(){throw new Error("setTimeout has not been defined")}function wa(){throw new Error("clearTimeout has not been defined")}var Ca=ka,Aa=wa;function Da(e){if(Ca===setTimeout)return setTimeout(e,0);if((Ca===ka||!Ca)&&setTimeout)return Ca=setTimeout,setTimeout(e,0);try{return Ca(e,0)}catch(t){try{return Ca.call(null,e,0)}catch(t){return Ca.call(this,e,0)}}}"function"==typeof Ia.setTimeout&&(Ca=setTimeout),"function"==typeof Ia.clearTimeout&&(Aa=clearTimeout);var Oa,Pa=[],xa=!1,Ma=-1;function La(){xa&&Oa&&(xa=!1,Oa.length?Pa=Oa.concat(Pa):Ma=-1,Pa.length&&Na())}function Na(){if(!xa){var e=Da(La);xa=!0;for(var t=Pa.length;t;){for(Oa=Pa,Pa=[];++Ma<t;)Oa&&Oa[Ma].run();Ma=-1,t=Pa.length}Oa=null,xa=!1,function(e){if(Aa===clearTimeout)return clearTimeout(e);if((Aa===wa||!Aa)&&clearTimeout)return Aa=clearTimeout,clearTimeout(e);try{Aa(e)}catch(t){try{return Aa.call(null,e)}catch(t){return Aa.call(this,e)}}}(e)}}function Ua(e,t){this.fun=e,this.array=t}function Va(){}Ua.prototype.run=function(){this.fun.apply(null,this.array)};var Fa=Va,ja=Va,Ba=Va,Ha=Va,Ga=Va,qa=Va,Ja=Va,Wa=Ia.performance||{},za=Wa.now||Wa.mozNow||Wa.msNow||Wa.oNow||Wa.webkitNow||function(){return(new Date).getTime()},$a=new Date,Ka={nextTick:function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];Pa.push(new Ua(e,t)),1!==Pa.length||xa||Da(Na)},title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:Fa,addListener:ja,once:Ba,off:Ha,removeListener:Ga,removeAllListeners:qa,emit:Ja,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*za.call(Wa),i=Math.floor(t),n=Math.floor(t%1*1e9);return e&&(i-=e[0],(n-=e[1])<0&&(i--,n+=1e9)),[i,n]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-$a)/1e3}},Ya=function(e,t){_a.forEach(e,(function(i,n){n!==t&&n.toUpperCase()===t.toUpperCase()&&(e[t]=i,delete e[n])}))},Qa=function(e,t,i,n,r){return function(e,t,i,n,r){return e.config=t,i&&(e.code=i),e.request=n,e.response=r,e.isAxiosError=!0,e.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code}},e}(new Error(e),t,i,n,r)},Xa=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"],Za=_a.isStandardBrowserEnv()?function(){var e,t=/(msie|trident)/i.test(navigator.userAgent),i=document.createElement("a");function n(e){var n=e;return t&&(i.setAttribute("href",n),n=i.href),i.setAttribute("href",n),{href:i.href,protocol:i.protocol?i.protocol.replace(/:$/,""):"",host:i.host,search:i.search?i.search.replace(/^\?/,""):"",hash:i.hash?i.hash.replace(/^#/,""):"",hostname:i.hostname,port:i.port,pathname:"/"===i.pathname.charAt(0)?i.pathname:"/"+i.pathname}}return e=n(window.location.href),function(t){var i=_a.isString(t)?n(t):t;return i.protocol===e.protocol&&i.host===e.host}}():function(){return!0},ec=_a.isStandardBrowserEnv()?{write:function(e,t,i,n,r,o){var s=[];s.push(e+"="+encodeURIComponent(t)),_a.isNumber(i)&&s.push("expires="+new Date(i).toGMTString()),_a.isString(n)&&s.push("path="+n),_a.isString(r)&&s.push("domain="+r),!0===o&&s.push("secure"),document.cookie=s.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},tc=function(e){return new Promise((function(t,i){var n=e.data,r=e.headers;_a.isFormData(n)&&delete r["Content-Type"];var o=new XMLHttpRequest;if(e.auth){var s=e.auth.username||"",a=e.auth.password||"";r.Authorization="Basic "+btoa(s+":"+a)}var c,u,d=(c=e.baseURL,u=e.url,c&&!/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(u)?function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}(c,u):u);if(o.open(e.method.toUpperCase(),Sa(d,e.params,e.paramsSerializer),!0),o.timeout=e.timeout,o.onreadystatechange=function(){if(o&&4===o.readyState&&(0!==o.status||o.responseURL&&0===o.responseURL.indexOf("file:"))){var n="getAllResponseHeaders"in o?function(e){var t,i,n,r={};return e?(_a.forEach(e.split("\n"),(function(e){if(n=e.indexOf(":"),t=_a.trim(e.substr(0,n)).toLowerCase(),i=_a.trim(e.substr(n+1)),t){if(r[t]&&Xa.indexOf(t)>=0)return;r[t]="set-cookie"===t?(r[t]?r[t]:[]).concat([i]):r[t]?r[t]+", "+i:i}})),r):r}(o.getAllResponseHeaders()):null,r={data:e.responseType&&"text"!==e.responseType?o.response:o.responseText,status:o.status,statusText:o.statusText,headers:n,config:e,request:o};!function(e,t,i){var n=i.config.validateStatus;!n||n(i.status)?e(i):t(Qa("Request failed with status code "+i.status,i.config,null,i.request,i))}(t,i,r),o=null}},o.onabort=function(){o&&(i(Qa("Request aborted",e,"ECONNABORTED",o)),o=null)},o.onerror=function(){i(Qa("Network Error",e,null,o)),o=null},o.ontimeout=function(){var t="timeout of "+e.timeout+"ms exceeded";e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),i(Qa(t,e,"ECONNABORTED",o)),o=null},_a.isStandardBrowserEnv()){var l=ec,h=(e.withCredentials||Za(d))&&e.xsrfCookieName?l.read(e.xsrfCookieName):void 0;h&&(r[e.xsrfHeaderName]=h)}if("setRequestHeader"in o&&_a.forEach(r,(function(e,t){void 0===n&&"content-type"===t.toLowerCase()?delete r[t]:o.setRequestHeader(t,e)})),_a.isUndefined(e.withCredentials)||(o.withCredentials=!!e.withCredentials),e.responseType)try{o.responseType=e.responseType}catch(t){if("json"!==e.responseType)throw t}"function"==typeof e.onDownloadProgress&&o.addEventListener("progress",e.onDownloadProgress),"function"==typeof e.onUploadProgress&&o.upload&&o.upload.addEventListener("progress",e.onUploadProgress),e.cancelToken&&e.cancelToken.promise.then((function(e){o&&(o.abort(),i(e),o=null)})),void 0===n&&(n=null),o.send(n)}))},ic={"Content-Type":"application/x-www-form-urlencoded"};function nc(e,t){!_a.isUndefined(e)&&_a.isUndefined(e["Content-Type"])&&(e["Content-Type"]=t)}var rc={adapter:function(){var e;return("undefined"!=typeof XMLHttpRequest||void 0!==Ka&&"[object process]"===Object.prototype.toString.call(Ka))&&(e=tc),e}(),transformRequest:[function(e,t){return Ya(t,"Accept"),Ya(t,"Content-Type"),_a.isFormData(e)||_a.isArrayBuffer(e)||_a.isBuffer(e)||_a.isStream(e)||_a.isFile(e)||_a.isBlob(e)?e:_a.isArrayBufferView(e)?e.buffer:_a.isURLSearchParams(e)?(nc(t,"application/x-www-form-urlencoded;charset=utf-8"),e.toString()):_a.isObject(e)?(nc(t,"application/json;charset=utf-8"),JSON.stringify(e)):e}],transformResponse:[function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};_a.forEach(["delete","get","head"],(function(e){rc.headers[e]={}})),_a.forEach(["post","put","patch"],(function(e){rc.headers[e]=_a.merge(ic)}));var oc=rc;function sc(e){e.cancelToken&&e.cancelToken.throwIfRequested()}var ac=function(e){return sc(e),e.headers=e.headers||{},e.data=ba(e.data,e.headers,e.transformRequest),e.headers=_a.merge(e.headers.common||{},e.headers[e.method]||{},e.headers),_a.forEach(["delete","get","head","post","put","patch","common"],(function(t){delete e.headers[t]})),(e.adapter||oc.adapter)(e).then((function(t){return sc(e),t.data=ba(t.data,t.headers,e.transformResponse),t}),(function(t){return Ra(t)||(sc(e),t&&t.response&&(t.response.data=ba(t.response.data,t.response.headers,e.transformResponse))),Promise.reject(t)}))},cc=function(e,t){t=t||{};var i={},n=["url","method","params","data"],r=["headers","auth","proxy"],o=["baseURL","url","transformRequest","transformResponse","paramsSerializer","timeout","withCredentials","adapter","responseType","xsrfCookieName","xsrfHeaderName","onUploadProgress","onDownloadProgress","maxContentLength","validateStatus","maxRedirects","httpAgent","httpsAgent","cancelToken","socketPath"];_a.forEach(n,(function(e){void 0!==t[e]&&(i[e]=t[e])})),_a.forEach(r,(function(n){_a.isObject(t[n])?i[n]=_a.deepMerge(e[n],t[n]):void 0!==t[n]?i[n]=t[n]:_a.isObject(e[n])?i[n]=_a.deepMerge(e[n]):void 0!==e[n]&&(i[n]=e[n])})),_a.forEach(o,(function(n){void 0!==t[n]?i[n]=t[n]:void 0!==e[n]&&(i[n]=e[n])}));var s=n.concat(r).concat(o),a=Object.keys(t).filter((function(e){return-1===s.indexOf(e)}));return _a.forEach(a,(function(n){void 0!==t[n]?i[n]=t[n]:void 0!==e[n]&&(i[n]=e[n])})),i};function uc(e){this.defaults=e,this.interceptors={request:new Ea,response:new Ea}}uc.prototype.request=function(e){"string"==typeof e?(e=arguments[1]||{}).url=arguments[0]:e=e||{},(e=cc(this.defaults,e)).method?e.method=e.method.toLowerCase():this.defaults.method?e.method=this.defaults.method.toLowerCase():e.method="get";var t=[ac,void 0],i=Promise.resolve(e);for(this.interceptors.request.forEach((function(e){t.unshift(e.fulfilled,e.rejected)})),this.interceptors.response.forEach((function(e){t.push(e.fulfilled,e.rejected)}));t.length;)i=i.then(t.shift(),t.shift());return i},uc.prototype.getUri=function(e){return e=cc(this.defaults,e),Sa(e.url,e.params,e.paramsSerializer).replace(/^\?/,"")},_a.forEach(["delete","get","head","options"],(function(e){uc.prototype[e]=function(t,i){return this.request(_a.merge(i||{},{method:e,url:t}))}})),_a.forEach(["post","put","patch"],(function(e){uc.prototype[e]=function(t,i,n){return this.request(_a.merge(n||{},{method:e,url:t,data:i}))}}));var dc=uc;function lc(e){this.message=e}lc.prototype.toString=function(){return"Cancel"+(this.message?": "+this.message:"")},lc.prototype.__CANCEL__=!0;var hc=lc;function pc(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");var t;this.promise=new Promise((function(e){t=e}));var i=this;e((function(e){i.reason||(i.reason=new hc(e),t(i.reason))}))}pc.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},pc.source=function(){var e;return{token:new pc((function(t){e=t})),cancel:e}};var fc=pc;function mc(e){var t=new dc(e),i=la(dc.prototype.request,t);return _a.extend(i,dc.prototype,t),_a.extend(i,t),i}var vc=mc(oc);vc.Axios=dc,vc.create=function(e){return mc(cc(vc.defaults,e))},vc.Cancel=hc,vc.CancelToken=fc,vc.isCancel=Ra,vc.all=function(e){return Promise.all(e)},vc.spread=function(e){return function(t){return e.apply(null,t)}};var gc=vc,_c=vc;gc.default=_c;var yc=gc,Sc=((new Date).getTime(),0),Tc=function(){return(new Date).getTime()+Sc},Ec=function(){var e=new Date;return e.setTime(Tc()),e.toLocaleString()},bc={sdkAppId:"",userId:"",version:"",env:"qcloud",browserVersion:"",ua:""},Rc=function(e){var t=Qu(),i=t.name,n=t.version;bc.sdkAppId="".concat(e.sdkAppId),bc.version="".concat(e.version),bc.env=e.env,bc.userId=e.userId,bc.browserVersion=i+n,bc.ua=navigator.userAgent},Ic=function(e,t){var i={timestamp:Ec(),sdkAppId:bc.sdkAppId,userId:bc.userId,version:bc.version,log:e};t&&(i.errorInfo=t.message),yc.post(Oc(),JSON.stringify(i)).catch((function(){}))},kc=function(e){var t="stat-".concat(e.eventType,"-").concat(e.result);"delta-join"!==e.eventType&&"delta-leave"!==e.eventType&&"delta-publish"!==e.eventType||(t="".concat(e.eventType,":").concat(e.delta)),Ic(t),"failed"===e.result&&(t="stat-".concat(e.eventType,"-").concat(e.result,"-").concat(e.code),Ic(t,e.error))},wc=function(e){if(!$u){var t=i(i({},e),bc);Uc(t.code)&&(t.code="failed"===t.result?ua.UNKNOWN:0),yc.post(Pc(),JSON.stringify(t)).catch((function(){}))}},Cc=function(e){$u||(wc(i(i({},e),{},{result:"success"})),"qcloud"===bc.env&&kc(i(i({},e),{},{result:"success"})))},Ac=function(e){if(!$u){var t=e.eventType,n=e.code,r=e.error,o={eventType:t,result:"failed",code:n||(r instanceof da?r.getExtraCode()||r.getCode():ua.UNKNOWN)};wc(o),"qcloud"===bc.env&&kc(i(i({},o),{},{error:r}))}},Dc=function(){return function(e){var t=window.location.search.match(new RegExp("(\\?|&)trtc_env=([^&]*)(&|$)"));return t?decodeURIComponent(t[2]):""}()},Oc=function(){return"".concat(vs||"https://yun.tim.qq.com","/v5/AVQualityReportSvc/C2S?sdkappid=1&cmdtype=jssdk_log")},Pc=function(){return"".concat(vs||"https://yun.tim.qq.com","/v5/AVQualityReportSvc/C2S?sdkappid=1&cmdtype=jssdk_event")};function xc(){var e=navigator.userAgent,t=navigator.connection,i=e.match(/NetType\/\w+/)?e.match(/NetType\/\w+/)[0]:"";"3gnet"===(i=i.toLowerCase().replace("nettype/",""))&&(i="3g");var n=t&&t.type&&t.type.toLowerCase(),r=t&&t.effectiveType&&t.effectiveType.toLowerCase();"slow-2"===r&&(r="2g");var o=i||"unknown";if(n)switch(n){case"cellular":case"wimax":o=r||"unknown";break;case"wifi":o="wifi";break;case"ethernet":o="wired";break;case"none":case"other":case"unknown":o="unknown"}return Xu.info("networkType:",o),o}var Mc=function(e){if(!e||"object"!==n(e)||"[object Object]"!=Object.prototype.toString.call(e))return!1;var t=Object.getPrototypeOf(e);if(null===t)return!0;var i=Object.prototype.hasOwnProperty.call(t,"constructor")&&t.constructor;return"function"==typeof i&&i instanceof i&&Function.prototype.toString.call(i)===Function.prototype.toString.call(Object)};function Lc(e){var t=Math.round(e/2)+1;return t>6?13e3:1e3*function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return t<=1?n:e(t-1,n,i+n)}(t)}var Nc=function(e){return"function"==typeof e},Uc=function(e){return void 0===e},Vc=function(e){return"string"==typeof e},Fc=function(e){return"number"==typeof e};function jc(e){return Reflect.apply(Object.prototype.toString,e,[]).replace(/^\[object\s(\w+)\]$/,"$1").toLowerCase()}function Bc(e,t){for(var i in e)if(t[i]&&"undefined"!==jc(e[i])&&jc(e[i])!==t[i].toLowerCase())return{ret:!1,message:"".concat(i," should be ").concat(t[i])};return{ret:!0}}function Hc(e){var t={};return t.urls="turn:".concat(e.url),Uc(e.username)||Uc(e.credential)||(t.username=e.username,t.credential=e.credential,t.credentialType="password",Uc(e.credentialType)||(t.credentialType=e.credentialType)),t}function Gc(){return performance&&performance.now?Math.floor(performance.now()):Date.now()}function qc(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"big";if(!Vc(e))return 0;var i=e.split(".");return"big"===t?(Number(i[0])<<24|Number(i[1])<<16|Number(i[2])<<8|Number(i[3]))>>>0:(Number(i[3])<<24|Number(i[2])<<16|Number(i[1])<<8|Number(i[0]))>>>0}function Jc(e){return Wc.apply(this,arguments)}function Wc(){return(Wc=o(regeneratorRuntime.mark((function e(t){var i,n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,i={userId:String(t.userId),sdkAppId:String(t.sdkAppId),isStrGroupId:t.useStringRoomId,groupId:String(t.roomId),sdkVersion:"4.11.7",userSig:String(t.userSig)},n=Gc(),e.next=5,yc.post(oa,i,{timeout:1500});case 5:if(r=e.sent,Ic("stat-schedule-delta:".concat(Gc()-n)),0!==r.data.code){e.next=9;break}return e.abrupt("return",r.data.data);case 9:Xu.debug("schedule failed: "+r.data.msg),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(0),Xu.debug("schedule failed: "+e.t0);case 15:case"end":return e.stop()}}),e,null,[[0,12]])})))).apply(this,arguments)}var zc,$c=window.navigator&&window.navigator.userAgent||"",Kc=/AppleWebKit\/([\d.]+)/i.exec($c),Yc=(Kc&&parseFloat(Kc.pop()),/iPad/i.test($c)),Qc=/iPhone/i.test($c)&&!Yc,Xc=/iPod/i.test($c),Zc=Qc||Yc||Xc,eu=(Zc&&function(){var e=$c.match(/OS (\d+)_/i);e&&e[1]&&e[1]}(),/Android/i.test($c)),tu=(eu&&function(){var e=$c.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(!e)return null;var t=e[1]&&parseFloat(e[1]),i=e[2]&&parseFloat(e[2]);t&&i&&parseFloat(e[1]+"."+e[2])}(),eu&&/webkit/i.test($c),/Firefox/i.test($c)),iu=tu&&function(){var e=$c.match(/Firefox\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),nu=/Edge\//i.test($c),ru=nu&&function(){var e=$c.match(/Edge\/(\d+)/i);if(e&&e[1])return e[1]}(),ou=/Edg\//i.test($c),su=ou&&function(){var e=$c.match(/Edg\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),au=/SogouMobileBrowser\//i.test($c),cu=au&&function(){var e=$c.match(/SogouMobileBrowser\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),uu=/MetaSr\s/i.test($c),du=uu&&function(){var e=$c.match(/MetaSr(\s\d+(\.\d+)+)/);return e&&e[1]?parseFloat(e[1]):null}(),lu=/TBS\/\d+/i.test($c),hu=lu&&function(){var e=$c.match(/TBS\/(\d+)/i);if(e&&e[1])return e[1]}(),pu=/XWEB\/\d+/i.test($c),fu=pu&&function(){var e=$c.match(/XWEB\/(\d+)/i);if(e&&e[1])return e[1]}(),mu=(/MSIE\s8\.0/.test($c),/MSIE\/\d+/i.test($c)&&function(){var e=/MSIE\s(\d+)\.\d/.exec($c),t=e&&parseFloat(e[1]);!t&&/Trident\/7.0/i.test($c)&&/rv:11.0/.test($c)&&(t=11)}(),/(micromessenger|webbrowser)/i.test($c)),vu=mu&&function(){var e=$c.match(/MicroMessenger\/(\d+)/i);if(e&&e[1])return e[1]}(),gu=!lu&&/MQQBrowser\/\d+/i.test($c)&&/COVC\/\d+/i.test($c),_u=!lu&&/MQQBrowser\/\d+/i.test($c)&&!/COVC\/\d+/i.test($c),yu=(_u||gu)&&function(){var e=$c.match(/ MQQBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Su=!lu&&/ QQBrowser\/\d+/i.test($c),Tu=Su&&function(){var e=$c.match(/ QQBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Eu=!lu&&/QQBrowserLite\/\d+/i.test($c),bu=Eu&&function(){var e=$c.match(/QQBrowserLite\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Ru=!lu&&/MQBHD\/\d+/i.test($c),Iu=Ru&&function(){var e=$c.match(/MQBHD\/([\d.]+)/);return e&&e[1]?e[1]:null}(),ku=/Windows/i.test($c),wu=!Zc&&/MAC OS X/i.test($c),Cu=!eu&&/Linux/i.test($c),Au=(/MicroMessenger/i.test($c),/UCBrowser/i.test($c)),Du=(/Electron/i.test($c),/MiuiBrowser/i.test($c)),Ou=Du&&function(){var e=$c.match(/MiuiBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Pu=/HuaweiBrowser/i.test($c),xu=/Huawei/i.test($c),Mu=Pu&&function(){var e=$c.match(/HuaweiBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Lu=/SamsungBrowser/i.test($c),Nu=Lu&&function(){var e=$c.match(/SamsungBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Uu=/HeyTapBrowser/i.test($c),Vu=Uu&&function(){var e=$c.match(/HeyTapBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Fu=/VivoBrowser/i.test($c),ju=Fu&&function(){var e=$c.match(/VivoBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Bu=/Chrome/i.test($c),Hu=!nu&&!uu&&!au&&!lu&&!pu&&!ou&&!Su&&!Du&&!Pu&&!Lu&&!Uu&&!Fu&&/Chrome/i.test($c),Gu=Hu&&function(){var e=$c.match(/Chrome\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),qu=Hu&&function(){var e=$c.match(/Chrome\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Ju=!Bu&&!_u&&!gu&&!Eu&&!Ru&&/Safari/i.test($c),Wu=Ju&&function(){var e=$c.match(/Version\/([\d.]+)/);return e&&e[1]?e[1]:null}(),zu=Hu?"Chrome/"+qu:Ju?"Safari/"+Wu:"NotSupportedBrowser",$u="file:"===location.protocol||"localhost"===location.hostname||/^\d+\.\d+\.\d+\.\d+$/.test(location.hostname),Ku=function(){if(Uc(zc))try{zc=window.localStorage}catch(e){Xu.warn(e),zc=!1}return zc},Yu=new Map([[tu,["Firefox",iu]],[ou,["Edg",su]],[Hu,["Chrome",qu]],[Ju,["Safari",Wu]],[lu,["TBS",hu]],[pu,["XWEB",fu]],[mu&&Qc,["WeChat",vu]],[Su,["QQ(Win)",Tu]],[_u,["QQ(Mobile)",yu]],[gu,["QQ(Mobile X5)",yu]],[Eu,["QQ(Mac)",bu]],[Ru,["QQ(iPad)",Iu]],[Du,["MI",Ou]],[Pu,["HW",Mu]],[Lu,["Samsung",Nu]],[Uu,["OPPO",Vu]],[Fu,["VIVO",ju]],[nu,["EDGE",ru]],[au,["SogouMobile",cu]],[uu,["Sogou",du]]]);function Qu(){var e="unknown",t="unknown";return Yu.get(!0)&&(e=Yu.get(!0)[0],t=Yu.get(!0)[1]),{name:e,version:t}}var Xu=function(){var e=function(){},t=["trace","debug","info","warn","error"];function i(e,t){var i=e[t];if(Nc(i.bind))return i.bind(e);try{return Function.prototype.bind.call(i,e)}catch(t){return function(){return Function.prototype.apply.apply(i,[e,arguments])}}}function r(t){return"debug"===t&&(t="log"),"undefined"!==("undefined"==typeof console?"undefined":n(console))&&(void 0!==console[t]?i(console,t):void 0!==console.log?i(console,"log"):e)}function o(e,i){for(var n=0;n<t.length;n++){var r=t[n];this[r]=this.methodFactory(r,e,i)}this.log=this.debug}function s(e,t,i){return function(){"undefined"!==("undefined"==typeof console?"undefined":n(console))&&(o.call(this,t,i),this[e].apply(this,arguments))}}function a(e,t,i){return r(e)||s.apply(this,arguments)}function c(e,i,r){var s,c=this,u="loglevel";function d(){var e;if("undefined"!==("undefined"==typeof window?"undefined":n(window))){try{Ku()&&(e=window.localStorage[u])}catch(e){}return void 0===c.levels[e]&&(e=void 0),e}}e&&(u+=":"+e),c.name=e,c.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},c.methodFactory=r||a,c.getLevel=function(){return s},c.setLevel=function(i,r){if(Vc(i)&&void 0!==c.levels[i.toUpperCase()]&&(i=c.levels[i.toUpperCase()]),!(Fc(i)&&i>=0&&i<=c.levels.SILENT))throw"log.setLevel() called with invalid level: "+i;if(s=i,!1!==r&&function(e){var i=(t[e]||"silent").toUpperCase();if("undefined"!==("undefined"==typeof window?"undefined":n(window)))try{Ku()&&(window.localStorage[u]=i)}catch(e){}}(i),o.call(c,i,e),"undefined"===("undefined"==typeof console?"undefined":n(console))&&i<c.levels.SILENT)return"No console available for logging"},c.setDefaultLevel=function(e){d()||c.setLevel(e,!1)},c.enableAll=function(e){c.setLevel(c.levels.TRACE,e)},c.disableAll=function(e){c.setLevel(c.levels.SILENT,e)};var l=d();null==l&&(l=null==i?"WARN":i),c.setLevel(l,!1)}var u=new c,d={};u.getLogger=function(e){if(!Vc(e)||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=d[e];return t||(t=d[e]=new c(e,u.getLevel(),u.methodFactory)),t};var l="undefined"!==("undefined"==typeof window?"undefined":n(window))?window.log:void 0;return u.noConflict=function(){return"undefined"!==("undefined"==typeof window?"undefined":n(window))&&window.log===u&&(window.log=l),u},u.getLoggers=function(){return d},u}(),Zu=wt("slice"),ed=pe("species"),td=[].slice,id=Math.max;gt({target:"Array",proto:!0,forced:!Zu},{slice:function(e,t){var i,n,r,o=H(this),s=Ke(o.length),a=Xe(e,s),c=Xe(void 0===t?s:t,s);if(St(o)&&("function"!=typeof(i=o.constructor)||i!==Array&&!St(i.prototype)?G(i)&&null===(i=i[ed])&&(i=void 0):i=void 0,i===Array||void 0===i))return td.call(o,a,c);for(n=new(void 0===i?Array:i)(id(c-a,0)),r=0;a<c;a++,r++)a in o&&Jo(n,r,o[a]);return n.length=r,n}});var nd=[].join,rd=j!=Object,od=ko("join",",");gt({target:"Array",proto:!0,forced:rd||!od},{join:function(e){return nd.call(H(this),void 0===e?",":e)}}),gt({target:"Array",stat:!0},{isArray:St});var sd=wt("splice"),ad=Math.max,cd=Math.min;gt({target:"Array",proto:!0,forced:!sd},{splice:function(e,t){var i,n,r,o,s,a,c=re(this),u=Ke(c.length),d=Xe(e,u),l=arguments.length;if(0===l?i=n=0:1===l?(i=0,n=u-d):(i=l-2,n=cd(ad(ze(t),0),u-d)),u+i-n>9007199254740991)throw TypeError("Maximum allowed length exceeded");for(r=Et(c,n),o=0;o<n;o++)(s=d+o)in c&&Jo(r,o,c[s]);if(r.length=n,i<n){for(o=d;o<u-n;o++)a=o+i,(s=o+n)in c?c[a]=c[s]:delete c[a];for(o=u;o>u-n+i;o--)delete c[o-1]}else if(i>n)for(o=u-n;o>d;o--)a=o+i-1,(s=o+n-1)in c?c[a]=c[s]:delete c[a];for(o=0;o<i;o++)c[o+d]=arguments[o+2];return c.length=u-n+i,r}});var ud=function(e){var t=Xi(B(this)),i="",n=ze(e);if(n<0||1/0==n)throw RangeError("Wrong number of repetitions");for(;n>0;(n>>>=1)&&(t+=t))1&n&&(i+=t);return i},dd=Math.ceil,ld=function(e){return function(t,i,n){var r,o,s=Xi(B(t)),a=s.length,c=void 0===n?" ":Xi(n),u=Ke(i);return u<=a||""==c?s:((o=ud.call(c,dd((r=u-a)/c.length))).length>r&&(o=o.slice(0,r)),e?s+o:o+s)}},hd=[ld(!1),ld(!0)][0],pd=Math.abs,fd=Date.prototype,md=fd.getTime,vd=fd.toISOString,gd=O((function(){return"0385-07-25T07:06:39.999Z"!=vd.call(new Date(-50000000000001))}))||!O((function(){vd.call(new Date(NaN))}))?function(){if(!isFinite(md.call(this)))throw RangeError("Invalid time value");var e=this.getUTCFullYear(),t=this.getUTCMilliseconds(),i=e<0?"-":e>9999?"+":"";return i+hd(pd(e),i?6:4,0)+"-"+hd(this.getUTCMonth()+1,2,0)+"-"+hd(this.getUTCDate(),2,0)+"T"+hd(this.getUTCHours(),2,0)+":"+hd(this.getUTCMinutes(),2,0)+":"+hd(this.getUTCSeconds(),2,0)+"."+hd(t,3,0)+"Z"}:vd;gt({target:"Date",proto:!0,forced:Date.prototype.toISOString!==gd},{toISOString:gd});var _d=It.some,yd=ko("some");gt({target:"Array",proto:!0,forced:!yd},{some:function(e){return _d(this,e,arguments.length>1?arguments[1]:void 0)}});var Sd=[].slice,Td=/MSIE .\./.test(W),Ed=function(e){return function(t,i){var n=arguments.length>2,r=n?Sd.call(arguments,2):void 0;return e(n?function(){("function"==typeof t?t:Function(t)).apply(this,r)}:t,i)}};gt({global:!0,bind:!0,forced:Td},{setTimeout:Ed(D.setTimeout),setInterval:Ed(D.setInterval)});var bd,Rd=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))},Id=new(function(){function e(){s(this,e),this.intervalMap_=new Map}return c(e,[{key:"setInterval",value:function(e){function t(t,i){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e,t){var i=this,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!window||!window.requestAnimationFrame)return setInterval(e,t);var r=Rd(),o=Gc(),s=o;this.intervalMap_.set(r,{rafId:null,timeoutId:null,onVisibilityChange:null});var a=function a(){if(n&&document.hidden){e();var c=setTimeout(a,t);i.setTimeoutId(r,c),o=Gc(),s=o}else{(s=Gc())-o>=t&&(o=s,e());var u=requestAnimationFrame(a);i.setRafId(r,u)}},c=requestAnimationFrame(a);if(this.setRafId(r,c),n){var u=function(){if(document.hidden){var e=Gc()-o;if(e>=t)a();else{var n=setTimeout(a,t-e);i.setTimeoutId(r,n)}}};document.addEventListener("visibilitychange",u),this.setOnVisibilityChange(r,u)}return r}))},{key:"clearInterval",value:function(e){if(this.intervalMap_.has(e)){var t=this.intervalMap_.get(e),i=t.rafId,n=t.timeoutId,r=t.onVisibilityChange;cancelAnimationFrame(i),clearTimeout(n),document.removeEventListener("visibilitychange",r),this.intervalMap_.delete(e)}}},{key:"setTimeoutId",value:function(e,t){if(this.intervalMap_.has(e)){var i=this.intervalMap_.get(e);i.timeoutId&&clearTimeout(i.timeoutId),i.timeoutId=t}}},{key:"setRafId",value:function(e,t){if(this.intervalMap_.has(e)){var i=this.intervalMap_.get(e);i.rafId&&cancelAnimationFrame(i.rafId),i.rafId=t}}},{key:"setOnVisibilityChange",value:function(e,t){this.intervalMap_.has(e)&&(this.intervalMap_.get(e).onVisibilityChange=t)}}]),e}());function kd(e){try{return JSON.stringify(e)}catch(e){if(!bd)try{var t={};t.a=t,JSON.stringify(t)}catch(e){bd=e.message}if(e.message===bd)return"[Circular]";throw e}}function wd(e){var t="",i=0;return e.length>1&&Vc(e[0])&&(t=(t=e[0].replace(/(%?)(%([sdjo]))/g,(function(t,n,r,o){if(!n){var s=e[i+=1],a="";switch(o){case"s":a+=s;break;case"d":a+=+s;break;case"j":a=kd(s);break;case"o":var c=kd(s);"{"!==c[0]&&"["!==c[0]&&(c="<".concat(c,">")),a=function(e){if(!Object.getOwnPropertyDescriptor||!Object.getPrototypeOf)return Object.prototype.toString.call(e).slice(8,-1);for(;e;){var t=Object.getOwnPropertyDescriptor(e,"constructor");if(void 0!==t&&Nc(t.value)&&""!==t.value.name)return t.value.name;e=Object.getPrototypeOf(e)}return""}(s)+c}return a}return t}))).replace(/%{2,2}/g,"%"),i+=1),e.length>i&&(t&&(t+=" "),t+=e.slice(i).join(" ")),t}var Cd=Object.prototype.hasOwnProperty;function Ad(){try{throw new Error}catch(e){return e.stack}}function Dd(e){var t=this,i=[],n=[];this.length=function(){return i.length},this.sent=function(){return n.length},this.push=function(t){i.push(t),i.length>e&&i.shift()},this.send=function(){return n.length||(n=i,i=[]),n},this.confirm=function(){n=[],t.content=""},this.fail=function(){i=n.concat(i),t.confirm();var r=1+i.length+n.length-e;r>0&&(n.splice(0,r),i=n.concat(i),t.confirm())}}var Od,Pd,xd,Md=!!Ad(),Ld={interval:1e3,level:"trace",capacity:0,stacktrace:{levels:["trace","warn","error"],depth:3,excess:0},timestamp:function(){return(new Date).toISOString()},format:function(e){return"[".concat(e.timestamp,"] <").concat(e.level.label.toUpperCase(),">").concat(e.logger?" (".concat(e.logger,")"):"",": ").concat(e.message).concat(e.stacktrace?"\n".concat(e.stacktrace):"")}},Nd=-1,Ud=!1,Vd="",Fd="",jd="",Bd=!1;Xu.setConfig=function(e){!function(e){Ud||(Vd="".concat(e.sdkAppId),Fd="".concat(e.userId),jd="".concat(e.version),Ud=!0)}(e)},Xu.setLogLevel=function(e){Xu.setLevel(e)},Xu.getLogLevel=function(e){return Xu.getLevel(e)},Xu.enableUploadLog=function(){Bd||(function(e,t){if(!e||!e.getLogger)throw new TypeError("Argument is not a root loglevel object");if(Od)throw new Error("You can assign a plugin only one time");Od=e;var i=function e(){for(var t={},i=0;i<arguments.length;i+=1){var r=Object(arguments[i]);for(var o in r)Cd.call(r,o)&&(t[o]="object"!==n(r[o])||Array.isArray(r[o])?r[o]:e(t[o],r[o]))}return t}(Ld,t);i.capacity=i.capacity||500;var r,o=i.interval;Nd=Id.setInterval((function(){if(Ud&&!s.sent()){if(!s.length())return;var e=s.send();s.content=r?'{"logs":['.concat(e.join(","),"]}"):e.join("\n"),function(e){if(Ud){var t=JSON.stringify({timestamp:Ec(),sdkAppId:Vd,userId:Fd,version:jd,log:e});yc.post(Oc(),t).then((function(){s.confirm()})).catch((function(){s.fail()}))}}(s.content)}}),o);var s=new Dd(i.capacity);Pd=e.methodFactory,xd=function(e,t,n){var o=Pd(e,t,n),a=Md&&i.stacktrace.levels.some((function(t){return t===e})),c=Od.levels[e.toUpperCase()];return function(){for(var u=arguments.length,d=new Array(u),l=0;l<u;l++)d[l]=arguments[l];var h=wd(d),p=c>=t;if(p){var f=new Date;f.setTime(Tc());var m=f.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1")+":".concat(f.getMilliseconds()),v="["+m+"] <"+e.toUpperCase()+"> "+h;o.apply(void 0,[v])}var g=Ec(),_=a?Ad():"";if(_){var y=_.split("\n");y.splice(0,i.stacktrace.excess+3);var S=i.stacktrace.depth;if(S&&y.length!==S+1){var T=y.splice(0,S);_=T.join("\n"),y.length&&(_+="\n    and ".concat(y.length," more"))}else _=y.join("\n")}var E=i.format({message:h,level:{label:e,value:c},logger:n||"",timestamp:g,stacktrace:_});void 0===r&&(r=!Vc(E));var b="";if(r)try{b+=JSON.stringify(E)}catch(e){return o.apply(void 0,d),void Od.getLogger("logger").error(e)}else b+=E;s.push(b)}},e.methodFactory=xd,e.setLevel(e.getLevel())}(Xu),Bd=!0)},Xu.disableUploadLog=function(){Bd&&(Xu.warn("disable upload log! Without log we are difficult to help you triage the issue you might run into!"),function(){if(!Od)throw new Error("You can't disable a not appled plugin");if(xd!==Od.methodFactory)throw new Error("You can't disable a plugin after appling another plugin");Od.methodFactory=Pd,Od.setLevel(Od.getLevel()),Od=void 0,Id.clearInterval(Nd)}(),Bd=!1)},Xu.enableUploadLog(),Xu.setLevel("INFO");var Hd=!0,Gd=Math.floor;gt({target:"Number",stat:!0},{isInteger:function(e){return!G(e)&&isFinite(e)&&Gd(e)===e}});var qd,Jd=function(e){if(ro(e))throw TypeError("The method doesn't accept regular expressions");return e},Wd=pe("match"),zd=function(e){var t=/./;try{"/./"[e](t)}catch(i){try{return t[Wd]=!1,"/./"[e](t)}catch(e){}}return!1},$d=Ee.f,Kd="".startsWith,Yd=Math.min,Qd=zd("startsWith"),Xd=!(Qd||(qd=$d(String.prototype,"startsWith"),!qd||qd.writable));gt({target:"String",proto:!0,forced:!Xd&&!Qd},{startsWith:function(e){var t=Xi(B(this));Jd(e);var i=Ke(Yd(arguments.length>1?arguments[1]:void 0,t.length)),n=Xi(e);return Kd?Kd.call(t,n,i):t.slice(i,i+n.length)===n}});var Zd=It.forEach,el=ko("forEach")?[].forEach:function(e){return Zd(this,e,arguments.length>1?arguments[1]:void 0)};for(var tl in gt({target:"Array",proto:!0,forced:[].forEach!=el},{forEach:el}),$r){var il=D[tl],nl=il&&il.prototype;if(nl&&nl.forEach!==el)try{ke(nl,"forEach",el)}catch(e){nl.forEach=el}}var rl,ol,sl,al,cl=D.Promise,ul=/(?:iphone|ipod|ipad).*applewebkit/i.test(W),dl="process"==V(D.process),ll=D.setImmediate,hl=D.clearImmediate,pl=D.process,fl=D.MessageChannel,ml=D.Dispatch,vl=0,gl={};try{rl=D.location}catch(e){}var _l=function(e){if(gl.hasOwnProperty(e)){var t=gl[e];delete gl[e],t()}},yl=function(e){return function(){_l(e)}},Sl=function(e){_l(e.data)},Tl=function(e){D.postMessage(String(e),rl.protocol+"//"+rl.host)};ll&&hl||(ll=function(e){for(var t=[],i=arguments.length,n=1;i>n;)t.push(arguments[n++]);return gl[++vl]=function(){("function"==typeof e?e:Function(e)).apply(void 0,t)},ol(vl),vl},hl=function(e){delete gl[e]},dl?ol=function(e){pl.nextTick(yl(e))}:ml&&ml.now?ol=function(e){ml.now(yl(e))}:fl&&!ul?(al=(sl=new fl).port2,sl.port1.onmessage=Sl,ol=yt(al.postMessage,al,1)):D.addEventListener&&"function"==typeof postMessage&&!D.importScripts&&rl&&"file:"!==rl.protocol&&!O(Tl)?(ol=Tl,D.addEventListener("message",Sl,!1)):ol="onreadystatechange"in ye("script")?function(e){on.appendChild(ye("script")).onreadystatechange=function(){on.removeChild(this),_l(e)}}:function(e){setTimeout(yl(e),0)});var El,bl,Rl,Il,kl,wl,Cl,Al,Dl={set:ll,clear:hl},Ol=/web0s(?!.*chrome)/i.test(W),Pl=Ee.f,xl=Dl.set,Ml=D.MutationObserver||D.WebKitMutationObserver,Ll=D.document,Nl=D.process,Ul=D.Promise,Vl=Pl(D,"queueMicrotask"),Fl=Vl&&Vl.value;Fl||(El=function(){var e,t;for(dl&&(e=Nl.domain)&&e.exit();bl;){t=bl.fn,bl=bl.next;try{t()}catch(e){throw bl?Il():Rl=void 0,e}}Rl=void 0,e&&e.enter()},ul||dl||Ol||!Ml||!Ll?Ul&&Ul.resolve?((Cl=Ul.resolve(void 0)).constructor=Ul,Al=Cl.then,Il=function(){Al.call(Cl,El)}):Il=dl?function(){Nl.nextTick(El)}:function(){xl.call(D,El)}:(kl=!0,wl=Ll.createTextNode(""),new Ml(El).observe(wl,{characterData:!0}),Il=function(){wl.data=kl=!kl}));var jl,Bl,Hl,Gl,ql=Fl||function(e){var t={fn:e,next:void 0};Rl&&(Rl.next=t),bl||(bl=t,Il()),Rl=t},Jl=function(e){var t,i;this.promise=new e((function(e,n){if(void 0!==t||void 0!==i)throw TypeError("Bad Promise constructor");t=e,i=n})),this.resolve=_t(t),this.reject=_t(i)},Wl={f:function(e){return new Jl(e)}},zl=function(e){try{return{error:!1,value:e()}}catch(e){return{error:!0,value:e}}},$l="object"==typeof window,Kl=Dl.set,Yl=pe("species"),Ql="Promise",Xl=Ge.get,Zl=Ge.set,eh=Ge.getterFor(Ql),th=cl&&cl.prototype,ih=cl,nh=th,rh=D.TypeError,oh=D.document,sh=D.process,ah=Wl.f,ch=ah,uh=!!(oh&&oh.createEvent&&D.dispatchEvent),dh="function"==typeof PromiseRejectionEvent,lh=!1,hh=mt(Ql,(function(){var e=Oe(ih),t=e!==String(ih);if(!t&&66===Q)return!0;if(Q>=51&&/native code/.test(e))return!1;var i=new ih((function(e){e(1)})),n=function(e){e((function(){}),(function(){}))};return(i.constructor={})[Yl]=n,!(lh=i.then((function(){}))instanceof n)||!t&&$l&&!dh})),ph=hh||!Lr((function(e){ih.all(e).catch((function(){}))})),fh=function(e){var t;return!(!G(e)||"function"!=typeof(t=e.then))&&t},mh=function(e,t){if(!e.notified){e.notified=!0;var i=e.reactions;ql((function(){for(var n=e.value,r=1==e.state,o=0;i.length>o;){var s,a,c,u=i[o++],d=r?u.ok:u.fail,l=u.resolve,h=u.reject,p=u.domain;try{d?(r||(2===e.rejection&&yh(e),e.rejection=1),!0===d?s=n:(p&&p.enter(),s=d(n),p&&(p.exit(),c=!0)),s===u.promise?h(rh("Promise-chain cycle")):(a=fh(s))?a.call(s,l,h):l(s)):h(n)}catch(e){p&&!c&&p.exit(),h(e)}}e.reactions=[],e.notified=!1,t&&!e.rejection&&gh(e)}))}},vh=function(e,t,i){var n,r;uh?((n=oh.createEvent("Event")).promise=t,n.reason=i,n.initEvent(e,!1,!0),D.dispatchEvent(n)):n={promise:t,reason:i},!dh&&(r=D["on"+e])?r(n):"unhandledrejection"===e&&function(e,t){var i=D.console;i&&i.error&&(1===arguments.length?i.error(e):i.error(e,t))}("Unhandled promise rejection",i)},gh=function(e){Kl.call(D,(function(){var t,i=e.facade,n=e.value;if(_h(e)&&(t=zl((function(){dl?sh.emit("unhandledRejection",n,i):vh("unhandledrejection",i,n)})),e.rejection=dl||_h(e)?2:1,t.error))throw t.value}))},_h=function(e){return 1!==e.rejection&&!e.parent},yh=function(e){Kl.call(D,(function(){var t=e.facade;dl?sh.emit("rejectionHandled",t):vh("rejectionhandled",t,e.value)}))},Sh=function(e,t,i){return function(n){e(t,n,i)}},Th=function(e,t,i){e.done||(e.done=!0,i&&(e=i),e.value=t,e.state=2,mh(e,!0))},Eh=function(e,t,i){if(!e.done){e.done=!0,i&&(e=i);try{if(e.facade===t)throw rh("Promise can't be resolved itself");var n=fh(t);n?ql((function(){var i={done:!1};try{n.call(t,Sh(Eh,i,e),Sh(Th,i,e))}catch(t){Th(i,t,e)}})):(e.value=t,e.state=1,mh(e,!1))}catch(t){Th({done:!1},t,e)}}};if(hh&&(nh=(ih=function(e){Dr(this,ih,Ql),_t(e),jl.call(this);var t=Xl(this);try{e(Sh(Eh,t),Sh(Th,t))}catch(e){Th(t,e)}}).prototype,(jl=function(e){Zl(this,{type:Ql,done:!1,notified:!1,parent:!1,reactions:[],rejection:!1,state:0,value:void 0})}).prototype=Ur(nh,{then:function(e,t){var i=eh(this),n=ah(es(this,ih));return n.ok="function"!=typeof e||e,n.fail="function"==typeof t&&t,n.domain=dl?sh.domain:void 0,i.parent=!0,i.reactions.push(n),0!=i.state&&mh(i,!1),n.promise},catch:function(e){return this.then(void 0,e)}}),Bl=function(){var e=new jl,t=Xl(e);this.promise=e,this.resolve=Sh(Eh,t),this.reject=Sh(Th,t)},Wl.f=ah=function(e){return e===ih||e===Hl?new Bl(e):ch(e)},"function"==typeof cl&&th!==Object.prototype)){Gl=th.then,lh||(qe(th,"then",(function(e,t){var i=this;return new ih((function(e,t){Gl.call(i,e,t)})).then(e,t)}),{unsafe:!0}),qe(th,"catch",nh.catch,{unsafe:!0}));try{delete th.constructor}catch(e){}rr&&rr(th,nh)}gt({global:!0,wrap:!0,forced:hh},{Promise:ih}),tr(ih,Ql,!1),Fr(Ql),Hl=J(Ql),gt({target:Ql,stat:!0,forced:hh},{reject:function(e){var t=ah(this);return t.reject.call(void 0,e),t.promise}}),gt({target:Ql,stat:!0,forced:hh},{resolve:function(e){return function(e,t){if(be(e),G(t)&&t.constructor===e)return t;var i=Wl.f(e);return(0,i.resolve)(t),i.promise}(this,e)}}),gt({target:Ql,stat:!0,forced:ph},{all:function(e){var t=this,i=ah(t),n=i.resolve,r=i.reject,o=zl((function(){var i=_t(t.resolve),o=[],s=0,a=1;Ar(e,(function(e){var c=s++,u=!1;o.push(void 0),a++,i.call(t,e).then((function(e){u||(u=!0,o[c]=e,--a||n(o))}),r)})),--a||n(o)}));return o.error&&r(o.value),i.promise},race:function(e){var t=this,i=ah(t),n=i.reject,r=zl((function(){var r=_t(t.resolve);Ar(e,(function(e){r.call(t,e).then(i.resolve,n)}))}));return r.error&&n(r.value),i.promise}});var bh=wn.trim,Rh=D.parseInt,Ih=/^[+-]?0[Xx]/,kh=8!==Rh(En+"08")||22!==Rh(En+"0x16")?function(e,t){var i=bh(Xi(e));return Rh(i,t>>>0||(Ih.test(i)?16:10))}:Rh;gt({global:!0,forced:parseInt!=kh},{parseInt:kh});var wh=It.findIndex,Ch=!0;"findIndex"in[]&&Array(1).findIndex((function(){Ch=!1})),gt({target:"Array",proto:!0,forced:Ch},{findIndex:function(e){return wh(this,e,arguments.length>1?arguments[1]:void 0)}}),qn("findIndex");var Ah=O((function(){nn(1)}));gt({target:"Object",stat:!0,forced:Ah},{keys:function(e){return nn(re(e))}});var Dh=L.f,Oh=function(e){return function(t){for(var i,n=H(t),r=nn(n),o=r.length,s=0,a=[];o>s;)i=r[s++],P&&!Dh.call(n,i)||a.push(e?[i,n[i]]:n[i]);return a}},Ph=(Oh(!0),Oh(!1));gt({target:"Object",stat:!0},{values:function(e){return Ph(e)}});var xh=et.includes;gt({target:"Array",proto:!0},{includes:function(e){return xh(this,e,arguments.length>1?arguments[1]:void 0)}}),qn("includes"),gt({target:"String",proto:!0,forced:!zd("includes")},{includes:function(e){return!!~Xi(B(this)).indexOf(Xi(Jd(e)),arguments.length>1?arguments[1]:void 0)}});var Mh=k((function(e){var t=Object.prototype.hasOwnProperty,i="~";function n(){}function r(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function o(e,t,n,o,s){if("function"!=typeof n)throw new TypeError("The listener must be a function");var a=new r(n,o||e,s),c=i?i+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function s(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function a(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(i=!1)),a.prototype.eventNames=function(){var e,n,r=[];if(0===this._eventsCount)return r;for(n in e=this._events)t.call(e,n)&&r.push(i?n.slice(1):n);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(e)):r},a.prototype.listeners=function(e){var t=i?i+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var r=0,o=n.length,s=new Array(o);r<o;r++)s[r]=n[r].fn;return s},a.prototype.listenerCount=function(e){var t=i?i+e:e,n=this._events[t];return n?n.fn?1:n.length:0},a.prototype.emit=function(e,t,n,r,o,s){var a=i?i+e:e;if(!this._events[a])return!1;var c,u,d=this._events[a],l=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),l){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,n),!0;case 4:return d.fn.call(d.context,t,n,r),!0;case 5:return d.fn.call(d.context,t,n,r,o),!0;case 6:return d.fn.call(d.context,t,n,r,o,s),!0}for(u=1,c=new Array(l-1);u<l;u++)c[u-1]=arguments[u];d.fn.apply(d.context,c)}else{var h,p=d.length;for(u=0;u<p;u++)switch(d[u].once&&this.removeListener(e,d[u].fn,void 0,!0),l){case 1:d[u].fn.call(d[u].context);break;case 2:d[u].fn.call(d[u].context,t);break;case 3:d[u].fn.call(d[u].context,t,n);break;case 4:d[u].fn.call(d[u].context,t,n,r);break;default:if(!c)for(h=1,c=new Array(l-1);h<l;h++)c[h-1]=arguments[h];d[u].fn.apply(d[u].context,c)}}return!0},a.prototype.on=function(e,t,i){return o(this,e,t,i,!1)},a.prototype.once=function(e,t,i){return o(this,e,t,i,!0)},a.prototype.removeListener=function(e,t,n,r){var o=i?i+e:e;if(!this._events[o])return this;if(!t)return s(this,o),this;var a=this._events[o];if(a.fn)a.fn!==t||r&&!a.once||n&&a.context!==n||s(this,o);else{for(var c=0,u=[],d=a.length;c<d;c++)(a[c].fn!==t||r&&!a[c].once||n&&a[c].context!==n)&&u.push(a[c]);u.length?this._events[o]=1===u.length?u[0]:u:s(this,o)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&s(this,t)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=i,a.EventEmitter=a,e.exports=a})),Lh="connection-state-changed",Nh="connected",Uh="error",Vh="DISCONNECTED",Fh="CONNECTING",jh="RECONNECTING",Bh="CONNECTED",Hh={ON_PUBLISH_RESPONSE:2,NEW_ICE_CANDIDATE:4,CLINET_BANNED:8,CHANNEL_SETUP_SUCCESS:19,CHANNEL_SETUP_FAILED:80,REBUILD_SESSION_RESULT:514,JOIN_ROOM_RESULT:20,PEER_JOIN:4134,PEER_LEAVE:4135,STREAM_ADDED:16,STREAM_REMOVED:18,UPDATE_REMOTE_SDP:48,UPDATE_AUDIO_SSRC:50,UPDATE_VIDEO_SSRC:52,UPLINK_NETWORK_STATS:22,UPDATE_REMOTE_MUTE_STAT:23,CLOSE_PEER_ACK:10,SUBSCRIBE_ACK:26,PONG:775,PUBLISH_RESULT:4098,UNPUBLISH_RESULT:4100,SUBSCRIBE_RESULT:4102,UNSUBSCRIBE_RESULT:4104,SUBSCRIBE_CHANGE_RESULT:4106,UPDATE_OFFER_RESULT:4128,REMOTE_STREAM_UPDATE:4130,START_PUBLISH_TENCENT_CDN_RES:1286,STOP_PUBLISH_TENCENT_CDN_RES:1288,START_PUBLISH_GIVEN_CDN_RES:777,STOP_PUBLISH_GIVEN_CDN_RES:779,START_MIX_TRANSCODE_RES:781,STOP_MIX_TRANSCODE_RES:783,USER_LIST_RES:4137,SWITCH_ROLE_RES:4110},Gh=[Hh.UPDATE_REMOTE_MUTE_STAT,Hh.UPLINK_NETWORK_STATS,Hh.PONG,Hh.REMOTE_STREAM_UPDATE,Hh.USER_LIST_RES],qh={ON_PUBLISH_RESPONSE:"on-publish-response",NEW_ICE_CANDIDATE:"new-ice-candidate",CLINET_BANNED:"client-banned",CHANNEL_SETUP_SUCCESS:"channel-setup-success",CHANNEL_SETUP_FAILED:"channel-setup-failed",REBUILD_SESSION_RESULT:"channel-reconnect-result",JOIN_ROOM_RESULT:"join-room-result",PEER_JOIN:"peer-join",PEER_LEAVE:"peer-leave",STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",UPDATE_REMOTE_SDP:"update-remote-sdp",UPDATE_AUDIO_SSRC:"update-audio-ssrc",UPDATE_VIDEO_SSRC:"update-video-ssrc",UPLINK_NETWORK_STATS:"uplink-network-stats",UPDATE_REMOTE_MUTE_STAT:"update-remote-mute-stat",CLOSE_PEER_ACK:"close-peer-ack",SUBSCRIBE_ACK:"subscribe-ack",REQUEST_REBUILD_SESSION:"request-rebuild-session",CLIENT_REJOIN:"client-rejoin",PONG:"pong",PUBLISH_RESULT:"publish-result",UNPUBLISH_RESULT:"unpublish-result",SUBSCRIBE_RESULT:"subscribe-result",SUBSCRIBE_CHANGE_RESULT:"subscribe-change-result",UNSUBSCRIBE_RESULT:"unsubscribe-result",UPDATE_OFFER_RESULT:"update-offer-result",REMOTE_STREAM_UPDATE:"remote-stream-update",START_PUBLISH_TENCENT_CDN_RES:"start-publish-tencent-cdn-res",STOP_PUBLISH_TENCENT_CDN_RES:"stop-publish-tencent-cdn-res",START_PUBLISH_GIVEN_CDN_RES:"start-publish-given-cdn-res",STOP_PUBLISH_GIVEN_CDN_RES:"stop-publish-given-cdn-res",START_MIX_TRANSCODE_RES:"start-mix-transcode-res",STOP_MIX_TRANSCODE_RES:"stop-mix-transcode-res",USER_LIST_RES:"user-list-res",SWITCH_ROLE_RES:"switch_role_res"},Jh="on_unpublish",Wh=new Map,zh=function(e,t){var i=Wh.get(e);i||(Wh.set(e,[]),i=Wh.get(e)),i.push(t)},$h=function(e){var t=Wh.get(e);return t?Wh.delete(e):t=[],t},Kh=Object.prototype.hasOwnProperty;function Yh(e){if(null==e)return!0;if("boolean"==typeof e)return!1;if("number"==typeof e)return 0===e;if("string"==typeof e)return 0===e.length;if("function"==typeof e)return 0===e.length;if(Array.isArray(e))return 0===e.length;if(e instanceof Error)return""===e.message;if(Mc(e))switch(Object.prototype.toString.call(e)){case"[object File]":case"[object Map]":case"[object Set]":return 0===e.size;case"[object Object]":for(var t in e)if(Kh.call(e,t))return!1;return!0}return!1}var Qh=/"/g,Xh=function(e,t,i,n){var r=Xi(B(e)),o="<"+t;return""!==i&&(o+=" "+i+'="'+Xi(n).replace(Qh,"&quot;")+'"'),o+">"+r+"</"+t+">"},Zh=function(e){return O((function(){var t=""[e]('"');return t!==t.toLowerCase()||t.split('"').length>3}))};gt({target:"String",proto:!0,forced:Zh("link")},{link:function(e){return Xh(this,"a","href",e)}});var ep="AVOID_REPEATED_CALL",tp="INVALID_PARAMETER_TYPE",ip="INVALID_PARAMETER_INSTANCE",np="SIGNAL_CHANNEL_RECONNECTION_FAILED",rp="INVALID_ROOMID_INTEGER",op="INVALID_REMOTE_STREAM",sp="INVALID_AUDIO_VOLUME",ap="INVALID_REPLACE_TRACK",cp="INVALID_STREAM_INITIALIZED",up="NOT_SUPPORTED_H264ENCODE",dp="NOT_SUPPORTED_H264DECODE",lp={AVOID_REPEATED_CALL:function(e){return"previous ".concat(e.name,"() is ongoing, please avoid repeated calls.")},INVALID_PARAMETER_REQUIRED:function(e){var t=e.key,i=e.rule,n=e.fnName,r=e.value;return"'".concat(t||i.name,"' is a required param when calling ").concat(n,"(), received: ").concat(r,".")},INVALID_PARAMETER_TYPE:function(e){var t,i=e.key,n=e.rule,r=e.fnName,o=e.value,s="".concat(i||n.name);return t=Array.isArray(n.type)?n.type.join("|"):n.type,"'".concat(s,"' must be type of ").concat(t," when calling ").concat(r,"(), received type: ").concat(jc(o),".")},INVALID_PARAMETER_EMPTY:function(e){var t=e.key,i=e.rule,n=e.fnName,r=e.value;return"'".concat(t||i.name,"' cannot be '").concat(r,"' when calling ").concat(n,"().")},INVALID_PARAMETER_INSTANCE:function(e){var t=e.key,i=e.rule,n=e.fnName,r=e.value,o="".concat(t||i.name),s="".concat(i.instanceOf.name||i.instanceOf);return"'".concat(o,"' must be instanceof ").concat(s," when calling ").concat(n,"(), received type: ").concat(jc(r),".")},INVALID_PARAMETER_RANGE:function(e){var t=e.key,i=e.rule,n=e.fnName,r=e.value;return"'".concat(t||i.name,"' must be one of ").concat(i.values.join("|")," when calling ").concat(n,"(), received: ").concat(r,".")},API_CALL_TIMEOUT:function(e){return"".concat(e.commandDesc||e.command," timeout observed.")},SIGNAL_CHANNEL_RECONNECTION_FAILED:"signal channel reconnection failed, please check your network.",SIGNAL_CHANNEL_SETUP_FAILED:function(e){return"SignalChannel setup failure: (errorCode: ".concat(e.errorCode,", errorMsg: ").concat(e.errorMsg," }).")},ERROR_MESSAGE:function(e){var t="".concat(e.type," failed");return e.message&&(t="".concat(t,": ").concat(e.message,".")),t},SUBSCRIPTION_TIMEOUT:"remote server does not respond to the subscription.",EXCHANGE_SDP_TIMEOUT:"exchange sdp timeout.",DOWNLINK_RECONNECTION_FAILED:"downlink reconnection failed, please check your network and re-join room.",EXCHANGE_SDP_FAILED:function(e){return"exchange sdp failed ".concat(e.errMsg,".")},UPDATE_OFFER_TIMEOUT:"update offer timeout observed.",UPLINK_RECONNECTION_FAILED:"uplink reconnection failed, please check your network and publish again.",AUDIO:function(e){return e.error.toString()+" <audio>"},VIDEO:function(e){return e.error.toString()+" <video>"},INVALID_RECORDID:"recordId must be an integer number.",INVALID_PURE_AUDIO:"pureAudioPushMode must be 1 or 2.",INVALID_STREAMID:"streamId must be a sting literal within 64 bytes, and not be empty.",INVALID_USER_DEFINE_RECORDID:"userDefineRecordId must be a sting literal contains (a-zA-Z),(0-9), underline and hyphen, within 64 bytes, and not be empty.",INVALID_USER_DEFINE_PUSH_ARGS:"userDefinePushArgs must be a sting literal within 256 bytes, and not be empty.",INVALID_PROXY:'proxy server url must start with "wss://".',INVALID_JOIN:"duplicate join() called.",INVALID_ROOMID_STRING:"roomId must be validate string when useStringRoomId is true.",INVALID_ROOMID_INTEGER:"roomId must be a integer between [1, 4294967294] when useStringRoomId is false.",INVALID_SIGNAL_CHANNEL:"SignalChannel is not ready yet.",JOIN_ROOM_TIMEOUT:"join room timeout.",JOIN_ROOM_FAILED:function(e){return"Failed to join room - "+e.error},REJOIN_ROOM_FAILED:function(e){return"reJoin room: ".concat(e.roomId," failed, please check your network.")},INVALID_LEAVE:"please call leave() before destroy().",INVALID_PUBLISH:"please call join() before publish().",INVALID_UNPUBLISH:"stream has not been published yet.",INVALID_AUDIENCE:"no permission to publish() under live/".concat("audience",', please call switchRole("').concat("anchor",'") firstly before publish().'),INVALID_INITIALIZE:"cannot publish stream because stream is not initialized or is switching device.",INVALID_DUPLICATE_PUBLISHING:"duplicate publishing, please unpublish and then re-publish.",INVALID_SUBSCRIBE_UNDEFINED:"stream is undefined or null.",INVALID_SUBSCRIBE_LOCAL:"stream cannot be LocalStream.",INVALID_REMOTE_STREAM:"remoteStream does not exist because it has been unpublished by remote peer.",SUBSCRIBE_FAILED:function(e){return"failed to subscribe stream, reason: ".concat(e.message,".")},INVALID_ROLE:"switchRole can only be called in live mode.",INVALID_PARAMETER_SWITCH_ROLE:"role could only be set to a value as ".concat("anchor"," or ").concat("audience","."),INVALID_OPERATION_SWITCH_ROLE:"please call join() before switchRole().",SWITCH_ROLE_TIMEOUT:"switchRole timeout.",SWITCH_ROLE_FAILED:function(e){return"switchRole failed, errCode: ".concat(e.errCode," errMsg: ").concat(e.errMsg,".")},CLIENT_BANNED:function(e){return"client was banned because of "+e.reason+"."},INVALID_OPERATION_START_PUBLISH_CDN:"please call publish() before startPublishCDNStream().",INVALID_OPERATION_STOP_PUBLISH_CDN:"please call startPublishCDNStream() before stopPublishCDNStream().",INVALID_PARAMETER_START_PUBLISH_CDN:"streamId must be valid string or undefined.",START_PUBLISH_CDN_FAILED:function(e){return"startPublishCDNStream failed, errMsg: ".concat(e.message,".")},STOP_PUBLISH_CDN_FAILED:function(e){return"stopPublishCDNStream failed, errMsg: ".concat(e.message,".")},START_MIX_TRANSCODE:"please call startMixTranscode() after join().",STOP_MIX_TRANSCODE:"please call stopMixTranscode() after startMixTranscode().",INVALID_AUDIO_VOLUME:"interval must be a number.",ENABLE_SMALL_STREAM_PUBLISHED:"Cannot enable small stream after localStream published.",DISABLE_SMALL_STREAM_PUBLISHED:"Cannot disable small stream after localStream published.",NOT_SUPPORTED_SMALL_STREAM:"your browser does not support opening small stream.",INVALID_SMALL_STREAM_PROFILE:"small stream profile is invalid.",INVALID_PARAMETER_REMOTE_STREAM:"remoteStream is invalid.",REMOTE_NOT_PUBLISH_SMALL_STREAM:"remote peer does not publish small stream.",INVALID_SWITCH_DEVICE:"cannot switch device on current stream.",INVALID_SWITCH_DEVICE_PUBLISHING:"cannot switch device when publishing localStream.",INVALID_REPLACE_TRACK:"cannot replace track when publishing localStream.",INVALID_INITIALIZE_LOCAL_STREAM:"local stream has not initialized yet.",INVALID_ADD_TRACK_REPETITIVE:"previous addTrack is ongoing, please avoid repetitive execution.",INVALID_ADD_TRACK_REMOVING:"cannot add track when a track is removing.",INVALID_ADD_TRACK_PUBLISHING:"cannot add track when publishing localStream.",INVALID_STREAM_INITIALIZED:"your local stream haven't been initialized yet.",INVALID_ADD_TRACK_NUMBER:"a Stream has at most one audio track and one video track.",INVALID_REMOVE_AUDIO_TRACK:"remove audio track is not supported.",INVALID_REMOVE_AUDIO_ADDING:"cannot remove track when a track is adding.",INVALID_REMOVE_AUDIO_ON:"previous removeTrack is ongoing, please avoid repetitive execution.",INVALID_REMOVE_TRACK_PUBLISHING:"cannot remove track when publishing localStream.",INVALID_REMOVE_TRACK_NOT_PUBLISHING:"the track to be removed is not being publishing.",INVALID_REMOVE_TRACK_NUMBER:"remove the only video track is not supported, please use replaceTrack or muteVideo.",INVALID_REMOVE_TRACK_NOT_PUBLISHED:function(e){return"try to replace ".concat(e.kind," track but there's no previous ").concat(e.kind," being published.")},START_MIX_TRANSCODE_TIMEOUT:"startMixTranscode timeout.",START_MIX_TRANSCODE_FAILED:function(e){return"startMixTranscode failed, errMsg: ".concat(e.errMsg,".")},STOP_MIX_TRANSCODE_TIMEOUT:"stopMixTranscode timeout.",STOP_MIX_TRANSCODE_FAILED:function(e){return"stopMixTranscode failed, errMsg: ".concat(e.errMsg,".")},MIX_TRANSCODE_NOT_STARTED:"mixTranscode has not been started.",MIX_TRANSCODE_PARAM:"param should be object when start mix transcoding.",MIX_PARAMS_USER_ID:"userId is required.",MIX_PARAMS_RECT:"width and height cannot be less than 0.",MIX_PARAMS_LOCATION:"locationX and locationY cannot be less than 0.",MIX_PARAMS_ZORDER:"zOrder should between 1 and 15.",MIX_PARAMS_VIDEO:"videoWidth and videoHeight cannot be less than 0.",MIX_PARAMS_STREAM:"videoWidth and videoHeight of output stream should be contain all mix stream.",INVALID_PLAY:"duplicate play() call observed, please stop() firstly.",INVALID_USERID:"userId cannot be all spaces.",INVALID_CREATE_STREAM_SOURCE:"LocalStream must be created by createStream() with either audio/video or audioSource/videoSource, but can not be mixed with audio/video and audioSource/videoSource.",INVALID_CREATE_STREAM_SCREEN:"screen/video cannot be both true.",INVALID_CREATE_STREAM_AUDIO:"audio/screenAudio cannot be both true.",INVALID_CREATE_STREAM_SCREEN_AUDIO:"when screen is true, screenAudio can be configured.",NOT_SUPPORTED_HTTP:"not supported in http protocol, please use https protocol.",NOT_SUPPORTED_WEBRTC:"your browser does NOT support WebRTC!",NOT_SUPPORTED_TRTC:"your browser does NOT support TRTC! ",NOT_SUPPORTED_PROFILE:"your browser does not support setVideoProfile.",NOT_SUPPORTED_MEDIA:"your browser does not support navigator.mediaDevices.",NOT_SUPPORTED_H264ENCODE:"your device does not support H.264 encoding.",NOT_SUPPORTED_H264DECODE:"your device does not support H.264 decoding.",NOT_SUPPORTED_REPLACE_TRACK:"replaceTrack is not supported in this browser, please use switchDevice or addTrack instead.",NOT_SUPPORTED_CAPTURE:"captureScreen is not supported, please use chrome.",MICROPHONE_NOT_FOUND:"no microphone detected, please check your microphone and the configuration on TRTC.createStream.",CAMERA_NOT_FOUND:"no camera detected, please check your camera and the configuration on TRTC.createStream."},hp=ca+"module-ErrorCode.html";function pp(e){var t=e.key,i=e.data,n=e.link,r="",o="",s="";Yh(i)?r=lp[t]:Nc(lp[t])&&(r=lp[t](i));var a=function(){if(window.TRTC_ERROR_INFO&&window.TRTC_ERROR_LINK)return{TRTC_ERROR_INFO:window.TRTC_ERROR_INFO,TRTC_ERROR_LINK:window.TRTC_ERROR_LINK};var e=localStorage.getItem("trtc_error_assistance");if(e){e=JSON.parse(e);var t=document.createElement("script");t.type="text/javascript",t.text=e.message,document.body.appendChild(t);var i=window.TRTC_ERROR_INFO,n=window.TRTC_ERROR_LINK;return document.body.removeChild(t),{TRTC_ERROR_INFO:i,TRTC_ERROR_LINK:n}}return{}}(),c=a.TRTC_ERROR_INFO,u=a.TRTC_ERROR_LINK;c&&c[t]&&(Yh(i)?o=c[t]:Nc(c[t])&&(o=c[t](i))),n?s=ca+"".concat(n.className,".html#").concat("TRTC"===n.className?".":"").concat(n.fnName):u&&u[t]&&(s=ca+u[t]);var d=r;return(d+=" "+o)+(o?s?"查看文档："+s:"查看文档："+hp:s?"Refer to："+s:"Refer to："+hp)}var fp=function(){function e(t){s(this,e),this.client_=t.client,this.sdkAppId_=t.sdkAppId,this.userId_=t.userId,this.userSig_=t.userSig,this.url_=t.url,this.backupUrl_=t.backupUrl,this.version_=t.version,this.urlWithParam_="".concat(this.url_,"?sdkAppid=").concat(this.sdkAppId_,"&identifier=").concat(this.userId_,"&userSig=").concat(this.userSig_),this.backupUrlWithParam_="".concat(this.backupUrl_,"?sdkAppid=").concat(this.sdkAppId_,"&identifier=").concat(this.userId_,"&userSig=").concat(this.userSig_),this.isConnected_=!1,this.isConnecting_=!1,this.socketInUse_=null,this.socket_=null,this.backupSocket_=null,this.backupTimer_=-1,this.signalInfo_={},this.currentState_=Vh,this.reconnectionCount_=0,this.reconnectionTimer_=-1,this.seq_=0,this.pingPongTimeoutId_=-1,this.pingTimeoutId_=-1,this.emitter_=new Mh}var t;return c(e,[{key:"connect",value:function(){var e=this;Xu.info("connect to url: ".concat(this.urlWithParam_)),this.emitter_.emit(Lh,{prevState:this.currentState_,state:Fh}),this.currentState_=Fh,this.socket_=new WebSocket(this.urlWithParam_),this.bindSocket(this.socket_),this.backupTimer_=setTimeout((function(){e.isConnected_||(Xu.info("trying to connect to backupUrl"),e.tryConnectBackup())}),5e3)}},{key:"tryConnectBackup",value:function(){this.backupSocket_||(this.unbindAndCloseSocket("main"),Xu.debug("try to connect to url: ".concat(this.backupUrlWithParam_)),this.backupSocket_=new WebSocket(this.backupUrlWithParam_),this.bindSocket(this.backupSocket_))}},{key:"bindSocket",value:function(e){e.onopen=this.onopen.bind(this),e.onclose=this.onclose.bind(this),e.onerror=this.onerror.bind(this),e.onmessage=this.onmessage.bind(this)}},{key:"unbindSocket",value:function(e){e.onopen=function(){},e.onclose=function(){},e.onerror=function(){},e.onmessage=function(){}}},{key:"unbindAndCloseSocket",value:function(e){if("main"===e){if(this.socket_){this.unbindSocket(this.socket_);try{this.socket_.close(1e3)}catch(e){}this.socket_=null}}else if(this.backupSocket_){this.unbindSocket(this.backupSocket_);try{this.backupSocket_.close(1e3)}catch(e){}this.backupSocket_=null}}},{key:"clearBackupTimer",value:function(){-1!==this.backupTimer_&&(clearTimeout(this.backupTimer_),this.backupTimer_=-1)}},{key:"clearReconnectionTimer",value:function(){-1!==this.reconnectionTimer_&&(clearTimeout(this.reconnectionTimer_),this.reconnectionTimer_=-1)}},{key:"onopen",value:function(e){if(!this.isConnected_){this.isConnected_=!0,this.isConnecting_=!1,this.clearBackupTimer(),e.target===this.socket_?(this.unbindAndCloseSocket("backup"),this.socketInUse_=this.socket_):(this.unbindAndCloseSocket("main"),this.socketInUse_=this.backupSocket_);var t=e.target.url;Xu.info("[".concat(this.userId_,"] websocket[").concat(t,"] is connected")),this.emitter_.emit(Lh,{prevState:this.currentState_,state:Bh}),this.currentState_===Fh?this.addSignalEvent(32791,"signal channel is connected"):this.currentState_===jh&&this.addSignalEvent(32795,"signal channel reconnect success"),this.currentState_=Bh,this.emitter_.emit(Nh)}}},{key:"onclose",value:function(e){var t=e.target.url,i=e.target===this.socketInUse_;Xu.info("[".concat(this.userId_,"] websocket[").concat(t," InUse: ").concat(i,"] is closed with code: ").concat(e.code)),e.target===this.socketInUse_&&(this.isConnected_=!1,e.wasClean&&1e3===e.code?(this.emitter_.emit(Lh,{prevState:this.currentState_,state:Vh}),this.currentState_=Vh,this.addSignalEvent(32790,"signal channel is disconnected")):(Xu.warn("[".concat(this.userId_,"] onclose code:").concat(e.code," reason:").concat(e.reason)),Xu.warn("close current websocket and schedule a reconnect timeout"),this.socketInUse_.onclose=function(){},this.socketInUse_.close(4011),this.socket_=this.backupSocket_=this.socketInUse_=null,this.reconnect("main")))}},{key:"onerror",value:function(e){var t=e.target.url;Xu.debug("[".concat(this.userId_,"] websocket[").concat(t,"] error observed")),this.isConnected_?e.target===this.socketInUse_&&(this.isConnected_=!1,this.unbindAndCloseSocket("main"),this.unbindAndCloseSocket("backup"),this.socketInUse_=null,this.reconnect("main")):(this.isReconnecting_||Ac({eventType:Ls,code:ua.UNKNOWN}),e.target==this.socket_?(this.unbindAndCloseSocket("main"),this.reconnect("backup")):(this.unbindAndCloseSocket("backup"),this.reconnect("main"))),this.isConnecting_=!1,this.isConnected_=!1}},{key:"onmessage",value:function(e){var t=this;if(this.isConnected_){var i=JSON.parse(e.data),n=i.cmd,r=i.content,o=Object.values(Hh),s=Object.keys(Hh)[o.indexOf(n)],a=qh[s];if(!Gh.includes(n)){var c=e.target==this.socket_?this.url_:this.backupUrl_;if(Xu.debug("[".concat(this.userId_,"] websocket[").concat(c,"] received message: ").concat(e.data)),Xu.info("[".concat(this.userId_,"] Received event: [ ").concat(a||"unknown cmd: "+n," ]")),(a===qh.UPDATE_REMOTE_SDP||a===qh.UPDATE_AUDIO_SSRC||a===qh.UPDATE_VIDEO_SSRC)&&r.offersdp)try{var u=JSON.parse(r.offersdp),d=u.audiossrc,l=u.videossrc,h=u.rtxssrc;Xu.info("[".concat(this.userId_,"] ssrc info in offersdp: [ audiossrc: ").concat(d," videossrc: ").concat(l," rtxssrc: ").concat(h," ]"))}catch(m){}}switch(n){case Hh.CHANNEL_SETUP_SUCCESS:this.signalInfo_.relayIp=r.relayip,this.signalInfo_.relayInnerIp=r.innerip,this.signalInfo_.signalIp=r.signalip,this.signalInfo_.localIp=r.localip,this.signalInfo_.dataPort=r.dataport,this.signalInfo_.stunPort=r.stunport,this.signalInfo_.checkSigSeq=r.checkSigSeq,this.signalInfo_.socketId=r.socketid,this.signalInfo_.tinyId=r.tinyid,this.signalInfo_.openId=r.openid,this.signalInfo_.stunPortList=r.stunportList,!r.stunportList||r.stunportList.length<=0?this.signalInfo_.stunServers="stun:"+r.relayip+":"+r.stunport:(this.signalInfo_.stunServers=[],r.stunportList.forEach((function(e){var i="stun:"+r.relayip+":"+e;t.signalInfo_.stunServers.push(i)}))),r.cgiurl&&(this.signalInfo_.logCgiUrl=r.cgiurl),r.svrTime&&function(e){Sc=e-(new Date).getTime();var t=new Date;t.setTime(e),Xu.info("baseTime from server: "+t+" offset: "+Sc)}(r.svrTime),Xu.info("ChannelSetup Success: signalIp:".concat(r.signalip," relayIp:").concat(r.relayip," clientIp:").concat(r.localip," checkSigSeq:").concat(r.checkSigSeq)),Xu.info("start ping pong"),this.startPingPong(),this.isReconnecting_&&(this.reconnectionCount_=0,this.clearReconnectionTimer(),1===r.rc&&this.emitter_.emit(qh.REQUEST_REBUILD_SESSION,{signalInfo:this.signalInfo_})),this.emitter_.emit(a,{signalInfo:this.signalInfo_});break;case Hh.REBUILD_SESSION_RESULT:0===r.result?(Xu.info("reconnect - rebuild session succeeded"),this.client_.checkConnectionsToReconnect()):(this.emitter_.emit(qh.CLIENT_REJOIN),Xu.error("reconnect - rebuild session failed: ".concat(JSON.stringify(r))));break;case Hh.CHANNEL_SETUP_FAILED:if(!this.isReconnecting_){var p="sdkAppId invalid",f="";Uc(r.errorCode)||(p=r.errorCode,f=r.errorMsg);var m=new da({code:ua.SIGNAL_CHANNEL_SETUP_FAILED,extraCode:p,message:pp({key:"SIGNAL_CHANNEL_SETUP_FAILED",data:{errorCode:p,errorMsg:f}})});this.close(),Ac({eventType:Ls,error:m}),this.emitter_.emit(Uh,m)}break;default:this.emitter_.emit(a,{data:i})}}}},{key:"addSignalEvent",value:function(e,t){zh(this.userId_,{eventId:e,eventDesc:t,timestamp:Tc(),userId:this.userId_,tinyId:this.signalInfo_.tinyId})}},{key:"reconnect",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"main";if(this.isConnecting_||-1!==this.reconnectionTimer_)Xu.info("signal channel is reconnecting, ignoring current reconnection");else{if(this.reconnectionCount_>=30){Xu.warn("SDK has tried reconnect signal channel for ".concat(30," times, but all failed. please check your network"));var i=new da({code:ua.SIGNAL_CHANNEL_RECONNECTION_FAILED,message:pp({key:np})});return Ac({eventType:Ns,error:i}),this.addSignalEvent(32796,"signal channel reconnect fail"),void this.emitter_.emit(Uh,i)}this.isConnecting_=!0,this.reconnectionCount_++,this.currentState_!==jh&&(this.emitter_.emit(Lh,{prevState:this.currentState_,state:jh}),this.currentState_=jh,this.addSignalEvent(32794,"signal channel is reconnecting")),Xu.warn("reconnecting to ".concat(t," signal channel [").concat(this.reconnectionCount_,"/").concat(30,"]"));var n=this.getReconnectionUrl(t);"main"===t?(this.socket_=new WebSocket(n),this.bindSocket(this.socket_)):(this.backupSocket_=new WebSocket(n),this.bindSocket(this.backupSocket_));var r=Lc(this.reconnectionCount_);this.reconnectionTimer_=setTimeout((function(){Xu.warn("reconnect ".concat(t," signal channel timeout(").concat(r/1e3,"s), close and try again")),e.isConnecting_=!1,e.clearReconnectionTimer(),e.unbindAndCloseSocket(t),e.reconnect("main"===t?"backup":"main")}),r)}}},{key:"isConnected",value:function(){return this.isConnected_}},{key:"isReconnecting_",get:function(){return-1!==this.reconnectionTimer_}},{key:"getReconnectionUrl",value:function(e){var t="main"===e?this.urlWithParam_:this.backupUrlWithParam_;return Yh(this.signalInfo_)||-1!==t.indexOf("&rc=1")||(t+="&iip="+this.signalInfo_.relayInnerIp+"&dp="+this.signalInfo_.dataPort+"&oip="+this.signalInfo_.relayIp+"&sp="+this.signalInfo_.stunPort+"&rc=1"),t}},{key:"send",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;if(this.isConnected_){var n=this.createSendMessage(e);return n.data=t,void 0!==i&&(n.srctinyid=i),this.socketInUse_.send(JSON.stringify(n)),n.seq}}},{key:"sendWithoutUA",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2?arguments[2]:void 0;if(this.isConnected_){var n=this.createSendMessage(e,!1);return n.data=t,void 0!==i&&(n.srctinyid=i),this.socketInUse_.send(JSON.stringify(n)),n.seq}}},{key:"sendWithReport",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2?arguments[2]:void 0;if(this.isConnected_){var n=this.createSendMessage(e);return n.data=t,n.report=i,this.socketInUse_.send(JSON.stringify(n)),n.seq}}},{key:"sendWaitForResponse",value:function(e){var t=this,i=e.command,n=e.data,r=e.timeout,o=void 0===r?5e3:r,s=e.responseCommand,a=e.commandDesc;return new Promise((function(e,r){var c=setTimeout((function(){t.off(s,u);var e=new da({code:ua.API_CALL_TIMEOUT,message:pp({key:"API_CALL_TIMEOUT",data:{error:{commandDesc:a,command:i}}})});Xu.warn(e),r(e)}),o),u=function i(n){n.data.seq===d&&(clearTimeout(c),t.off(s,i),e(n))};t.on(s,u);var d=t.send(i,n,0)}))}},{key:"startPingPong",value:(t=o(regeneratorRuntime.mark((function e(){var t=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,-1===this.pingPongTimeoutId_){e.next=3;break}return e.abrupt("return");case 3:return e.next=5,this.ping();case 5:this.pingPongTimeoutId_=setTimeout((function(){t.pingPongTimeoutId_=-1,t.startPingPong()}),1e4),this.client_.isRelayMaybeFailed()&&this.emitter_.emit(qh.CLIENT_REJOIN),e.next=14;break;case 9:e.prev=9,e.t0=e.catch(0),Xu.warn("ping-pong failed, start signal reconnection"),this.close(),this.reconnect("main");case 14:case"end":return e.stop()}}),e,this,[[0,9]])}))),function(){return t.apply(this,arguments)})},{key:"stopPingPong",value:function(){Xu.info("stop ping pong"),clearTimeout(this.pingTimeoutId_),clearTimeout(this.pingPongTimeoutId_),this.pingTimeoutId_=-1,this.pingPongTimeoutId_=-1}},{key:"ping",value:function(){var e=this;return new Promise((function(t,i){if(-1!==e.pingTimeoutId_)return t();e.sendWithoutUA("ping"),e.once(qh.PONG,(function(){clearTimeout(e.pingTimeoutId_),e.pingTimeoutId_=-1,t()})),e.pingTimeoutId_=setTimeout((function(){e.pingTimeoutId_=-1,i()}),1e4)}))}},{key:"createSendMessage",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i={tag_key:e,data:"",openid:this.userId_,tinyid:this.signalInfo_.tinyId,version:this.version_,seq:++this.seq_};return t&&(i.ua=navigator.userAgent),i}},{key:"getCurrentState",value:function(){return this.currentState_}},{key:"getSocketId",value:function(){return this.signalInfo_.socketId}},{key:"close",value:function(){Xu.info("close SignalChannel"),this.clearBackupTimer(),this.clearReconnectionTimer(),this.stopPingPong(),this.isConnecting_=!1,this.isConnected_=!1,this.socketInUse_=null,this.unbindAndCloseSocket("main"),this.unbindAndCloseSocket("backup")}},{key:"on",value:function(e,t,i){this.emitter_.on(e,t,i)}},{key:"removeListener",value:function(e,t,i){this.emitter_.removeListener(e,t,i)}},{key:"once",value:function(e,t,i){this.emitter_.once(e,t,i)}},{key:"off",value:function(e,t,i){this.emitter_.off(e,t,i)}}]),e}(),mp=It.find,vp=!0;"find"in[]&&Array(1).find((function(){vp=!1})),gt({target:"Array",proto:!0,forced:vp},{find:function(e){return mp(this,e,arguments.length>1?arguments[1]:void 0)}}),qn("find");var gp=k((function(e){var t=e.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),(t+=null!=e["network-id"]?" network-id %d":"%v")+(null!=e["network-cost"]?" network-cost %d":"%v")}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",(t+=null!=e.rateNumerator?" rate=%s":"")+(null!=e.rateDenominator?"/%s":"")}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(t).forEach((function(e){t[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))})),_p=(gp.v,gp.o,gp.s,gp.i,gp.u,gp.e,gp.p,gp.z,gp.r,gp.t,gp.c,gp.b,gp.m,gp.a,k((function(e,t){var i=function(e){return String(Number(e))===e?Number(e):e},n=function(e,t,n){var r=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:r&&!t[e.name]&&(t[e.name]={});var o=e.push?{}:r?t[e.name]:t;!function(e,t,n,r){if(r&&!n)t[r]=i(e[1]);else for(var o=0;o<n.length;o+=1)null!=e[o+1]&&(t[n[o]]=i(e[o+1]))}(n.match(e.reg),o,e.names,e.name),e.push&&t[e.push].push(o)},r=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(e){var t={},i=[],o=t;return e.split(/(\r\n|\r|\n)/).filter(r).forEach((function(e){var t=e[0],r=e.slice(2);"m"===t&&(i.push({rtp:[],fmtp:[]}),o=i[i.length-1]);for(var s=0;s<(gp[t]||[]).length;s+=1){var a=gp[t][s];if(a.reg.test(r))return n(a,o,r)}})),t.media=i,t};var o=function(e,t){var n=t.split(/=(.+)/,2);return 2===n.length?e[n[0]]=i(n[1]):1===n.length&&t.length>1&&(e[n[0]]=void 0),e};t.parseParams=function(e){return e.split(/;\s?/).reduce(o,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(e){return e.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(e){for(var t=[],n=e.split(" ").map(i),r=0;r<n.length;r+=3)t.push({component:n[r],ip:n[r+1],port:n[r+2]});return t},t.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(o,{})}))},t.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var t,n=!1;return"~"!==e[0]?t=i(e):(t=i(e.substring(1,e.length)),n=!0),{scid:t,paused:n}}))}))}}))),yp=(_p.parse,_p.parseParams,_p.parseFmtpConfig,_p.parsePayloads,_p.parseRemoteCandidates,_p.parseImageAttributes,_p.parseSimulcastStreamList,/%[sdv%]/g),Sp=function(e){var t=1,i=arguments,n=i.length;return e.replace(yp,(function(e){if(t>=n)return e;var r=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(r);case"%d":return Number(r);case"%v":return""}}))},Tp=function(e,t,i){var n=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var r=0;r<t.names.length;r+=1){var o=t.names[r];t.name?n.push(i[t.name][o]):n.push(i[t.names[r]])}else n.push(i[t.name]);return Sp.apply(null,n)},Ep=["v","o","s","i","u","e","p","c","b","t","r","z","a"],bp=["i","c","b","a"],Rp={write:function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var i=t.outerOrder||Ep,n=t.innerOrder||bp,r=[];return i.forEach((function(t){gp[t].forEach((function(i){i.name in e&&null!=e[i.name]?r.push(Tp(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){r.push(Tp(t,i,e))}))}))})),e.media.forEach((function(e){r.push(Tp("m",gp.m[0],e)),n.forEach((function(t){gp[t].forEach((function(i){i.name in e&&null!=e[i.name]?r.push(Tp(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){r.push(Tp(t,i,e))}))}))}))})),r.join("\r\n")+"\r\n"},parse:_p.parse,parseParams:_p.parseParams,parseFmtpConfig:_p.parseFmtpConfig,parsePayloads:_p.parsePayloads,parseRemoteCandidates:_p.parseRemoteCandidates,parseImageAttributes:_p.parseImageAttributes,parseSimulcastStreamList:_p.parseSimulcastStreamList},Ip=function(e){return Rp.parse(e)},kp=function(e){return Rp.write(e)},wp=function(e){var t=Ip(e);return t.media.forEach((function(e){"audio"===e.type&&e.fmtp.forEach((function(e){e.config+=";sprop-stereo=1;stereo=1"}))})),kp(t)},Cp={result:!1,detail:{isBrowserSupported:!1,isWebRTCSupported:!1,isMediaDevicesSupported:!1,isH264EncodeSupported:!1,isVp8EncodeSupported:!1,isH264DecodeSupported:!1,isVp8DecodeSupported:!1}},Ap=function(){return!(Au||nu||ou&&su<80||tu&&iu<56)},Dp=function(){return["RTCPeerConnection","webkitRTCPeerConnection","RTCIceGatherer"].filter((function(e){return e in window})).length>0},Op=function(){if(!navigator.mediaDevices)return!1;var e=["getUserMedia","enumerateDevices"];return e.filter((function(e){return e in navigator.mediaDevices})).length===e.length},Pp=function(){var e=o(regeneratorRuntime.mark((function e(){var t,i,n,r,o,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Cp.detail.isH264EncodeSupported&&!Cp.detail.isVp8EncodeSupported){e.next=2;break}return e.abrupt("return",{isH264EncodeSupported:Cp.detail.isH264EncodeSupported,isVp8EncodeSupported:Cp.detail.isVp8EncodeSupported});case 2:return t="",i=!1,n=!1,e.prev=5,r=new RTCPeerConnection,(o=document.createElement("canvas")).getContext("2d"),s=o.captureStream(0),r.addTrack(s.getVideoTracks()[0],s),e.next=13,r.createOffer();case 13:return-1!==(t=e.sent).sdp.toLowerCase().indexOf("h264")&&(i=!0),-1!==t.sdp.toLowerCase().indexOf("vp8")&&(n=!0),r.close(),Cp.detail.isH264EncodeSupported=i,Cp.detail.isVp8EncodeSupported=n,e.abrupt("return",{isH264EncodeSupported:Cp.detail.isH264EncodeSupported,isVp8EncodeSupported:Cp.detail.isVp8EncodeSupported});case 22:return e.prev=22,e.t0=e.catch(5),e.abrupt("return",{isH264EncodeSupported:!1,isVp8EncodeSupported:!1});case 25:case"end":return e.stop()}}),e,null,[[5,22]])})));return function(){return e.apply(this,arguments)}}();function xp(){return Mp.apply(this,arguments)}function Mp(){return(Mp=o(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=o(regeneratorRuntime.mark((function e(t){var i,n,r,s,a,c,u,d,l,h,p,f,m,v;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i={encode:!1,decode:!1},n=null,e.prev=2,r=document.createElement("canvas"),s=r.getContext("2d"),r.width=640,r.height=480,a=setInterval((function(){s.fillText("test",Math.floor(640*Math.random()),Math.floor(480*Math.random()))}),33),c=-1,u=-1,n=function(){clearInterval(c),clearInterval(a),clearTimeout(u),l.close(),h.close(),d.getTracks().forEach((function(e){return e.stop()}))},u=setTimeout((function(){n(),t(i)}),3e3),d=r.captureStream(),l=new RTCPeerConnection({}),h=new RTCPeerConnection({offerToReceiveAudio:!0,offerToReceiveVideo:!0}),l.addEventListener("icecandidate",(function(e){return h.addIceCandidate(e.candidate)})),h.addEventListener("icecandidate",(function(e){return l.addIceCandidate(e.candidate)})),l.addTrack(d.getVideoTracks()[0],d),e.next=20,l.createOffer();case 20:return p=e.sent,e.next=23,l.setLocalDescription(p);case 23:return e.next=25,h.setRemoteDescription(p);case 25:return e.next=27,h.createAnswer();case 27:return f=e.sent,m=Ip(f.sdp),v=m.media[0].rtp.findIndex((function(e){return"H264"===e.codec})),m.media[0].rtp=[m.media[0].rtp[v]],m.media[0].fmtp=m.media[0].fmtp.filter((function(e){return e.payload===m.media[0].rtp[0].payload})),m.media[0].rtcpFb=m.media[0].rtcpFb.filter((function(e){return e.payload===m.media[0].rtp[0].payload})),f.sdp=kp(m),e.next=36,h.setLocalDescription(f);case 36:return e.next=38,l.setRemoteDescription(f);case 38:c=setInterval(o(regeneratorRuntime.mark((function e(){var r,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i.encode&&i.decode&&(n(),t(i)),e.next=3,l.getStats();case 3:return r=e.sent,e.next=6,h.getStats();case 6:o=e.sent,i.encode||r.forEach((function(e){"outbound-rtp"===e.type&&e.mediaType===ea&&e.framesEncoded>0&&(i.encode=!0)})),i.decode||o.forEach((function(e){"inbound-rtp"===e.type&&e.mediaType===ea&&e.framesDecoded>0&&(i.decode=!0)}));case 9:case"end":return e.stop()}}),e)}))),500),e.next=46;break;case 41:e.prev=41,e.t0=e.catch(2),n(),Xu.warn(e.t0),t(i);case 46:case"end":return e.stop()}}),e,null,[[2,41]])})));return function(t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Lp=function(){var e=o(regeneratorRuntime.mark((function e(){var t,i,n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Cp.detail.isH264DecodeSupported&&!Cp.detail.isVp8DecodeSupported){e.next=2;break}return e.abrupt("return",{isH264DecodeSupported:Cp.detail.isH264DecodeSupported,isVp8DecodeSupported:Cp.detail.isVp8DecodeSupported});case 2:return t="",i=!1,n=!1,e.prev=5,r=new RTCPeerConnection,e.next=9,r.createOffer({offerToReceiveAudio:1,offerToReceiveVideo:1});case 9:return-1!==(t=e.sent).sdp.toLowerCase().indexOf("h264")&&(i=!0),-1!==t.sdp.toLowerCase().indexOf("vp8")&&(n=!0),r.close(),e.abrupt("return",{isH264DecodeSupported:i,isVp8DecodeSupported:n});case 16:return e.prev=16,e.t0=e.catch(5),e.abrupt("return",{isH264DecodeSupported:!1,isVp8DecodeSupported:!1});case 19:case"end":return e.stop()}}),e,null,[[5,16]])})));return function(){return e.apply(this,arguments)}}(),Np=function(){var e=o(regeneratorRuntime.mark((function e(){var t,i,n,r,o,s,a,c,u,d,l,h;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Cp.result){e.next=2;break}return e.abrupt("return",Cp);case 2:return t=Ap(),i=Dp(),n=Op(),e.next=7,Pp();case 7:return r=e.sent,o=r.isH264EncodeSupported,s=r.isVp8EncodeSupported,e.next=12,Lp();case 12:if(a=e.sent,c=a.isH264DecodeSupported,u=a.isVp8DecodeSupported,Cp.result=t&&i&&n&&(o||s)&&(c||u),Cp.detail.isBrowserSupported=t,Cp.detail.isWebRTCSupported=i,Cp.detail.isMediaDevicesSupported=n,Cp.detail.isH264EncodeSupported=o,Cp.detail.isVp8EncodeSupported=s,Cp.detail.isH264DecodeSupported=c,Cp.detail.isVp8DecodeSupported=u,!o||!c||!Uu&&!Fu){e.next=32;break}return e.next=26,xp();case 26:d=e.sent,l=d.encode,h=d.decode,Cp.detail.isH264EncodeSupported=l,Cp.detail.isH264DecodeSupported=h,l&&h||Xu.error("".concat(navigator.userAgent," isH264EncodeSupported: ").concat(l," isH264DecodeSupported: ").concat(h));case 32:return Cp.result||Xu.error("".concat(navigator.userAgent," isBrowserSupported: ").concat(t," ")+"isWebRTCSupported: ".concat(i," isMediaSupported: ").concat(n," ")+"isH264EncodeSupported: ".concat(Cp.detail.isH264EncodeSupported," isVp8EncodeSupported: ").concat(s," ")+"isH264DecodeSupported: ".concat(Cp.detail.isH264DecodeSupported," isVp8DecodeSupported: ").concat(u," ")),e.abrupt("return",Cp);case 34:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),Up=function(){return!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia)},Vp=function(){return"RTCPeerConnection"in window&&"getReceivers"in window.RTCPeerConnection.prototype},Fp=function(){return"RTCPeerConnection"in window&&"getSenders"in window.RTCPeerConnection.prototype},jp=function(){return"RTCRtpSender"in window&&"setParameters"in window.RTCRtpSender.prototype&&Fp()},Bp=function(){return!!Uc(navigator.mediaDevices)&&(Xu.error(lp.NOT_SUPPORTED_MEDIA),!0)},Hp=function(){return"http:"===location.protocol&&!$u&&(Xu.error(lp.NOT_SUPPORTED_HTTP),!0)},Gp=function(e){return!("candidate-pair"!==e.type||!e.nominated||"in-progress"!==e.state&&"succeeded"!==e.state||"boolean"==typeof e.selected&&!e.selected)},qp=new Map([[eu,"Android"],[Zc,"iOS"],[ku,"Windows"],[wu,"MacOS"],[Cu,"Linux"]]),Jp=function(){var e="unknown";return qp.get(!0)&&(e=qp.get(!0)),e};function Wp(){var e="";return screen.width&&(e+=(screen.width?screen.width*window.devicePixelRatio:"")+" * "+(screen.height?screen.height*window.devicePixelRatio:"")),e}function zp(){var e=!1;return(navigator.getUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)&&(e=!0),e}function $p(){for(var e={isSupported:!1},t=["AudioContext","webkitAudioContext","mozAudioContext","msAudioContext"],i=0;i<t.length;i++)if(t[i]in window){e.isSupported=!0;break}return e.isSupported}function Kp(){return!mu&&!Zc&&!(!Ap()||!("captureStream"in HTMLCanvasElement.prototype))}Np();var Yp="stream-added",Qp="stream-removed",Xp="stream-updated",Zp="stream-subscribed",ef="error",tf="connection-state-changed",nf="stream-added",rf="peer-join",of="mute-audio",sf="mute-video",af="unmute-audio",cf="unmute-video",uf="network-quality",df="audio-volume",lf="error",hf="player-state-changed",pf="error",ff="player-state-changed",mf=function(){function e(t){s(this,e),this.prevReport_={},this.prevEncoderImplementation_="",this.prevQualityLimitationReason_=""}var t,i,n,r;return c(e,[{key:"getSenderStats",value:(r=o(regeneratorRuntime.mark((function e(t){var i,n,r,o=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i={audio:{bytesSent:0,packetsSent:0,audioLevel:0,totalAudioEnergy:0},video:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0,smallFramesEncoded:0,smallFPSCapture:0,smallFramesSent:0},rtt:0},n=t.getPeerConnection(),r=t.getSSRC(),!n){e.next=14;break}return e.prev=4,e.next=7,n.getStats();case 7:e.sent.forEach((function(e){if("outbound-rtp"===e.type)if("video"===e.mediaType){if(!tu&&Uc(e.trackId))return;e.ssrc!==r.video||Uc(e.encoderImplementation)||o.prevEncoderImplementation_===e.encoderImplementation||(Xu.debug("[".concat(t.getUserId(),"] encoderImplementation change to ").concat(e.encoderImplementation)),o.prevEncoderImplementation_=e.encoderImplementation),e.ssrc!==r.video||Uc(e.qualityLimitationReason)||o.prevQualityLimitationReason_===e.qualityLimitationReason||(Xu.debug("[".concat(t.getUserId(),"] qualityLimitationReason change to ").concat(e.qualityLimitationReason)),o.prevQualityLimitationReason_=e.qualityLimitationReason);var n=t.getSSRC();e.ssrc===n.video?(i.video.bytesSent=e.bytesSent,i.video.packetsSent=e.packetsSent,i.video.framesEncoded=e.framesEncoded):(i.video.smallBytesSent=e.bytesSent,i.video.smallFramesEncoded=e.framesEncoded)}else"audio"===e.mediaType&&(i.audio.bytesSent=e.bytesSent,i.audio.packetsSent=e.packetsSent);else"candidate-pair"===e.type?Gp(e)&&Fc(e.currentRoundTripTime)&&(i.rtt=Math.floor(1e3*e.currentRoundTripTime)):"track"===e.type?(Uc(e.frameWidth)||(e.trackIdentifier===t.getLocalStreamVideoTrackId()?(i.video.frameWidth=e.frameWidth,i.video.frameHeight=e.frameHeight,i.video.framesSent=e.framesSent):(i.video.smallFrameWidth=e.frameWidth,i.video.smallFrameHeight=e.frameHeight,i.video.smallFramesSent=e.framesSent)),Uc(e.audioLevel)||(i.audio.audioLevel=e.audioLevel||0)):"media-source"===e.type&&("audio"===e.kind?(i.audio.audioLevel=e.audioLevel||0,i.audio.totalAudioEnergy=e.totalAudioEnergy||0):"video"===e.kind&&(e.trackIdentifier===t.getLocalStreamVideoTrackId()?i.video.fpsCapture=e.framesPerSecond:i.video.smallFPSCapture=e.framesPerSecond))})),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(4),Xu.warn("failed to getStats on sender connection");case 14:return e.abrupt("return",i);case 15:case"end":return e.stop()}}),e,null,[[4,11]])}))),function(e){return r.apply(this,arguments)})},{key:"getReceiverStats",value:(n=o(regeneratorRuntime.mark((function e(t){var i,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i={tinyId:t.getTinyId(),userId:t.getUserId(),rtt:0,hasAudio:!1,hasVideo:!1,hasAuxiliary:!1,audio:{bytesReceived:0,packetsReceived:0,packetsLost:0,jitter:0,audioLevel:0,totalAudioEnergy:0},video:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0},auxiliary:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0}},!(n=t.getPeerConnection())){e.next=13;break}return e.prev=3,e.next=6,n.getStats();case 6:e.sent.forEach((function(e){if("inbound-rtp"===e.type){if("audio"===e.mediaType)i.audio.packetsReceived=e.packetsReceived,i.audio.bytesReceived=e.bytesReceived,i.audio.packetsLost=e.packetsLost,i.audio.jitter=e.jitter,i.hasAudio=!0;else if("video"===e.mediaType){if(tu&&0===e.bytesReceived)return;var n=t.getSSRC();e.ssrc===n.video&&(i.video.packetsReceived=e.packetsReceived,i.video.bytesReceived=e.bytesReceived,i.video.packetsLost=e.packetsLost,i.video.framesReceived=e.framesReceived,i.video.framesDecoded=e.framesDecoded,i.video.fpsDecoded=e.framesPerSecond,i.hasVideo=!0),e.ssrc===n.auxiliary&&(i.auxiliary.packetsReceived=e.packetsReceived,i.auxiliary.bytesReceived=e.bytesReceived,i.auxiliary.packetsLost=e.packetsLost,i.auxiliary.framesReceived=e.framesReceived,i.auxiliary.framesDecoded=e.framesDecoded,i.auxiliary.fpsDecoded=e.framesPerSecond,i.hasAuxiliary=!0)}}else"track"===e.type?(Uc(e.frameWidth)||(e.trackIdentifier===t.getMainStreamVideoTrackId()&&(i.video.frameWidth=e.frameWidth,i.video.frameHeight=e.frameHeight),e.trackIdentifier===t.getAuxStreamVideoTrackId()&&(i.auxiliary.frameWidth=e.frameWidth,i.auxiliary.frameHeight=e.frameHeight)),"audio"===e.kind&&(i.audio.audioLevel=e.audioLevel||0,i.audio.totalAudioEnergy=e.totalAudioEnergy||0)):"candidate-pair"===e.type&&Gp(e)&&Fc(e.currentRoundTripTime)&&(i.rtt=Math.floor(1e3*e.currentRoundTripTime))})),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(3),Xu.warn("failed to getStats on receiver connection");case 13:return e.abrupt("return",i);case 14:case"end":return e.stop()}}),e,null,[[3,10]])}))),function(e){return n.apply(this,arguments)})},{key:"getStats",value:(i=o(regeneratorRuntime.mark((function e(t,i){var n,r,o,s,a,c,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n={},!t){e.next=5;break}return e.next=4,this.getSenderStats(t);case 4:n=e.sent;case 5:r=[],o=b(i),e.prev=7,o.s();case 9:if((s=o.n()).done){e.next=17;break}return(a=y(s.value,2))[0],c=a[1],e.next=13,this.getReceiverStats(c);case 13:u=e.sent,r.push(u);case 15:e.next=9;break;case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(7),o.e(e.t0);case 22:return e.prev=22,o.f(),e.finish(22);case 25:return e.abrupt("return",{senderStats:n,receiverStats:r});case 26:case"end":return e.stop()}}),e,this,[[7,19,22,25]])}))),function(e,t){return i.apply(this,arguments)})},{key:"prepareReport",value:function(e){var t=e.stats,i=e.report,n=e.freezeMap;if(!Yh(t.senderStats)&&(i.uint32_delay=t.senderStats.rtt,i.RTTReportState.uint32_delay=t.senderStats.rtt,i.AudioReportState.sentAudioLevel=t.senderStats.audio.audioLevel,i.AudioReportState.sentAudioEnergy=t.senderStats.audio.totalAudioEnergy,i.AudioReportState.uint32_audio_enc_pkg_br=t.senderStats.audio.bytesSent,i.VideoReportState.uint32_video_snd_br=t.senderStats.video.bytesSent,i.VideoReportState.uint32_send_total_pkg=t.senderStats.video.packetsSent,i.VideoReportState.VideoEncState[0].uint32_enc_width=t.senderStats.video.frameWidth,i.VideoReportState.VideoEncState[0].uint32_enc_height=t.senderStats.video.frameHeight,i.VideoReportState.VideoEncState[0].uint32_enc_fps=t.senderStats.video.framesEncoded,i.VideoReportState.VideoEncState[0].uint32_capture_fps=t.senderStats.video.fpsCapture,i.VideoReportState.VideoEncState[0].uint32_send_fps=t.senderStats.video.framesSent,t.senderStats.video.smallBytesSent)){i.VideoReportState.uint32_small_video_snd_br=t.senderStats.video.smallBytesSent;var r={uint32_enc_width:t.senderStats.video.smallFrameWidth||0,uint32_enc_height:t.senderStats.video.smallFrameHeight||0,uint32_enc_fps:t.senderStats.video.smallFramesEncoded||0,uint32_capture_fps:t.senderStats.video.smallFPSCapture||0,uint32_send_fps:t.senderStats.video.smallFramesSent||0};i.VideoReportState.VideoEncState.push(r)}t.receiverStats.forEach((function(e){var t=e.userId;if(i.RTTReportState.RTTDecState.push({uint32_delay:e.rtt,uint64_sender_uin:e.tinyId}),e.hasAudio&&(i.AudioReportState.AudioDecState.push({uint32_audio_delay:0,uint32_audio_jitter:e.audio.jitter,uint32_audio_real_recv_pkg:e.audio.packetsReceived,uint32_audio_flow:e.audio.bytesReceived,uint32_audio_real_recv_br:0,uint64_sender_uin:e.tinyId,userId:e.userId,packetsLost:e.audio.packetsLost,totalPacketsLost:e.audio.packetsLost,audioLevel:e.audio.audioLevel,audioEnergy:e.audio.totalAudioEnergy}),i.AudioReportState.uint32_audio_real_recv_pkg+=e.audio.packetsReceived,i.AudioReportState.uint32_audio_flow+=e.audio.bytesReceived,i.uint32_real_num+=e.audio.packetsReceived),e.hasVideo){var r=n.get(t+"_main"),o=r?r.duration:0;i.VideoReportState.VideoDecState.push({uint32_video_recv_fps:e.video.framesReceived,uint32_video_dec_fps:e.video.fpsDecoded,uint32_video_recv_br:e.video.bytesReceived,uint32_video_real_recv_pkg:e.video.packetsReceived,uint32_dec_height:e.video.frameHeight,uint32_dec_width:e.video.frameWidth,uint32_video_jitter:0,uint64_sender_uin:e.tinyId,userId:e.userId,packetsLost:e.video.packetsLost,totalPacketsLost:e.video.packetsLost,uint32_video_strtype:0,int32_video_freeze_ms:o}),i.VideoReportState.uint32_video_total_real_recv_pkg+=e.video.packetsReceived,i.VideoReportState.uint32_video_rcv_br+=e.video.bytesReceived}if(e.hasAuxiliary){var s=n.get(t+"_auxiliary"),a=s?s.duration:0;i.VideoReportState.VideoDecState.push({uint32_video_recv_fps:e.auxiliary.framesReceived,uint32_video_dec_fps:e.auxiliary.fpsDecoded,uint32_video_recv_br:e.auxiliary.bytesReceived,uint32_video_real_recv_pkg:e.auxiliary.packetsReceived,uint32_dec_height:e.auxiliary.frameHeight,uint32_dec_width:e.auxiliary.frameWidth,uint32_video_jitter:0,uint64_sender_uin:e.tinyId,userId:e.userId,packetsLost:e.auxiliary.packetsLost,totalPacketsLost:e.auxiliary.packetsLost,uint32_video_strtype:2,int32_video_freeze_ms:a})}})),i.uint64_end_utime=(new Date).getTime();var o=this.prevReport_;if(this.prevReport_=JSON.parse(JSON.stringify(i)),Yh(o))i.AudioReportState.uint32_audio_enc_pkg_br=8*i.AudioReportState.uint32_audio_enc_pkg_br/2,i.VideoReportState.uint32_video_rcv_br=8*i.VideoReportState.uint32_video_rcv_br/2,i.VideoReportState.uint32_video_snd_br=8*i.VideoReportState.uint32_video_snd_br/2,i.VideoReportState.uint32_small_video_snd_br&&(i.VideoReportState.uint32_small_video_snd_br=8*i.VideoReportState.uint32_small_video_snd_br/2),i.VideoReportState.VideoDecState.forEach((function(e){e.uint32_video_recv_br=8*e.uint32_video_recv_br/2,i.uint32_total_send_bps=i.AudioReportState.uint32_audio_enc_pkg_br+i.VideoReportState.uint32_video_snd_br}));else{if(i.uint64_begine_utime=o.uint64_end_utime,i.uint32_real_num-=o.uint32_real_num,i.uint32_real_num<=0&&(i.uint32_real_num=0),i.AudioReportState.uint32_audio_real_recv_pkg-=o.AudioReportState.uint32_audio_real_recv_pkg,i.AudioReportState.uint32_audio_real_recv_pkg<=0&&(i.AudioReportState.uint32_audio_real_recv_pkg=0),i.AudioReportState.uint32_audio_enc_pkg_br-=o.AudioReportState.uint32_audio_enc_pkg_br,i.AudioReportState.uint32_audio_enc_pkg_br<=0&&(i.AudioReportState.uint32_audio_enc_pkg_br=0),i.AudioReportState.uint32_audio_enc_pkg_br=8*i.AudioReportState.uint32_audio_enc_pkg_br/2,i.VideoReportState.uint32_video_snd_br-=o.VideoReportState.uint32_video_snd_br,i.VideoReportState.uint32_video_snd_br<=0&&(i.VideoReportState.uint32_video_snd_br=0),i.VideoReportState.uint32_video_snd_br=8*i.VideoReportState.uint32_video_snd_br/2,i.VideoReportState.uint32_small_video_snd_br&&(i.VideoReportState.uint32_small_video_snd_br-=o.VideoReportState.uint32_small_video_snd_br,i.VideoReportState.uint32_small_video_snd_br<=0&&(i.VideoReportState.uint32_small_video_snd_br=0),i.VideoReportState.uint32_small_video_snd_br=8*i.VideoReportState.uint32_small_video_snd_br/2),i.AudioReportState.uint32_audio_flow-=o.AudioReportState.uint32_audio_flow,i.AudioReportState.uint32_audio_flow<=0&&(i.AudioReportState.uint32_audio_flow=0),i.VideoReportState.uint32_send_total_pkg-=o.VideoReportState.uint32_send_total_pkg,i.VideoReportState.uint32_send_total_pkg<=0&&(i.VideoReportState.uint32_send_total_pkg=0),i.VideoReportState.uint32_video_rcv_br-=o.VideoReportState.uint32_video_rcv_br,i.VideoReportState.uint32_video_rcv_br<=0&&(i.VideoReportState.uint32_video_rcv_br=0),i.VideoReportState.uint32_video_rcv_br=8*i.VideoReportState.uint32_video_rcv_br/2,i.VideoReportState.uint32_video_total_real_recv_pkg-=o.VideoReportState.uint32_video_total_real_recv_pkg,i.VideoReportState.uint32_video_total_real_recv_pkg<=0&&(i.VideoReportState.uint32_video_total_real_recv_pkg=0),i.VideoReportState.VideoEncState[0].uint32_enc_fps-=o.VideoReportState.VideoEncState[0].uint32_enc_fps,i.VideoReportState.VideoEncState[0].uint32_enc_fps<0&&(i.VideoReportState.VideoEncState[0].uint32_enc_fps=0),i.VideoReportState.VideoEncState[0].uint32_enc_fps=i.VideoReportState.VideoEncState[0].uint32_enc_fps/2,i.VideoReportState.VideoEncState[0].uint32_send_fps-=o.VideoReportState.VideoEncState[0].uint32_send_fps,i.VideoReportState.VideoEncState[0].uint32_send_fps<0&&(i.VideoReportState.VideoEncState[0].uint32_send_fps=0),i.VideoReportState.VideoEncState[0].uint32_send_fps=i.VideoReportState.VideoEncState[0].uint32_send_fps/2,i.VideoReportState.VideoEncState[1]){var s=0,a=0;o.VideoReportState.VideoEncState[1]&&(s=o.VideoReportState.VideoEncState[1].uint32_enc_fps,a=o.VideoReportState.VideoEncState[1].uint32_enc_fps),i.VideoReportState.VideoEncState[1].uint32_enc_fps-=s,i.VideoReportState.VideoEncState[1].uint32_enc_fps<0&&(i.VideoReportState.VideoEncState[1].uint32_enc_fps=0),i.VideoReportState.VideoEncState[1].uint32_enc_fps=i.VideoReportState.VideoEncState[1].uint32_enc_fps/2,i.VideoReportState.VideoEncState[1].uint32_send_fps-=a,i.VideoReportState.VideoEncState[1].uint32_send_fps<0&&(i.VideoReportState.VideoEncState[1].uint32_send_fps=0),i.VideoReportState.VideoEncState[1].uint32_send_fps=i.VideoReportState.VideoEncState[1].uint32_send_fps/2}for(var c=i.VideoReportState.VideoDecState.length,u=0;u<c;u++){for(var d=i.VideoReportState.VideoDecState[u],l=d.uint64_sender_uin,h=d.uint32_video_strtype,p=d.uint32_video_real_recv_pkg,f=d.uint32_video_recv_br,m=d.uint32_video_recv_fps,v=0;v<o.VideoReportState.VideoDecState.length;v++){var g=o.VideoReportState.VideoDecState[v];if(g.uint64_sender_uin===l&&g.uint32_video_strtype===h){d.packetsLost=d.totalPacketsLost-g.totalPacketsLost,(p-=g.uint32_video_real_recv_pkg)<=0&&(p=0),(f-=g.uint32_video_recv_br)<=0&&(f=0),(m-=g.uint32_video_recv_fps)<0&&(m=0);break}}i.VideoReportState.VideoDecState[u].uint32_video_real_recv_pkg=p,i.VideoReportState.VideoDecState[u].uint32_video_recv_br=8*f/2,i.VideoReportState.VideoDecState[u].uint32_video_recv_fps=m/2}c=i.AudioReportState.AudioDecState.length;for(var _=0;_<c;_++){for(var y=i.AudioReportState.AudioDecState[_],S=y.uint32_audio_real_recv_pkg,T=y.uint32_audio_flow,E=y.uint64_sender_uin,b=0;b<o.AudioReportState.AudioDecState.length;b++){var R=o.AudioReportState.AudioDecState[b];if(R.uint64_sender_uin===E){y.packetsLost=y.totalPacketsLost-R.totalPacketsLost,(S-=R.uint32_audio_real_recv_pkg)<=0&&(S=0),(T-=R.uint32_audio_flow)<=0&&(T=0);break}}i.AudioReportState.AudioDecState[_].uint32_audio_real_recv_pkg=S,i.AudioReportState.AudioDecState[_].uint32_audio_flow=T,i.AudioReportState.AudioDecState[_].uint32_audio_real_recv_br=8*T/2}i.AudioReportState.uint32_audio_real_recv_br=8*i.AudioReportState.uint32_audio_flow/2,i.uint32_real_num=i.AudioReportState.uint32_audio_real_recv_pkg+i.VideoReportState.uint32_video_total_real_recv_pkg,i.uint32_total_send_bps=i.AudioReportState.uint32_audio_enc_pkg_br+i.VideoReportState.uint32_video_snd_br,i.uint32_total_recv_bps=i.AudioReportState.uint32_audio_real_recv_br+i.VideoReportState.uint32_video_rcv_br}return i}},{key:"getStatsReport",value:(t=o(regeneratorRuntime.mark((function e(t){var i,n,r,o,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t.uplinkConnection,n=t.downlinkConnections,r=t.freezeMap,o={uint64_begine_utime:(new Date).getTime(),uint64_end_utime:0,uint32_real_num:0,uint32_delay:0,uint32_CPU_curfreq:0,uint32_total_send_bps:0,uint32_total_recv_bps:0,AudioReportState:{uint32_audio_enc_pkg_br:0,uint32_audio_real_recv_pkg:0,uint32_audio_flow:0,uint32_audio_real_recv_br:0,uint32_audio_delay:0,uint32_audio_jitter:0,uint32_microphone_status:1,sentAudioLevel:0,sentAudioEnergy:0,AudioDecState:[]},VideoReportState:{uint32_video_delay:0,uint32_video_snd_br:0,uint32_video_total_real_recv_pkg:0,uint32_video_rcv_br:0,uint32_send_total_pkg:0,VideoEncState:[{uint32_enc_width:0,uint32_enc_height:0,uint32_capture_fps:0,uint32_enc_fps:0,uint32_send_fps:0}],VideoDecState:[]},RTTReportState:{uint32_delay:0,RTTDecState:[]}},e.next=4,this.getStats(i,n);case 4:return s=e.sent,this.prepareReport({stats:s,report:o,freezeMap:r}),e.abrupt("return",o);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),e}(),vf=function(){function e(t){s(this,e),this.id_=t.id,this.direction_=t.direction,this.type_=t.type,this.directionPrefix_="local"===this.direction_?"":"*"}return c(e,[{key:"log",value:function(e,t){Xu[e]("[".concat(this.directionPrefix_).concat(this.id_,"] ").concat(this.type_," ").concat(t))}},{key:"info",value:function(e){this.log("info",e)}},{key:"debug",value:function(e){this.log("debug",e)}},{key:"warn",value:function(e){this.log("warn",e)}},{key:"error",value:function(e){this.log("error",e)}}]),e}(),gf=new Mh,_f={JOIN_START:1,JOIN_SEND_CMD:2,JOIN_RECEIVED_CMD_RES:3,JOIN_SUCCESS:4,JOIN_FAILED:5,LEAVE_START:20,LEAVE_SEND_CMD:21,LEAVE_SUCCESS:22,HEARTBEAT_STATS:23,RECEIVED_PUBLISHED_USER_LIST:24,CALL_STATS:25,PUBLISH_START:27,STREAM_PLAY_SUCCESS:100,PLAYER_STATE_CHANGED:101,VIDEO_PLAYING:102,AUDIO_PLAYING:103,REMOTE_STREAM_TRACK_UPDATED:110,REMOTE_STREAM_ADDED:111,REMOTE_STREAM_SUBSCRIBE_START:112,REMOTE_STREAM_SUBSCRIBED:113,REMOTE_STREAM_UNSUBSCRIBED:114,REMOTE_STREAM_UPDATED:115,REMOTE_STREAM_REMOVED:116,LOCAL_STREAM_PUBLISHED:120,LOCAL_STREAM_INITIALIZE_START:121,LOCAL_STREAM_INITIALIZE_END:122,LOCAL_STREAM_INITIALIZE_FAILED:123,VIDEO_TRACK_MUTED:130,VIDEO_TRACK_UNMUTED:131,PLAY_STREAM_START:132,VIDEO_LOADED_DATA:133,PLAY_VIDEO_START:134,VIDEO_TRACK_ENDED:135,AUDIO_TRACK_MUTED:136,AUDIO_TRACK_ENDED:137,CONNECTION_STATE_CHANGED:200,CONNECTION_SEND_SUBSCRIBE_CMD:201,NETWORK_QUALITY:300},yf=function(){function e(t){var i=t.signalChannel,n=t.connections,r=t.userId,o=t.client;s(this,e),this.client_=o,this.signalChannel_=i,this.connections_=n,this.log_=new vf({id:"q|"+r,direction:"local",type:""}),this.uplinkConnection_=null,this.uplinkNetworkQuality_=0,this.uplinkRTT_=0,this.uplinkLoss_=0,this.downlinkNetworkQuality_=0,this.downlinkRTT_=0,this.downlinkLoss_=0,this.downlinkPrevStatMap_=new Map,this.downlinkLossAndRTTMap_=new Map,this.interval_=-1,this.emitter_=new Mh,this.initialize()}var t,i;return c(e,[{key:"uplinkNetworkQuality",get:function(){return this.uplinkNetworkQuality_},set:function(e){e!==this.uplinkNetworkQuality_&&this.log_.info("uplink network quality change ".concat(this.uplinkNetworkQuality," -> ").concat(e,", rtt: ").concat(this.uplinkRTT_,", loss: ").concat(this.uplinkLoss_)),this.uplinkNetworkQuality_=e}},{key:"downlinkNetworkQuality",get:function(){return this.downlinkNetworkQuality_},set:function(e){if(e!==this.downlinkNetworkQuality_){var t=this.getAverageLossAndRTT(S(this.downlinkLossAndRTTMap_.values())),i=t.rtt,n=t.loss;this.log_.info("downlink network quality change ".concat(this.downlinkNetworkQuality," -> ").concat(e,", rtt: ").concat(i,", loss: ").concat(n))}this.downlinkNetworkQuality_=e}},{key:"initialize",value:function(){var e=this;this.signalChannel_.on(qh.UPLINK_NETWORK_STATS,(function(t){e.handleUplinkNetworkQuality(t)})),this.signalChannel_.on(Lh,this.handleSignalConnectionStateChange.bind(this)),this.start()}},{key:"handleUplinkNetworkQuality",value:function(e){if(!this.uplinkConnection_)return this.uplinkNetworkQuality=0,this.uplinkLoss_=0,void(this.uplinkRTT_=0);var t=this.uplinkConnection_.getPeerConnection();if(t&&this.isPeerConnectionDisconnected(t))return this.uplinkNetworkQuality=6,this.uplinkLoss_=0,void(this.uplinkRTT_=0);var i=e.data.content;if(0===i.result){var n=i.expectAudPkg+i.expectVidPkg,r=i.recvAudPkg+i.recvVidPkg,o=n-r;if(0===n&&0===r)return;this.uplinkLoss_=o<=0?0:Math.round(o/n*100),this.uplinkRTT_=i.rtt,this.uplinkNetworkQuality=this.getNetworkQuality(this.uplinkLoss_,this.uplinkRTT_)}}},{key:"handleDownlinkNetworkQuality",value:(i=o(regeneratorRuntime.mark((function e(){var t,i,n,r,o,s,a,c,u,d,l,h,p,f,m,v=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.connections_&&0!==this.connections_.size){e.next=3;break}return this.downlinkNetworkQuality=0,e.abrupt("return");case 3:if(t=S(this.connections_.values()),i=t.filter((function(e){return e.getPeerConnection()&&"connected"===e.getPeerConnection().connectionState})),t.filter((function(e){return e.getPeerConnection()&&v.isPeerConnectionDisconnected(e.getPeerConnection())})).length!==t.length){e.next=9;break}return this.downlinkNetworkQuality=6,e.abrupt("return");case 9:n=0;case 10:if(!(n<i.length)){e.next=31;break}return r=i[n].getPeerConnection(),e.next=14,this.getStat(r);case 14:if(o=e.sent,s=o.rtt,a=o.totalPacketsLost,c=o.totalPacketsReceived,this.downlinkPrevStatMap_.has(r)){e.next=21;break}return this.downlinkPrevStatMap_.set(r,{totalPacketsLost:a,totalPacketsReceived:c}),e.abrupt("continue",28);case 21:d=this.downlinkPrevStatMap_.get(r),l=a-d.totalPacketsLost,h=c-d.totalPacketsReceived,u=l<=0||h<0?0:Math.round(l/(l+h)*100),this.downlinkPrevStatMap_.set(r,{totalPacketsLost:a,totalPacketsReceived:c}),this.downlinkLossAndRTTMap_.set(r,{rtt:s,loss:u,userId:i[n].getUserId()});case 28:n++,e.next=10;break;case 31:if(S(this.downlinkPrevStatMap_.keys()).forEach((function(e){v.isPeerConnectionDisconnected(e)&&(v.downlinkPrevStatMap_.delete(e),v.downlinkLossAndRTTMap_.delete(e))})),0!==this.downlinkLossAndRTTMap_.size){e.next=34;break}return e.abrupt("return");case 34:p=this.getAverageLossAndRTT(S(this.downlinkLossAndRTTMap_.values())),f=p.rtt,m=p.loss,this.downlinkRTT_=f,this.downlinkLoss_=m,this.downlinkNetworkQuality=this.getNetworkQuality(m,f);case 38:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"getStat",value:(t=o(regeneratorRuntime.mark((function e(t){var i,n,r,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i={rtt:0,totalPacketsLost:0,totalPacketsReceived:0},t&&Vp()){e.next=3;break}return e.abrupt("return",i);case 3:n=t.getReceivers(),e.prev=4,r=0;case 6:if(!(r<n.length)){e.next=15;break}return o=n[r],e.next=10,o.getStats();case 10:e.sent.forEach((function(e){"candidate-pair"===e.type&&Fc(e.currentRoundTripTime)&&(i.rtt=Math.round(1e3*e.currentRoundTripTime)),"inbound-rtp"!==e.type||"audio"!==e.mediaType&&"video"!==e.mediaType||(i.totalPacketsLost+=e.packetsLost,i.totalPacketsReceived+=e.packetsReceived)}));case 12:r++,e.next=6;break;case 15:return e.abrupt("return",i);case 18:return e.prev=18,e.t0=e.catch(4),e.abrupt("return",i);case 21:case"end":return e.stop()}}),e,null,[[4,18]])}))),function(e){return t.apply(this,arguments)})},{key:"getAverageLossAndRTT",value:function(e){var t={rtt:0,loss:0};return Array.isArray(e)&&e.length>0&&(e.forEach((function(e){t.rtt+=e.rtt,t.loss+=e.loss})),Object.keys(t).forEach((function(i){t[i]=Math.round(t[i]/e.length)}))),t}},{key:"getNetworkQuality",value:function(e,t){return e>50||t>500?5:e>30||t>350?4:e>20||t>200?3:e>10||t>100?2:e>=0||t>=0?1:0}},{key:"handleSignalConnectionStateChange",value:function(e){e.state===Vh?(this.uplinkRTT_=0,this.uplinkLoss_=0,this.uplinkNetworkQuality=6):e.state===Bh&&6===this.uplinkNetworkQuality&&(this.uplinkNetworkQuality=5)}},{key:"handleUplinkConnectionStateChange",value:function(e){var t=e.state;t===ys?(this.uplinkLoss_=0,this.uplinkRTT_=0,this.uplinkNetworkQuality=6):t===Es&&6===this.uplinkNetworkQuality&&(this.uplinkNetworkQuality=5)}},{key:"isPeerConnectionDisconnected",value:function(e){return!(!e||"disconnected"!==e.connectionState&&"failed"!==e.connectionState&&"closed"!==e.connectionState)}},{key:"setUplinkConnection",value:function(e){this.uplinkConnection_=e,this.uplinkConnection_?this.uplinkConnection_.on(tf,this.handleUplinkConnectionStateChange.bind(this)):(this.uplinkNetworkQuality=0,this.uplinkRTT_=0,this.uplinkLoss_=0)}},{key:"start",value:function(){var e=this;-1===this.interval_?(this.log_.info("start network quality calculating"),this.interval_=Id.setInterval((function(){e.handleDownlinkNetworkQuality(),gf.emit(_f.NETWORK_QUALITY,{client:e.client_,uplinkNetworkQuality:e.uplinkNetworkQuality,downlinkNetworkQuality:e.downlinkNetworkQuality,uplinkRTT:e.uplinkRTT_,uplinkLoss:e.uplinkLoss_,downlinkRTT:e.downlinkRTT_,downlinkLoss:e.downlinkLoss_,downlinkLossAndRTTMap:e.downlinkLossAndRTTMap_}),e.emitter_.emit(uf,{uplinkNetworkQuality:e.uplinkNetworkQuality,downlinkNetworkQuality:e.downlinkNetworkQuality,uplinkRTT:e.uplinkRTT_,uplinkLoss:e.uplinkLoss_,downlinkRTT:e.downlinkRTT_,downlinkLoss:e.downlinkLoss_})}),2e3)):this.log_.info("network quality calculating is already started")}},{key:"stop",value:function(){this.log_.info("stop network quality calculating"),-1!==this.interval_&&(Id.clearInterval(this.interval_),this.interval_=-1)}},{key:"on",value:function(e,t){this.emitter_.on(e,t)}}]),e}(),Sf=function(){function e(){s(this,e),this.log_=Xu,this.localStream_=null,this.prevDevices_=[],this.initialize()}var t,i,n;return c(e,[{key:"initialize",value:(n=o(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:navigator.mediaDevices&&navigator.mediaDevices.addEventListener("devicechange",this.onDeviceChange.bind(this));case 1:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"onDeviceChange",value:(i=o(regeneratorRuntime.mark((function e(){var t,i,n,r=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.localStream_&&this.localStream_.getMediaStream()&&!this.localStream_.getScreen()){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,Wm.getDevices();case 4:t=e.sent,i=t.filter((function(e){return r.prevDevices_.findIndex((function(t){var i=t.deviceId;return e.deviceId===i}))<0})),n=this.prevDevices_.filter((function(e){return t.findIndex((function(t){var i=t.deviceId;return e.deviceId===i}))<0})),i.length>0&&this.handleDeviceAdded(this.prevDevices_,i),n.length>0&&this.handleDeviceRemoved(t,n),this.prevDevices_=t;case 10:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"setLocalStream",value:(t=o(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=4;break}return e.next=3,Wm.getDevices();case 3:this.prevDevices_=e.sent;case 4:this.localStream_=t;case 5:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"handleDeviceAdded",value:function(e,t){this.log_.warn("devicesAdded: ".concat(JSON.stringify(t))),this.localStream_.updateDeviceIdInUse();var i=t.filter((function(e){return"videoinput"===e.kind})),n=t.filter((function(e){return"audioinput"===e.kind})),r=e.filter((function(e){return"videoinput"===e.kind})),o=e.filter((function(e){return"audioinput"===e.kind})),s=i.length>0&&0===r.length&&this.localStream_.getVideo(),a=n.length>0&&0===o.length&&this.localStream_.getAudio();if(a&&s)return this.log_.info("new microphone and camera detected, but there was no device before."),void this.localStream_.updateStream({audio:!0,video:!0,cameraId:i[0].deviceId,microphoneId:n[0].deviceId});s&&(this.log_.info("new camera detected, but there was no camera before."),this.localStream_.updateStream({audio:!1,video:!0,cameraId:i[0].deviceId})),a&&(this.log_.info("new microphone detected, but there was no microphone before."),this.localStream_.updateStream({audio:!0,video:!1,microphoneId:n[0].deviceId}))}},{key:"handleDeviceRemoved",value:function(e,t){this.log_.warn("devicesRemoved: ".concat(JSON.stringify(t))),this.localStream_.updateDeviceIdInUse();var i=!1,n=!1,r=this.localStream_.getCameraId(),o=this.localStream_.getMicrophoneId();if("default"===o){var s=this.localStream_.getMicrophoneGroupId(),a=e.filter((function(e){return"default"===e.deviceId&&"audioinput"===e.kind}))[0];a&&a.groupId!==s&&(n=!0)}if(t.forEach((function(e){var t=e.deviceId;r.length>0&&t===r?i=!0:o.length>0&&t===o&&(n=!0)})),i&&n)return this.log_.warn("current camera and microphone in use is lost, cameraId: ".concat(r,", microphoneId: ").concat(o)),void((this.localStream_.getAudio()||this.localStream_.getVideo())&&this.localStream_.updateStream({video:!0,audio:!0}));i&&(this.log_.warn("current camera in use is lost, deviceId: ".concat(r)),this.localStream_.getVideo()&&this.localStream_.updateStream({video:!0,audio:!1})),n&&(this.log_.warn("current microphone in use is lost, deviceId: ".concat(o)),this.localStream_.getAudio()&&this.localStream_.updateStream({video:!1,audio:!0}))}}]),e}(),Tf=1..toFixed,Ef=Math.floor,bf=function(e,t,i){return 0===t?i:t%2==1?bf(e,t-1,i*e):bf(e*e,t/2,i)},Rf=function(e,t,i){for(var n=-1,r=i;++n<6;)r+=t*e[n],e[n]=r%1e7,r=Ef(r/1e7)},If=function(e,t){for(var i=6,n=0;--i>=0;)n+=e[i],e[i]=Ef(n/t),n=n%t*1e7},kf=function(e){for(var t=6,i="";--t>=0;)if(""!==i||0===t||0!==e[t]){var n=String(e[t]);i=""===i?n:i+ud.call("0",7-n.length)+n}return i},wf=Tf&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!O((function(){Tf.call({})}));gt({target:"Number",proto:!0,forced:wf},{toFixed:function(e){var t,i,n,r,o=function(e){if("number"!=typeof e&&"Number"!=V(e))throw TypeError("Incorrect invocation");return+e}(this),s=ze(e),a=[0,0,0,0,0,0],c="",u="0";if(s<0||s>20)throw RangeError("Incorrect fraction digits");if(o!=o)return"NaN";if(o<=-1e21||o>=1e21)return String(o);if(o<0&&(c="-",o=-o),o>1e-21)if(i=(t=function(e){for(var t=0,i=e;i>=4096;)t+=12,i/=4096;for(;i>=2;)t+=1,i/=2;return t}(o*bf(2,69,1))-69)<0?o*bf(2,-t,1):o/bf(2,t,1),i*=4503599627370496,(t=52-t)>0){for(Rf(a,0,i),n=s;n>=7;)Rf(a,1e7,0),n-=7;for(Rf(a,bf(10,n,1),0),n=t-1;n>=23;)If(a,1<<23),n-=23;If(a,1<<n),Rf(a,1,1),If(a,2),u=kf(a)}else Rf(a,0,i),Rf(a,1<<-t,0),u=kf(a)+ud.call("0",s);return s>0?c+((r=u.length)<=s?"0."+ud.call("0",s-r)+u:u.slice(0,r-s)+"."+u.slice(r-s)):c+u}});var Cf,Af,Df=window.AudioContext||window.webkitAudioContext,Of=null,Pf=function(){function e(){var t=this;s(this,e),Of||(Of=new Df),this.context_=Of,this.instant_=0,this.slow_=0,this.clip_=0,this.script_=this.context_.createScriptProcessor(2048,1,1),this.script_.onaudioprocess=function(e){var i,n=e.inputBuffer.getChannelData(0),r=0,o=0;for(i=0;i<n.length;++i)r+=n[i]*n[i],Math.abs(n[i])>.99&&(o+=1);t.instant_=Math.sqrt(r/n.length),t.slow_=.95*t.slow_+.05*t.instant_,t.clip_=o/n.length}}return c(e,[{key:"connectToSource",value:function(e,t){try{var i=new MediaStream;i.addTrack(e),this.mic_=this.context_.createMediaStreamSource(i),this.mic_.connect(this.script_),this.script_.connect(this.context_.destination),Uc(t)||t(null)}catch(e){Xu.error("soundMeter connectToSource error: "+e),Uc(t)||t(e)}}},{key:"stop",value:function(){this.mic_.disconnect(),this.script_.disconnect()}},{key:"resume",value:function(){this.context_&&this.context_.resume()}},{key:"getVolume",value:function(){return this.instant_.toFixed(2)}}]),e}(),xf=function(){function e(t){s(this,e),this.stream_=t.stream,this.userId_=t.stream.getUserId(),this.log_=this.stream_.getIDLogger(),this.track_=t.track,this.div_=t.div,this.muted_=t.muted,this.outputDeviceId_=t.outputDeviceId,this.volume_=t.volume,this.emitter_=new Mh,this.initializeElement(),this.state_="NONE",this.soundMeter_=null}var t,i,n,r;return c(e,[{key:"initializeElement",value:function(){var e=new MediaStream;e.addTrack(this.track_);var t=document.createElement("audio");t.srcObject=e,t.muted=this.muted_,t.setAttribute("id","audio_".concat(this.stream_.getId())),t.setAttribute("autoplay","autoplay"),t.setAttribute("playsinline","playsinline"),this.div_.appendChild(t),this.element_=t,this.handleEvents()}},{key:"play",value:(r=o(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.outputDeviceId_){e.next=3;break}return e.next=3,this.element_.setSinkId(this.outputDeviceId_);case 3:return this.setVolume(this.volume_),e.prev=4,e.next=7,this.element_.play();case 7:e.next=15;break;case 9:if(e.prev=9,e.t0=e.catch(4),this.log_.warn("<audio> play() error: "+e.t0),!(t=e.t0.toString()+" <audio>").startsWith("NotAllowedError")){e.next=15;break}throw new da({code:ua.PLAY_NOT_ALLOWED,message:t});case 15:case"end":return e.stop()}}),e,this,[[4,9]])}))),function(){return r.apply(this,arguments)})},{key:"handleEvents",value:function(){this.handleElementEvent=this.handleElementEvent.bind(this),this.handleTrackEvent=this.handleTrackEvent.bind(this),this.element_.addEventListener("playing",this.handleElementEvent),this.element_.addEventListener("ended",this.handleElementEvent),this.element_.addEventListener("pause",this.handleElementEvent),this.element_.addEventListener("error",this.handleElementEvent),this.track_.addEventListener("ended",this.handleTrackEvent),this.track_.addEventListener("mute",this.handleTrackEvent),this.track_.addEventListener("unmute",this.handleTrackEvent)}},{key:"handleElementEvent",value:(n=o(regeneratorRuntime.mark((function e(t){var i,n,r,o,s,a=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=t.type,e.t0=i,e.next="playing"===e.t0?4:"ended"===e.t0?9:"pause"===e.t0?12:"error"===e.t0?16:27;break;case 4:return this.log_.info("stream - audio player is starting playing"),this.state_="PLAYING",gf.emit(_f.AUDIO_PLAYING,{stream:this.stream_}),this.emitter_.emit(ff,{state:this.state_,reason:"playing"}),e.abrupt("break",27);case 9:return this.log_.info("stream - audio player is ended"),"STOPPED"!==this.state_&&(this.state_="STOPPED",this.emitter_.emit(ff,{state:this.state_,reason:"ended"})),e.abrupt("break",27);case 12:return this.log_.info("stream - audio player is paused"),this.state_="PAUSED",this.emitter_.emit(ff,{state:this.state_,reason:"pause"}),e.abrupt("break",27);case 16:if(!this.element_||!this.element_.error){e.next=26;break}return n="".concat(Jp(),"/").concat(Qu().name,"/").concat(Qu().version),e.next=20,Wm.getSpeakers();case 20:r=e.sent,o=r[0].label,(s=r.find((function(e){return e.deviceId===a.outputDeviceId_})))&&(o=s.label),this.log_.error("stream - audio player error observed. code: ".concat(this.element_.error.code," message: ").concat(this.element_.error.message," deviceInfo: ").concat(n," speaker: ").concat(o)),Ic("stat-".concat(this.stream_.getType(),"-audio-").concat(Bs,"-").concat(this.element_.error.code,"-").concat(n,"-").concat(o),this.element_.error);case 26:return e.abrupt("break",27);case 27:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"handleTrackEvent",value:function(e){var t=e.type;switch(t){case"ended":this.log_.info("stream - audio player track is ended"),"STOPPED"!==this.state_&&(this.state_="STOPPED",this.emitter_.emit(ff,{state:this.state_,reason:"ended"})),gf.emit(_f.AUDIO_TRACK_ENDED,{stream:this.stream_,type:t});break;case"mute":this.log_.info("stream - audio track is unable to provide media output"),"PAUSED"!==this.state_&&(this.state_="PAUSED",this.emitter_.emit(ff,{state:this.state_,reason:"mute"})),gf.emit(_f.AUDIO_TRACK_MUTED,{stream:this.stream_,type:t});break;case"unmute":this.log_.info("stream - audio track is able to provide media output"),"PAUSED"===this.state_&&(this.state_="PLAYING",this.emitter_.emit(ff,{state:this.state_,reason:"unmute"}))}}},{key:"unbindEvents",value:function(){this.element_&&(this.element_.removeEventListener("playing",this.handleElementEvent),this.element_.removeEventListener("ended",this.handleElementEvent),this.element_.removeEventListener("pause",this.handleElementEvent),this.element_.removeEventListener("error",this.handleElementEvent)),this.track_&&(this.track_.removeEventListener("ended",this.handleTrackEvent),this.track_.removeEventListener("mute",this.handleTrackEvent),this.track_.removeEventListener("unmute",this.handleTrackEvent))}},{key:"setSinkId",value:(i=o(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.outputDeviceId_===t){e.next=4;break}return e.next=3,this.element_.setSinkId(t);case 3:this.outputDeviceId_=t;case 4:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"setVolume",value:function(e){this.log_.info("stream - audioElement setVolume to : ".concat(e)),this.element_.volume=e}},{key:"getAudioLevel",value:function(){return this.soundMeter_||(this.soundMeter_=new Pf,this.soundMeter_.connectToSource(this.track_)),this.soundMeter_.getVolume()}},{key:"stop",value:function(){this.unbindEvents(),this.div_.removeChild(this.element_),this.element_.srcObject=null,this.soundMeter_&&(this.soundMeter_.stop(),this.soundMeter_=null),this.element_=null}},{key:"resume",value:(t=o(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.soundMeter_&&this.soundMeter_.resume(),e.next=4,this.element_.play();case 4:e.next=12;break;case 6:if(e.prev=6,e.t0=e.catch(0),this.log_.warn("<audio> play() error: "+e.t0),!(t=pp({key:"AUDIO",data:{error:e.t0}})).startsWith("NotAllowedError")){e.next=12;break}throw new da({code:ua.PLAY_NOT_ALLOWED,message:t});case 12:case"end":return e.stop()}}),e,this,[[0,6]])}))),function(){return t.apply(this,arguments)})},{key:"on",value:function(e,t){this.emitter_.on(e,t)}}]),e}(),Mf=function(){function e(t){s(this,e),this.stream_=t.stream,this.userId_=t.stream.getUserId(),this.log_=this.stream_.getIDLogger(),this.track_=t.track,this.div_=t.div,this.muted_=t.muted,this.objectFit_=t.objectFit,this.mirror_=t.mirror,this.emitter_=new Mh,this.initializeElement(),this.state_="NONE"}var t,i;return c(e,[{key:"initializeElement",value:function(){var e=new MediaStream;e.addTrack(this.track_);var t=document.createElement("video");t.srcObject=e,t.muted=!0;var i="width: 100%; height: 100%; object-fit: ".concat(this.objectFit_,";");this.mirror_&&(i+="transform: rotateY(180deg);"),t.setAttribute("id","video_".concat(this.stream_.getId())),t.setAttribute("style",i),t.setAttribute("autoplay","autoplay"),t.setAttribute("playsinline","playsinline"),this.div_.appendChild(t),this.element_=t,this.handleEvents()}},{key:"play",value:(i=o(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.element_.play();case 3:e.next=11;break;case 5:if(e.prev=5,e.t0=e.catch(0),this.log_.warn("<video> play() error: "+e.t0),!(t=e.t0.toString()+" <video>").startsWith("NotAllowedError")){e.next=11;break}throw new da({code:ua.PLAY_NOT_ALLOWED,message:t});case 11:case"end":return e.stop()}}),e,this,[[0,5]])}))),function(){return i.apply(this,arguments)})},{key:"handleEvents",value:function(){this.handleElementEvent=this.handleElementEvent.bind(this),this.handleTrackEvent=this.handleTrackEvent.bind(this),this.element_.addEventListener("playing",this.handleElementEvent),this.element_.addEventListener("ended",this.handleElementEvent),this.element_.addEventListener("pause",this.handleElementEvent),this.element_.addEventListener("error",this.handleElementEvent),this.element_.addEventListener("loadeddata",this.handleElementEvent),this.track_.addEventListener("ended",this.handleTrackEvent),this.track_.addEventListener("mute",this.handleTrackEvent),this.track_.addEventListener("unmute",this.handleTrackEvent)}},{key:"handleElementEvent",value:function(e){switch(e.type){case"playing":this.log_.info("stream - video player is starting playing"),this.state_="PLAYING",gf.emit(_f.VIDEO_PLAYING,{stream:this.stream_}),this.emitter_.emit(ff,{state:this.state_,reason:"playing"});break;case"ended":this.log_.info("stream - video player is ended"),"STOPPED"!==this.state_&&(this.state_="STOPPED",this.emitter_.emit(ff,{state:this.state_,reason:"ended"}));break;case"pause":this.log_.info("stream - video player is paused"),this.state_="PAUSED",this.emitter_.emit(ff,{state:this.state_,reason:"pause"});break;case"error":if(this.element_&&this.element_.error){var t="".concat(Jp(),"/").concat(Qu().name,"/").concat(Qu().version);this.log_.error("stream - video player error observed. code: ".concat(this.element_.error.code," message: ").concat(this.element_.error.message," deviceInfo: ").concat(t)),Ic("stat-".concat(this.stream_.getType(),"-video-").concat(Bs,"-").concat(this.element_.error.code,"-").concat(t),this.element_.error)}break;case"loadeddata":gf.emit(_f.VIDEO_LOADED_DATA,{stream:this.stream_})}}},{key:"handleTrackEvent",value:function(e){var t=e.type;switch(t){case"ended":this.log_.info("stream - video player track is ended"),"STOPPED"!==this.state_&&(this.state_="STOPPED",this.emitter_.emit(ff,{state:this.state_,reason:"ended"})),gf.emit(_f.VIDEO_TRACK_ENDED,{stream:this.stream_,type:t});break;case"mute":this.log_.info("stream - video track is unable to provide media output"),"PAUSED"!==this.state_&&(this.state_="PAUSED",this.emitter_.emit(ff,{state:this.state_,reason:"mute"})),gf.emit(_f.VIDEO_TRACK_MUTED,{stream:this.stream_,type:t});break;case"unmute":this.log_.info("stream - video track is able to provide media output"),"PAUSED"===this.state_&&(this.state_="PLAYING",this.emitter_.emit(ff,{state:this.state_,reason:"unmute"}),gf.emit(_f.VIDEO_TRACK_UNMUTED,{stream:this.stream_}))}}},{key:"unbindEvents",value:function(){this.element_&&(this.element_.removeEventListener("playing",this.handleElementEvent),this.element_.removeEventListener("ended",this.handleElementEvent),this.element_.removeEventListener("pause",this.handleElementEvent),this.element_.removeEventListener("error",this.handleElementEvent),this.element_.removeEventListener("loadeddata",this.handleElementEvent)),this.track_&&(this.track_.removeEventListener("ended",this.handleTrackEvent),this.track_.removeEventListener("mute",this.handleTrackEvent),this.track_.removeEventListener("unmute",this.handleTrackEvent))}},{key:"stop",value:function(){this.unbindEvents(),this.div_.removeChild(this.element_),this.element_.srcObject=null,this.element_=null}},{key:"resume",value:(t=o(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.element_.play();case 3:e.next=11;break;case 5:if(e.prev=5,e.t0=e.catch(0),this.log_.warn("<video> play() error: "+e.t0),!(t=pp({key:"VIDEO",data:{error:e.t0}})).startsWith("NotAllowedError")){e.next=11;break}throw new da({code:ua.PLAY_NOT_ALLOWED,message:t});case 11:case"end":return e.stop()}}),e,this,[[0,5]])}))),function(){return t.apply(this,arguments)})},{key:"getVideoFrame",value:function(){var e=document.createElement("canvas");return e.width=this.element_.videoWidth,e.height=this.element_.videoHeight,e.getContext("2d").drawImage(this.element_,0,0),e.toDataURL("image/png")}},{key:"on",value:function(e,t){this.emitter_.on(e,t)}}]),e}(),Lf=function(){function e(t){s(this,e),this.userId_=t.userId,this.tinyId_=t.tinyId,this.client_=t.client,this.sdpSemantics_=t.client.getSdpSemantics(),this.isUplink_=t.isUplink,this.log_=new vf({id:"n|"+this.userId_,direction:this.isUplink_?"local":"remote",type:""}),this.signalChannel_=t.signalChannel,this.peerConnection_=null,this.connectTimer_=-1,this.isErrorObserved_=!1,this.emitter_=new Mh,this.currentState_=ys,this.waitForPeerConnectionConnectedPromise_=null,this.isReconnecting_=!1,this.reconnectionCount_=0,this.reconnectionTimer_=-1,this.isFirstConnection_=!0}var t;return c(e,[{key:"initialize",value:function(){var e={iceServers:this.client_.getIceServers(),iceTransportPolicy:this.client_.getIceTransportPolicy(),sdpSemantics:this.sdpSemantics_,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",tcpCandidatePolicy:"disable",IceTransportsType:"nohost"};this.peerConnection_=new RTCPeerConnection(e),this.peerConnection_.onconnectionstatechange=this.onConnectionStateChange.bind(this)}},{key:"close",value:function(){this.log_.info("closing connection"),this.closePeerConnection()}},{key:"closePeerConnection",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.peerConnection_&&(this.peerConnection_.onconnectionstatechange=function(){},this.peerConnection_.close(),this.peerConnection_=null,e&&this.emitConnectionStateChangedEvent(ys))}},{key:"getDTLSTransportState",value:function(){if(!this.peerConnection_)return"unknown";var e=null;if(this.isUplink_){if(!Fp()||0===this.peerConnection_.getSenders().length)return"unknown";e=this.peerConnection_.getSenders()[0].transport}else{if(!Vp()||0===this.peerConnection_.getReceivers().length)return"unknown";e=this.peerConnection_.getReceivers()[0].transport}return e?e.state:"unknown"}},{key:"onConnectionStateChange",value:function(e){var t=this.peerConnection_.iceConnectionState,i=this.getDTLSTransportState();if(this.log_.info("onConnectionStateChange() connectionState: "+e.target.connectionState),this.log_.info("ICE Transport state: ".concat(t,", DTLS Transport state: ").concat(i)),"connecting"===e.target.connectionState&&this.emitConnectionStateChangedEvent(Ss),"failed"===e.target.connectionState||"closed"===e.target.connectionState){var n="".concat(this.isUplink_?"uplink":"downlink"," ICE/DTLS Transport connection ").concat(e.target.connectionState,". ICE Transport state: ").concat(t,", DTLS Transport state: ").concat(i),r=new da({message:n,code:ua.ICE_TRANSPORT_ERROR});Ac({eventType:xs,error:r}),this.emitConnectionStateChangedEvent(ys),this.isErrorObserved_||this.emitter_.emit(ef,r)}if(("connected"===e.target.connectionState||"completed"===e.target.connectionState)&&(this.logSelectedCandidate(),Cc({eventType:xs}),this.emitConnectionStateChangedEvent(Es),!this.isUplink_&&!this.sentSubscriptionAfterConnected_&&this.pendingSubscription_.length>0)){this.log_.info("send pending subscription after RTCPeerConnection is connected");var o=this.pendingSubscription_[0];this.doSendSubscription(o.data,o.stream,o.type),this.sentSubscriptionAfterConnected_=!0}}},{key:"emitConnectionStateChangedEvent",value:function(e){e!==this.currentState_&&(this.currentState_===Ts&&e===Ss||(gf.emit(_f.CONNECTION_STATE_CHANGED,{client:this.client_,connection:this,prevState:this.currentState_,state:e}),this.emitter_.emit(tf,{prevState:this.currentState_,state:e}),this.currentState_=e))}},{key:"hitTest",value:function(e){return(0===e||"0"===e)&&this.isUplink_||e===this.tinyId_}},{key:"addEventInternal",value:function(e,t){var i=this.client_.getUserId(),n={eventId:e,eventDesc:t,timestamp:Tc(),userId:i,tinyId:this.client_.getTinyId()};this.isUplink_||(n.remoteUserId=this.userId_,n.remoteTinyId=this.tinyId_),zh(i,n)}},{key:"getPeerConnection",value:function(){return this.peerConnection_}},{key:"getClient",value:function(){return this.client_}},{key:"getUserId",value:function(){return this.userId_}},{key:"getTinyId",value:function(){return this.tinyId_}},{key:"logSelectedCandidate",value:(t=o(regeneratorRuntime.mark((function e(){var t,i,n,r,o,s,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.peerConnection_){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.peerConnection_.getStats();case 4:t=e.sent,i=b(t),e.prev=6,i.s();case 8:if((n=i.n()).done){e.next=18;break}if((r=y(n.value,2))[0],o=r[1],!Gp(o)){e.next=16;break}return s=t.get(o.localCandidateId),a=t.get(o.remoteCandidateId),s&&this.log_.debug("local candidate: ".concat(s.candidateType," ").concat(s.protocol,":").concat(s.ip||s.address,":").concat(s.port," ").concat(s.networkType||""," ").concat("relay"===s.candidateType?"relayProtocol:"+s.relayProtocol:"")),a&&this.log_.debug("remote candidate: ".concat(a.candidateType," ").concat(a.protocol,":").concat(a.ip||a.address,":").concat(a.port)),e.abrupt("break",18);case 16:e.next=8;break;case 18:e.next=23;break;case 20:e.prev=20,e.t0=e.catch(6),i.e(e.t0);case 23:return e.prev=23,i.f(),e.finish(23);case 26:case"end":return e.stop()}}),e,this,[[6,20,23,26]])}))),function(){return t.apply(this,arguments)})},{key:"getCurrentState",value:function(){return this.currentState_}},{key:"waitForPeerConnectionConnected",value:function(){var e=this;return this.waitForPeerConnectionConnectedPromise_||(this.waitForPeerConnectionConnectedPromise_=new Promise((function(t,i){if(e.currentState_===Es)return t();var n=-1,r=function i(r){r.state===Es&&(clearTimeout(n),e.emitter_.off(tf,i,e),t())};n=setTimeout((function(){e.emitter_.off(tf,r,e),i(new da({code:ua.API_CALL_TIMEOUT,message:"connection timeout"}))}),1e4),e.emitter_.on(tf,r,e)})),this.waitForPeerConnectionConnectedPromise_=this.waitForPeerConnectionConnectedPromise_.then((function(t){return e.waitForPeerConnectionConnectedPromise_=null,t})).catch((function(t){throw e.waitForPeerConnectionConnectedPromise_=null,t}))),this.waitForPeerConnectionConnectedPromise_}},{key:"getReconnectionCount",value:function(){return this.reconnectionCount_}},{key:"startReconnection",value:function(){this.isReconnecting_=!0,this.emitConnectionStateChangedEvent(Ts),this.reconnect(),this.addEventInternal(this.isUplink_?32797:32800,"".concat(this.isUplink_?"uplink":"downlink","-connection is reconnecting"))}},{key:"stopReconnection",value:function(){this.log_.info("stop reconnection"),this.isReconnecting_=!1,this.reconnectionCount_=0,this.clearReconnectionTimer(),this.signalChannel_.off(Nh,this.reconnect,this)}},{key:"on",value:function(e,t,i){this.emitter_.on(e,t,i)}},{key:"off",value:function(e,t,i){this.emitter_.off(e,t,i)}}]),e}(),Nf={TRTC:{createClient:{name:"clientConfig",required:!0,type:Xs,properties:{sdkAppId:{required:!0,type:Ys,allowEmpty:!1},userId:{required:!0,type:Ks,allowEmpty:!1},userSig:{required:!0,type:Ks,allowEmpty:!1},mode:{required:!0,type:Ks,values:["rtc","live"]},useStringRoomId:{type:Qs},autoSubscribe:{type:Qs},streamId:{type:Ks},userDefineRecordId:{type:Ks},pureAudioPushMode:{type:Ys,values:[1,2]}}},createStream:{name:"streamConfig",required:!0,type:Xs,properties:{userId:{type:Ks},audio:{type:Qs},video:{type:Qs},screen:{type:Qs},screenAudio:{type:Qs},microphoneId:{type:Ks},cameraId:{type:Ks},facingMode:{type:Ks,values:["user","environment"]},audioSource:{instanceOf:MediaStreamTrack},videoSource:{instanceOf:MediaStreamTrack},mirror:{type:Qs}},validate:function(e){if(!Uc(e.screen)&&e.screen&&Uc(e.audio)&&(e.audio=!1),!(Uc(e.audio)&&Uc(e.video)||Uc(e.audioSource)&&Uc(e.videoSource)))throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_CREATE_STREAM_SOURCE"})});if(!Uc(e.screen)&&!0===e.screen&&!0===e.video)throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_CREATE_STREAM_SCREEN"})});if(e.audio&&e.screenAudio)throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_CREATE_STREAM_AUDIO"})});if(!0!==e.screen&&!0===e.screenAudio)throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_CREATE_STREAM_SCREEN_AUDIO"})});if(!Uc(e.screen)&&!0===e.screen&&!this.isScreenShareSupported())throw new da({code:ua.INVALID_OPERATION,message:pp({key:"NOT_SUPPORTED_CAPTURE"})})}}},CLIENT:{join:{name:"joinOptions",required:!0,properties:{roomId:{required:!0,type:[Ys,Ks],allowEmpty:!1,validate:function(e){if(this.useStringRoomId_){if(!Vc(e)||!/^[A-Za-z\d\s!#$%&()+\-:;<=.>?@[\]^_{}|~,]{1,64}$/.test(e))throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_ROOMID_STRING"})})}else if(!(Fc(e)&&/^[1-9]\d*$/.test(String(e))&&e<4294967295))throw new da({code:ua.INVALID_PARAMETER,message:pp({key:rp})})}},role:{type:[Ks],values:["anchor","audience"]}}},publish:{name:"stream",required:!0,instanceOf:sa,validate:function(e){if(!Cp.result)throw new da({code:ua.NOT_SUPPORTED,message:pp({key:"NOT_SUPPORTED_TRTC"})});if(!this.isJoined_)throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_PUBLISH"})});if("live"===this.mode_&&"audience"===this.role_)throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_AUDIENCE"})});if(this.localStream_)throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_DUPLICATE_PUBLISHING"})});if(!e.getIsReadyToPublish())throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_INITIALIZE"})});if(this.notPublishWithoutH264Supported_)throw new da({code:ua.NOT_SUPPORTED_H264,message:pp({key:up})})}},unpublish:{name:"stream",required:!0,instanceOf:sa,validate:function(e){if(e!==this.localStream_)throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_UNPUBLISH"})})}},subscribe:[{name:"stream",required:!0,instanceOf:aa,validate:function(e){if(!e.getConnection())throw new da({code:ua.INVALID_OPERATION,message:pp({key:op})});if(this.notSubscribeWithoutH264Supported_)throw new da({code:ua.NOT_SUPPORTED_H264,message:pp({key:dp})})}},{name:"options",type:Xs,properties:{audio:{type:Qs},video:{type:Qs}}}],unsubscribe:{name:"stream",required:!0,instanceOf:aa,validate:function(e){if(!e.getConnection())throw new da({code:ua.INVALID_OPERATION,message:pp({key:op})})}},switchRole:{name:"role",required:!0,values:["anchor","audience"],validate:function(){if("live"!==this.mode_)throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_ROLE"})});if(!this.isJoined_)throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_OPERATION_SWITCH_ROLE"})})}}},LOCAL_STREAM:{switchDevice:[{name:"type",required:!0,type:Ks,values:[Zs,ea]},{name:"deviceId",required:!0,type:Ks,validate:function(){if(this.screen_||this.audioSource_||this.videoSource_)throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_SWITCH_DEVICE"})});if(0===this.publishState_)throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_SWITCH_DEVICE_PUBLISHING"})})}}]},STREAM:{play:[{name:"elementId",required:!0,type:[Ks,"HTMLDivElement"]},{name:"options",type:Xs,properties:{objectFit:{type:Ks,values:["contain","cover"]},muted:{type:Qs}},validate:function(){if(this.isPlaying_)throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_PLAY"})})}}]}},Uf=wn.trim;function Vf(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return function(e,i,n){var r=n.value;return n.value=function(){for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];return jf.call(this,t,n,i,this.name_),r.apply(this,n)},n}}function Ff(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return function(e,i,n){var r=n.value;return n.value=o(regeneratorRuntime.mark((function e(){var n,o,s,a=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(n=a.length,o=new Array(n),s=0;s<n;s++)o[s]=a[s];return jf.call(this,t,o,i,this.name_),e.abrupt("return",r.apply(this,o));case 3:case"end":return e.stop()}}),e,this)}))),n}}function jf(e,t,i,n){try{for(var r=0;r<e.length;r++){Bf.call(this,{rule:e[r],value:t[r],fnName:i,className:n});var o=e[r].properties;if(Mc(o))for(var s=Object.keys(o),a=0;a<s.length;a++){var c=s[a];Bf.call(this,{rule:o[c],value:t[r]&&t[r][c],key:c,fnName:i,className:n})}}}catch(e){throw Xu.error(e),e}}function Bf(e){var t=e.rule,i=e.value,n=e.key,r=e.fnName,o=e.className;if(Uc(i)){if(t.required)throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_PARAMETER_REQUIRED",data:{key:n,rule:t,fnName:r,value:i},link:{className:o,fnName:r}})})}else{if(Array.isArray(t.type)){if(!t.type.map((function(e){return e.toLowerCase()})).includes(jc(i)))throw new da({code:ua.INVALID_PARAMETER,message:pp({key:tp,data:{key:n,rule:t,fnName:r,value:i},link:{className:o,fnName:r}})})}else if(!Uc(t.type)&&jc(i)!==t.type)throw new da({code:ua.INVALID_PARAMETER,message:pp({key:tp,data:{key:n,rule:t,fnName:r,value:i},link:{className:o,fnName:r}})});if(!1===t.allowEmpty&&(0===i||Vc(i)&&""===i.trim()))throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_PARAMETER_EMPTY",data:{key:n,rule:t,fnName:r,value:i},link:{className:o,fnName:r}})});if(Vc(t.instanceOf)){if(!i||i.name_!==t.instanceOf)throw new da({code:ua.INVALID_PARAMETER,message:pp({key:ip,data:{key:n,rule:t,fnName:r,value:i},link:{className:o,fnName:r}})})}else if(Nc(t.instanceOf)&&!(i instanceof t.instanceOf))throw new da({code:ua.INVALID_PARAMETER,message:pp({key:ip,data:{key:n,rule:t,fnName:r,value:i},link:{className:o,fnName:r}})});if(t.values&&!t.values.includes(i))throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_PARAMETER_RANGE",data:{key:n,rule:t,fnName:r,value:i},link:{className:o,fnName:r}})});Nc(t.validate)&&t.validate.call(this,i,this)}}gt({target:"String",proto:!0,forced:function(e){return O((function(){return!!En[e]()||"​᠎"!="​᠎"[e]()||En[e].name!==e}))}("trim")},{trim:function(){return Uf(this)}});var Hf=(Cf=Ff.apply(void 0,S(Nf.STREAM.play)),R((Af=function(){function e(t){s(this,e),this.name_="Stream",this.userId_=t.userId,this.isRemote_=t.isRemote,this.type_=t.type,this.log_=new vf({id:"s".concat(t.seq?t.seq:"","|").concat(this.userId_),direction:this.isRemote_?"remote":"local",type:this.isRemote_?this.type_:""}),this.mirror_=!1,this.isRemote_||(this.mirror_=!0),Uc(t.mirror)||(this.mirror_=t.mirror),this.client_=null,Uc(t.client)||(this.client_=t.client),this.mediaStream_=null,this.div_=null,this.isPlaying_=!1,this.connection_=null,this.audioPlayer_=null,this.videoPlayer_=null,this.muted_=!1,this.objectFit_="cover",this.id_=Rd(),this.audioOutputDeviceId_=0,this.audioVolume_=1,this.emitter_=new Mh,this.connectionState_=ys}var t,r,a,u,d;return c(e,[{key:"getType",value:function(){return this.type_}},{key:"getIDLogger",value:function(){return this.log_}},{key:"isSubscribed",get:function(){return"main"===this.type_&&this.connection_.isMainStreamSubscribed||"auxiliary"===this.type_&&this.connection_.isAuxStreamSubscribed}},{key:"isMainVideoSubscribed",get:function(){var e=this.getSubscribedState();return"main"===this.type_&&e&&e.video}},{key:"isMainAudioSubscribed",get:function(){var e=this.getSubscribedState();return"main"===this.type_&&e&&e.audio}},{key:"isAuxVideoSubscribed",get:function(){var e=this.getSubscribedState();return"auxiliary"===this.type_&&e&&e.auxiliary}},{key:"emitConnectionStateChanged",value:function(e){e.state!==this.connectionState_&&(e.state!==ys&&this.isRemote_&&!this.isSubscribed||(this.emitter_.emit("connection-state-changed",e),this.connectionState_=e.state))}},{key:"setConnection",value:function(e){this.connection_!==e&&(e instanceof Lf?(null!==this.connection_&&this.connection_.off(tf,this.emitConnectionStateChanged,this),e.on(tf,this.emitConnectionStateChanged,this)):null===e&&this.connection_.off(tf,this.emitConnectionStateChanged,this),this.connection_=e)}},{key:"getConnection",value:function(){return this.connection_}},{key:"play",value:(d=o(regeneratorRuntime.mark((function e(t,i){var r,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.isPlaying_=!0,this.log_.info("stream start to play with options: ".concat(JSON.stringify(i))),(r=document.createElement("div")).setAttribute("id","player_".concat(this.id_)),r.setAttribute("style","width: 100%; height: 100%; position: relative; background-color: black; overflow: hidden;"),o=t,"object"!==n(t)&&(o=document.getElementById(t)),o.appendChild(r),this.div_=r,this.isRemote_||(this.muted_=!0),i&&!Uc(i.muted)&&(this.muted_=i.muted),this.isRemote_&&"auxiliary"===this.getType()&&(this.objectFit_="contain"),i&&!Uc(i.objectFit)&&(this.objectFit_=i.objectFit),gf.emit(_f.PLAY_STREAM_START,{stream:this}),e.next=16,Promise.all([this.playAudio(),this.playVideo()]);case 16:gf.emit(_f.STREAM_PLAY_SUCCESS,{stream:this});case 17:case"end":return e.stop()}}),e,this)}))),function(e,t){return d.apply(this,arguments)})},{key:"playAudio",value:(u=o(regeneratorRuntime.mark((function e(){var t,n=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasAudio()&&(!this.isRemote_||this.isMainAudioSubscribed)){e.next=2;break}return e.abrupt("return");case 2:if(t=this.getAudioTrack(),this.audioPlayer_||!t){e.next=16;break}return this.log_.info("stream - create AudioPlayer and play"),this.audioPlayer_=new xf({stream:this,track:t,div:this.div_,muted:this.muted_,outputDeviceId:this.audioOutputDeviceId_,volume:this.audioVolume_}),this.audioPlayer_.on(ff,(function(e){var t={type:"audio",state:e.state,reason:e.reason};gf.emit(_f.PLAYER_STATE_CHANGED,i({stream:n},t)),n.emitter_.emit(hf,t)})),e.prev=7,e.next=10,this.audioPlayer_.play();case 10:e.next=16;break;case 12:throw e.prev=12,e.t0=e.catch(7),this.emitter_.emit(pf,e.t0),e.t0;case 16:case"end":return e.stop()}}),e,this,[[7,12]])}))),function(){return u.apply(this,arguments)})},{key:"playVideo",value:(a=o(regeneratorRuntime.mark((function e(){var t,n=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasVideo()&&(!this.isRemote_||this.isMainVideoSubscribed||this.isAuxVideoSubscribed)){e.next=2;break}return e.abrupt("return");case 2:if(t=this.getVideoTrack(),this.videoPlayer_||!t){e.next=17;break}return gf.emit(_f.PLAY_VIDEO_START,{stream:this}),this.log_.info("stream - create VideoPlayer and play"),this.videoPlayer_=new Mf({stream:this,track:t,div:this.div_,muted:this.muted_,objectFit:this.objectFit_,mirror:this.mirror_}),this.videoPlayer_.on(ff,(function(e){var t={type:"video",state:e.state,reason:e.reason};gf.emit(_f.PLAYER_STATE_CHANGED,i({stream:n},t)),n.emitter_.emit(hf,t)})),e.prev=8,e.next=11,this.videoPlayer_.play();case 11:e.next=17;break;case 13:throw e.prev=13,e.t0=e.catch(8),this.emitter_.emit(pf,e.t0),e.t0;case 17:case"end":return e.stop()}}),e,this,[[8,13]])}))),function(){return a.apply(this,arguments)})},{key:"stopAudio",value:function(){this.audioPlayer_&&(this.log_.info("stream - stop AudioPlayer"),this.audioPlayer_.stop(),this.audioPlayer_=null)}},{key:"stopVideo",value:function(){this.videoPlayer_&&(this.log_.info("stream - stop VideoPlayer"),this.videoPlayer_.stop(),this.videoPlayer_=null)}},{key:"restartAudio",value:function(){this.isPlaying_&&(this.stopAudio(),this.playAudio().catch((function(e){})))}},{key:"restartVideo",value:function(){this.isPlaying_&&(this.stopVideo(),this.playVideo().catch((function(e){})))}},{key:"stop",value:function(){this.isPlaying_&&(this.isPlaying_=!1,this.stopAudio(),this.stopVideo(),this.div_.parentNode.removeChild(this.div_))}},{key:"resume",value:(r=o(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isPlaying_){e.next=2;break}return e.abrupt("return");case 2:if(this.log_.info("stream - resume"),!this.audioPlayer_){e.next=6;break}return e.next=6,this.audioPlayer_.resume();case 6:if(!this.videoPlayer_){e.next=9;break}return e.next=9,this.videoPlayer_.resume();case 9:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"close",value:function(){this.isPlaying_&&this.stop(),this.mediaStream_&&(this.mediaStream_.preventEvent=1,this.mediaStream_.getTracks().forEach((function(e){e.stop()})),this.mediaStream_=null)}},{key:"muteAudio",value:function(){return this.addRemoteEvent(!0,"audio"),this.doEnableTrack("audio",!1)}},{key:"muteVideo",value:function(){return this.addRemoteEvent(!0,"video"),this.doEnableTrack("video",!1)}},{key:"unmuteAudio",value:function(){return this.addRemoteEvent(!1,"audio"),this.doEnableTrack("audio",!0)}},{key:"unmuteVideo",value:function(){return this.addRemoteEvent(!1,"video"),this.doEnableTrack("video",!0)}},{key:"addRemoteEvent",value:function(e,t){if(this.isRemote_&&this.client_){var i=this.client_.getUserId(),n="".concat(e?"mute":"unmute"," remote ").concat(t);zh(i,{eventId:"audio"===t?e?32785:32787:e?32784:32786,eventDesc:n,timestamp:(new Date).getTime(),userId:i,tinyId:this.client_.getTinyId(),remoteUserId:this.userId_,remoteTinyId:this.connection_.getTinyId()})}}},{key:"doEnableTrack",value:function(e,t){var i=!1;return"audio"===e?this.mediaStream_.getAudioTracks().forEach((function(e){i=!0,e.enabled=t})):this.mediaStream_.getVideoTracks().forEach((function(e){i=!0,e.enabled=t})),i}},{key:"getId",value:function(){return this.id_}},{key:"getUserId",value:function(){return this.userId_}},{key:"getTinyId",value:function(){return this.connection_?this.connection_.getTinyId():""}},{key:"isPlaying",value:function(){return this.isPlaying_}},{key:"setAudioOutput",value:(t=o(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.audioOutputDeviceId_=t,!this.audioPlayer_){e.next=4;break}return e.next=4,this.audioPlayer_.setSinkId(t);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"setAudioVolume",value:function(e){this.audioVolume_=e,this.log_.info("setAudioVolume to ".concat(e)),this.audioPlayer_&&this.audioPlayer_.setVolume(e)}},{key:"getAudioLevel",value:function(){var e=0;return this.audioPlayer_&&(e=this.audioPlayer_.getAudioLevel()),e}},{key:"hasAudio",value:function(){if(this.isRemote_){if(!this.connection_)return!1;var e=this.connection_.getTrackState();return"main"===this.type_&&e.audio}return!!this.getAudioTrack()}},{key:"hasVideo",value:function(){if(this.isRemote_){if(!this.connection_)return!1;var e=this.connection_.getTrackState();return"auxiliary"===this.type_?e.auxiliary:e.video}return!!this.getVideoTrack()}},{key:"getSubscribedState",value:function(){return this.isRemote_&&this.connection_?this.connection_.getSubscribeState():null}},{key:"getAudioTrack",value:function(){var e=null;if(this.mediaStream_){var t=this.mediaStream_.getAudioTracks();t.length>0&&(e=t[0])}return e}},{key:"getVideoTrack",value:function(){var e=null;if(this.mediaStream_){var t=this.mediaStream_.getVideoTracks();t.length>0&&(e=t[0])}return e}},{key:"getVideoFrame",value:function(){return this.videoPlayer_?this.videoPlayer_.getVideoFrame():null}},{key:"getMediaStream",value:function(){return this.mediaStream_}},{key:"setMediaStream",value:function(e){e!==this.mediaStream_&&(this.mediaStream_&&this.mediaStream_.getTracks().forEach((function(e){return e.stop()})),this.mediaStream_=e)}},{key:"updateVideoPlayingState",value:function(e){this.isPlaying_&&(e?(this.log_.info("playing state updated, play video"),this.playVideo().catch((function(e){}))):(this.log_.info("playing state updated, stop video"),this.stopVideo()))}},{key:"updateAudioPlayingState",value:function(e){this.isPlaying_&&(e?(this.log_.info("playing state updated, play audio"),this.playAudio().catch((function(e){}))):(this.log_.info("playing state updated, stop audio"),this.stopAudio()))}},{key:"on",value:function(e,t,i){this.emitter_.on(e,t,i)}},{key:"off",value:function(e,t,i){"*"===e?this.emitter_.removeAllListeners():this.emitter_.off(e,t,i)}},{key:"isRemote",value:function(){return this.isRemote_}},{key:"getDiv",value:function(){return this.div_}},{key:"getObjectFit",value:function(){return this.objectFit_}},{key:"getMuted",value:function(){return this.muted_}},{key:"getClient",value:function(){return this.client_}}]),e}()).prototype,"play",[Cf],Object.getOwnPropertyDescriptor(Af.prototype,"play"),Af.prototype),Af),Gf=function(e){d(n,e);var t=g(n);function n(e){var r;s(this,n);var o={isRemote:!0,type:e.type},a=i(i({},e),o);return(r=t.call(this,a)).name_=aa,r.isInSubscriptionCycle_=!1,r.isStreamAddedEventEmitted_=!1,r.isAbleToCallSubscription_=!0,r.installEvents(),r}return c(n,[{key:"installEvents",value:function(){gf.on(_f.REMOTE_STREAM_SUBSCRIBED,this.handleStreamSubscribed,this),gf.on(_f.REMOTE_STREAM_UNSUBSCRIBED,this.handleStreamUnsubscribed,this)}},{key:"uninstallEvents",value:function(){gf.off(_f.REMOTE_STREAM_SUBSCRIBED,this.handleStreamSubscribed,this),gf.off(_f.REMOTE_STREAM_UNSUBSCRIBED,this.handleStreamUnsubscribed,this)}},{key:"handleStreamSubscribed",value:function(e){e.client===this.client_&&e.stream===this&&this.connection_.getCurrentState()===Es&&this.emitConnectionStateChanged({prevState:ys,state:Es})}},{key:"handleStreamUnsubscribed",value:function(e){e.client===this.client_&&e.stream===this&&this.emitConnectionStateChanged({prevState:Es,state:ys})}},{key:"getType",value:function(){return _(l(n.prototype),"getType",this).call(this)}},{key:"getIsAbleToCallSubscription",value:function(){return this.isAbleToCallSubscription_}},{key:"setIsAbleToCallSubscription",value:function(e){this.isAbleToCallSubscription_=e}},{key:"setInSubscriptionCycle",value:function(e){this.isInSubscriptionCycle_=e}},{key:"isInSubscriptionCycle",value:function(){return this.isInSubscriptionCycle_}},{key:"setIsStreamAddedEventEmitted",value:function(e){this.isStreamAddedEventEmitted_=e}},{key:"getIsStreamAddedEventEmitted",value:function(){return this.isStreamAddedEventEmitted_}},{key:"getAudioTrack",value:function(){return this.connection_&&this.connection_.getTrackState().audio?_(l(n.prototype),"getAudioTrack",this).call(this):null}},{key:"getVideoTrack",value:function(){if(!this.connection_)return null;var e=this.connection_.getTrackState();return"main"===this.type_&&!e.video||"auxiliary"===this.type_&&!e.auxiliary?null:_(l(n.prototype),"getVideoTrack",this).call(this)}},{key:"close",value:function(){this.uninstallEvents(),_(l(n.prototype),"close",this).call(this)}}]),n}(Hf),qf=function(){function e(t){s(this,e),this.client_=t.client,this.subscribedStreams_=new Map,this.unsubscribedStreams_=new Map,this.subscriptedOptions_=new Map,this.autoRecoveryFlags_=new Map}var t,i,n;return c(e,[{key:"isEnabled",get:function(){return"webrtc"!==this.client_.getEnv()}},{key:"recover",value:(n=o(regeneratorRuntime.mark((function e(t){var i,n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.getUserId(),n=t.getType(),this.hasAutoRecoveryFlag(i,n)){e.next=5;break}return e.abrupt("return");case 5:if(r=this.getUnsubscribedStream(i,n)?"unsubscribe":"subscribe",e.prev=6,Xu.warn("recover() try to recover subscription [".concat(r,"][").concat(i,"][").concat(n,"]")),"subscribe"!==r){e.next=13;break}return e.next=11,this.recoverSubscription(i,t);case 11:e.next=15;break;case 13:return e.next=15,this.recoverUnsubscription(i,t);case 15:Cc({eventType:Vs}),Xu.warn("recover() recover successfully [".concat(r,"][").concat(i,"][").concat(n,"]")),e.next=23;break;case 19:e.prev=19,e.t0=e.catch(6),Xu.error("recover() recover failed [".concat(r,"][").concat(i,"][").concat(n,"]"),e.t0),Ac({eventType:Vs,error:e.t0});case 23:this.deleteAutoRecoveryFlag(i,n);case 24:case"end":return e.stop()}}),e,this,[[6,19]])}))),function(e){return n.apply(this,arguments)})},{key:"recoverSubscription",value:(i=o(regeneratorRuntime.mark((function e(t,i){var n,r,o,s,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.getOptions(t,i.getType()),r=this.getSubscribedStream(t,i.getType()),n&&r){e.next=4;break}return e.abrupt("return");case 4:o=this.getStreamMuteState(r),s=o.isAudioMuted,a=o.isVideoMuted,this.mergeStream(r,i),this.recoverPlayingState(r),s&&r.doEnableTrack("audio",!1),a&&r.doEnableTrack("video",!1);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"recoverUnsubscription",value:(t=o(regeneratorRuntime.mark((function e(t,i){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.getUnsubscribedStream(t,i.getType())){e.next=3;break}return e.abrupt("return");case 3:this.mergeStream(n,i);case 4:case"end":return e.stop()}}),e,this)}))),function(e,i){return t.apply(this,arguments)})},{key:"getStreamMuteState",value:function(e){var t={isAudioMuted:!1,isVideoMuted:!1},i=e.getMediaStream();return i&&(t.isAudioMuted=i.getAudioTracks().map((function(e){return e.enabled})).includes(!1),t.isVideoMuted=i.getVideoTracks().map((function(e){return e.enabled})).includes(!1)),t}},{key:"recoverPlayingState",value:function(e){var t=e.isPlaying(),i=e.getDiv();if(t&&i){var n=i.parentNode;e.stop(),e.play(n,{objectFit:e.getObjectFit(),muted:e.getMuted()})}}},{key:"mergeStream",value:function(e,t){var i=t.getConnection(),n=t.getMediaStream();e.setConnection(i),i.setRemoteStream(n.id,e),e.setMediaStream(n),e.updateAudioPlayingState(t.hasAudio()),e.updateVideoPlayingState(t.hasVideo())}},{key:"addSubscriptionRecord",value:function(e,t,i){var n=t.getType();if(this.subscribedStreams_.has(e))this.subscribedStreams_.get(e).set(n,t);else{var r=new Map;r.set(t.getType(),t),this.subscribedStreams_.set(e,r)}if(this.subscriptedOptions_.has(e))this.subscriptedOptions_.get(e).set(n,i);else{var o=new Map;o.set(t.getType(),i),this.subscriptedOptions_.set(e,o)}this.deleteUnsubscriptionRecord(e,n)}},{key:"addUnsubscriptionRecord",value:function(e,t){if(this.unsubscribedStreams_.has(e))this.unsubscribedStreams_.get(e).set(t.getType(),t);else{var i=new Map;i.set(t.getType(),t),this.unsubscribedStreams_.set(e,i)}this.deleteSubscriptionRecord(e,t.getType())}},{key:"getSubscribedStream",value:function(e,t){return this.subscribedStreams_.has(e)&&this.subscribedStreams_.get(e).has(t)?this.subscribedStreams_.get(e).get(t):null}},{key:"getOptions",value:function(e,t){return this.subscriptedOptions_.has(e)&&this.subscriptedOptions_.get(e).has(t)?this.subscriptedOptions_.get(e).get(t):null}},{key:"getUnsubscribedStream",value:function(e,t){return this.unsubscribedStreams_.has(e)&&this.unsubscribedStreams_.get(e).has(t)?this.unsubscribedStreams_.get(e).get(t):null}},{key:"deleteSubscriptionRecord",value:function(e,t){this.subscribedStreams_.has(e)&&this.subscribedStreams_.get(e).delete(t),this.subscriptedOptions_.has(e)&&this.subscriptedOptions_.get(e).delete(t)}},{key:"deleteUnsubscriptionRecord",value:function(e,t){this.unsubscribedStreams_.has(e)&&this.unsubscribedStreams_.get(e).delete(t)}},{key:"markAllStream",value:function(){for(var e=0,t=S(this.subscribedStreams_.entries());e<t.length;e++)for(var i=y(t[e],2),n=i[0],r=0,o=S(i[1].entries());r<o.length;r++){var s=y(o[r],1)[0];this.setAutoRecoveryFlag(n,s)}for(var a=0,c=S(this.unsubscribedStreams_.entries());a<c.length;a++)for(var u=y(c[a],2),d=u[0],l=0,h=S(u[1].entries());l<h.length;l++){var p=y(h[l],1)[0];this.setAutoRecoveryFlag(d,p)}}},{key:"setAutoRecoveryFlag",value:function(e,t){if(Xu.info("setAutoRecoveryFlag() mark [".concat(e,"][").concat(t,"]")),this.autoRecoveryFlags_.has(e))this.autoRecoveryFlags_.get(e).set(t);else{var i=new Map;i.set(t),this.autoRecoveryFlags_.set(e,i)}}},{key:"hasAutoRecoveryFlag",value:function(e,t){return!!this.isEnabled&&this.autoRecoveryFlags_.has(e)&&this.autoRecoveryFlags_.get(e).has(t)}},{key:"deleteAutoRecoveryFlag",value:function(e,t){this.autoRecoveryFlags_.has(e)&&this.autoRecoveryFlags_.get(e).delete(t)}},{key:"delete",value:function(e){this.unsubscribedStreams_.delete(e),this.subscribedStreams_.delete(e),this.subscriptedOptions_.delete(e),this.autoRecoveryFlags_.delete(e)}}]),e}();gt({target:"String",proto:!0,forced:Zh("small")},{small:function(){return Xh(this,"small","","")}});var Jf=function(){function e(){s(this,e),this.video_=document.createElement("video"),this.video_.autoplay=!0,this.canvas_=document.createElement("canvas"),this.canvasCtx_=this.canvas_.getContext("2d")}return c(e,[{key:"setSrc",value:function(e){this.video_.srcObject=e}},{key:"setCanvasRect",value:function(e,t){this.canvas_.width=e,this.canvas_.height=t}},{key:"drawVideoToCanvas",value:function(){this.canvasCtx_.drawImage(this.video_,0,0,this.canvas_.width,this.canvas_.height)}},{key:"generateVideoTrackFromCanvasCapture",value:function(e){return this.canvas_.captureStream(e).getVideoTracks()[0]}},{key:"generateStreamFromTrack",value:function(e){var t=new MediaStream;return t.addTrack(e),t}},{key:"canvas",get:function(){return this.canvas_}},{key:"canvasCtx",get:function(){return this.canvasCtx_}},{key:"canDrawVideoToCanvas",get:function(){return this.video_.readyState===this.video_.HAVE_ENOUGH_DATA}}]),e}(),Wf=function(){function e(){s(this,e),this.processor_=new Jf}return c(e,[{key:"generateSmallVideoTrack",value:function(e){var t=this.getSmallVideoProfile(e),i=this.processor_.generateStreamFromTrack(e.videoTrack);this.processor_.setSrc(i),this.processor_.setCanvasRect(t.width,t.height);var n=this.processor_.generateVideoTrackFromCanvasCapture(t.framerate);return this.interval_=Id.setInterval(this.render.bind(this),Math.ceil(1e3/t.framerate)),n}},{key:"render",value:function(){this.processor_.canDrawVideoToCanvas&&this.processor_.drawVideoToCanvas()}},{key:"destroy",value:function(){Id.clearInterval(this.interval_)}},{key:"getSmallVideoProfile",value:function(e){var t,i=e.videoTrack,n=e.smallStreamConfig,r=i.getSettings(),o=r&&r.width&&r.height?{width:r.width,height:r.height}:e.videoProfile,s=o.width*o.height,a=n.width*n.height;return Xu.log("big stream resolution: ".concat(o.height,"*").concat(o.width," small stream resolution: ").concat(n.height,"*").concat(n.width," ")),s>a?t=s/a:(Xu.warn("Small stream resolution is larger than big stream, which is invalid. big: ".concat(o.width," * ").concat(o.height," small: ").concat(n.width," * ").concat(n.height)),t=s/19200),{width:parseInt(o.width/Math.sqrt(t)),height:parseInt(o.height/Math.sqrt(t)),framerate:n.framerate}}}]),e}(),zf={voiceActivityDetection:!1},$f=function(e){d(E,e);var t,i,n,r,a,u,h,p,f,m,v,y,S,T=g(E);function E(e){var t;return s(this,E),(t=T.call(this,e)).localStream_=null,t.exchangeSDPTimeout_=-1,t.generator_=null,t.isSDPExchanging_=!1,t.ssrc_={audio:0,video:0,small:0},t}return c(E,[{key:"initialize",value:function(){_(l(E.prototype),"initialize",this).call(this),this.installEvents()}},{key:"reset",value:function(){_(l(E.prototype),"close",this).call(this),this.uninstallEvents(),this.clearExchangeSDPTimeout()}},{key:"close",value:function(){this.reset(),this.emitConnectionStateChangedEvent(ys),this.generator_&&(this.generator_.destroy(),this.generator_=null)}},{key:"installEvents",value:function(){this.emitter_.on(ef,this.handleError,this),this.emitter_.on(tf,this.handleConnectionStateChange,this)}},{key:"uninstallEvents",value:function(){this.emitter_.off(ef,this.handleError,this),this.emitter_.off(tf,this.handleConnectionStateChange,this)}},{key:"publish",value:(S=o(regeneratorRuntime.mark((function e(t){var i,n,r,o,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.localStream_=t,i=t.getMediaStream(),this.log_.info("is publishing stream: ".concat(t.getId())),n=this.localStream_.getAudioTrack(),r=this.localStream_.getVideoTrack(),n&&this.peerConnection_.addTrack(n,i),r&&(this.peerConnection_.addTrack(r,i),this.client_.getIsEnableSmallStream()&&(o=this.localStream_.getVideoProfile(),this.generator_=new Wf,s=this.generator_.generateSmallVideoTrack({videoTrack:r,videoProfile:o,smallStreamConfig:this.client_.smallStreamConfig_}),this.peerConnection_.addTrack(s,i))),this.updateMediaSettings(i),e.next=10,this.connect();case 10:return e.abrupt("return",t);case 11:case"end":return e.stop()}}),e,this)}))),function(e){return S.apply(this,arguments)})},{key:"updateMediaSettings",value:function(e){var t=this,i=this.client_.getSystemResult().detail,n=i.isH264EncodeSupported,r=i.isVp8EncodeSupported,o="";n?o="H264":r&&(o="VP8");var s={EncVideoCodec:o,EncVideoWidth:0,EncVideoHeight:0,EncVideoBr:"0",EncVideoFps:0,EncAudioCodec:"opus",EncAudioFS:0,EncAudioCh:0,EncAudioBr:"0"};"getSettings"in MediaStreamTrack.prototype?e.getTracks().forEach((function(e){var i=e.getSettings();if("audio"===e.kind){var n=1;i.channelCount&&(n=i.channelCount),s.EncAudioCh=n,s.EncAudioBr="".concat(1e3*t.localStream_.getAudioBitrate()),s.EncAudioFS=i.sampleRate}else"video"===e.kind&&(t.client_.getIsEnableSmallStream()&&(s.EncSmallVideoWidth=t.client_.smallStreamConfig.width,s.EncSmallVideoHeight=t.client_.smallStreamConfig.height,s.EncSmallVideoFps=t.client_.smallStreamConfig.framerate,s.EncSmallVideoBr="".concat(1e3*t.client_.smallStreamConfig.bitrate)),s.EncVideoWidth=i.width,s.EncVideoHeight=i.height,s.EncVideoFps=i.frameRate,s.EncVideoBr="".concat(1e3*t.localStream_.getVideoBitrate()))})):s=this.getMediaSettingsFromProfile(s),this.log_.info("updateMediaSettings: "+JSON.stringify(s)),this.signalChannel_.send("on_constraints_config",s)}},{key:"getMediaSettingsFromProfile",value:function(e){var t=this.localStream_;if(t){if(t.getAudioTrack()){var i=t.getAudioProfile();e.EncAudioCh=i.channelCount,e.EncAudioBr="".concat(1e3*i.bitrate),e.EncAudioFS=i.sampleRate}if(t.getVideoTrack()){var n=t.getVideoProfile();e.EncVideoWidth=n.width,e.EncVideoHeight=n.height,e.EncVideoFps=n.frameRate,e.EncVideoBr="".concat(1e3*n.bitrate)}}return e}},{key:"addTrack",value:(y=o(regeneratorRuntime.mark((function e(t){var i,n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.peerConnection_){e.next=19;break}if(this.log_.info("is adding ".concat(t.kind," track to current published local stream")),!(this.peerConnection_.getTransceivers().findIndex((function(e){return"stopped"===e.direction}))>=0)){e.next=6;break}return this.log_.warn("transceiver is stopping, negotiate sdp first"),e.next=6,this.updateOffer(na,t);case 6:if(!(i=this.peerConnection_.getSenders().find((function(e){return e.track&&e.track.kind===t.kind})))){e.next=13;break}return this.log_.warn("sender already exists, remove sender first"),n=i.track,this.removeSender(i),e.next=13,this.updateOffer(na,n);case 13:return r=this.localStream_.getMediaStream(),this.peerConnection_.addTrack(t,r),this.updateMediaSettings(r),e.next=18,this.updateOffer(ia,t);case 18:zh(this.userId_,{eventId:t.kind===Zs?32769:32768,eventDesc:"add ".concat(t.kind," track to current published stream"),timestamp:Tc(),userId:this.userId_,tinyId:this.tinyId_});case 19:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"isNeedToResetOfferOrder",value:function(){if("plan-b"===this.sdpSemantics_||!this.peerConnection_||!this.peerConnection_.localDescription)return!1;for(var e=this.peerConnection_.localDescription.sdp,t=Ip(e),i=0;i<t.media.length;i++)if(0===t.media[i].mid&&"video"===t.media[i].type)return!0;return!1}},{key:"removeSender",value:function(e){var t=null;"RTCPeerConnection"in window&&"getTransceivers"in window.RTCPeerConnection.prototype&&(t=this.peerConnection_.getTransceivers().find((function(t){return t.sender&&t.sender.track===e.track}))),this.peerConnection_.removeTrack(e),t&&Nc(t.stop)&&(this.log_.info("stop transceiver"),t.stop())}},{key:"removeTrack",value:(v=o(regeneratorRuntime.mark((function e(t){var i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.peerConnection_||!Fp()){e.next=13;break}if(this.log_.info("is removing ".concat(t.kind," track from current published local stream")),"video"!==t.kind||!this.isNeedToResetOfferOrder()){e.next=8;break}return this.reset(),this.initialize(),e.next=7,this.publish(this.localStream_);case 7:return e.abrupt("return");case 8:return(i=this.peerConnection_.getSenders().find((function(e){return e.track===t})))&&(this.removeSender(i),this.updateMediaSettings(this.localStream_.getMediaStream())),e.next=12,this.updateOffer(na,t);case 12:zh(this.userId_,{eventId:t.kind===Zs?32771:32770,eventDesc:"remove ".concat(t.kind," track from current published stream"),timestamp:Tc(),userId:this.userId_,tinyId:this.tinyId_});case 13:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"isReplaceTrackAvailable",value:function(){return"RTCRtpSender"in window&&"replaceTrack"in window.RTCRtpSender.prototype}},{key:"replaceTrack",value:(m=o(regeneratorRuntime.mark((function e(t){var i,n=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isReplaceTrackAvailable()&&Fp()){e.next=2;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:"NOT_SUPPORTED_REPLACE_TRACK"})});case 2:if(this.peerConnection_){e.next=4;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:ap})});case 4:if(0!==(i=this.peerConnection_.getSenders()).length){e.next=7;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:ap})});case 7:i.forEach((function(e){e.track&&e.track.kind===t.kind&&(n.log_.info("is replacing ".concat(t.kind," track to current published local stream")),e.replaceTrack(t))})),zh(this.userId_,{eventId:t.kind===Zs?32783:32782,eventDesc:"replace ".concat(t.kind," track from current published stream"),timestamp:Tc(),userId:this.userId_,tinyId:this.tinyId_});case 9:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"setBandwidth",value:(f=o(regeneratorRuntime.mark((function e(t,i,n){var r,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isUplink_){e.next=2;break}return e.abrupt("return",n);case 2:if(jp()){e.next=4;break}return e.abrupt("return","video"===i?this.updateVideoBandwidthRestriction(n,t):this.updateAudioBandwidthRestriction(n,t));case 4:if(!(r=this.peerConnection_.getSenders().find((function(e){return e.track&&e.track.kind===i})))){e.next=20;break}return(o=r.getParameters()).encodings&&0!==o.encodings.length||(o.encodings=[{}]),"unlimited"===t?delete o.encodings[0].maxBitrate:o.encodings[0].maxBitrate=1e3*t,e.prev=9,e.next=12,r.setParameters(o);case 12:return this.log_.debug(i+" bandwidth was set to "+t+" kbps"),e.abrupt("return",n);case 16:return e.prev=16,e.t0=e.catch(9),this.log_.info("failed to set bandwidth by setting maxBitrate: "+e.t0),e.abrupt("return","video"===i?this.updateVideoBandwidthRestriction(n,t):this.updateAudioBandwidthRestriction(n,t));case 20:return e.abrupt("return",n);case 21:case"end":return e.stop()}}),e,this,[[9,16]])}))),function(e,t,i){return f.apply(this,arguments)})},{key:"setSmallStreamBandwidth",value:(p=o(regeneratorRuntime.mark((function e(t,i){var n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isUplink_){e.next=2;break}return e.abrupt("return",i);case 2:if(jp()){e.next=4;break}return e.abrupt("return",this.updateSmallVideoBandwidthRestriction(i,t));case 4:if(!(n=this.peerConnection_.getSenders().filter((function(e){return e.track&&"video"===e.track.kind}))[1])){e.next=20;break}return(r=n.getParameters()).encodings&&0!==r.encodings.length||(r.encodings=[{}]),"unlimited"===t?delete r.encodings[0].maxBitrate:r.encodings[0].maxBitrate=1e3*t,e.prev=9,e.next=12,n.setParameters(r);case 12:return this.log_.info("small stream bandwidth was set to "+t+" kbps"),e.abrupt("return",i);case 16:return e.prev=16,e.t0=e.catch(9),this.log_.debug("failed to set small stream bandwidth by setting maxBitrate: "+e.t0),e.abrupt("return",this.updateSmallVideoBandwidthRestriction(i,t));case 20:return e.abrupt("return",i);case 21:case"end":return e.stop()}}),e,this,[[9,16]])}))),function(e,t){return p.apply(this,arguments)})},{key:"updateVideoBandwidthRestriction",value:function(e,t){var i="AS";return tu&&(i="TIAS",t*=1e3),-1===e.indexOf("b="+i+":")?e.replace(/m=video (.*)\r\nc=IN (.*)\r\n/,"m=video $1\r\nc=IN $2\r\nb="+i+":"+t+"\r\n"):e.replace(new RegExp("b="+i+":.*\r\n"),"b="+i+":"+t+"\r\n")}},{key:"updateAudioBandwidthRestriction",value:function(e,t){var i="AS";return tu&&(i="TIAS",t*=1e3),e.replace(/m=audio (.*)\r\nc=IN (.*)\r\n/,"m=audio $1\r\nc=IN $2\r\nb="+i+":"+t+"\r\n")}},{key:"updateSmallVideoBandwidthRestriction",value:function(e,t){var i="AS";tu&&(i="TIAS",t*=1e3);var n=/m=video (.*)\r\nc=IN (.*)\r\n/g,r=[],o=n.exec(e);for(r.push(o);null!==o;)o=n.exec(e),r.push(o);var s=r[r.length-2],a=e.slice(0,s.index),c=e.slice(s.index);return-1===e.indexOf("b="+i+":")?a+(c=c.replace(/m=video (.*)\r\nc=IN (.*)\r\n/,"m=video $1\r\nc=IN $2\r\nb="+i+":"+t+"\r\n")):a+(c=c.replace(new RegExp("b="+i+":.*\r\n"),"b="+i+":"+t+"\r\n"))}},{key:"removeBandwidthRestriction",value:function(e){return e.replace(/b=AS:.*\r\n/,"").replace(/b=TIAS:.*\r\n/,"")}},{key:"removeVideoOrientation",value:function(e){return e.replace(/urn:3gpp:video-orientation/,"")}},{key:"connect",value:(h=o(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.exchangeSDP();case 3:return e.next=5,this.waitForPeerConnectionConnected();case 5:e.next=11;break;case 7:throw e.prev=7,e.t0=e.catch(0),this.closePeerConnection(!0),e.t0;case 11:case"end":return e.stop()}}),e,this,[[0,7]])}))),function(){return h.apply(this,arguments)})},{key:"exchangeSDP",value:(u=o(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.isSDPExchanging_=!0,e.next=4,this.createOffer();case 4:return this.log_.info("createOffer success, sending offer to remote server"),e.next=7,this.doExchangeSDP();case 7:this.isSDPExchanging_=!1,e.next=14;break;case 10:throw e.prev=10,e.t0=e.catch(0),this.isSDPExchanging_=!1,e.t0;case 14:case"end":return e.stop()}}),e,this,[[0,10]])}))),function(){return u.apply(this,arguments)})},{key:"createOffer",value:(a=o(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.peerConnection_.createOffer(zf);case 3:return t=e.sent,e.next=6,this.peerConnection_.setLocalDescription(t);case 6:this.updateSSRC(t.sdp),Cc({eventType:Os,kind:"offer"}),e.next=14;break;case 10:throw e.prev=10,e.t0=e.catch(0),Ac({eventType:Os,kind:"offer",error:e.t0}),e.t0;case 14:case"end":return e.stop()}}),e,this,[[0,10]])}))),function(){return a.apply(this,arguments)})},{key:"doExchangeSDP",value:function(){var e=this;return new Promise((function(t,i){e.exchangeSDPTimeout_=setTimeout((function(){e.signalChannel_.off(qh.PUBLISH_RESULT,n),e.signalChannel_.off(qh.ON_PUBLISH_RESPONSE,n),e.clearExchangeSDPTimeout();var t=new da({code:ua.API_CALL_TIMEOUT,message:pp({key:"EXCHANGE_SDP_TIMEOUT"})});i(t)}),5e3);var n=function(){var n=o(regeneratorRuntime.mark((function n(r){return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,e.clearExchangeSDPTimeout(),n.next=4,e.acceptAnswer(r.data.content);case 4:t(),n.next=10;break;case 7:n.prev=7,n.t0=n.catch(0),i(n.t0);case 10:case"end":return n.stop()}}),n,null,[[0,7]])})));return function(e){return n.apply(this,arguments)}}(),r={type:e.peerConnection_.localDescription.type,sdp:e.removeVideoOrientation(e.peerConnection_.localDescription.sdp),screen:e.localStream_.hasScreenTrack()};e.signalChannel_.once(qh.PUBLISH_RESULT,n),e.signalChannel_.once(qh.ON_PUBLISH_RESPONSE,n),e.log_.debug("sending sdp offer: "+r.sdp),e.signalChannel_.send("on_publish",r,0)}))}},{key:"setSDPDirection",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"all",n=Ip(e);return n.media.forEach((function(e){"all"!==i&&e.type!==i||(e.direction=t)})),kp(n)}},{key:"updateOffer",value:(r=o(regeneratorRuntime.mark((function e(t,i){var n,r,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.peerConnection_.createOffer(zf);case 3:return n=e.sent,tu&&(n.sdp=this.setSDPDirection(n.sdp,"sendrecv")),e.next=7,this.peerConnection_.setLocalDescription(n);case 7:return r={action:t,trackId:i.id,kind:i.kind,type:"offer",sdp:this.peerConnection_.localDescription.sdp},this.log_.info("createOffer success, sending updated offer to remote server"),this.log_.debug("updatedOffer: "+r.sdp),e.next=12,this.signalChannel_.sendWaitForResponse({command:"on_update_track",data:r,responseCommand:qh.UPDATE_OFFER_RESULT,timeout:1e4,commandDesc:"update offer"});case 12:return o=e.sent,e.next=15,this.acceptAnswer(o.data.content);case 15:Cc({eventType:Os,kind:"offer"}),e.next=23;break;case 18:throw e.prev=18,e.t0=e.catch(0),this.log_.error(e.t0),Ac({eventType:Os,kind:"offer",error:e.t0}),e.t0;case 23:case"end":return e.stop()}}),e,this,[[0,18]])}))),function(e,t){return r.apply(this,arguments)})},{key:"acceptAnswer",value:(n=o(regeneratorRuntime.mark((function e(t){var i,n,r,o,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(77392!==t.result){e.next=3;break}throw this.log_.error(lp.NOT_SUPPORTED_H264ENCODE),new da({code:ua.NOT_SUPPORTED_H264,message:pp({key:up})});case 3:return i=this.localStream_.getVideoBitrate(),n=this.localStream_.getAudioBitrate(),r=this.removeVideoOrientation(t.sdp),e.prev=6,e.next=9,this.setBandwidth(i,"video",r);case 9:return r=e.sent,e.next=12,this.setBandwidth(n,"audio",r);case 12:if(r=e.sent,!this.client_.getIsEnableSmallStream()){e.next=18;break}return o=this.client_.smallStreamConfig,e.next=17,this.setSmallStreamBandwidth(o.bitrate,r);case 17:r=e.sent;case 18:return s={type:t.type,sdp:r},e.next=21,this.peerConnection_.setRemoteDescription(s);case 21:this.log_.debug("accepted answer: "+r),Cc({eventType:Ps,kind:"answer"}),e.next=30;break;case 25:throw e.prev=25,e.t0=e.catch(6),Ac({eventType:Ps,kind:"answer",error:e.t0}),this.log_.error("failed to accept remote answer "+e.t0),e.t0;case 30:case"end":return e.stop()}}),e,this,[[6,25]])}))),function(e){return n.apply(this,arguments)})},{key:"sendMutedFlag",value:function(e){var t={srctinyid:0,userid:this.userId_,flag:e};this.log_.info("send muted flag: ".concat(e)),this.signalChannel_.send("on_mute_uplink",t)}},{key:"getIsReconnecting",value:function(){return this.isReconnecting_}},{key:"reconnect",value:(i=o(regeneratorRuntime.mark((function e(){var t,i,n=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(-1===this.reconnectionTimer_){e.next=3;break}return this.log_.warn("reconnect() uplink is reconnecting, ignore current reconnection"),e.abrupt("return");case 3:if(!(this.reconnectionCount_>=30)){e.next=12;break}return this.log_.warn("SDK has tried reconnect uplink for ".concat(30," times, but all failed, please check your network")),this.stopReconnection(),t=new da({code:ua.UPLINK_RECONNECTION_FAILED,message:pp({key:"UPLINK_RECONNECTION_FAILED"})}),Ac({eventType:Cs,error:t}),this.addEventInternal(32799,"uplink-connection reconnect fail"),this.emitConnectionStateChangedEvent(ys),this.emitter_.emit(ef,t),e.abrupt("return");case 12:if(this.signalChannel_.getCurrentState()===Bh){e.next=16;break}return this.log_.warn("reconnect() signal channel is not connected, suspend reconnection until signal is connected"),this.signalChannel_.once(Nh,this.reconnect,this),e.abrupt("return");case 16:if(this.reconnectionCount_++,e.prev=17,this.log_.warn("reconnect() try to reconnect uplink [".concat(this.reconnectionCount_,"/").concat(30,"]")),i=Lc(this.reconnectionCount_),this.reconnectionTimer_=setTimeout((function(){n.log_.warn("reconnect() uplink reconnect timeout(".concat(i/1e3,"s), try again")),n.signalChannel_.off(qh.UNPUBLISH_RESULT,n.onUnpublishResult,n),n.clearReconnectionTimer(),n.reconnect()}),i),!(this.isSDPExchanging_||this.peerConnection_&&"connecting"===this.peerConnection_.connectionState)){e.next=23;break}return e.abrupt("return");case 23:this.signalChannel_.send(Jh),this.signalChannel_.once(qh.UNPUBLISH_RESULT,this.onUnpublishResult,this),e.next=29;break;case 27:e.prev=27,e.t0=e.catch(17);case 29:case"end":return e.stop()}}),e,this,[[17,27]])}))),function(){return i.apply(this,arguments)})},{key:"onUnpublishResult",value:(t=o(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.reset(),this.initialize(),e.next=5,this.publish(this.localStream_);case 5:e.next=9;break;case 7:e.prev=7,e.t0=e.catch(0);case 9:case"end":return e.stop()}}),e,this,[[0,7]])}))),function(){return t.apply(this,arguments)})},{key:"clearExchangeSDPTimeout",value:function(){-1!==this.exchangeSDPTimeout_&&(clearTimeout(this.exchangeSDPTimeout_),this.exchangeSDPTimeout_=-1)}},{key:"clearReconnectionTimer",value:function(){-1!==this.reconnectionTimer_&&(clearTimeout(this.reconnectionTimer_),this.reconnectionTimer_=-1)}},{key:"handleError",value:function(e){e.getCode()===ua.ICE_TRANSPORT_ERROR&&(this.isFirstConnection_&&(this.isFirstConnection_=!1,Ac({eventType:ws,error:e})),this.isReconnecting_||this.startReconnection())}},{key:"handleConnectionStateChange",value:function(e){e.state===Es&&(this.isFirstConnection_&&(this.isFirstConnection_=!1,Cc({eventType:ws}),this.addEventInternal(32792,"uplink-connection is connected")),this.isReconnecting_&&(Cc({eventType:Cs}),this.log_.warn("reconnect() uplink reconnect successfully"),this.addEventInternal(32798,"uplink-connection reconnect success"),this.stopReconnection()))}},{key:"updateSSRC",value:function(e){var t=this;try{var i=0;Ip(e).media.forEach((function(e){if("audio"===e.type){var n=e.ssrcs[0];n&&(t.ssrc_.audio=n.id)}else{var r=e.ssrcs[0];switch(i+=1){case 1:r&&(t.ssrc_.video=r.id);break;case 2:r&&(t.ssrc_.small=r.id)}}}))}catch(e){}}},{key:"getLocalStreamVideoTrackId",value:function(){if(this.localStream_){var e=this.localStream_.getVideoTrack();if(e)return e.id}return""}},{key:"getSSRC",value:function(){return this.ssrc_}}]),E}(Lf),Kf=function(e){d(f,e);var t,i,n,r,a,u,h,p=g(f);function f(e){var t;return s(this,f),(t=p.call(this,e)).remoteStreams_=new Map,t.autoSubscribe=e.autoSubscribe,t.trackState_={audio:e.trackState.audio,video:e.trackState.video,auxiliary:e.trackState.auxiliary},t.ssrc_={audio:0,video:0,auxiliary:0},t.subscribeState_={audio:e.autoSubscribe,video:e.autoSubscribe,auxiliary:e.autoSubscribe},t.pendingSubscription_=[],t.pendingStreams_=[],t.subscriptionTimeout_=-1,t.subscriptionRetryCount_=0,t.isSubscriptionPending_=!1,t.sentSubscriptionAfterConnected_=!1,t.isSDPExchanging_=!1,t.installEvents(),t}return c(f,[{key:"isMainStreamSubscribed",get:function(){return(this.subscribeState_.audio||this.subscribeState_.video)&&(this.trackState_.audio||this.trackState_.video)}},{key:"isAuxStreamSubscribed",get:function(){return this.subscribeState_.auxiliary&&this.trackState_.auxiliary}},{key:"initialize",value:function(){_(l(f.prototype),"initialize",this).call(this),this.peerConnection_.ontrack=this.onTrack.bind(this)}},{key:"close",value:function(){var e=this;_(l(f.prototype),"close",this).call(this),this.emitConnectionStateChangedEvent(ys),-1!==this.subscriptionTimeout_&&(clearTimeout(this.subscriptionTimeout_),this.subscriptionTimeout_=-1),this.remoteStreams_.forEach((function(t){var i=t;i.setConnection(null),i.getIsStreamAddedEventEmitted()&&e.emitter_.emit(Qp,{stream:i})})),this.remoteStreams_.clear(),this.uninstallEvents()}},{key:"installEvents",value:function(){var e=this;gf.on(_f.REMOTE_STREAM_TRACK_UPDATED,this.onRemoteStreamUpdate,this),this.signalChannel_.on(qh.SUBSCRIBE_CHANGE_RESULT,this.onSubscribeChangeResult,this),this.signalChannel_.on(qh.UNSUBSCRIBE_RESULT,this.onUnsubscribeResult,this),this.emitter_.on(ef,(function(t){t.getCode()===ua.ICE_TRANSPORT_ERROR&&(e.isFirstConnection_&&(e.isFirstConnection_=!1,Ac({eventType:As,error:t})),e.isReconnecting_||e.startReconnection())})),this.emitter_.on(tf,(function(t){t.state===Es&&e.isFirstConnection_&&(e.isFirstConnection_=!1,Cc({eventType:As}),e.addEventInternal(32793,"downlink-connection is connected"))}))}},{key:"uninstallEvents",value:function(){gf.removeListener(_f.REMOTE_STREAM_TRACK_UPDATED,this.onRemoteStreamUpdate,this),this.signalChannel_.removeListener(qh.SUBSCRIBE_CHANGE_RESULT,this.onSubscribeChangeResult,this),this.signalChannel_.removeListener(qh.UNSUBSCRIBE_RESULT,this.onUnsubscribeResult,this)}},{key:"onRemoteStreamUpdate",value:function(e){if(this.hitTest(e.tinyId)&&e.client===this.client_){this.updateTrackState(e.action,e.kind);var t=e.kind===ta?_s:gs,i=this.remoteStreams_.get(t);if(!i)return;e.action===ia?this.handleRemoteAddTrack(e.kind,i):this.handleRemoteRemoveTrack(e.kind,i)}}},{key:"handleRemoteAddTrack",value:function(e,t){this.log_.info("remote add ".concat(e," track")),"audio"===e?t.updateAudioPlayingState(this.subscribeState_.audio):t.updateVideoPlayingState(e===ta?this.subscribeState_.auxiliary:this.subscribeState_.video),t.getIsStreamAddedEventEmitted()?this.emitter_.emit(Xp,{stream:t}):(this.emitter_.emit(Yp,{stream:t}),this.currentState_===Es&&t.emitConnectionStateChanged({prevState:ys,state:Es}))}},{key:"handleRemoteRemoveTrack",value:function(e,t){t.getIsStreamAddedEventEmitted()&&(this.log_.info("remote remove ".concat(e," track")),e!==ta&&(this.trackState_.audio||this.trackState_.video)||t.isInSubscriptionCycle()?("audio"===e?t.updateAudioPlayingState(!1):t.updateVideoPlayingState(!1),this.emitter_.emit(Xp,{stream:t})):(this.log_.info("remote stream ".concat(t.getType()," removed")),this.currentState_===Es&&t.emitConnectionStateChanged({prevState:Es,state:ys}),this.emitter_.emit(Qp,{stream:t})))}},{key:"updateTrackState",value:function(e,t){var i=e===ia;switch(t){case Zs:this.trackState_.audio=i;break;case ea:this.trackState_.video=i;break;case ta:this.trackState_.auxiliary=i}this.log_.info("trackState updated: ".concat(JSON.stringify(this.trackState_)))}},{key:"onTrack",value:function(e){var t=e.streams[0],i=e.track;if(this.log_.info("ontrack() kind: ".concat(i.kind," id: ").concat(i.id," streamId: ").concat(t.id)),"unified-plan"===this.sdpSemantics_){var n=function(e){var t=Rp.parse(e),i={audio:[],video:[]};return t.media.forEach((function(e){if(e.ssrcs){var t=e.ssrcs[0].id>>16&255;if("audio"===e.type)i.audio.push(gs);else if("video"==e.type){var n=2===t?gs:_s;i.video.push(n)}}})),i}(this.peerConnection_.remoteDescription.sdp);if("audio"===i.kind){if(0===n.audio.length||t.id!==gs)return void this.log_.debug("skip this invalid audio track")}else if(-1===n.video.indexOf(t.id))return void this.log_.debug("skip this invalid video track: ".concat(i.id,"  msid: ").concat(t.id))}wc({eventType:"ontrack",kind:i.kind});var r=!1,o=this.remoteStreams_.get(t.id),s=t.id===gs?"main":"auxiliary";if(Uc(o)&&((o=new Gf({type:s,userId:this.userId_,client:this.client_})).setConnection(this),this.remoteStreams_.set(t.id,o),r=!0),o.setMediaStream(t),i.kind===Zs?o.updateAudioPlayingState(this.subscribeState_.audio):"main"===s?o.updateVideoPlayingState(this.subscribeState_.video):o.updateVideoPlayingState(this.subscribeState_.auxiliary),("auxiliary"!==s||this.trackState_.auxiliary)&&("main"!==s||this.trackState_.audio||this.trackState_.video)){var a=this.client_.getSubscriptionManager();a&&a.hasAutoRecoveryFlag(this.userId_,s)||(r?this.emitter_.emit(Yp,{stream:o}):this.emitter_.emit(Xp,{stream:o}))}}},{key:"addRRTRLine",value:function(e){var t=e.split("\r\n"),i=new Map;t.forEach((function(e,n){/^a=rtcp-fb:/.test(e)&&t[n+1]&&!/^a=rtcp-fb:/.test(t[n+1])&&i.set(n+1,e.match(/^a=rtcp-fb:\d+/)[0]+" rrtr")}));for(var n=S(i),r=0;r<n.length;r++){var o=y(n[r],2),s=o[0],a=o[1];t.splice(s+r,0,a)}return t.join("\r\n")}},{key:"addSPSDescription",value:function(e){var t=Ip(e);return t.media.forEach((function(e){"video"===e.type&&e.fmtp.forEach((function(e){e.config+=";sps-pps-idr-in-keyframe=1"}))})),kp(t)}},{key:"removeSDESDescription",value:function(e){var t=["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"],i=Ip(e);return i.media.forEach((function(e){e.ext=e.ext.filter((function(e){return!t.includes(e.uri)}))})),kp(i)}},{key:"isSubscriptionStateNotChanged",value:function(e,t){return"main"===e.getType()?!Uc(t.audio)&&!Uc(t.video)&&t.audio===this.subscribeState_.audio&&t.video===this.subscribeState_.video:"auxiliary"===e.getType()?!Uc(t.video)&&this.subscribeState_.auxiliary===t.video:void 0}},{key:"subscribe",value:(h=o(regeneratorRuntime.mark((function e(t,i){var n,r,o,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=i.emitEvent,r=void 0===n||n,o=t.getType(),!this.isSubscriptionStateNotChanged(t,i)){e.next=13;break}if(!this.peerConnection_){e.next=8;break}return e.next=6,this.waitForPeerConnectionConnected();case 6:e.next=11;break;case 8:return this.initialize(),e.next=11,this.connect();case 11:return r&&this.emitter_.emit(Zp,{stream:t,result:!0}),e.abrupt("return",t);case 13:if("main"===o?(Uc(i.audio)||(this.subscribeState_.audio=i.audio),Uc(i.video)||(this.subscribeState_.video=i.video),this.addEventInternal(this.subscribeState_.audio?32777:32779,this.subscribeState_.audio?"subscribe audio":"unsubscribe audio"),this.addEventInternal(this.subscribeState_.video?32777:32779,this.subscribeState_.video?"subscribe video":"unsubscribe video")):Uc(i.video)||(this.subscribeState_.auxiliary=i.video),this.log_.info("subscribe ".concat(o," stream with options ").concat(JSON.stringify(i)," current state: ").concat(JSON.stringify(this.subscribeState_))),!this.peerConnection_&&!this.isSDPExchanging_){e.next=23;break}return s=Gs,this.isMainStreamSubscribed||this.isAuxStreamSubscribed||(s=Hs),e.next=20,this.sendSubscription(t,s);case 20:"main"===o?(t.updateAudioPlayingState(this.subscribeState_.audio),t.updateVideoPlayingState(this.subscribeState_.video)):t.updateVideoPlayingState(this.subscribeState_.auxiliary),e.next=26;break;case 23:return this.initialize(),e.next=26,this.connect();case 26:return r&&this.emitter_.emit(Zp,{stream:t,result:!0}),e.abrupt("return",t);case 28:case"end":return e.stop()}}),e,this)}))),function(e,t){return h.apply(this,arguments)})},{key:"unsubscribe",value:(u=o(regeneratorRuntime.mark((function e(t){var i,n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("main"!==(i=t.getType())){e.next=9;break}if(this.isMainStreamSubscribed){e.next=5;break}return this.log_.info("main stream already unsubscribed"),e.abrupt("return",t);case 5:this.subscribeState_.audio=!1,this.subscribeState_.video=!1,e.next=13;break;case 9:if(this.isAuxStreamSubscribed){e.next=12;break}return this.log_.info("auxiliary stream already unsubscribed"),e.abrupt("return",t);case 12:this.subscribeState_.auxiliary=!1;case 13:return n=Hs,("main"===i&&this.isAuxStreamSubscribed||"auxiliary"===i&&this.isMainStreamSubscribed)&&(n=Gs),this.log_.info("unsubscribe ".concat(i," stream with ").concat(JSON.stringify(this.subscribeState_))),e.next=18,this.sendSubscription(t,n);case 18:return t.updateVideoPlayingState(!1),t.updateAudioPlayingState(!1),n===Hs&&((r=t.getMediaStream())&&r.getTracks().forEach((function(e){return r.removeTrack(e)})),this.closePeerConnection(),this.emitConnectionStateChangedEvent(ys)),this.addEventInternal(32779,"unsubscribe audio"),this.addEventInternal(32778,"unsubscribe video"),e.abrupt("return",t);case 24:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"sendSubscription",value:function(e,t){var i=this;return new Promise((function(n,r){var o={srctinyid:i.tinyId_,userid:i.userId_,audio:i.subscribeState_.audio,bigVideo:i.subscribeState_.video,auxVideo:i.subscribeState_.auxiliary};i.pendingSubscription_.length>0?i.log_.debug("queue the subscription for later handling"):i.doSendSubscription(o,e,t),i.pendingSubscription_.push({stream:e,type:t,data:o,callback:function(e){var o=e.code,s=e.message;if(0===o)n();else{var a=new da({code:o,message:pp({key:"ERROR_MESSAGE",data:{type:t,message:s}})});i.log_.error(a),r(a)}}}),e.setInSubscriptionCycle(!0)}))}},{key:"doSendSubscription",value:function(e,t,i){var n=this;if(!this.peerConnection_||"connected"!==this.peerConnection_.connectionState&&"completed"!==this.peerConnection_.connectionState)return this.log_.debug("try to send subscription [".concat(i,"] when peeConnection connected")),void(this.sentSubscriptionAfterConnected_=!1);t&&this.pendingStreams_.push(t),this.log_.debug("doSendSubscription() send SUBSCRIBE command with data: ".concat(JSON.stringify(e))),i===Gs?this.signalChannel_.send("on_sub_change",e):i===Hs&&this.signalChannel_.send("on_unsub",e),this.isSubscriptionPending_=!0,this.subscriptionTimeout_=setTimeout((function(){if(n.isSubscriptionPending_)if(n.log_.debug("subscription timeout"),n.subscriptionRetryCount_+=1,n.subscriptionRetryCount_<=3){n.log_.debug("resend subscription");var e=n.pendingSubscription_[0].data;n.doSendSubscription(e,t,i)}else n.log_.error(lp.SUBSCRIPTION_TIMEOUT),n.pendingSubscription_.shift(),n.pendingStreams_.shift(),n.isSubscriptionPending_=!1,n.subscriptionRetryCount_=0,n.emitter_.emit(ef,new da({code:ua.SUBSCRIPTION_TIMEOUT,message:pp({key:"SUBSCRIPTION_TIMEOUT"})}))}),5e3)}},{key:"onSubscribeChangeResult",value:function(e){var t=e.data.content,i=t.srctinyid;if(this.hitTest(i)){var n=this.pendingSubscription_[0];n&&n.type===Gs&&n.callback({code:t.errCode,message:t.errMsg}),this.sendNextSubscription()}}},{key:"onUnsubscribeResult",value:function(e){var t=e.data.content,i=t.srctinyid;if(this.hitTest(i)){var n=this.pendingSubscription_[0];n&&n.type===Hs&&n.callback({code:t.errCode,message:t.errMsg}),this.sendNextSubscription()}}},{key:"connect",value:(a=o(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.exchangeSDP();case 3:return e.next=5,this.waitForPeerConnectionConnected();case 5:e.next=11;break;case 7:throw e.prev=7,e.t0=e.catch(0),this.closePeerConnection(!0),e.t0;case 11:case"end":return e.stop()}}),e,this,[[0,7]])}))),function(){return a.apply(this,arguments)})},{key:"exchangeSDP",value:(r=o(regeneratorRuntime.mark((function e(){var t,i,n,r,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.isSDPExchanging_=!0,e.next=4,this.createOffer();case 4:return this.log_.info("createOffer success, sending offer to remote server"),t=this.peerConnection_.localDescription,i=t.type,n=t.sdp,r={type:i,sdp:n,userid:this.userId_,srctinyid:this.tinyId_,audio:this.subscribeState_.audio,bigVideo:this.subscribeState_.video,auxVideo:this.subscribeState_.auxiliary},gf.emit(_f.CONNECTION_SEND_SUBSCRIBE_CMD,{client:this.client_,connection:this,userId:this.userId_,tinyId:this.tinyId_,role:20,subscribeState:this.subscribeState_,trackState:this.trackState_}),e.next=10,this.signalChannel_.sendWaitForResponse({command:"on_sub",commandDesc:"exchange sdp",data:r,responseCommand:qh.SUBSCRIBE_RESULT});case 10:return o=e.sent,e.next=13,this.onSubscribeResult(o);case 13:this.isSDPExchanging_=!1,e.next=20;break;case 16:throw e.prev=16,e.t0=e.catch(0),this.isSDPExchanging_=!1,e.t0;case 20:case"end":return e.stop()}}),e,this,[[0,16]])}))),function(){return r.apply(this,arguments)})},{key:"createOffer",value:(n=o(regeneratorRuntime.mark((function e(){var t,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t={voiceActivityDetection:!1},"RTCPeerConnection"in window&&"addTransceiver"in window.RTCPeerConnection.prototype&&"unified-plan"===this.sdpSemantics_?(this.peerConnection_.addTransceiver("audio",{direction:"recvonly"}),this.peerConnection_.addTransceiver("video",{direction:"recvonly"}),this.peerConnection_.addTransceiver("video",{direction:"recvonly"})):(t.offerToReceiveAudio=!0,t.offerToReceiveVideo=!0),e.next=4,this.peerConnection_.createOffer(t);case 4:return(i=e.sent).sdp=this.addRRTRLine(i.sdp),i.sdp=this.addSPSDescription(i.sdp),i.sdp=wp(i.sdp),"unified-plan"===this.sdpSemantics_&&(i.sdp=this.removeSDESDescription(i.sdp)),e.next=11,this.peerConnection_.setLocalDescription(i);case 11:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"onSubscribeResult",value:(i=o(regeneratorRuntime.mark((function e(t){var i,n,r,o,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.data.content||77393!==t.data.content.errCode){e.next=3;break}throw this.log_.error(lp.NOT_SUPPORTED_H264DECODE),new da({code:ua.NOT_SUPPORTED_H264,message:pp(dp)});case 3:if(i=t.data.content,n=i.type,r=i.sdp,o=i.errCode,s=i.errMsg,e.prev=4,0===o){e.next=7;break}throw new da({code:o,message:pp({key:"EXCHANGE_SDP_FAILED",data:{errMsg:s}})});case 7:return this.log_.debug("accept remote answer: "+r),e.next=10,this.peerConnection_.setRemoteDescription({type:n,sdp:r});case 10:this.updateSSRC(r),e.next=17;break;case 13:throw e.prev=13,e.t0=e.catch(4),this.log_.error(e.t0),e.t0;case 17:case"end":return e.stop()}}),e,this,[[4,13]])}))),function(e){return i.apply(this,arguments)})},{key:"updateSSRC",value:function(e){var t=this;try{Ip(e).media.forEach((function(e){if("audio"===e.type){var i=e.ssrcs.find((function(e){return e.value.includes(gs)}));i&&(t.ssrc_.audio=i.id)}else{var n=e.ssrcs.find((function(e){return e.value.includes(gs)})),r=e.ssrcs.find((function(e){return e.value.includes(_s)}));n&&(t.ssrc_.video=n.id),r&&(t.ssrc_.auxiliary=r.id)}}))}catch(e){}}},{key:"sendNextSubscription",value:function(){void 0!==this.pendingSubscription_.shift()&&(this.subscriptionRetryCount_=0,this.isSubscriptionPending_=!1,-1!==this.subscriptionTimeout_&&(clearTimeout(this.subscriptionTimeout_),this.subscriptionTimeout_=-1));var e=this.pendingStreams_.shift();if(e&&(this.log_.debug("mark ".concat(e.getType()," stream exit subscription cycle")),e.setInSubscriptionCycle(!1)),this.pendingSubscription_.length>0){var t=this.pendingSubscription_[0];this.log_.info("schedule a pending subscription"),this.doSendSubscription(t.data,t.stream,t.type)}}},{key:"setRemoteStream",value:function(e,t){this.remoteStreams_.set(e,t)}},{key:"getSubscribeState",value:function(){return this.subscribeState_}},{key:"getTrackState",value:function(){return this.trackState_}},{key:"getSSRC",value:function(){return this.ssrc_}},{key:"getMainStream",value:function(){return this.remoteStreams_.get(gs)}},{key:"getAuxStream",value:function(){return this.remoteStreams_.get(_s)}},{key:"getMainStreamVideoTrackId",value:function(){var e=this.getMainStream();if(e){var t=e.getVideoTrack();if(t)return t.id}return""}},{key:"getAuxStreamVideoTrackId",value:function(){var e=this.getAuxStream();if(e){var t=e.getVideoTrack();if(t)return t.id}return""}},{key:"reconnect",value:(t=o(regeneratorRuntime.mark((function e(){var t,i,n=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(-1===this.reconnectionTimer_){e.next=3;break}return this.log_.warn("reconnect() downlink is reconnecting, ignore current reconnection"),e.abrupt("return");case 3:if(!(this.reconnectionCount_>=30)){e.next=12;break}return this.log_.warn("SDK has tried reconnect downlink [".concat(this.userId_,"] for ").concat(30," times, but all failed, please check your network")),this.stopReconnection(),t=new da({code:ua.DOWNLINK_RECONNECTION_FAILED,message:pp({key:"DOWNLINK_RECONNECTION_FAILED"})}),Ac({eventType:Ds,error:t}),this.addEventInternal(32802,"downlink-connection reconnect fail"),this.emitConnectionStateChangedEvent(ys),this.emitter_.emit(ef,t),e.abrupt("return");case 12:if(this.signalChannel_.getCurrentState()===Bh){e.next=16;break}return this.log_.warn("reconnect() signal channel is not connected, suspend reconnection until signal is connected"),this.signalChannel_.once(Nh,this.reconnect,this),e.abrupt("return");case 16:if(this.reconnectionCount_++,this.log_.warn("reconnect() try to reconnect downlink [".concat(this.reconnectionCount_,"/").concat(30,"]")),i=Lc(this.reconnectionCount_),this.reconnectionTimer_=setTimeout((function(){n.log_.warn("reconnect() downlink [".concat(n.userId_,"] reconnect timeout(").concat(i/1e3,"s), try again")),n.clearReconnectionTimer(),n.reconnect()}),i),!(this.isSDPExchanging_||this.peerConnection_&&"connecting"===this.peerConnection_.connectionState)){e.next=22;break}return e.abrupt("return");case 22:return e.prev=22,this.closePeerConnection(),this.sentSubscriptionAfterConnected_=!1,this.initialize(),e.next=28,this.connect();case 28:this.stopReconnection(),this.log_.warn("reconnect() downlink reconnect successfully"),Cc({eventType:Ds}),this.addEventInternal(32801,"downlink-connection reconnect success"),this.recoverSubscription(),e.next=37;break;case 35:e.prev=35,e.t0=e.catch(22);case 37:case"end":return e.stop()}}),e,this,[[22,35]])}))),function(){return t.apply(this,arguments)})},{key:"recoverSubscription",value:function(){var e=this,t=this.client_.getSubscriptionManager();t&&S(this.remoteStreams_.values()).forEach((function(i){t.hasAutoRecoveryFlag(e.userId_,i.getType())&&t.recover(i)}))}},{key:"getIsReconnecting",value:function(){return this.isReconnecting_}},{key:"getSubscribedMainStream",value:function(){var e=null;return this.isMainStreamSubscribed&&(e=this.remoteStreams_.get(gs)),e}},{key:"clearReconnectionTimer",value:function(){-1!==this.reconnectionTimer_&&(clearTimeout(this.reconnectionTimer_),this.reconnectionTimer_=-1)}},{key:"startReconnection",value:function(){var e=this.client_.getSubscriptionManager();if(e){var t,i=b(this.remoteStreams_.values());try{for(i.s();!(t=i.n()).done;){var n=t.value,r=n.getType();("main"===r&&(this.trackState_.audio||this.trackState_.video)||"auxiliary"===r&&this.trackState_.auxiliary)&&e.setAutoRecoveryFlag(this.userId_,n.getType())}}catch(e){i.e(e)}finally{i.f()}}_(l(f.prototype),"startReconnection",this).call(this)}},{key:"getCurrentState",value:function(){return this.currentState_}}]),f}(Lf),Yf=function(e){return function(t,i,n,r){_t(i);var o=re(t),s=j(o),a=Ke(o.length),c=e?a-1:0,u=e?-1:1;if(n<2)for(;;){if(c in s){r=s[c],c+=u;break}if(c+=u,e?c<0:a<=c)throw TypeError("Reduce of empty array with no initial value")}for(;e?c>=0:a>c;c+=u)c in s&&(r=i(r,s[c],c,o));return r}},Qf=[Yf(!1),Yf(!0)][0],Xf=ko("reduce");gt({target:"Array",proto:!0,forced:!Xf||!dl&&Q>79&&Q<83},{reduce:function(e){return Qf(this,e,arguments.length,arguments.length>1?arguments[1]:void 0)}});var Zf=function(){function e(){s(this,e),this.startTime=0,this.endTime=0,this.start()}return c(e,[{key:"start",value:function(){0===this.startTime&&(this.startTime=Gc())}},{key:"stop",value:function(){0===this.endTime&&(this.endTime=Gc())}},{key:"getDuration",value:function(){return 0===this.endTime?Gc()-this.startTime:this.endTime-this.startTime}}]),e}(),em=function(){function e(t){s(this,e),this.client_=t.client,this.intervalId_=-1,this.statsCalculator_=new mf,this.prevStats_=null,this.renderFreezeMap_=new Map,this.remoteStreamMap_=new Map,this.dataFreezeMap_=new Map,this.monitorFreezeData_=new Map}var t,i,n;return c(e,[{key:"installEvents",value:function(){gf.on(_f.PLAY_VIDEO_START,this.handlePlayVideoStart,this),gf.on(_f.VIDEO_TRACK_MUTED,this.onVideoTrackMuted,this),gf.on(_f.VIDEO_TRACK_UNMUTED,this.onVideoTrackUnmuted,this),gf.on(_f.REMOTE_STREAM_REMOVED,this.handleStreamStopped,this),gf.on(_f.REMOTE_STREAM_UNSUBSCRIBED,this.handleStreamStopped,this),gf.on(_f.VIDEO_PLAYING,this.handleVideoPlaying,this)}},{key:"uninstallEvents",value:function(){gf.off(_f.PLAY_VIDEO_START,this.handlePlayVideoStart,this),gf.off(_f.VIDEO_TRACK_MUTED,this.onVideoTrackMuted,this),gf.off(_f.VIDEO_TRACK_UNMUTED,this.onVideoTrackUnmuted,this),gf.off(_f.REMOTE_STREAM_REMOVED,this.handleStreamStopped,this),gf.off(_f.REMOTE_STREAM_UNSUBSCRIBED,this.handleStreamStopped,this),gf.off(_f.VIDEO_PLAYING,this.handleVideoPlaying,this)}},{key:"start",value:function(){var e=this;-1===this.intervalId_&&(this.installEvents(),this.intervalId_=Id.setInterval(o(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.detectFPS();case 3:t.next=7;break;case 5:t.prev=5,t.t0=t.catch(0);case 7:case"end":return t.stop()}}),t,null,[[0,5]])}))),1e3))}},{key:"stop",value:function(){-1!==this.intervalId_&&(this.uninstallEvents(),Id.clearInterval(this.intervalId_),this.intervalId_=-1,this.renderFreezeMap_.clear(),this.dataFreezeMap_.clear(),this.remoteStreamMap_.clear())}},{key:"onVideoTrackMuted",value:function(e){var t=e.stream;if(t.getClient()===this.client_&&t.isRemote()){var i=t.userId_,n=t.type_,r="".concat(i,"_").concat(n),o=this.dataFreezeMap_.get(r),s=new Zf;o?o.durationItemList.push(s):this.dataFreezeMap_.set(r,{userId:i,type:n,durationItemList:[s],isFreezing:function(){var e=this.durationItemList[this.durationItemList.length-1];return e&&0===e.endTime}})}}},{key:"onVideoTrackUnmuted",value:function(e){var t=e.stream;if(t.getClient()===this.client_&&t.isRemote()){var i=t.userId_,n=t.type_,r="".concat(i,"_").concat(n);this.stopDataFreeze({key:r,userId:i,type:n})}}},{key:"handleStreamStopped",value:function(e){var t=e.client,i=e.stream;if(t===this.client_){var n=i.getUserId(),r=i.getType(),o="".concat(n,"_").concat(r);this.stopDataFreeze({key:o,userId:n,type:r})}}},{key:"stopDataFreeze",value:function(e){var t=e.key,i=e.userId,n=e.type,r=this.dataFreezeMap_.get(t);if(r&&r.isFreezing()){var o=r.durationItemList[r.durationItemList.length-1];o.stop();var s=o.getDuration();s>500?(wc({eventType:"videoFrozenCount",delta:s}),this.monitorFreezeData_.set(t,{userId:i,type:n,duration:s})):r.durationItemList.pop()}}},{key:"getTotalDuration",value:function(e){return e.reduce((function(e,t){var i=t.getDuration();return e+Math.min(i,5e3)}),0)}},{key:"getStats",value:(n=o(regeneratorRuntime.mark((function e(){var t,i,n,r,o,s,a,c,u,d,l;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this.client_.getConnections(),i={},n=b(t),e.prev=3,n.s();case 5:if((r=n.n()).done){e.next=20;break}if(o=y(r.value,2),s=o[0],(a=o[1]).getPeerConnection()){e.next=9;break}return e.abrupt("continue",18);case 9:return c=a.getSubscribeState(),u=a.getTrackState(),e.next=13,this.statsCalculator_.getReceiverStats(a);case 13:d=e.sent,(l={userId:d.userId,tinyId:s,hasVideo:u.video&&c.video,hasAuxiliary:u.auxiliary&&c.auxiliary,video:{framesDecoded:0},auxiliary:{framesDecoded:0}}).hasVideo&&(l.video.framesDecoded=d.video.framesDecoded),l.hasAuxiliary&&(l.auxiliary.framesDecoded=d.auxiliary.framesDecoded),i[d.userId]=l;case 18:e.next=5;break;case 20:e.next=25;break;case 22:e.prev=22,e.t0=e.catch(3),n.e(e.t0);case 25:return e.prev=25,n.f(),e.finish(25);case 28:return e.abrupt("return",i);case 29:case"end":return e.stop()}}),e,this,[[3,22,25,28]])}))),function(){return n.apply(this,arguments)})},{key:"detectFPS",value:(i=o(regeneratorRuntime.mark((function e(){var t,i,n,r,o,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getStats();case 2:if(t=e.sent,this.prevStats_){e.next=6;break}return this.prevStats_=t,e.abrupt("return");case 6:e.t0=regeneratorRuntime.keys(t);case 7:if((e.t1=e.t0()).done){e.next=17;break}if(i=e.t1.value,this.prevStats_[i]){e.next=11;break}return e.abrupt("continue",7);case 11:n=t[i].tinyId,r=this.client_.getMutedStates(),t[i].hasVideo&&this.prevStats_[i].hasVideo&&r.has(n)&&!r.get(n).videoMuted&&(o=t[i].video.framesDecoded-this.prevStats_[i].video.framesDecoded,this.handleRenderFreeze({userId:i,type:"main",fps:o})),t[i].hasAuxiliary&&this.prevStats_[i].hasAuxiliary&&(s=t[i].auxiliary.framesDecoded-this.prevStats_[i].auxiliary.framesDecoded,this.handleRenderFreeze({userId:i,type:"auxiliary",fps:s})),e.next=7;break;case 17:this.prevStats_=t;case 18:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"handleRenderFreeze",value:(t=o(regeneratorRuntime.mark((function e(t){var i,n,r,o,s,a,c,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=t.userId,n=t.fps,r=t.type,o="".concat(i,"_").concat(r),s=this.renderFreezeMap_.get(o),n<=2?(a=Gc(),s&&!s.isFreeze&&(s.freezeTimeline.push({startTime:a,endTime:void 0}),s.isFreeze=!0),s||this.renderFreezeMap_.set(o,{userId:i,type:r,isFreeze:!0,freezeTimeline:[{startTime:a,endTime:void 0}],renderFreezeTotal:0})):s&&s.isFreeze&&(s.isFreeze=!1,(c=s.freezeTimeline.pop()).endTime=Gc(),u=c.endTime-c.startTime,s.freezeTimeline.push(c),s.renderFreezeTotal+=Math.min(5e3,u));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"handlePlayVideoStart",value:function(e){var t=e.stream;if(t.getClient()===this.client_&&t.isRemote()&&t.hasVideo()){var i="".concat(t.getUserId(),"_").concat(t.getType());this.remoteStreamMap_.has(i)?this.remoteStreamMap_.get(i).remoteStream=t:this.remoteStreamMap_.set(i,{isPlayingFired:!1,remoteStream:t})}}},{key:"handleVideoPlaying",value:function(e){var t=e.stream;if(t.isRemote()&&t.getClient()===this.client_){var i="".concat(t.getUserId(),"_").concat(t.getType());this.remoteStreamMap_.has(i)&&(this.remoteStreamMap_.get(i).isPlayingFired=!0)}}},{key:"getDataFreezeDuration",value:function(e){var t={dataFreeze:0,count:0},i=this.dataFreezeMap_.get(e);if(i){if(i.isFreezing()){var n=i.durationItemList[i.durationItemList.length-1];n.stop(),n.getDuration()<500&&i.durationItemList.pop()}t.dataFreeze=this.getTotalDuration(i.durationItemList),t.count=i.durationItemList.length}return t}},{key:"getRenderFreezeDuration",value:function(e){var t=this.renderFreezeMap_.get(e),i=0,n=0;if(t)if(t.isFreeze){var r=Gc()-t.freezeTimeline[t.freezeTimeline.length-1].startTime;i=t.renderFreezeTotal+Math.min(r,5e3),n=t.freezeTimeline.length}else i=t.renderFreezeTotal;return{renderFreeze:i,count:n}}},{key:"getMonitorFreeze",value:function(){return this.monitorFreezeData_}},{key:"isBlackStream",value:function(e){return!!this.remoteStreamMap_.has(e)&&!this.remoteStreamMap_.get(e).isPlayingFired}},{key:"resetMonitor",value:function(){this.monitorFreezeData_.clear()}}]),e}(),tm=function e(t){s(this,e),this.userId=t.userId,this.tinyId=t.tinyId,this.role=20===t.role?"anchor":"audience"};function im(e){var t=e.retryFunction,i=e.settings,n=e.onError,r=e.onRetrying,s=e.context;return function(){for(var e=this,a=arguments.length,c=new Array(a),u=0;u<a;u++)c[u]=arguments[u];var d=i.retries||5,l=0,h=-1,p=0,f=function(){var a=o(regeneratorRuntime.mark((function o(a,u){var m,v,g,_;return regeneratorRuntime.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:return o.prev=0,m=s||e,o.next=4,t.apply(m,c);case 4:v=o.sent,l=0,a(v),o.next=14;break;case 9:o.prev=9,o.t0=o.catch(0),g=function(){clearTimeout(h),l=0,p=2,u(o.t0)},_=function(){2!==p&&l<d?(l++,p=1,Nc(r)&&r(l,g),h=setTimeout((function(){h=-1,f(a,u)}),i.timeout||1e3)):g()},n(o.t0,_,u);case 14:case"end":return o.stop()}}),o,null,[[0,9]])})));return function(e,t){return a.apply(this,arguments)}}();return new Promise(f)}}var nm=k((function(e){!function(t){function i(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function n(e,t,n,r,o,s){return i((a=i(i(t,e),i(r,s)))<<(c=o)|a>>>32-c,n);var a,c}function r(e,t,i,r,o,s,a){return n(t&i|~t&r,e,t,o,s,a)}function o(e,t,i,r,o,s,a){return n(t&r|i&~r,e,t,o,s,a)}function s(e,t,i,r,o,s,a){return n(t^i^r,e,t,o,s,a)}function a(e,t,i,r,o,s,a){return n(i^(t|~r),e,t,o,s,a)}function c(e,t){var n,c,u,d,l;e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;var h=1732584193,p=-271733879,f=-1732584194,m=271733878;for(n=0;n<e.length;n+=16)c=h,u=p,d=f,l=m,h=r(h,p,f,m,e[n],7,-680876936),m=r(m,h,p,f,e[n+1],12,-389564586),f=r(f,m,h,p,e[n+2],17,606105819),p=r(p,f,m,h,e[n+3],22,-1044525330),h=r(h,p,f,m,e[n+4],7,-176418897),m=r(m,h,p,f,e[n+5],12,1200080426),f=r(f,m,h,p,e[n+6],17,-1473231341),p=r(p,f,m,h,e[n+7],22,-45705983),h=r(h,p,f,m,e[n+8],7,1770035416),m=r(m,h,p,f,e[n+9],12,-1958414417),f=r(f,m,h,p,e[n+10],17,-42063),p=r(p,f,m,h,e[n+11],22,-1990404162),h=r(h,p,f,m,e[n+12],7,1804603682),m=r(m,h,p,f,e[n+13],12,-40341101),f=r(f,m,h,p,e[n+14],17,-1502002290),h=o(h,p=r(p,f,m,h,e[n+15],22,1236535329),f,m,e[n+1],5,-165796510),m=o(m,h,p,f,e[n+6],9,-1069501632),f=o(f,m,h,p,e[n+11],14,643717713),p=o(p,f,m,h,e[n],20,-373897302),h=o(h,p,f,m,e[n+5],5,-701558691),m=o(m,h,p,f,e[n+10],9,38016083),f=o(f,m,h,p,e[n+15],14,-660478335),p=o(p,f,m,h,e[n+4],20,-405537848),h=o(h,p,f,m,e[n+9],5,568446438),m=o(m,h,p,f,e[n+14],9,-1019803690),f=o(f,m,h,p,e[n+3],14,-187363961),p=o(p,f,m,h,e[n+8],20,1163531501),h=o(h,p,f,m,e[n+13],5,-1444681467),m=o(m,h,p,f,e[n+2],9,-51403784),f=o(f,m,h,p,e[n+7],14,1735328473),h=s(h,p=o(p,f,m,h,e[n+12],20,-1926607734),f,m,e[n+5],4,-378558),m=s(m,h,p,f,e[n+8],11,-2022574463),f=s(f,m,h,p,e[n+11],16,1839030562),p=s(p,f,m,h,e[n+14],23,-35309556),h=s(h,p,f,m,e[n+1],4,-1530992060),m=s(m,h,p,f,e[n+4],11,1272893353),f=s(f,m,h,p,e[n+7],16,-155497632),p=s(p,f,m,h,e[n+10],23,-1094730640),h=s(h,p,f,m,e[n+13],4,681279174),m=s(m,h,p,f,e[n],11,-358537222),f=s(f,m,h,p,e[n+3],16,-722521979),p=s(p,f,m,h,e[n+6],23,76029189),h=s(h,p,f,m,e[n+9],4,-640364487),m=s(m,h,p,f,e[n+12],11,-421815835),f=s(f,m,h,p,e[n+15],16,530742520),h=a(h,p=s(p,f,m,h,e[n+2],23,-995338651),f,m,e[n],6,-198630844),m=a(m,h,p,f,e[n+7],10,1126891415),f=a(f,m,h,p,e[n+14],15,-1416354905),p=a(p,f,m,h,e[n+5],21,-57434055),h=a(h,p,f,m,e[n+12],6,1700485571),m=a(m,h,p,f,e[n+3],10,-1894986606),f=a(f,m,h,p,e[n+10],15,-1051523),p=a(p,f,m,h,e[n+1],21,-2054922799),h=a(h,p,f,m,e[n+8],6,1873313359),m=a(m,h,p,f,e[n+15],10,-30611744),f=a(f,m,h,p,e[n+6],15,-1560198380),p=a(p,f,m,h,e[n+13],21,1309151649),h=a(h,p,f,m,e[n+4],6,-145523070),m=a(m,h,p,f,e[n+11],10,-1120210379),f=a(f,m,h,p,e[n+2],15,718787259),p=a(p,f,m,h,e[n+9],21,-343485551),h=i(h,c),p=i(p,u),f=i(f,d),m=i(m,l);return[h,p,f,m]}function u(e){var t,i="",n=32*e.length;for(t=0;t<n;t+=8)i+=String.fromCharCode(e[t>>5]>>>t%32&255);return i}function d(e){var t,i=[];for(i[(e.length>>2)-1]=void 0,t=0;t<i.length;t+=1)i[t]=0;var n=8*e.length;for(t=0;t<n;t+=8)i[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return i}function l(e){var t,i,n="";for(i=0;i<e.length;i+=1)t=e.charCodeAt(i),n+="0123456789abcdef".charAt(t>>>4&15)+"0123456789abcdef".charAt(15&t);return n}function h(e){return unescape(encodeURIComponent(e))}function p(e){return function(e){return u(c(d(e),8*e.length))}(h(e))}function f(e,t){return function(e,t){var i,n,r=d(e),o=[],s=[];for(o[15]=s[15]=void 0,r.length>16&&(r=c(r,8*e.length)),i=0;i<16;i+=1)o[i]=909522486^r[i],s[i]=1549556828^r[i];return n=c(o.concat(d(t)),512+8*t.length),u(c(s.concat(n),640))}(h(e),h(t))}function m(e,t,i){return t?i?f(t,e):l(f(t,e)):i?p(e):l(p(e))}e.exports?e.exports=m:t.md5=m}(I)})),rm=function(){function e(t){s(this,e),this.client_=t.client,this.signalChannel_=t.signalChannel,this.isMixing_=!1,this.config_=null,this.data_=null,this.remoteStreamMap_=new Map,this.installEvents()}var t,i;return c(e,[{key:"isPresetLayoutMode",get:function(){return this.config_&&this.config_.mode===Js}},{key:"installEvents",value:function(){gf.on(_f.REMOTE_STREAM_SUBSCRIBED,this.onStreamSubscribed,this),gf.on(_f.REMOTE_STREAM_UNSUBSCRIBED,this.onStreamUnsubscribed,this),this.client_.on("stream-removed",this.onStreamRemoved,this)}},{key:"uninstallEvents",value:function(){gf.off(_f.REMOTE_STREAM_SUBSCRIBED,this.onStreamSubscribed,this),gf.off(_f.REMOTE_STREAM_UNSUBSCRIBED,this.onStreamUnsubscribed,this),this.client_.off("stream-removed",this.onStreamRemoved,this)}},{key:"stop",value:function(){this.uninstallEvents()}},{key:"onStreamSubscribed",value:function(e){var t=e.client,i=e.stream;t===this.client_&&(this.remoteStreamMap_.set(i.getId(),{remoteStream:i,isUsed:!1}),this.isMixing_&&this.hasAvailablePlaceHolder()&&this.startMixTranscode(this.config_))}},{key:"onStreamUnsubscribed",value:function(e){var t=e.client,i=e.stream;t===this.client_&&this.onStreamRemoved({stream:i})}},{key:"onStreamRemoved",value:function(e){var t=e.stream;if(this.remoteStreamMap_.has(t.getId())){var i=this.remoteStreamMap_.get(t.getId()).isUsed;this.remoteStreamMap_.delete(t.getId()),this.isMixing_&&this.isPresetLayoutMode&&i&&this.startMixTranscode(this.config_)}}},{key:"startMixTranscode",value:(i=o(regeneratorRuntime.mark((function e(t){var i,n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,this.resetIsUsedFlag(),this.validateMixTranscodeParamsType(t),this.config_=t,i=this.getInputParam(t,this.remoteStreamMap_),n=this.getOutputParam(t),r=this.getOutputSessionId({config:t,roomId:this.client_.getRoomId(),userId:this.client_.getUserId()}),this.validateMixTranscodeParamsValue(i,n),!this.isMixing_||!this.data_||r===this.data_.outputSessionId){e.next=12;break}return Xu.info("startMixTranscode() streamId changed, stop mixing before start"),e.next=12,this.doStopMixTranscode();case 12:return e.next=14,this.doStartMixTranscode({outputSessionId:r,inputParam:i,outputParam:n});case 14:e.next=20;break;case 16:throw e.prev=16,e.t0=e.catch(0),this.resetIsUsedFlag(),e.t0;case 20:case"end":return e.stop()}}),e,this,[[0,16]])}))),function(e){return i.apply(this,arguments)})},{key:"doStartMixTranscode",value:function(e){var t=this,i=e.outputSessionId,n=e.inputParam,r=e.outputParam;return new Promise((function(e,o){var s={roomid:String(t.client_.getRoomId()),sdkAppID:String(t.client_.getSDKAppId()),socketid:t.signalChannel_.getSocketId(),mcuRequestTime:Date.now(),outputSessionId:i,inputParam:n,outputParam:r};t.data_=s,Xu.info("startMixTranscode: ".concat(JSON.stringify(s))),t.signalChannel_.send("on_start_mcu_mix",s),t.isMixing_=!0;var a=setTimeout((function(){Xu.error("startMixTranscode timeout observed"),t.isMixing_=!1,t.signalChannel_.off(qh.START_MIX_TRANSCODE_RES,c),o(new da({code:ua.START_MIX_TRANSCODE_FAILED,message:pp({key:"START_MIX_TRANSCODE_TIMEOUT"})}))}),5e3),c=function(i){clearTimeout(a),i.data.content.errCode?(Xu.error("startMixTranscode failed, errCode: ".concat(i.data.content.errCode," errMsg: ").concat(i.data.content.errMsg)),t.isMixing_=!1,o(new da({code:ua.START_MIX_TRANSCODE_FAILED,message:pp({key:"START_MIX_TRANSCODE_FAILED",data:{errMsg:i.data.content.errMsg}})}))):e()};t.signalChannel_.once(qh.START_MIX_TRANSCODE_RES,c)}))}},{key:"stopMixTranscode",value:(t=o(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isMixing_){e.next=2;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:"MIX_TRANSCODE_NOT_STARTED"})});case 2:return e.next=4,this.doStopMixTranscode();case 4:this.resetIsUsedFlag();case 5:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"doStopMixTranscode",value:function(){var e=this;return new Promise((function(t,i){var n={roomid:String(e.client_.getRoomId()),sdkAppID:String(e.client_.getSDKAppId()),socketid:e.signalChannel_.getSocketId(),userid:e.client_.getUserId(),mcuRequestTime:Date.now(),outPutSessionId:e.data_.outputSessionId,streamType:e.data_.outputParam.streamType};Xu.info("stopMixTranscode: ".concat(JSON.stringify(n))),e.signalChannel_.send("on_stop_mcu_mix",n);var r=setTimeout((function(){Xu.error("stopMixTranscode timeout observed"),e.signalChannel_.off(qh.STOP_MIX_TRANSCODE_RES,o),i(new da({code:ua.STOP_MIX_TRANSCODE_FAILED,message:pp({key:"STOP_MIX_TRANSCODE_TIMEOUT"})}))}),5e3),o=function(n){clearTimeout(r),n.data.content.errCode?(Xu.error("stopMixTranscode failed, errCode: ".concat(n.data.content.errCode," errMsg: ").concat(n.data.content.errMsg)),i(new da({code:ua.STOP_MIX_TRANSCODE_FAILED,message:pp({key:"STOP_MIX_TRANSCODE_FAILED",data:{errMsg:n.data.content.errMsg}})}))):(e.isMixing_=!1,t())};e.signalChannel_.once(qh.STOP_MIX_TRANSCODE_RES,o)}))}},{key:"validateMixTranscodeParamsType",value:function(e){if("object"!==jc(e))throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"MIX_TRANSCODE_PARAM"})});var t=Bc(e,{streamId:Ks,videoWidth:Ys,videoHeight:Ys,videoBitrate:Ys,videoFramerate:Ys,videoGOP:Ys,audioSampleRate:Ys,audioBitrate:Ys,audioChannels:Ys,backgroundColor:Ys,backgroundImage:Ks,mixUsers:"array"});if(!t.ret)throw new da({code:ua.INVALID_PARAMETER,message:t.message});var i={userId:Ks,roomId:this.client_.getUseStringRoomId()?Ks:Ys,pureAudio:Qs,width:Ys,height:Ys,locationX:Ys,locationY:Ys,zOrder:Ys};e.mixUsers.forEach((function(e){var t=Bc(e,i);if(!t.ret)throw new da({code:ua.INVALID_PARAMETER,message:"mixUser.".concat(t.message)})}))}},{key:"getOutputSessionId",value:function(e){var t=e.config,i=e.userId,n=e.roomId;return Vc(t.streamId)&&t.streamId.length>0?t.streamId:nm("".concat(n,"_").concat(i,"_main"))}},{key:"getInputParam",value:function(e,t){var i=this,n=e.mixUsers.map((function(e){return{userid:e.userId,roomid:String(e.roomId||i.client_.getRoomId()),width:e.width||0,height:e.height||0,locationX:e.locationX||0,locationY:e.locationY||0,zOrder:e.zOrder,streamType:Uc(e.streamType)||"auxiliary"!==e.streamType?0:1,inputType:e.pureAudio?$s:zs}}));return e.mode===Js&&(n.forEach((function(e){if(e.userid===Ws){var i=S(t.values()).find((function(e){return!e.isUsed}));i&&(e.userid=i.remoteStream.getUserId(),e.streamType="auxiliary"===i.remoteStream.getType()?1:0,i.isUsed=!0)}})),n=n.filter((function(e){return e.userid!==Ws}))),n}},{key:"getOutputParam",value:function(e){var t=e.streamId||"";return{streamId:t,streamType:t.length>0?1:0,videoWidth:Uc(e.videoWidth)?640:e.videoWidth,videoHeight:Uc(e.videoHeight)?480:e.videoHeight,videoBitrate:e.videoBitrate||0,videoFramerate:e.videoFramerate||15,videoGOP:e.videoGOP||2,audioSampleRate:e.audioSampleRate||48e3,audioBitrate:e.audioBitrate||64,audioChannels:e.audioChannels||1,backgroundColor:e.backgroundColor||0,backgroundImage:e.backgroundImage||"",extraInfo:"",VCodec:2,ACodec:0}}},{key:"validateMixTranscodeParamsValue",value:function(e,t){var i=0,n=0;if(e.forEach((function(e){if(Uc(e.userid))throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"MIX_PARAMS_USER_ID"})});if(e.inputType!==$s){if(e.width<0||e.height<0)throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"MIX_PARAMS_RECT"})});if(e.locationX<0||e.locationY<0)throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"MIX_PARAMS_LOCATION"})});if(!e.zOrder||e.zOrder<1||e>15)throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"MIX_PARAMS_ZORDER"})});e.width+e.locationX>i&&(i=e.width+e.locationX),e.height+e.locationY>n&&(n=e.height+e.locationY)}})),t.videoWidth<0||t.videoWidth<0)throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"MIX_PARAMS_VIDEO"})});if(t.videoWidth<i||t.videoHeight<n)throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"MIX_PARAMS_STREAM"})})}},{key:"hasAvailablePlaceHolder",value:function(){return!!this.isPresetLayoutMode&&this.data_.inputParam.length!==this.config_.mixUsers.length}},{key:"resetIsUsedFlag",value:function(){this.remoteStreamMap_.forEach((function(e){return e.isUsed=!1}))}}]),e}(),om=function(){function e(t){s(this,e),this.client_=t.client,this.signalChannel_=t.signalChannel,this.isPublishingTencentCDN_=!1,this.publishGivenCDNData_=null,this.isPublishingGivenCDN_=!1}return c(e,[{key:"getIsPublishingTencentCDN",value:function(){return this.isPublishingTencentCDN_}},{key:"getIsPublishingGivenCDN",value:function(){return this.isPublishingGivenCDN_}},{key:"startPublishTencentCDN",value:function(e){var t=this;e=e||"".concat(this.client_.getSDKAppId(),"_").concat(this.client_.getRoomId(),"_").concat(this.client_.getUserId(),"_main");var i={roomid:String(this.client_.getRoomId()),sdkAppID:String(this.client_.getSDKAppId()),requestTime:Date.now(),sessionId:nm("".concat(this.client_.getRoomId(),"_").concat(this.client_.getUserId(),"_main")),streamId:e,streamType:0};return Xu.info("startPublishTencentCDN: "+JSON.stringify(i)),new Promise((function(e,n){t.isPublishingTencentCDN_=!0;var r=setTimeout((function(){Xu.error("startPublishTencentCDN timeout observed"),t.isPublishingTencentCDN_=!1,t.signalChannel_.off(qh.START_PUBLISH_TENCENT_CDN_RES,o),n(new Error("startPublishTencentCDN timeout"))}),5e3),o=function(i){clearTimeout(r);var o=i.data.content,s=o.errCode,a=o.errMsg;0===s?e():(t.isPublishingTencentCDN_=!1,-102083===s&&(a="Please enable relayed-push in https://console.cloud.tencent.com/trtc/ and try later, refer to https://web.sdk.qcloud.com/trtc/webrtc/doc/zh-cn/tutorial-26-advanced-publish-cdn-stream.html"),Xu.error("startPublishTencentCDN failed, errCode: ".concat(s,", errMsg: ").concat(a)),n(new Error(a)))};t.signalChannel_.once(qh.START_PUBLISH_TENCENT_CDN_RES,o),t.signalChannel_.send("on_start_publishing",i)}))}},{key:"stopPublishTencentCDN",value:function(){var e=this,t={roomid:String(this.client_.getRoomId()),sdkAppID:String(this.client_.getSDKAppId()),requestTime:Date.now(),sessionId:nm("".concat(this.client_.getRoomId(),"_").concat(this.client_.getUserId(),"_main"))};return Xu.info("stopPublishTencentCDN: "+JSON.stringify(t)),new Promise((function(i,n){var r=setTimeout((function(){Xu.error("stopPublishTencentCDN timeout observed"),e.signalChannel_.off(qh.STOP_PUBLISH_TENCENT_CDN_RES,o),n(new Error("stopPublishTencentCDN timeout"))}),5e3),o=function(t){clearTimeout(r);var o=t.data.content,s=o.errCode,a=o.errMsg;0===s?(e.isPublishingTencentCDN_=!1,i()):-102069===s?(Xu.warn("stopPublishTencentCDN failed, can not stopPublishTencentCDN in auto relayed-push mode"),e.isPublishingTencentCDN_=!1,i()):(Xu.error("stopPublishTencentCDN failed, errCode: ".concat(s," errMsg: ").concat(a)),n(new Error(a)))};e.signalChannel_.once(qh.STOP_PUBLISH_TENCENT_CDN_RES,o),e.signalChannel_.send("on_stop_publishing",t)}))}},{key:"startPublishGivenCDN",value:function(e){var t=this,i={roomid:String(this.client_.getRoomId()),sdkAppID:String(this.client_.getSDKAppId()),socketid:this.signalChannel_.getSocketId(),pushRequestTime:Date.now(),pushAppid:e.appId,pushBizId:e.bizId,pushCdnUrl:e.url,pushStreamType:"main"};return Xu.info("startPublishGivenCDN: "+JSON.stringify(i)),this.publishGivenCDNData_=i,new Promise((function(e,n){t.isPublishingGivenCDN_=!0;var r=setTimeout((function(){Xu.error("startPublishGivenCDN timeout observed"),t.isPublishingGivenCDN_=!1,t.signalChannel_.off(qh.START_PUBLISH_GIVEN_CDN_RES,o),n(new Error("startPublishGivenCDN timeout"))}),5e3),o=function(i){clearTimeout(r);var o=i.data.content,s=o.errCode,a=o.errMsg;0===s?e():(Xu.error("startPublishGivenCDN failed, errCode: ".concat(s,", errMsg: ").concat(a)),t.isPublishingGivenCDN_=!1,n(new Error(a)))};t.signalChannel_.once(qh.START_PUBLISH_GIVEN_CDN_RES,o),t.signalChannel_.send("on_start_push_user_cdn",i)}))}},{key:"stopPublishGivenCDN",value:function(){var e=this,t=this.publishGivenCDNData_,i=t.pushAppid,n=t.pushBizId,r=t.pushCdnUrl,o=t.pushStreamType,s={roomid:String(this.client_.getRoomId()),sdkAppID:String(this.client_.getSDKAppId()),socketid:this.signalChannel_.getSocketId(),pushRequestTime:Date.now(),pushAppid:i,pushBizId:n,pushCdnUrl:r,pushStreamType:o};return Xu.info("stopPublishGivenCDN: "+JSON.stringify(s)),new Promise((function(t,i){var n=setTimeout((function(){Xu.error("stopPublishGivenCDN timeout observed"),e.signalChannel_.off(qh.STOP_PUBLISH_GIVEN_CDN_RES,r),i(new Error("stopPublishGivenCDN timeout"))}),5e3),r=function(r){clearTimeout(n);var o=r.data.content,s=o.errCode,a=o.errMsg;0===s?(e.isPublishingGivenCDN_=!1,t()):(Xu.error("stopPublishGivenCDN failed, errCode: ".concat(s," errMsg: ").concat(a)),i(new Error(a)))};e.signalChannel_.once(qh.STOP_PUBLISH_GIVEN_CDN_RES,r),e.signalChannel_.send("on_stop_push_user_cdn",s)}))}}]),e}(),sm=function(){function e(t){s(this,e),this.client_=t.client,this.durationMap_=new Map,this.installEvents()}return c(e,[{key:"installEvents",value:function(){gf.on(_f.REMOTE_STREAM_SUBSCRIBED,this.handleSubscribed,this),gf.on(_f.REMOTE_STREAM_TRACK_UPDATED,this.handleStreamTrackUpdated,this),gf.on(_f.REMOTE_STREAM_UNSUBSCRIBED,this.handleStreamStopped,this),gf.on(_f.REMOTE_STREAM_REMOVED,this.handleStreamStopped,this)}},{key:"uninstallEvents",value:function(){gf.off(_f.REMOTE_STREAM_SUBSCRIBED,this.handleSubscribed,this),gf.off(_f.REMOTE_STREAM_UPDATED,this.handleStreamTrackUpdated,this),gf.off(_f.REMOTE_STREAM_UNSUBSCRIBED,this.handleStreamStopped,this),gf.off(_f.REMOTE_STREAM_REMOVED,this.handleStreamStopped,this)}},{key:"handleSubscribed",value:function(e){var t=e.client,i=e.stream;if(t===this.client_){var n=i.getUserId(),r=i.getType(),o="".concat(n,"_").concat(r);if(i.hasAudio())if(i.isMainAudioSubscribed){var s=new Zf,a=this.durationMap_.get(o);a?this.isRecording(a.audio)||a.audio.push(s):this.durationMap_.set(o,{userId:n,type:r,audio:[s],video:[]})}else this.stopDurationItem(o,"audio");if(i.hasVideo())if("main"===r&&i.isMainVideoSubscribed||"auxiliary"===r&&i.isAuxVideoSubscribed){var c=new Zf,u=this.durationMap_.get(o);u?this.isRecording(u.video)||u.video.push(c):this.durationMap_.set(o,{userId:n,type:r,audio:[],video:[c]})}else this.stopDurationItem(o,"video")}}},{key:"handleStreamStopped",value:function(e){var t=e.client,i=e.stream;if(this.clientHitTest(t)){var n=i.getUserId(),r=i.getType(),o="".concat(n,"_").concat(r);this.stopDurationItem(o,"audio"),this.stopDurationItem(o,"video")}}},{key:"handleStreamTrackUpdated",value:function(e){var t=e.client,i=e.userId,n=e.tinyId,r=e.kind,o=e.action;if(this.clientHitTest(t)&&this.client_.getConnections().has(n)){var s=r===ta?r:"main",a="".concat(i,"_").concat(s);if(o===ia){var c=this.client_.getConnections().get(n).getSubscribeState();if(r===Zs&&!c.audio||r===ea&&!c.video||r===ta&&!c.auxiliary)return;var u=new Zf,d=this.durationMap_.get(a);d?(r!==Zs||this.isRecording(d.audio)||d.audio.push(u),r===Zs||this.isRecording(d.video)||d.video.push(u)):this.durationMap_.set(a,{userId:i,type:s,audio:r===Zs?[u]:[],video:r===Zs?[]:[u]})}else this.stopDurationItem(a,r===Zs?"audio":"video")}}},{key:"isRecording",value:function(e){return e.findIndex((function(e){return 0===e.endTime}))>=0}},{key:"stopDurationItem",value:function(e,t){if(this.durationMap_.has(e)){var i=this.durationMap_.get(e)[t].find((function(e){return 0===e.endTime}));i&&i.stop()}}},{key:"clientHitTest",value:function(e){return this.client_===e}},{key:"getDuration",value:function(e,t){return this.durationMap_.has(e)?this.durationMap_.get(e)[t].reduce((function(e,t){return e+t.getDuration()}),0):0}},{key:"getDurationMap",value:function(){return this.durationMap_}},{key:"reset",value:function(){this.durationMap_.clear()}}]),e}(),am=vr.f,cm=O((function(){return!Object.getOwnPropertyNames(1)}));gt({target:"Object",stat:!0,forced:cm},{getOwnPropertyNames:am});var um,dm,lm,hm,pm,fm,mm,vm,gm,_m,ym,Sm,Tm=new(function(){function e(){s(this,e),this.prefix_="TRTC",this.queue_=new Map,this.intervalId_=Id.setInterval(this.doFlush.bind(this),2e4),this.checkStorage()}return c(e,[{key:"getRealKey",value:function(e){return"".concat(this.prefix_,"_").concat(e)}},{key:"checkStorage",value:function(){var e=this;Ku()&&Object.keys(localStorage).filter((function(t){if(t.startsWith(e.prefix_)){var i=JSON.parse(localStorage.getItem(t));if(i&&i.expiresIn<Date.now())return!0}return!1})).forEach((function(e){return localStorage.removeItem(e)}))}},{key:"doFlush",value:function(){if(Ku())try{var e,t=b(this.queue_);try{for(t.s();!(e=t.n()).done;){var i=y(e.value,2),n=i[0],r=i[1];localStorage.setItem(n,JSON.stringify(r))}}catch(e){t.e(e)}finally{t.f()}}catch(e){Xu.warn(e)}}},{key:"getItem",value:function(e){if(!Ku())return null;try{var t=JSON.parse(localStorage.getItem(this.getRealKey(e)));return t&&t.expiresIn>=Date.now()?t.value:null}catch(e){Xu.warn(e)}}},{key:"setItem",value:function(e,t){if(Ku())try{var i={expiresIn:Date.now()+6048e5,value:t};this.queue_.set(this.getRealKey(e),i)}catch(e){Xu.warn(e)}}},{key:"deleteItem",value:function(e){if(!Ku())return!1;try{return e=this.getRealKey(e),this.queue_.delete(e),localStorage.removeItem(e),!0}catch(e){return Xu.warn(e),!1}}},{key:"clear",value:function(){if(Ku())try{localStorage.clear()}catch(e){Xu.warn(e)}}}]),e}()),Em={unknown:0,wifi:1,"4g":2,"3g":3,"2g":4,wired:5},bm={msg_user_info:0,uint32_video_avg_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_avg_bitrate:0,uint32_video_block_time:0,uint32_video_play_time:0,uint32_audio_block_time:0,uint32_audio_play_time:0,uint32_audio_play_db:0,uint32_avg_down_loss:0,uint32_stream_type:0,uint32_video_render_first:0,uint32_video_block_count:0,uint32_audio_block_count:0,uint32_audio_bitrate:0,uint32_video_black_screen_subjective:0,uint32_audio_recv_bitrate:0,uint32_video_external_block_time:0},Rm=function e(t){s(this,e),this.str_identifier=String(t.userId),this.uint64_tinyid=Number(t.tinyId),this.uint32_role=t.role},Im=function(){function e(t){var i=this;s(this,e),this.frameWorkType_=t.frameWorkType||30,this.client_=t.client,this.keyPrefix_="key_point",this.storageKey_="".concat(this.keyPrefix_,"_").concat(this.client_.getUserId()),this.log_=new vf({id:"kpm|"+this.client_.getUserId(),direction:"local",type:""}),this.upload=im({retryFunction:this.upload,settings:{timeout:500,retries:3},onError:function(e,t){return t()}}),Object.getOwnPropertyNames(this.__proto__).forEach((function(e){e.startsWith("handle")&&Nc(i[e])&&(i[e]=function(e){var t=e.fn,i=e.context;return o(regeneratorRuntime.mark((function e(){var n,r,o,s=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(e.prev=0,n=s.length,r=new Array(n),o=0;o<n;o++)r[o]=s[o];return e.next=4,t.apply(i||this,r);case 4:return e.abrupt("return",e.sent);case 7:e.prev=7,e.t0=e.catch(0),Xu.error("".concat(t.name,"() error observed ")+e.t0);case 10:case"end":return e.stop()}}),e,this,[[0,7]])})))}({fn:i[e],context:i}))})),this.initData(),this.installEvents(),this.intervalId_=Id.setInterval(this.setStorage.bind(this),2e4)}var t,n,r;return c(e,[{key:"initData",value:function(){this.firstPublishedUserList_=[],this.networkQuality_={totalUplinkRTT:0,totalUplinkLoss:0,count:0,totalDownlinkRTTAndLossMap:new Map},this.basicInfo={string_sdk_version:"4.11.7",uint32_os_type:15,string_device_name:"",string_http_user_agent:navigator.userAgent,string_os_version:"",uint32_avg_rtt:0,uint32_avg_up_loss:0,uint32_scene:"live"===this.client_.getMode()?1:0,uint32_joining_duration:0,uint32_networkType:Em[xc()],uint32_framework:this.frameWorkType_},this.pathJoinRoom_={uint64_start_time:0,uint64_init_audio_start_time:0,uint64_init_audio_end_time:0,uint64_init_camera_start_time:0,uint64_init_camera_end_time:0,uint64_send_request_enter_room_cmd_start_time:0,uint64_send_request_enter_room_cmd_end_time:0,uint64_send_first_video_frame_time:0,uint64_recv_userlist_time:0,uint64_end_time:0,int32_init_audio_ret:0,int32_init_camera_ret:0,int32_send_request_enter_room_cmd_ret:0,int32_end_ret:0},this.pathLeaveRoom_={uint64_start_time:0,uint64_send_request_exit_room_cmd_start_time:0,uint64_send_request_exit_room_cmd_end_time:0,uint64_end_time:0,int32_send_request_exit_room_cmd_ret:0,int32_end_ret:0},this.pathMainVideoMap_=new Map,this.pathMainAudioMap_=new Map,this.pathAuxiliaryMap_=new Map,this.localStreamStats_={totalVideoBitrate:0,totalVideoFPS:0,totalVideoHeight:0,totalVideoWidth:0,totalAudioLevel:0,videoCount:0,audioLevelCount:0,publishStartTime:0,statsToReport:{uint32_audio_capture_db:0,uint32_video_big_capture_fps:0,uint32_video_big_bitrate:0,uint32_video_big_resolution:0}},this.remoteStreamStatsMap_=new Map}},{key:"installEvents",value:function(){gf.on(_f.JOIN_START,this.handleJoinStart,this),gf.on(_f.JOIN_SEND_CMD,this.handleJoinSendCMD,this),gf.on(_f.JOIN_RECEIVED_CMD_RES,this.handleJoinReceivedCMDResponce,this),gf.on(_f.JOIN_SUCCESS,this.handleJoinSuccess,this),gf.on(_f.JOIN_FAILED,this.handleJoinFailed,this),gf.on(_f.RECEIVED_PUBLISHED_USER_LIST,this.handleReceivedPublishUserList,this),gf.on(_f.CONNECTION_STATE_CHANGED,this.handleConnectionStateChanged,this),gf.on(_f.LEAVE_START,this.handleLeaveStart,this),gf.on(_f.LEAVE_SUCCESS,this.handleLeaveSuccess,this),gf.on(_f.LEAVE_SEND_CMD,this.handleLeaveSendCMD,this),gf.on(_f.CONNECTION_SEND_SUBSCRIBE_CMD,this.handleSendSubscribeCMD,this),gf.on(_f.VIDEO_PLAYING,this.handleVideoPlaying,this),gf.on(_f.AUDIO_PLAYING,this.handleAudioPlaying,this),gf.on(_f.NETWORK_QUALITY,this.handleNetworkQuality,this),gf.on(_f.HEARTBEAT_STATS,this.handleHeartbeatStats,this),gf.on(_f.REMOTE_STREAM_ADDED,this.handleRemoteStreamAdded,this),gf.on(_f.REMOTE_STREAM_SUBSCRIBE_START,this.handleRemoteStreamSubscribeStart,this),gf.on(_f.REMOTE_STREAM_SUBSCRIBED,this.handleRemoteStreamSubscribed,this),gf.on(_f.VIDEO_LOADED_DATA,this.handleVideoLoadedData,this),gf.on(_f.PLAY_STREAM_START,this.handlePlayStream,this),gf.on(_f.PUBLISH_START,this.handlePublishStart,this),gf.on(_f.LOCAL_STREAM_INITIALIZE_START,this.handleLocalStreamInitStart,this),gf.on(_f.LOCAL_STREAM_INITIALIZE_END,this.handleLocalStreamInitEnd,this),gf.on(_f.LOCAL_STREAM_INITIALIZE_FAILED,this.handleLocalStreamInitFailed,this)}},{key:"uninstallEvents",value:function(){gf.off(_f.JOIN_START,this.handleJoinStart,this),gf.off(_f.JOIN_SEND_CMD,this.handleJoinSendCMD,this),gf.off(_f.JOIN_RECEIVED_CMD_RES,this.handleJoinReceivedCMDResponce,this),gf.off(_f.RECEIVED_PUBLISHED_USER_LIST,this.handleReceivedPublishUserList,this),gf.off(_f.CONNECTION_STATE_CHANGED,this.handleConnectionStateChanged,this),gf.off(_f.LEAVE_START,this.handleLeaveStart,this),gf.off(_f.LEAVE_SUCCESS,this.handleLeaveSuccess,this),gf.off(_f.JOIN_FAILED,this.handleJoinFailed,this),gf.off(_f.LEAVE_SEND_CMD,this.handleLeaveSendCMD,this),gf.off(_f.CONNECTION_SEND_SUBSCRIBE_CMD,this.handleSendSubscribeCMD,this),gf.off(_f.VIDEO_LOADED_META_DATA,this.handleVideoPlaying,this),gf.off(_f.AUDIO_LOADED_META_DATA,this.handleAudioPlaying,this),gf.off(_f.NETWORK_QUALITY,this.handleNetworkQuality,this),gf.off(_f.HEARTBEAT_STATS,this.handleHeartbeatStats,this),gf.off(_f.REMOTE_STREAM_ADDED,this.handleRemoteStreamAdded,this),gf.off(_f.REMOTE_STREAM_SUBSCRIBE_START,this.handleRemoteStreamSubscribeStart,this),gf.off(_f.REMOTE_STREAM_SUBSCRIBED,this.handleRemoteStreamSubscribed,this),gf.off(_f.VIDEO_LOADED_DATA,this.handleVideoLoadedData,this),gf.off(_f.PLAY_STREAM_START,this.handlePlayStream,this),gf.off(_f.PUBLISH_START,this.handlePublishStart,this),gf.off(_f.LOCAL_STREAM_INITIALIZE_START,this.handleLocalStreamInitStart,this),gf.off(_f.LOCAL_STREAM_INITIALIZE_END,this.handleLocalStreamInitEnd,this),gf.off(_f.LOCAL_STREAM_INITIALIZE_FAILED,this.handleLocalStreamInitFailed,this)}},{key:"handleJoinStart",value:function(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_start_time&&(this.pathJoinRoom_.uint64_start_time=Date.now(),this.checkStorage())}},{key:"handleJoinSendCMD",value:function(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_send_request_enter_room_cmd_start_time&&(this.pathJoinRoom_.uint64_send_request_enter_room_cmd_start_time=Date.now())}},{key:"handleJoinReceivedCMDResponce",value:function(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_send_request_enter_room_cmd_end_time&&(this.pathJoinRoom_.uint64_send_request_enter_room_cmd_end_time=Date.now(),this.pathJoinRoom_.int32_send_request_enter_room_cmd_ret=e.code,0!==e.code&&(this.pathJoinRoom_.int32_end_ret=3))}},{key:"handleJoinSuccess",value:function(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_end_time&&(this.pathJoinRoom_.uint64_end_time=Date.now(),this.pathJoinRoom_.int32_end_ret=0)}},{key:"handleJoinFailed",value:function(e){var t=e.client,i=e.error;this.hitTest(t)&&(this.pathJoinRoom_.uint64_end_time=Date.now(),this.pathJoinRoom_.int32_end_ret=3,this.pathJoinRoom_.int32_send_request_enter_room_cmd_ret=i instanceof da?Number(i.getExtraCode()||i.getCode()):ua.UNKNOWN,this.prepareReport(),this.report())}},{key:"handleReceivedPublishUserList",value:function(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_recv_userlist_time&&(this.pathJoinRoom_.uint64_recv_userlist_time=Date.now(),this.firstPublishedUserList_=e.data.content.userlist)}},{key:"handleConnectionStateChanged",value:function(e){var t=e.client,i=e.state,n=e.connection;if(this.hitTest(t)&&i===Es){this.client_.getUplinkConnection()===n&&0===this.pathJoinRoom_.uint64_send_first_video_frame_time&&this.localStreamStats_.publishStartTime>this.pathJoinRoom_.uint64_end_time&&this.localStreamStats_.publishStartTime-this.pathJoinRoom_.uint64_end_time<=100&&(this.pathJoinRoom_.uint64_send_first_video_frame_time=Date.now());var r=this.pathMainVideoMap_.get("".concat(n.getUserId(),"_").concat("main"));r&&0===r.statsToReport.uint64_pc_connected_time&&(r.statsToReport.uint64_pc_connected_time=Date.now())}}},{key:"handleLeaveStart",value:function(e){this.hitTest(e.client)&&(this.pathLeaveRoom_.uint64_start_time=Date.now())}},{key:"handleLeaveSuccess",value:function(e){this.hitTest(e.client)&&0===this.pathLeaveRoom_.uint64_end_time&&(this.pathLeaveRoom_.uint64_end_time=Date.now(),0!==this.pathJoinRoom_.uint64_end_time?this.basicInfo.uint32_joining_duration=this.pathLeaveRoom_.uint64_end_time-this.pathJoinRoom_.uint64_end_time:this.log_.warn("pathJoinRoom endTime is 0"),this.report())}},{key:"handleLeaveSendCMD",value:function(e){this.hitTest(e.client)&&(this.pathLeaveRoom_.uint64_send_request_exit_room_cmd_start_time=Date.now(),this.pathLeaveRoom_.uint64_send_request_exit_room_cmd_end_time=Date.now())}},{key:"handleRemoteStreamAdded",value:function(e){var t=e.client,n=e.stream;if(this.hitTest(t)){var r=n.getUserId(),o=n.getType(),s="".concat(r,"_").concat(o),a=this.remoteStreamStatsMap_.get(s);if(a)a.stream=n;else{var c={userId:r,totalVideoFPS:0,totalVideoBitrate:0,totalAudioLevel:0,totalAudioBitrate:0,totalLoss:0,audioCount:0,audioLevelCount:0,videoCount:0,networkQualityCount:0,streamAddedTime:Date.now(),subscribeStartTime:0,subscribedTime:0,playStreamTime:0,statsToReport:i({},bm),stream:n};c.statsToReport.msg_user_info=new Rm({userId:r,tinyId:n.getTinyId(),role:20}),c.statsToReport.uint32_stream_type="main"===o?2:7,this.remoteStreamStatsMap_.set(s,c)}}}},{key:"handleRemoteStreamSubscribeStart",value:function(e){var t=e.client,i=e.stream;if(this.hitTest(t)){var n=i.getUserId(),r=i.getType(),o="".concat(n,"_").concat(r),s=this.remoteStreamStatsMap_.get(o);s&&0===s.subscribeStartTime&&(s.subscribeStartTime=Date.now())}}},{key:"handleSendSubscribeCMD",value:function(e){if(this.hitTest(e.client)){var t=new Rm(e),i=Date.now(),n="".concat(e.userId,"_").concat("main");e.trackState.video&&e.subscribeState.video&&!this.pathMainVideoMap_.has(n)&&this.pathMainVideoMap_.set(n,{statsToReport:{msg_user_info:t,uint64_start_enter_time:this.pathJoinRoom_.uint64_start_time,uint64_render_first_frame_time:0,uint64_combine_first_frame_time:0,uint64_pc_connected_time:0},userId:e.userId,sendSubscribeCMDTime:i}),e.trackState.audio&&e.subscribeState.audio&&!this.pathMainAudioMap_.has(n)&&this.pathMainAudioMap_.set(n,{statsToReport:{msg_user_info:t,uint64_start_enter_time:this.pathJoinRoom_.uint64_start_time,uint64_play_first_frame_time:0},userId:e.userId,sendSubscribeCMDTime:i});var r="".concat(e.userId,"_").concat("auxiliary");e.trackState.auxiliary&&e.subscribeState.auxiliary&&!this.pathAuxiliaryMap_.has(r)&&this.pathAuxiliaryMap_.set(r,{sendSubscribeCMDTime:i})}}},{key:"handleRemoteStreamSubscribed",value:function(e){var t=e.client,i=e.stream;if(this.hitTest(t)){var n=i.getUserId(),r=i.getType(),o="".concat(n,"_").concat(r),s=this.remoteStreamStatsMap_.get(o);s&&0===s.subscribedTime&&(s.subscribedTime=Date.now(),s.stream=i)}}},{key:"handlePlayStream",value:function(e){var t=e.stream;if(t.isRemote()&&t.getConnection()&&this.hitTest(t.getConnection().getClient())){var i=t.getConnection().getUserId(),n="".concat(i,"_").concat(t.getType());if(this.remoteStreamStatsMap_.has(n)){var r=this.remoteStreamStatsMap_.get(n);0===r.playStreamTime&&(r.playStreamTime=Date.now())}}}},{key:"handleVideoLoadedData",value:function(e){var t=e.stream;if(t.isRemote()&&t.getConnection()&&this.hitTest(t.getConnection().getClient())){var i=t.getConnection().getUserId(),n="".concat(i,"_").concat(t.getType());if(this.pathMainVideoMap_.has(n)){var r=this.pathMainVideoMap_.get(n);0===r.statsToReport.uint64_combine_first_frame_time&&(r.statsToReport.uint64_combine_first_frame_time=Date.now())}}}},{key:"handleVideoPlaying",value:function(e){var t=e.stream;if(t.isRemote()&&t.getConnection()&&this.hitTest(t.getConnection().getClient())){var i=t.getConnection().getUserId(),n="".concat(i,"_").concat(t.getType()),r=Date.now();if(this.pathMainVideoMap_.has(n)){var o=this.pathMainVideoMap_.get(n);if(0===o.statsToReport.uint64_render_first_frame_time&&(o.statsToReport.uint64_render_first_frame_time=r),this.remoteStreamStatsMap_.has(n)){var s=this.remoteStreamStatsMap_.get(n),a=s.statsToReport,c=s.playStreamTime,u=s.subscribedTime;0===a.uint32_video_render_first&&c-u<=100&&(a.uint32_video_render_first=r-o.sendSubscribeCMDTime)}}if("auxiliary"===t.getType()&&this.pathAuxiliaryMap_.has(n)&&this.remoteStreamStatsMap_.has(n)){var d=this.remoteStreamStatsMap_.get(n),l=d.statsToReport,h=d.playStreamTime,p=d.subscribedTime;0===l.uint32_video_render_first&&h-p<=100&&(l.uint32_video_render_first=r-this.pathAuxiliaryMap_.get(n).sendSubscribeCMDTime)}}}},{key:"handleAudioPlaying",value:function(e){if(e.stream.isRemote()&&e.stream.getConnection()&&this.hitTest(e.stream.getConnection().getClient())){var t=e.stream.getConnection().getUserId(),i="".concat(t,"_").concat(e.stream.getType());if(this.pathMainAudioMap_.has(i)){var n=this.pathMainAudioMap_.get(i);0===n.statsToReport.uint64_play_first_frame_time&&(n.statsToReport.uint64_play_first_frame_time=Date.now())}}}},{key:"handleNetworkQuality",value:function(e){var t=this;this.hitTest(e.client)&&(this.networkQuality_.totalUplinkLoss+=e.uplinkLoss,this.networkQuality_.totalUplinkRTT+=e.uplinkRTT,this.networkQuality_.count++,e.downlinkLossAndRTTMap.forEach((function(e){var i=e.rtt,n=e.loss,r=e.userId,o=t.networkQuality_.totalDownlinkRTTAndLossMap.get(r);o?(o.totalRTT+=i,o.totalLoss+=n,o.count++):t.networkQuality_.totalDownlinkRTTAndLossMap.set(r,{totalRTT:i,totalLoss:n,count:1})})))}},{key:"handleHeartbeatStats",value:function(e){var t=this;if(this.hitTest(e.client)){var i=e.stats,n=i.VideoReportState,r=i.AudioReportState;n.VideoEncState[0]&&(this.localStreamStats_.totalVideoBitrate+=n.uint32_video_snd_br,this.localStreamStats_.totalVideoFPS+=n.VideoEncState[0].uint32_enc_fps,this.localStreamStats_.totalVideoWidth+=n.VideoEncState[0].uint32_enc_width,this.localStreamStats_.totalVideoHeight+=n.VideoEncState[0].uint32_enc_height,this.localStreamStats_.videoCount++),n.VideoDecState.forEach((function(e){var i=0===e.uint32_video_strtype,n=2===e.uint32_video_strtype,r="".concat(e.userId,"_").concat(i?"main":"auxiliary");if(t.remoteStreamStatsMap_.has(r)){var o=t.remoteStreamStatsMap_.get(r);(i&&o.stream.isMainVideoSubscribed||n&&o.stream.isAuxVideoSubscribed)&&(o.totalVideoFPS+=e.uint32_video_recv_fps,o.totalVideoBitrate+=e.uint32_video_recv_br,o.videoCount++,0===o.statsToReport.uint32_video_width&&(o.statsToReport.uint32_video_width=e.uint32_dec_width),0===o.statsToReport.uint32_video_height&&(o.statsToReport.uint32_video_height=e.uint32_dec_height))}})),r&&(r.AudioDecState.forEach((function(e){var i="".concat(e.userId,"_").concat("main");if(t.remoteStreamStatsMap_.has(i)){var n=t.remoteStreamStatsMap_.get(i);n.stream.isMainAudioSubscribed&&(n.totalAudioBitrate+=e.uint32_audio_real_recv_br,n.audioCount++,Math.floor(100*e.audioLevel)>0&&(n.totalAudioLevel+=e.audioLevel,n.audioLevelCount++))}})),Math.floor(100*r.sentAudioLevel)>0&&(this.localStreamStats_.totalAudioLevel+=r.sentAudioLevel,this.localStreamStats_.audioLevelCount++))}}},{key:"handlePublishStart",value:function(e){var t=e.client;this.hitTest(t)&&0===this.localStreamStats_.publishStartTime&&(this.localStreamStats_.publishStartTime=Date.now())}},{key:"handleLocalStreamInitStart",value:function(e){var t=e.audio,i=e.video;t&&0===this.pathJoinRoom_.uint64_init_audio_start_time&&(this.pathJoinRoom_.uint64_init_audio_start_time=Date.now()),i&&0===this.pathJoinRoom_.uint64_init_camera_start_time&&(this.pathJoinRoom_.uint64_init_camera_start_time=Date.now())}},{key:"handleLocalStreamInitEnd",value:function(e){var t=e.audio,i=e.video;t&&0===this.pathJoinRoom_.uint64_init_audio_end_time&&(this.pathJoinRoom_.uint64_init_audio_end_time=Date.now()),i&&0===this.pathJoinRoom_.uint64_init_camera_end_time&&(this.pathJoinRoom_.uint64_init_camera_end_time=Date.now())}},{key:"handleLocalStreamInitFailed",value:function(e){var t=e.audio,i=e.video,n=e.error,r=n instanceof da?n.getExtraCode()||n.getCode():{NotFoundError:1,NotAllowedError:2,NotReadableError:3,OverConstrainedError:4,AbortError:5}[n.name]||ua.UNKNOWN;t&&0===this.pathJoinRoom_.uint64_init_audio_end_time&&(this.pathJoinRoom_.int32_init_audio_ret=r,this.pathJoinRoom_.uint64_init_audio_end_time=Date.now()),i&&0===this.pathJoinRoom_.uint64_init_camera_end_time&&(this.pathJoinRoom_.int32_init_camera_ret=r,this.pathJoinRoom_.uint64_init_camera_end_time=Date.now())}},{key:"hasVideoFlag",value:function(e){return this.firstPublishedUserList_.findIndex((function(t){return t.userid===e&&1&t.flag}))>=0}},{key:"hasAudioFlag",value:function(e){return this.firstPublishedUserList_.findIndex((function(t){return t.userid===e&&8&t.flag}))>=0}},{key:"hasAuxFlag",value:function(e){return this.firstPublishedUserList_.findIndex((function(t){return t.userid===e&&4&t.flag}))>=0}},{key:"hitTest",value:function(e){return e===this.client_}},{key:"checkStorage",value:(r=o(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!(t=Tm.getItem(this.storageKey_))){e.next=6;break}return e.next=5,this.upload(t);case 5:Tm.deleteItem(this.storageKey_);case 6:e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),this.log_.warn(e.t0);case 11:case"end":return e.stop()}}),e,this,[[0,8]])}))),function(){return r.apply(this,arguments)})},{key:"setStorage",value:function(){this.prepareReport();var e=this.getReportData();0!==e.msg_path_enter_room.uint64_start_time&&Tm.setItem(this.storageKey_,e)}},{key:"prepareReport",value:function(){var e=this;if(this.networkQuality_.count>0&&(this.basicInfo.uint32_avg_rtt=Math.floor(this.networkQuality_.totalUplinkRTT/this.networkQuality_.count),this.basicInfo.uint32_avg_up_loss=Math.floor(this.networkQuality_.totalUplinkLoss/this.networkQuality_.count)),this.localStreamStats_.videoCount>0){this.localStreamStats_.statsToReport.uint32_video_big_capture_fps=Math.floor(this.localStreamStats_.totalVideoFPS/this.localStreamStats_.videoCount),this.localStreamStats_.statsToReport.uint32_video_big_bitrate=Math.floor(this.localStreamStats_.totalVideoBitrate/this.localStreamStats_.videoCount);var t=Math.floor(this.localStreamStats_.totalVideoWidth/this.localStreamStats_.videoCount),i=Math.floor(this.localStreamStats_.totalVideoHeight/this.localStreamStats_.videoCount);this.localStreamStats_.statsToReport.uint32_video_big_resolution=t<<16|i}this.localStreamStats_.audioLevelCount>0&&(this.localStreamStats_.statsToReport.uint32_audio_capture_db=Math.floor(this.localStreamStats_.totalAudioLevel/this.localStreamStats_.audioLevelCount*100)),this.remoteStreamStatsMap_.forEach((function(t,i){var n=t.userId;if(e.networkQuality_.totalDownlinkRTTAndLossMap.has(n)){var r=e.networkQuality_.totalDownlinkRTTAndLossMap.get(n),o=r.totalLoss,s=r.count;t.statsToReport.uint32_avg_down_loss=Math.floor(o/s)}t.videoCount>0&&(t.statsToReport.uint32_video_avg_fps=Math.floor(t.totalVideoFPS/t.videoCount),t.statsToReport.uint32_video_avg_bitrate=Math.floor(t.totalVideoBitrate/t.videoCount)),t.audioCount>0&&(t.statsToReport.uint32_audio_recv_bitrate=t.statsToReport.uint32_audio_bitrate=Math.floor(t.totalAudioBitrate/t.audioCount)),t.audioLevelCount>0&&(t.statsToReport.uint32_audio_play_db=Math.floor(t.totalAudioLevel/t.audioLevelCount*100));var a=e.client_.getCallDurationCalculator();a&&(t.statsToReport.uint32_audio_play_time=a.getDuration(i,"audio"),t.statsToReport.uint32_video_play_time=a.getDuration(i,"video")),t.statsToReport.uint32_video_render_first=Math.min(t.statsToReport.uint32_video_render_first,5e3);var c=e.client_.getBadCaseDetector();if(c){var u=c.getDataFreezeDuration(i),d=u.dataFreeze,l=u.count,h=c.getRenderFreezeDuration(i).renderFreeze;t.statsToReport.uint32_video_block_count=l,t.statsToReport.uint32_video_block_time=Math.min(d,t.statsToReport.uint32_video_play_time),t.statsToReport.uint32_video_external_block_time=Math.min(h,t.statsToReport.uint32_video_play_time),c.isBlackStream(i)&&0===t.statsToReport.uint32_video_avg_fps?t.statsToReport.uint32_video_black_screen_subjective=1:t.statsToReport.uint32_video_black_screen_subjective=0}(0===t.subscribeStartTime||t.subscribeStartTime-t.streamAddedTime>100||0===t.playStreamTime)&&(e.pathMainAudioMap_.delete(i),e.pathMainVideoMap_.delete(i),t.statsToReport.uint32_video_render_first=0)})),this.pathMainAudioMap_.forEach((function(t,i){e.hasAudioFlag(t.userId)?t.statsToReport.uint64_play_first_frame_time-t.statsToReport.uint64_start_enter_time>5e3&&(t.statsToReport.uint64_play_first_frame_time=t.statsToReport.uint64_start_enter_time+5e3):e.pathMainAudioMap_.delete(i)})),this.pathMainVideoMap_.forEach((function(t,i){e.hasVideoFlag(t.userId)?t.statsToReport.uint64_render_first_frame_time-t.statsToReport.uint64_start_enter_time>5e3&&(t.statsToReport.uint64_render_first_frame_time=t.statsToReport.uint64_start_enter_time+5e3):e.pathMainVideoMap_.delete(i)})),this.pathJoinRoom_.uint64_end_time-this.pathJoinRoom_.uint64_start_time>5e3&&(this.pathJoinRoom_.uint64_end_time=this.pathJoinRoom_.uint64_start_time+5e3)}},{key:"getReportData",value:function(){var e=this.client_.getSignalInfo();return{uint32_sdk_app_id:Number(this.client_.getSDKAppId()),msg_user_info:new Rm({userId:this.client_.getUserId(),tinyId:this.client_.getTinyId(),role:"anchor"===this.client_.getRole()?20:21}),msg_basic_info:this.basicInfo,uint32_acc_ip:qc(e.relayIp),uint32_client_ip:qc(e.localIp,"small"),uint32_acc_port:0,uint64_timestamp:Date.now(),uint32_seq:Math.floor(Math.random()*Math.pow(2,31)),msg_path_enter_room:this.pathJoinRoom_,msg_path_exit_room:this.pathLeaveRoom_,msg_path_recv_video:S(this.pathMainVideoMap_.values()).map((function(e){return e.statsToReport})),msg_quality_statistics:S(this.remoteStreamStatsMap_.values()).map((function(e){return e.statsToReport})),str_room_name:String(this.client_.getRoomId()),msg_path_recv_audio:S(this.pathMainAudioMap_.values()).map((function(e){return e.statsToReport})),uint32_info_client_ip:qc(e.localIp,"small"),error_code:[],msg_local_statistics:this.localStreamStats_.statsToReport}}},{key:"report",value:(n=o(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this.getReportData(),e.next=4,this.upload(t);case 4:Tm.deleteItem(this.storageKey_),this.initData(),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),this.log_.warn(e.t0);case 11:case"end":return e.stop()}}),e,this,[[0,8]])}))),function(){return n.apply(this,arguments)})},{key:"upload",value:(t=o(regeneratorRuntime.mark((function e(t){var i,n,r,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!$u&&0!==t.msg_path_enter_room.uint64_start_time){e.next=2;break}return e.abrupt("return");case 2:return i=Math.floor(Math.random()*Math.pow(2,31)),n=Number(this.client_.getSDKAppId()),r="".concat("https://yun.tim.qq.com","/v5/AVQualityReportSvc/C2S?random=").concat(i,"&sdkappid=").concat(n,"&cmdtype=jssdk_new_endreport"),e.next=7,yc.post(r,JSON.stringify(t));case 7:if("ok"===(o=e.sent).data){e.next=10;break}throw"key point upload failed: ".concat(o.data);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),e}();function km(){return function(e,t,i){var n=i.value,r=new Map;return i.value=o(regeneratorRuntime.mark((function e(){var i,o,s,a,c=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!r.get(this)){e.next=2;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:ep,data:{name:t}})});case 2:for(e.prev=2,r.set(this,!0),i=c.length,o=new Array(i),s=0;s<i;s++)o[s]=c[s];return e.next=7,n.apply(this,o);case 7:return a=e.sent,r.set(this,!1),e.abrupt("return",a);case 12:throw e.prev=12,e.t0=e.catch(2),r.set(this,!1),e.t0;case 16:case"end":return e.stop()}}),e,this,[[2,12]])}))),i}}var wm=(um=km(),dm=Ff(Nf.CLIENT.join),lm=km(),hm=km(),pm=Ff(Nf.CLIENT.publish),fm=km(),mm=Ff(Nf.CLIENT.unpublish),vm=Ff.apply(void 0,S(Nf.CLIENT.subscribe)),gm=Ff(Nf.CLIENT.unsubscribe),_m=km(),ym=Ff(Nf.CLIENT.switchRole),R((Sm=function(){function e(t){var i,n=this;if(s(this,e),this.name_="Client",this.mode_=t.mode,this.sdpSemantics_="plan-b",Uc(t.sdpSemantics)?function(){if(!("RTCRtpTransceiver"in window)||!("stop"in window.RTCRtpTransceiver.prototype))return!1;if(Uc(window.RTCRtpTransceiver))return!1;if(!("currentDirection"in RTCRtpTransceiver.prototype))return!1;var e=new RTCPeerConnection,t=!1;try{e.addTransceiver("audio"),t=!0}catch(e){}return e.close(),t}()&&(this.sdpSemantics_="unified-plan"):this.sdpSemantics_=t.sdpSemantics,this.sdkAppId_=t.sdkAppId,this.userId_=t.userId,this.log_=new vf({id:"c".concat(t.seq,"|").concat(this.userId_),direction:"local",type:""}),this.userSig_=t.userSig,this.roomId_=0,this.useStringRoomId_=t.useStringRoomId||!1,this.recordId_=null,this.pureAudioPushMode_=null,this.version_=t.version,this.log_.info("using sdpSemantics: "+this.sdpSemantics_),Xu.setConfig({sdkAppId:this.sdkAppId_,userId:this.userId_,version:this.version_}),!Uc(t.recordId)){if(!Number.isInteger(Number(t.recordId)))throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_RECORDID"})});this.recordId_=t.recordId}this.signalChannel_=null,this.isScreenShareOnly_=0,Uc(t.isScreenShareOnly)||(this.isScreenShareOnly_=t.isScreenShareOnly?1:0),this.role_="anchor",this.privateMapKey_="",this.tinyId_=0,this.env_="",this.proxy_=null,this.connections_=new Map,this.mutedStates_=new Map,this.userMap_=new Map,this.syncUserListInterval_=-1,this.localStream_=null,this.uplinkConnection_=null,this.emitter_=new Mh,this.signalInfo_={},this.isSignalReady_=!1,this.isJoined_=!1,this.heartbeat_=-1,this.lastHeartBeatTime_=-1,this.stats_=new mf,this.joinTimeout_=-1,this.networkQuality_=null,this.badCaseDetector_=null,this.autoSubscribe_=!!Uc(t.autoSubscribe)||t.autoSubscribe,this.startJoinTimestamp_=0,this.joinedTimestamp_=0,this.joinOptions={},this.basis_={browser:Qu().name+"/"+Qu().version,os:Jp(),displayResolution:Wp(),isScreenShareSupported:Up(),isWebRTCSupported:Dp(),isGetUserMediaSupported:zp(),isWebAudioSupported:$p(),isWebSocketsSupported:"WebSocket"in window&&2===window.WebSocket.CLOSING,isWebCodecSupported:(i={AudioDecoder:!1,AudioEncoder:!1,VideoDecoder:!1,VideoEncoder:!1,ImageDecoder:!1},Uc(window.AudioDecoder)||(i.AudioDecoder=!0),Uc(window.AudioEncoder)||(i.AudioEncoder=!0),Uc(window.VideoDecoder)||(i.VideoDecoder=!0),Uc(window.VideoEncoder)||(i.VideoEncoder=!0),Uc(window.ImageDecoder)||(i.ImageDecoder=!0),i),isMediaSessionSupported:"mediaSession"in navigator&&!Uc(navigator.mediaSession.setActionHandler),isWebTransportSupported:!Uc(window.WebTransport)},this.initBussinessInfo_(t),this.publishedCDN_=!1,this.publishCDNData_=null,this.mixedMCU_=!1,this.mixTranscodeData_=null,this.checkSystemResult_=null,this.enableAudioVolumeEvaluation_=!1,this.audioVolumeIntervalId_=null,this.mixTranscodeManager_=null,this.publishCDNManager_=null,this.keyPointManager_=new Im({client:this,frameWorkType:t.frameWorkType}),this.getUserList=im({retryFunction:this.getUserList,settings:{retries:3},onError:function(e,t){return t()},onRetrying:function(e){n.log_.info("retrying to get user list [".concat(e,"/3]"))}}),this.isPublishing_=!1,this.isEnableSmallStream_=!1,this.smallStreamConfig_={bitrate:100,framerate:15,height:120,width:160},this.turnServers_=[],this.iceTransportPolicy_=t.iceTransportPolicy,this.schedule_={domains:null,iceServers:null,iceTransportPolicy:null}}var t,n,r,a,u,d,l,h,p,f,m,v,g,_,T,E,R,I,k,w,C,A,D,O;return c(e,[{key:"initBussinessInfo_",value:function(e){this.bussinessInfo_=e.bussinessInfo;var t={};if(Vc(e.bussinessInfo)&&(t=JSON.parse(e.bussinessInfo)),!Uc(e.pureAudioPushMode)){if(!Number.isInteger(Number(e.pureAudioPushMode)))throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_PURE_AUDIO"})});this.pureAudioPushMode_=e.pureAudioPushMode,t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.pure_audio_push_mod=this.pureAudioPushMode_}if(!Uc(e.streamId)){if(!(Vc(e.streamId)&&String(e.streamId)&&String(e.streamId).length<=64))throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_STREAMID"})});t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.userdefine_streamid_main=e.streamId}if(!Uc(e.userDefineRecordId)){if(null===e.userDefineRecordId.match(/^[A-Za-z0-9_-]{1,64}$/gi))throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_USER_DEFINE_RECORDID"})});t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.userdefine_record_id=e.userDefineRecordId}if(!Uc(e.userDefinePushArgs)){if(!(Vc(e.userDefinePushArgs)&&String(e.userDefinePushArgs)&&String(e.userDefinePushArgs).length<=256))throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_USER_DEFINE_PUSH_ARGS"})});t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.userdefine_push_args=e.userDefinePushArgs}Yh(t)||(this.bussinessInfo_=JSON.stringify(t))}},{key:"setProxyServer",value:function(e){if(this.log_.info("set proxy server: ".concat(JSON.stringify(e))),Vc(e)){if(!e.startsWith("wss://"))throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_PROXY"})});this.proxy_=e}else if(Mc(e)){var t=e.websocketProxy,i=e.loggerProxy;t&&(this.proxy_=t),i&&function(e){vs=e}(i)}}},{key:"schedule",value:(O=o(regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Jc({userId:this.userId_,sdkAppId:this.sdkAppId_,roomId:t,useStringRoomId:this.useStringRoomId_,version:this.version_,userSig:this.userSig_});case 2:(n=e.sent)&&(this.log_.debug("schedule: ".concat(JSON.stringify(n))),this.schedule_=i(i({},this.schedule_),n));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return O.apply(this,arguments)})},{key:"getSignalChannelUrl",value:function(){var e={mainUrl:"wss://qcloud.rtc.qq.com",backupUrl:"wss://bk.rtc.qq.com"},t=Dc();return t?e.mainUrl=e.backupUrl="wss://".concat(t,".rtc.qq.com"):this.proxy_?e.mainUrl=e.backupUrl=this.proxy_:Array.isArray(this.schedule_.domains)&&this.schedule_.domains.length>0&&(e.mainUrl=e.backupUrl="wss://".concat(this.schedule_.domains[0]),this.schedule_.domains[1]&&(e.backupUrl="wss://".concat(this.schedule_.domains[1]))),e}},{key:"getUserId",value:function(){return this.userId_}},{key:"getUserSig",value:function(){return this.userSig_}},{key:"getRole",value:function(){return this.role_}},{key:"getSignalInfo",value:function(){return this.signalInfo_}},{key:"getRoomId",value:function(){return this.roomId_}},{key:"getSDKAppId",value:function(){return this.sdkAppId_}},{key:"getTinyId",value:function(){return this.tinyId_}},{key:"setTurnServer",value:function(e){this.log_.info("set turn server: "+JSON.stringify(e));var t=[];Array.isArray(e)?e.forEach((function(e){return t.push(Hc(e))})):Mc(e)&&t.push(Hc(e)),this.turnServers_=t}},{key:"getIceTransportPolicy",value:function(){return this.iceTransportPolicy_||this.schedule_.iceTransportPolicy||"all"}},{key:"initialize",value:function(){var e=this;return new Promise((function(t,i){e.log_.info("setup signal channel");var n=e.getSignalChannelUrl(),r=n.mainUrl,o=n.backupUrl;e.signalChannel_=new fp({sdkAppId:e.sdkAppId_,userId:e.userId_,userSig:e.userSig_,url:r,backupUrl:o,version:e.version_,client:e}),e.networkQuality_||(e.networkQuality_=new yf({connections:e.connections_,signalChannel:e.signalChannel_,userId:e.userId_,client:e}),e.networkQuality_.on(uf,(function(t){e.emitter_.emit(uf,t)}))),e.deviceDetector_||(e.deviceDetector_=new Sf),e.subscriptionManager_||(e.subscriptionManager_=new qf({client:e})),e.badCaseDetector_||(e.badCaseDetector_=new em({client:e})),e.callDurationCalculator_||(e.callDurationCalculator_=new sm({client:e})),e.mixTranscodeManager_||(e.mixTranscodeManager_=new rm({client:e,signalChannel:e.signalChannel_})),e.publishCDNManager_||(e.publishCDNManager_=new om({client:e,signalChannel:e.signalChannel_})),e.signalChannel_.on(Lh,(function(t){switch(e.log_.info("SignalChannel state changed from ".concat(t.prevState," to ").concat(t.state)),t.state){case Bh:t.prevState===jh?(e.log_.warn("signal channel reconnect successfully"),e.syncUserList(),Cc({eventType:Ns})):t.prevState===Fh&&Cc({eventType:Ls})}e.emitter_.emit("connection-state-changed",t)})),e.signalChannel_.on(Uh,(function(t){e.isSignalReady_?(e.closeUplink(),e.closeConnections(),e.emitter_.emit(lf,t)):i(t)})),e.signalChannel_.on(qh.CHANNEL_SETUP_FAILED,(function(t){e.log_.error("signal channel setup failed"),i(t)})),e.signalChannel_.on(qh.CHANNEL_SETUP_SUCCESS,(function(i){e.signalInfo_=i.signalInfo,e.tinyId_=e.signalInfo_.tinyId,e.isSignalReady_||(e.isSignalReady_=!0,t())})),e.signalChannel_.on(qh.PEER_JOIN,e.onPeerJoin,e),e.signalChannel_.on(qh.PEER_LEAVE,e.onPeerLeave,e),e.signalChannel_.on(qh.STREAM_ADDED,(function(t){e.onRemoteStreamAdded(t.data)})),e.signalChannel_.on(qh.STREAM_REMOVED,(function(t){e.onRemoteStreamRemoved(t.data)})),e.signalChannel_.on(qh.UPDATE_REMOTE_MUTE_STAT,(function(t){gf.emit(_f.RECEIVED_PUBLISHED_USER_LIST,{client:e,data:t.data}),e.onPublishedUserList(t.data),e.onUpdateRemoteMuteStat(t.data)})),e.signalChannel_.on(qh.CLINET_BANNED,(function(t){var i=t.data.content;e.reset();var n=i.type;"banned"===i.type?n="you got banned by account admin":"kick"===i.type?n="duplicated userId joining the room":"user_time_out"===i.type&&e.log_.warn("last heart beat time: ".concat(e.lastHeartBeatTime_," interval: ").concat(Date.now()-e.lastHeartBeatTime_)),Ic("stat-banned:".concat(i.type)),e.log_.error("user was banned because of [".concat(i.type,"]")),e.onClientBanned(n)})),e.signalChannel_.on(qh.REQUEST_REBUILD_SESSION,(function(t){e.signalInfo_=t.signalInfo;var i=[];e.connections_&&i.push(0);var n,r=[],o=b(e.connections_);try{for(o.s();!(n=o.n()).done;){var s=y(n.value,2),a=s[0],c=s[1];i.push(a);var u=c.getPeerConnection();if(u){var d=u.remoteDescription;d&&r.push(d.sdp)}}}catch(e){o.e(e)}finally{o.f()}var l={socketid:e.signalInfo_.socketId,tinyid:e.tinyId_,appid:e.sdkAppId_,openid:e.userId_,sessionid:String(e.roomId_),sids:i,relayInfo:e.signalInfo_.relayInnerIp,remotesdp:r,useStrRoomid:!!e.useStringRoomId_&&1};e.log_.debug("reconnect - rebuild session with data: ".concat(JSON.stringify(l))),e.signalChannel_.send("on_rebuild_session",l)})),e.signalChannel_.on(qh.CLIENT_REJOIN,(function(){e.reJoin()})),e.signalChannel_.connect()}))}},{key:"join",value:(D=o(regeneratorRuntime.mark((function e(t){var i,n,r,o,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isJoined_){e.next=2;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_JOIN"})});case 2:return e.next=4,Np();case 4:if(this.checkSystemResult_=e.sent,(i=Dc())||(i="qcloud",this.proxy_&&(this.proxy_.startsWith("wss://trtc.rtc.qq.com")?i="trtc":this.proxy_.startsWith("wss://webrtc.qq.com")&&(i="webrtc"))),this.env_=i,Rc({env:i,sdkAppId:this.sdkAppId_,userId:this.userId_,version:this.version_}),this.uploadTrtcStats(),n=this.checkSystemResult_.detail,r=n.isH264EncodeSupported,o=n.isVp8EncodeSupported,Dp()&&(r||o)){e.next=13;break}throw new da({code:ua.NOT_SUPPORTED,message:pp({key:"NOT_SUPPORTED_WEBRTC"})});case 13:if(this.joinOptions=t,this.startJoinTimestamp_=Gc(),gf.emit(_f.JOIN_START,{client:this}),zh(this.userId_,{eventId:32788,eventDesc:"joining room",timestamp:Tc(),userId:this.userId_,tinyId:this.tinyId_}),e.prev=17,this.schedule_.domains){e.next=21;break}return e.next=21,this.schedule(t.roomId);case 21:return e.next=23,this.initialize(t);case 23:return e.next=25,this.doJoin(t);case 25:gf.emit(_f.JOIN_SUCCESS,{client:this}),this.joinedTimestamp_=Gc(),s=this.joinedTimestamp_-this.startJoinTimestamp_,Cc({eventType:"delta-join",delta:s}),Cc({eventType:"join"}),e.next=38;break;case 32:throw e.prev=32,e.t0=e.catch(17),gf.emit(_f.JOIN_FAILED,{client:this,error:e.t0}),Ac({eventType:"join",error:e.t0}),this.reset(),e.t0;case 38:case"end":return e.stop()}}),e,this,[[17,32]])}))),function(e){return D.apply(this,arguments)})},{key:"uploadTrtcStats",value:(A=o(regeneratorRuntime.mark((function e(){var t,i,n,r,o,s,a,c,u,d,l,h,p;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Wm.getMicrophones();case 3:n=e.sent,t=n&&n.length,e.next=9;break;case 7:e.prev=7,e.t0=e.catch(0);case 9:return e.prev=9,e.next=12,Wm.getCameras();case 12:r=e.sent,i=r&&r.length,e.next=18;break;case 16:e.prev=16,e.t1=e.catch(9);case 18:o={microphone:t,camera:i},s=this.checkSystemResult_.detail,a=s.isH264EncodeSupported,c=s.isVp8EncodeSupported,u=s.isH264DecodeSupported,d=s.isVp8DecodeSupported,l={webRTC:this.basis_.isWebRTCSupported,getUserMedia:this.basis_.isGetUserMediaSupported,webSocket:this.basis_.isWebSocketsSupported,screenShare:this.basis_.isScreenShareSupported,webAudio:this.basis_.isWebAudioSupported,h264Encode:a,h264Decode:u,vp8Encode:c,vp8Decode:d},h={browser:this.basis_.browser,os:this.basis_.os,trtc:l,devices:o},p={isWebCodecSupported:this.basis_.isWebCodecSupported,isMediaSessionSupported:this.basis_.isMediaSessionSupported,isWebTransportSupported:this.basis_.isWebTransportSupported},Ic("trtcstats-"+JSON.stringify(h)),this.log_.info("TrtcStats-"+JSON.stringify(h)),Ic("trtcadvancedstats-"+JSON.stringify(p));case 26:case"end":return e.stop()}}),e,this,[[0,7],[9,16]])}))),function(){return A.apply(this,arguments)})},{key:"getVersion",value:function(){var e=this.version_.split(".");return 1e3*parseInt(e[0])+100*parseInt(e[1])+parseInt(e[2])}},{key:"doJoin",value:function(e){var t=this;return new Promise((function(i,n){if(!t.isSignalReady_)throw new da({code:ua.INVALID_OPERATION,message:pp({key:rp})});t.roomId_=e.roomId,Uc(e.role)||(t.role_=e.role);var r="";Uc(e.privateMapKey)||(r=e.privateMapKey),t.privateMapKey_=r,t.log_.info("Join() => joining room: ".concat(e.roomId," useStringRoomId: ").concat(t.useStringRoomId_," mode: ").concat(t.mode_," role: ").concat(t.role_));var o=t.signalInfo_,s={openid:o.openId,tinyid:o.tinyId,peerconnectionport:"",useStrRoomid:!!t.useStringRoomId_&&1,roomid:String(e.roomId),sdkAppID:String(t.sdkAppId_),socketid:o.socketId,userSig:t.userSig_,privMapEncrypt:r,privMap:"",relayip:o.relayInnerIp,dataport:o.dataPort,stunport:o.stunPort,checkSigSeq:o.checkSigSeq,pstnBizType:0,pstnPhoneNumber:null,recordId:t.recordId_,role:"user",jsSdkVersion:String(t.getVersion()),sdpSemantics:t.sdpSemantics_,browserVersion:zu,closeLocalMedia:!0,trtcscene:"live"===t.mode_?2:1,trtcrole:"anchor"===t.role_?20:21,bussinessInfo:t.bussinessInfo_,isAuxUser:t.isScreenShareOnly_,autoSubscribe:t.autoSubscribe_};t.joinTimeout_=setTimeout((function(){t.log_.error("join room timeout observed"),n(new da({code:ua.JOIN_ROOM_FAILED,message:pp({key:"JOIN_ROOM_TIMEOUT"})}))}),5e3),gf.emit(_f.JOIN_SEND_CMD,{client:t});var a={AbilityOption:{GeneralLimit:{CPULimit:{uint32_CPU_num:String(navigator.hardwareConcurrency||0),str_CPU_name:String(navigator.platform),uint32_CPU_maxfreq:String(0),model:"",uint32_total_memory:String(0)},uint32_terminal_type:String(eu?4:Qc?2:Yc?3:wu?12:ku?5:Cu?13:1),uint32_device_type:String(0),str_os_verion:eu?"Android":Qc?"iPhone":Yc?"iPad":wu?"Mac":ku?"Windows":Cu?"Linux":"unknown",uint32_link_type:String(1),str_client_version:"4.11.7",uint32_net_type:String(ra[xc()]),ua:navigator.userAgent,version:""}}},c=t.getSystemResult().detail,u=c.isH264EncodeSupported,d=c.isVp8EncodeSupported,l="";u?l="H264":d&&(l="VP8");var h={EncVideoCodec:l,EncVideoWidth:0,EncVideoHeight:0,EncVideoBr:"0",EncVideoFps:0,EncAudioCodec:"opus",EncAudioFS:0,EncAudioCh:0,EncAudioBr:"0"};a.AbilityOption.AVLimit=h,t.signalChannel_.sendWithReport("on_create_room",s,a),t.signalChannel_.once(qh.JOIN_ROOM_RESULT,(function(e){clearTimeout(t.joinTimeout_),t.joinTimeout_=-1;var r=e.data.content.ret;gf.emit(_f.JOIN_RECEIVED_CMD_RES,{client:t,code:r}),r?(t.log_.error("Join room failed result: "+r+" error: "+e.data.content.error),n(new da({code:ua.JOIN_ROOM_FAILED,extraCode:r,message:pp({key:"JOIN_ROOM_FAILED",data:{error:e.data.content.error}})}))):(t.isJoined_=!0,t.log_.info("Join room success, start heartbeat"),t.startHeartbeat(),t.badCaseDetector_&&t.badCaseDetector_.start(),t.syncUserList(),t.startSyncUserListInterval(),i())}))}))}},{key:"connectSignalBeforeReJoin",value:function(){var e=this;return new Promise((function(t,i){e.log_.warn("connectSignalBeforeReJoin() try to connect signal before reJoin"),e.isSignalReady_=!1,e.signalChannel_.close(),e.signalChannel_.once(qh.CHANNEL_SETUP_SUCCESS,(function(i){e.log_.warn("connectSignalBeforeReJoin() signal setup successfully"),t()})),e.signalChannel_.once(Uh,(function(t){e.log_.warn("connectSignalBeforeReJoin() signal setup failed"),i(t)})),e.signalChannel_.connect()}))}},{key:"reJoin",value:(C=o(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isJoined_){e.next=3;break}return this.log_.warn("reJoin() you haven't join room yet, abort reJoin"),e.abrupt("return");case 3:return this.isJoined_=!1,e.prev=4,this.log_.warn("reJoin() try to reJoin room: ".concat(this.joinOptions.roomId)),this.subscriptionManager_&&this.subscriptionManager_.markAllStream(),e.next=9,this.connectSignalBeforeReJoin();case 9:return e.next=11,this.doJoin(this.joinOptions);case 11:if(this.log_.warn("reJoin() reJoin successfully"),Cc({eventType:"rejoin"}),this.checkConnectionsToReconnect(),e.prev=14,!this.uplinkConnection_||!this.localStream_||this.uplinkConnection_.getIsReconnecting()){e.next=18;break}return e.next=18,this.republish();case 18:e.next=22;break;case 20:e.prev=20,e.t0=e.catch(14);case 22:e.next=29;break;case 24:e.prev=24,e.t1=e.catch(4),this.log_.warn("reJoin() reJoin failed"+e.t1),Ac({eventType:"rejoin",error:e.t1}),this.emitter_.emit(lf,new da({code:ua.JOIN_ROOM_FAILED,message:pp({key:"REJOIN_ROOM_FAILED",data:{roomId:this.joinOptions.roomId}})}));case 29:case"end":return e.stop()}}),e,this,[[4,24],[14,20]])}))),function(){return C.apply(this,arguments)})},{key:"republish",value:(w=o(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.log_.warn("republish() try to re-publish localStream"),t=this.localStream_,e.next=5,this.doUnpublish(t);case 5:return e.next=7,this.publish(t);case 7:this.log_.warn("republish() re-publish localStream successfully"),e.next=14;break;case 10:throw e.prev=10,e.t0=e.catch(0),this.log_.warn("republish() re-publish localStream failed "+e.t0),e.t0;case 14:case"end":return e.stop()}}),e,this,[[0,10]])}))),function(){return w.apply(this,arguments)})},{key:"leave",value:(k=o(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return gf.emit(_f.LEAVE_START,{client:this}),zh(this.userId_,{eventId:32789,eventDesc:"leaving room",timestamp:Tc(),userId:this.userId_,tinyId:this.tinyId_}),e.prev=2,e.next=5,this.doHeartbeat();case 5:e.next=9;break;case 7:e.prev=7,e.t0=e.catch(2);case 9:this.doLeave(),gf.emit(_f.LEAVE_SUCCESS,{client:this}),Cc({eventType:"leave"}),t=Math.floor((Gc()-this.joinedTimestamp_)/1e3),Cc({eventType:"delta-leave",delta:t});case 14:case"end":return e.stop()}}),e,this,[[2,7]])}))),function(){return k.apply(this,arguments)})},{key:"doLeave",value:function(){this.isJoined_&&(gf.emit(_f.LEAVE_SEND_CMD,{client:this}),this.log_.info("leave() => leaving room"),this.signalChannel_.send("on_quit_room"),this.reset())}},{key:"clearNetworkQuality",value:function(){this.networkQuality_&&(this.networkQuality_.stop(),this.networkQuality_=null)}},{key:"closeConnections",value:function(){var e=this;this.connections_.forEach((function(t){e.closeDownLink(t.getTinyId())}))}},{key:"destroy",value:function(){if(this.isJoined_)throw this.log_.warn("please call leave() before destroy() client"),new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_LEAVE"})});this.log_.info("destroying SignalChannel"),this.signalChannel_&&(this.signalChannel_.close(),this.signalChannel_=null)}},{key:"reset",value:function(){this.keyPointManager_&&this.keyPointManager_.prepareReport(),this.mixTranscodeManager_&&(this.mixTranscodeManager_.stop(),this.mixTranscodeManager_=null),this.publishCDNManager_&&(this.publishCDNManager_=null),this.userMap_.clear(),this.stopSyncUserListInterval(),this.stopHeartbeat(),this.closeConnections(),this.mutedStates_.clear(),this.clearNetworkQuality(),this.badCaseDetector_&&this.callDurationCalculator_&&this.uploadAllCallStats(),this.closeUplink(),this.isJoined_=!1,this.isSignalReady_=!1,this.destroy()}},{key:"startSyncUserListInterval",value:function(){"live"===this.mode_&&"audience"===this.role_&&-1===this.syncUserListInterval_&&(this.syncUserListInterval_=Id.setInterval(this.syncUserList.bind(this),1e4))}},{key:"stopSyncUserListInterval",value:function(){Id.clearInterval(this.syncUserListInterval_),this.syncUserListInterval_=-1}},{key:"syncUserList",value:(I=o(regeneratorRuntime.mark((function e(){var t,i=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.getUserList();case 3:t=e.sent,0!==this.userMap_.size&&this.userMap_.forEach((function(e){t.findIndex((function(t){return t.userId===e.userId}))<0&&(i.log_.info("peer leave detected: ".concat(e.userId)),i.cleanUser({userId:e.userId,tinyId:e.tinyId}))})),t.forEach((function(e){var t=e.userId;i.userMap_.has(t)||t===i.userId_||(i.userMap_.set(t,e),i.emitter_.emit(rf,{userId:t}))})),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),this.log_.warn("sync user list failed: "+e.t0);case 11:case"end":return e.stop()}}),e,this,[[0,8]])}))),function(){return I.apply(this,arguments)})},{key:"getUserList",value:function(){var e=this;return new Promise((function(t,i){e.signalChannel_.send("on_get_user_list"),e.signalChannel_.once(qh.USER_LIST_RES,(function(e){var i=e.data.content.userlist.map((function(e){var t=e.userid,i=e.srctinyid,n=e.role;return new tm({userId:t,tinyId:i,role:n})}));t(i)})),setTimeout(i,2e3)}))}},{key:"publish",value:(R=o(regeneratorRuntime.mark((function e(t){var i,n,r,o,s=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.setPublishState(0),this.isPublishing_=!0,i=Gc(),gf.emit(_f.PUBLISH_START,{client:this,stream:t}),this.log_.info("publish() => publishing local stream"),n=new $f({userId:this.userId_,tinyId:this.tinyId_,client:this,isUplink:!0,signalChannel:this.signalChannel_}),t.setConnection(n),n.initialize(),n.on(ef,(function(e){var t=e.getCode();t!==ua.ICE_TRANSPORT_ERROR&&(t===ua.UPLINK_RECONNECTION_FAILED&&s.closeUplink(),s.emitter_.emit(lf,e))})),e.prev=9,e.next=12,n.publish(t);case 12:this.localStream_=e.sent,this.localStream_.getBeautyStatus()&&this.log_.info("beauty stream is published successfully"),this.log_.info("local stream is published successfully"),this.isPublishing_=!1,t.setPublishState(1),this.uplinkConnection_=n,r=Gc(),o=r-i,Cc({eventType:bs}),Cc({eventType:"delta-publish",delta:o}),t.hasAudio()&&zh(this.userId_,{eventId:32769,eventDesc:"publish audio track",timestamp:Tc(),userId:this.userId_,tinyId:this.tinyId_}),t.hasVideo()&&zh(this.userId_,{eventId:32768,eventDesc:"publish video track",timestamp:Tc(),userId:this.userId_,tinyId:this.tinyId_}),this.networkQuality_&&this.networkQuality_.setUplinkConnection(this.uplinkConnection_),this.deviceDetector_&&this.deviceDetector_.setLocalStream(this.localStream_),gf.emit(_f.LOCAL_STREAM_PUBLISHED,{localStream:this.localStream_}),this.notPublishWithoutH264Supported_=!1,e.next=39;break;case 30:throw e.prev=30,e.t0=e.catch(9),e.t0 instanceof da&&e.t0.getCode()===ua.NOT_SUPPORTED_H264&&(this.notPublishWithoutH264Supported_=!0),t.setPublishState(-1),n.close(),this.log_.error("failed to publish stream "+e.t0),this.isPublishing_=!1,Ac({eventType:bs,error:e.t0}),e.t0;case 39:case"end":return e.stop()}}),e,this,[[9,30]])}))),function(e){return R.apply(this,arguments)})},{key:"unpublish",value:(E=o(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log_.info("unpublish() => unpublishing local stream"),e.prev=1,e.next=4,this.doUnpublish();case 4:Cc({eventType:Rs}),e.next=11;break;case 7:throw e.prev=7,e.t0=e.catch(1),Ac({eventType:Rs,error:e.t0}),e.t0;case 11:case"end":return e.stop()}}),e,this,[[1,7]])}))),function(){return E.apply(this,arguments)})},{key:"doUnpublish",value:function(){var e=this;return this.signalChannel_.sendWaitForResponse({command:Jh,commandDesc:"unpublish",responseCommand:qh.UNPUBLISH_RESULT}).then((function(){e.closeUplink()})).catch((function(){e.closeUplink()}))}},{key:"closeUplink",value:function(){this.uplinkConnection_&&(this.uplinkConnection_.getIsReconnecting()&&this.uplinkConnection_.stopReconnection(),this.uplinkConnection_.close(),this.uplinkConnection_=null,this.networkQuality_&&this.networkQuality_.setUplinkConnection(null),this.localStream_.hasAudio()&&zh(this.userId_,{eventId:32771,eventDesc:"unpublish audio track",timestamp:Tc(),userId:this.userId_,tinyId:this.tinyId_}),this.localStream_.hasVideo()&&zh(this.userId_,{eventId:32770,eventDesc:"unpublish video track",timestamp:Tc(),userId:this.userId_,tinyId:this.tinyId_}),this.localStream_.setConnection(null),this.localStream_=null,this.deviceDetector_&&this.deviceDetector_.setLocalStream(null))}},{key:"closeDownLink",value:function(e){var t=this.connections_.get(e);t&&(t.getIsReconnecting()&&t.stopReconnection(),this.subscriptionManager_&&this.subscriptionManager_.delete(t.getUserId()),t.close(),this.connections_.delete(e),this.mutedStates_.delete(e))}},{key:"subscribe",value:(T=o(regeneratorRuntime.mark((function e(t,i){var n,r,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log_.info("subscribe() => subscribe to [".concat(t.getUserId(),"] ").concat(t.getType()," stream with options: ").concat(JSON.stringify(i))),Uc(i)&&(i={audio:!0,video:!0}),Uc(i.video)&&(i.video=!0),Uc(i.audio)&&(i.audio=!0),e.prev=4,n=t.getConnection(),gf.emit(_f.REMOTE_STREAM_SUBSCRIBE_START,{client:this,stream:t}),e.next=9,n.subscribe(t,i);case 9:this.subscriptionManager_&&this.subscriptionManager_.addSubscriptionRecord(t.getUserId(),t,i),this.notSubscribeWithoutH264Supported_=!1,Cc({eventType:Is}),e.next=22;break;case 14:throw e.prev=14,e.t0=e.catch(4),(r=e.t0 instanceof da?e.t0.getCode():ua.UNKNOWN)===ua.NOT_SUPPORTED_H264&&(this.notSubscribeWithoutH264Supported_=!0),o=new da({code:r,message:pp({key:"SUBSCRIBE_FAILED",data:{message:e.t0.message}})}),Ac({eventType:Is,error:o}),this.log_.error(o),o;case 22:case"end":return e.stop()}}),e,this,[[4,14]])}))),function(e,t){return T.apply(this,arguments)})},{key:"unsubscribe",value:(_=o(regeneratorRuntime.mark((function e(t){var i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log_.info("unsubscribe() => unsubscribe to [".concat(t.getUserId(),"] ").concat(t.getType()," stream")),e.prev=1,i=t.getConnection(),e.next=5,i.unsubscribe(t);case 5:this.subscriptionManager_&&this.subscriptionManager_.addUnsubscriptionRecord(t.getUserId(),t),gf.emit(_f.REMOTE_STREAM_UNSUBSCRIBED,{client:this,stream:t}),Cc({eventType:ks}),e.next=14;break;case 10:throw e.prev=10,e.t0=e.catch(1),Ac({eventType:ks,error:e.t0}),e.t0;case 14:case"end":return e.stop()}}),e,this,[[1,10]])}))),function(e){return _.apply(this,arguments)})},{key:"switchRole",value:(g=o(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.role_!==t){e.next=2;break}return e.abrupt("return");case 2:if("audience"!==t||!this.localStream_){e.next=5;break}return e.next=5,this.unpublish(this.localStream_);case 5:return this.log_.info("switchRole() => switch role to: "+t),e.next=8,this.doSwitchRole(t);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)})},{key:"doSwitchRole",value:function(e){var t=this;return new Promise((function(i,n){var r={trtcscene:"live"===t.mode_?2:1,trtcrole:"anchor"===e?20:21};t.log_.info("switchRole signal data: "+JSON.stringify(r));var o=setTimeout((function(){t.log_.error("switchRole timeout observed"),t.signalChannel_.off(qh.SWITCH_ROLE_RES,s),n(new da({code:ua.SWITCH_ROLE_FAILED,message:pp({key:"SWITCH_ROLE_TIMEOUT"})}))}),5e3),s=function(r){clearTimeout(o);var s=r.data.content,a=s.errCode,c=s.errMsg;0===a?(t.role_=e,i()):(t.log_.error("switchRole failed, errCode: ".concat(a,", errMsg: ").concat(c)),n(new da({code:ua.SWITCH_ROLE_FAILED,message:pp({key:"SWITCH_ROLE_FAILED",data:{errMsg:c,errCode:a}})})))};t.signalChannel_.once(qh.SWITCH_ROLE_RES,s),t.signalChannel_.send("on_switch_role",r)}))}},{key:"on",value:function(e,t,i){this.emitter_.on(e,t,i)}},{key:"off",value:function(e,t,i){"*"===e?this.emitter_.removeAllListeners():this.emitter_.off(e,t,i)}},{key:"getRemoteMutedState",value:function(){var e=this,t=[];return this.mutedStates_.forEach((function(n,r,o){var s=e.connections_.get(r);s&&t.push(i({userId:s.getUserId()},n))})),t}},{key:"getTransportStats",value:(v=o(regeneratorRuntime.mark((function e(){var t,i,n,r,o,s,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t={rtt:0,downlinksRTT:{}},!this.uplinkConnection_){e.next=6;break}return e.next=4,this.stats_.getSenderStats(this.uplinkConnection_);case 4:i=e.sent,t.rtt=i.rtt;case 6:n=b(this.connections_),e.prev=7,n.s();case 9:if((r=n.n()).done){e.next=17;break}return(o=y(r.value,2))[0],s=o[1],e.next=13,this.stats_.getReceiverStats(s);case 13:a=e.sent,t.downlinksRTT[a.userId]=a.rtt;case 15:e.next=9;break;case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(7),n.e(e.t0);case 22:return e.prev=22,n.f(),e.finish(22);case 25:return e.abrupt("return",t);case 26:case"end":return e.stop()}}),e,this,[[7,19,22,25]])}))),function(){return v.apply(this,arguments)})},{key:"getLocalAudioStats",value:(m=o(regeneratorRuntime.mark((function e(){var t,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((t={})[this.userId_]={bytesSent:0,packetsSent:0},!this.uplinkConnection_){e.next=7;break}return e.next=5,this.stats_.getSenderStats(this.uplinkConnection_);case 5:i=e.sent,t[this.userId_]={bytesSent:i.audio.bytesSent,packetsSent:i.audio.packetsSent};case 7:return e.abrupt("return",t);case 8:case"end":return e.stop()}}),e,this)}))),function(){return m.apply(this,arguments)})},{key:"getLocalVideoStats",value:(f=o(regeneratorRuntime.mark((function e(){var t,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((t={})[this.userId_]={bytesSent:0,packetsSent:0,framesEncoded:0,framesSent:0,frameWidth:0,frameHeight:0},!this.uplinkConnection_){e.next=7;break}return e.next=5,this.stats_.getSenderStats(this.uplinkConnection_);case 5:i=e.sent,t[this.userId_]={bytesSent:i.video.bytesSent,packetsSent:i.video.packetsSent,framesEncoded:i.video.framesEncoded,framesSent:i.video.framesSent,frameWidth:i.video.frameWidth,frameHeight:i.video.frameHeight};case 7:return e.abrupt("return",t);case 8:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"getRemoteAudioStats",value:(p=o(regeneratorRuntime.mark((function e(){var t,i,n,r,o,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t={},i=b(this.connections_),e.prev=2,i.s();case 4:if((n=i.n()).done){e.next=12;break}return(r=y(n.value,2))[0],o=r[1],e.next=8,this.stats_.getReceiverStats(o);case 8:(s=e.sent).hasAudio&&(t[s.userId]={bytesReceived:s.audio.bytesReceived,packetsReceived:s.audio.packetsReceived,packetsLost:s.audio.packetsLost});case 10:e.next=4;break;case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(2),i.e(e.t0);case 17:return e.prev=17,i.f(),e.finish(17);case 20:return e.abrupt("return",t);case 21:case"end":return e.stop()}}),e,this,[[2,14,17,20]])}))),function(){return p.apply(this,arguments)})},{key:"getRemoteVideoStats",value:(h=o(regeneratorRuntime.mark((function e(){var t,i,n,r,o,s,a,c=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=c.length>0&&void 0!==c[0]?c[0]:"main",i={},n=b(this.connections_),e.prev=3,n.s();case 5:if((r=n.n()).done){e.next=14;break}return(o=y(r.value,2))[0],s=o[1],e.next=9,this.stats_.getReceiverStats(s);case 9:a=e.sent,"main"===t&&a.hasVideo&&(i[a.userId]={bytesReceived:a.video.bytesReceived,packetsReceived:a.video.packetsReceived,packetsLost:a.video.packetsLost,framesDecoded:a.video.framesDecoded,frameWidth:a.video.frameWidth,frameHeight:a.video.frameHeight}),"auxiliary"===t&&a.hasAuxiliary&&(i[a.userId]={bytesReceived:a.auxiliary.bytesReceived,packetsReceived:a.auxiliary.packetsReceived,packetsLost:a.auxiliary.packetsLost,framesDecoded:a.auxiliary.framesDecoded,frameWidth:a.auxiliary.frameWidth,frameHeight:a.auxiliary.frameHeight});case 12:e.next=5;break;case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(3),n.e(e.t0);case 19:return e.prev=19,n.f(),e.finish(19);case 22:return e.abrupt("return",i);case 23:case"end":return e.stop()}}),e,this,[[3,16,19,22]])}))),function(){return h.apply(this,arguments)})},{key:"getSdpSemantics",value:function(){return this.sdpSemantics_}},{key:"getIceServers",value:function(){return 0===this.turnServers_.length&&this.schedule_.iceServers?this.schedule_.iceServers:this.turnServers_}},{key:"getConnections",value:function(){return this.connections_}},{key:"getMutedStates",value:function(){return this.mutedStates_}},{key:"startHeartbeat",value:function(){-1===this.heartbeat_&&(this.log_.info("startHeartbeat..."),this.heartbeat_=Id.setInterval(this.doHeartbeat.bind(this),2e3))}},{key:"stopHeartbeat",value:function(){-1!==this.heartbeat_&&(this.log_.info("stopHeartbeat"),Id.clearInterval(this.heartbeat_),this.heartbeat_=-1,this.lastHeartBeatTime_=-1)}},{key:"doHeartbeat",value:(l=o(regeneratorRuntime.mark((function e(){var t,i,n,r,o,s,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.badCaseDetector_.getMonitorFreeze(),e.next=3,this.stats_.getStatsReport({uplinkConnection:this.uplinkConnection_,downlinkConnections:this.connections_,freezeMap:t});case 3:if(i=e.sent,gf.emit(_f.HEARTBEAT_STATS,{client:this,stats:i}),this.badCaseDetector_.resetMonitor(),this.signalChannel_){e.next=8;break}return e.abrupt("return");case 8:n=this.signalChannel_.isConnected()?$h(this.userId_):[],r={WebRTCQualityReq:i,eventList:n,sdkAppId:this.sdkAppId_,tinyid:this.tinyId_,roomid:this.roomId_,socketid:this.signalInfo_.socketId,clientip:this.signalInfo_.localIp,serverip:this.signalInfo_.relayIp,cpunumber:navigator.hardwareConcurrency||0,cpudevice:navigator.platform,devicename:navigator.platform,ostype:navigator.platform,mode:this.localStream_?this.localStream_.getScreen()?"screen":"video":""},o=0,this.localStream_&&this.localStream_.getMediaStream()&&(s=this.localStream_.getMediaStream().getAudioTracks(),o=s.length>0&&s[0].muted?3:1),r.WebRTCQualityReq.AudioReportState.uint32_microphone_status=o,this.signalChannel_.send("on_quality_report",r),a=Date.now(),this.lastHeartBeatTime_>0&&a-this.lastHeartBeatTime_>1e4&&this.log_.warn("heartbeat interval is over 10s"),this.lastHeartBeatTime_=a;case 17:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"onRemoteStreamAdded",value:function(e){var t=e.content,i=t.srcopenid,n=t.srctinyid;if(null!==i){this.userMap_.has(i)||(this.userMap_.set(i,new tm({userId:i,tinyId:n,role:"anchor"})),this.emitter_.emit(rf,{userId:i}));var r=this.connections_.get(n);if(r){if(r.getIsReconnecting())return;this.log_.warn("duplicated stream-added observed, rebuild the connection"),r.close(),this.connections_.delete(n)}var o={audio:t.audio,video:t.bigVideo,auxiliary:t.auxVideo};this.log_.info("remote peer [".concat(i,"] published stream. trackState: ").concat(JSON.stringify(o))),this.createDownlinkConnection({userId:i,tinyId:n,trackState:o})}else this.log_.warn("received null userId on stream added")}},{key:"createDownlinkConnection",value:function(e){var t=e.userId,i=e.tinyId,n=e.trackState,r=new Kf({userId:t,tinyId:i,client:this,isUplink:!1,signalChannel:this.signalChannel_,autoSubscribe:this.autoSubscribe_,trackState:n});if(this.connections_.set(i,r),this.installDownlinkEvents(r,t,i),this.autoSubscribe_)r.initialize(),r.connect().catch((function(){}));else{if(n.audio||n.video){var o=new Gf({type:"main",userId:t,client:this});o.setConnection(r),r.setRemoteStream(gs,o),o.setIsStreamAddedEventEmitted(!0),gf.emit(_f.REMOTE_STREAM_ADDED,{client:this,stream:o}),this.emitter_.emit(nf,{stream:o})}if(n.auxiliary){var s=new Gf({type:"auxiliary",userId:t,client:this});s.setConnection(r),r.setRemoteStream(_s,s),s.setIsStreamAddedEventEmitted(!0),gf.emit(_f.REMOTE_STREAM_ADDED,{client:this,stream:s}),this.emitter_.emit(nf,{stream:s})}}}},{key:"installDownlinkEvents",value:function(e,t,i){var n=this;e.on(Yp,(function(e){e.stream.setIsStreamAddedEventEmitted(!0),gf.emit(_f.REMOTE_STREAM_ADDED,{client:n,stream:e.stream}),n.emitter_.emit(nf,{stream:e.stream})})),e.on(Qp,(function(e){e.stream.stop(),e.stream.setIsStreamAddedEventEmitted(!1),n.subscriptionManager_&&n.subscriptionManager_.deleteAutoRecoveryFlag(e.stream.getUserId(),e.stream.getType()),gf.emit(_f.REMOTE_STREAM_REMOVED,{client:n,stream:e.stream}),n.emitter_.emit("stream-removed",{stream:e.stream})})),e.on(Xp,(function(e){gf.emit(_f.REMOTE_STREAM_UPDATED,{client:n,stream:e.stream}),n.emitter_.emit("stream-updated",{stream:e.stream})})),e.on(Zp,(function(e){gf.emit(_f.REMOTE_STREAM_SUBSCRIBED,{client:n,stream:e.stream}),n.emitter_.emit("stream-subscribed",{stream:e.stream})})),e.on(ef,(function(e){var t=e.getCode();t!==ua.ICE_TRANSPORT_ERROR&&(t===ua.DOWNLINK_RECONNECTION_FAILED&&n.closeDownLink(i),n.emitter_.emit(lf,e))}))}},{key:"onRemoteStreamRemoved",value:function(e){var t=e.content,i=t.srctinyid,n=t.srcopenid,r=this.connections_.get(i);r&&(void 0===n&&(n=r.getUserId()),this.log_.info("remote peer [".concat(n,"] unpublished stream")),this.closeDownLink(i))}},{key:"onPeerJoin",value:function(e){var t=e.data.content,i=t.srctinyid,n=t.userid,r=t.role;this.userMap_.has(n)||(this.userMap_.set(n,new tm({userId:n,tinyId:i,role:r})),this.emitter_.emit(rf,{userId:n}))}},{key:"onPeerLeave",value:function(e){var t=e.data.content,i=t.srctinyid,n=t.userid;this.log_.info("peer leave [".concat(n,"]")),this.cleanUser({userId:n,tinyId:i})}},{key:"cleanUser",value:function(e){var t=e.userId,i=e.tinyId;this.userMap_.delete(t),this.closeDownLink(i),this.emitter_.emit("peer-leave",{userId:t})}},{key:"onPublishedUserList",value:function(e){var t=this;try{var i=e.content.userlist.map((function(e){return e.userid}));this.connections_.forEach((function(e){var n=e.getUserId(),r=e.getTinyId();i.findIndex((function(e){return e===n}))<0&&(t.log_.info("peer unpublished detected [".concat(n,"]")),t.closeDownLink(r))})),e.content.userlist.forEach((function(e){var i=e.userid,n=e.srctinyid,r=e.flag;if(i!==t.userId_){var o=!!(1&r),s=!!(8&r),a=!!(4&r);if(t.connections_.has(n)){var c=t.connections_.get(n).getTrackState(),u=c.audio,d=c.video,l=c.auxiliary;!d&&o&&gf.emit(_f.REMOTE_STREAM_TRACK_UPDATED,{client:t,tinyId:n,userId:i,action:ia,kind:ea}),!u&&s&&gf.emit(_f.REMOTE_STREAM_TRACK_UPDATED,{client:t,tinyId:n,userId:i,action:ia,kind:Zs}),!l&&a&&gf.emit(_f.REMOTE_STREAM_TRACK_UPDATED,{client:t,tinyId:n,userId:i,action:ia,kind:ta}),d&&!o&&gf.emit(_f.REMOTE_STREAM_TRACK_UPDATED,{client:t,tinyId:n,userId:i,action:na,kind:ea}),u&&!s&&gf.emit(_f.REMOTE_STREAM_TRACK_UPDATED,{client:t,tinyId:n,userId:i,action:na,kind:Zs}),l&&!a&&gf.emit(_f.REMOTE_STREAM_TRACK_UPDATED,{client:t,tinyId:n,userId:i,action:na,kind:ta})}else t.log_.info("peer published detected [".concat(i,"]")),t.onRemoteStreamAdded({content:{audio:s,auxVideo:a,bigVideo:o,srcopenid:i,srctinyid:n}})}}))}catch(e){}}},{key:"onUpdateRemoteMuteStat",value:function(e){var t=this;e.content.userlist.forEach((function(e){var i=e.srctinyid,n=e.userid;if(0!==i&&i!==t.tinyId_){var r=t.connections_.get(i);if(r){var o=r.getMainStream();if(o&&o.getIsStreamAddedEventEmitted()){var s=!!(1&e.flag),a=!!(8&e.flag),c=!!(2&e.flag),u=!!(64&e.flag),d=!!(16&e.flag),l=t.mutedStates_.get(i);if(void 0===l)return t.mutedStates_.set(i,{hasAudio:a,hasVideo:s,hasSmall:c,audioMuted:u,videoMuted:d}),s?d?t.emitter_.emit(sf,{userId:n}):t.emitter_.emit(cf,{userId:n}):t.emitter_.emit(sf,{userId:n}),void(a?u?t.emitter_.emit(of,{userId:n}):t.emitter_.emit(af,{userId:n}):t.emitter_.emit(of,{userId:n}));var h=!u&&a;(!l.audioMuted&&l.hasAudio)!==h&&(h?t.emitter_.emit(af,{userId:n}):t.emitter_.emit(of,{userId:n}));var p=!d&&s;(!l.videoMuted&&l.hasVideo)!==p&&(p?t.emitter_.emit(cf,{userId:n}):t.emitter_.emit(sf,{userId:n})),t.mutedStates_.set(i,{hasAudio:a,hasVideo:s,hasSmall:c,audioMuted:u,videoMuted:d})}}else t.mutedStates_.delete(i)}}))}},{key:"onClientBanned",value:function(e){this.emitter_.emit("client-banned",new da({code:ua.CLIENT_BANNED,message:pp({key:"CLIENT_BANNED",data:{reason:e}})}))}},{key:"getEnv",value:function(){return this.env_}},{key:"getSubscriptionManager",value:function(){return this.subscriptionManager_}},{key:"startPublishCDNStream",value:(d=o(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.localStream_){e.next=2;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_OPERATION_START_PUBLISH_CDN"})});case 2:if(Uc(t.streamId)||Vc(t.streamId)){e.next=4;break}throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_PARAMETER_START_PUBLISH_CDN"})});case 4:return this.log_.info("startPublishCDNStream params: ".concat(JSON.stringify(t))),e.prev=5,e.next=8,this.publishCDNManager_.startPublishTencentCDN(t.streamId);case 8:if(!(t.appId&&t.bizId&&t.url)){e.next=11;break}return e.next=11,this.publishCDNManager_.startPublishGivenCDN(t);case 11:e.next=16;break;case 13:throw e.prev=13,e.t0=e.catch(5),new da({code:ua.START_PUBLISH_CDN_FAILED,message:pp({key:"START_PUBLISH_CDN_FAILED",data:e.t0})});case 16:case"end":return e.stop()}}),e,this,[[5,13]])}))),function(e){return d.apply(this,arguments)})},{key:"stopPublishCDNStream",value:(u=o(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.publishCDNManager_.getIsPublishingTencentCDN()){e.next=2;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_OPERATION_STOP_PUBLISH_CDN"})});case 2:return this.log_.info("stopPublishCDNStream"),e.prev=3,e.next=6,this.publishCDNManager_.stopPublishTencentCDN();case 6:if(!this.publishCDNManager_.getIsPublishingGivenCDN()){e.next=9;break}return e.next=9,this.publishCDNManager_.stopPublishGivenCDN();case 9:e.next=14;break;case 11:throw e.prev=11,e.t0=e.catch(3),new da({code:ua.STOP_PUBLISH_CDN_FAILED,message:pp({key:"STOP_PUBLISH_CDN_FAILED",data:e.t0})});case 14:case"end":return e.stop()}}),e,this,[[3,11]])}))),function(){return u.apply(this,arguments)})},{key:"startMixTranscode",value:(a=o(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isJoined_&&this.mixTranscodeManager_){e.next=2;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:"START_MIX_TRANSCODE"})});case 2:return Uc(t.mode)&&(t.mode=qs),e.prev=3,this.log_.info("startMixTranscode with config ".concat(JSON.stringify(t))),Ic("mix-transcode-mode:".concat(t.mode)),e.next=8,this.mixTranscodeManager_.startMixTranscode(t);case 8:Cc({eventType:Fs}),e.next=15;break;case 11:throw e.prev=11,e.t0=e.catch(3),Ac({eventType:Fs,error:e.t0}),e.t0;case 15:case"end":return e.stop()}}),e,this,[[3,11]])}))),function(e){return a.apply(this,arguments)})},{key:"stopMixTranscode",value:(r=o(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isJoined_&&this.mixTranscodeManager_){e.next=2;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:"STOP_MIX_TRANSCODE"})});case 2:return e.prev=2,e.next=5,this.mixTranscodeManager_.stopMixTranscode();case 5:Cc({eventType:js}),e.next=12;break;case 8:throw e.prev=8,e.t0=e.catch(2),Ac({eventType:js,error:e.t0}),e.t0;case 12:case"end":return e.stop()}}),e,this,[[2,8]])}))),function(){return r.apply(this,arguments)})},{key:"getSystemResult",value:function(){return this.checkSystemResult_}},{key:"enableAudioVolumeEvaluation",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2e3,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!Fc(t))throw new da({code:ua.INVALID_PARAMETER,message:pp({key:sp})});if(this.log_.info("enableAudioVolumeEvaluation with interval: "+t),t<=0)return this.enableAudioVolumeEvaluation_=!1,Id.clearInterval(this.audioVolumeIntervalId_),void(this.audioVolumeIntervalId_=null);t=Math.floor(Math.max(t,16)),this.audioVolumeIntervalId_&&(Id.clearInterval(this.audioVolumeIntervalId_),this.audioVolumeIntervalId_=null),this.enableAudioVolumeEvaluation_=!0,this.audioVolumeIntervalId_=Id.setInterval((function(){var t=[];if(e.localStream_){var i=Math.floor(100*e.localStream_.getAudioLevel());t.push({userId:e.userId_,audioVolume:i,stream:e.localStream_})}e.connections_.forEach((function(e){var i=e.getSubscribedMainStream();if(i){var n=Math.floor(100*i.getAudioLevel());t.push({userId:e.getUserId(),audioVolume:n,stream:i})}})),e.emitter_.emit(df,{result:t})}),t,i)}},{key:"uploadAllCallStats",value:function(){var e=this;this.callDurationCalculator_.getDurationMap().forEach((function(t,i){var n={userId:t.userId,type:t.type,duration:e.callDurationCalculator_.getDuration(i,"video"),dataFreeze:e.badCaseDetector_.getDataFreezeDuration(i).dataFreeze,renderFreeze:e.badCaseDetector_.getRenderFreezeDuration(i).renderFreeze};Ic("callStats-"+JSON.stringify(n))})),this.badCaseDetector_.stop(),this.callDurationCalculator_.reset()}},{key:"enableSmallStream",value:(n=o(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isPublished()&&!this.isPublishing_){e.next=2;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:"ENABLE_SMALL_STREAM_PUBLISHED"})});case 2:if(!Kp()){e.next=7;break}this.setIsEnableSmallStream(!0),this.log_.info("SmallStream successfully enabled"),e.next=8;break;case 7:throw new da({code:ua.INVALID_OPERATION,message:pp({key:"NOT_SUPPORTED_SMALL_STREAM"})});case 8:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"disableSmallStream",value:(t=o(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isPublished()&&!this.isPublishing_){e.next=2;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:"DISABLE_SMALL_STREAM_PUBLISHED"})});case 2:this.setIsEnableSmallStream(!1),this.log_.info("SmallStream successfully disabled");case 4:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"setSmallStreamProfile",value:function(e){var t=this;Object.keys(this.smallStreamConfig_).forEach((function(i){e[i]&&(t.smallStreamConfig_[i]=e[i])})),this.log_.info("setSmallStreamProfile: bitrate=".concat(this.smallStreamConfig_.bitrate,", framerate=").concat(this.smallStreamConfig_.framerate,", height=").concat(this.smallStreamConfig_.height,", width=").concat(this.smallStreamConfig_.width));var i=this.smallStreamConfig_,n=i.width,r=i.height,o=i.bitrate,s=i.framerate;if(n<0||r<0||o<0||s<0)throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_SMALL_STREAM_PROFILE"})})}},{key:"setRemoteVideoStreamType",value:function(e,t){switch(this.log_.info("setRemoteVideoStreamType: streamType=".concat(e.getType(),", set ").concat(t)),t){case"big":case"small":this.changeVideoType(e,t)}}},{key:"changeVideoType",value:function(e,t){if(!(e instanceof Gf))throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_PARAMETER_REMOTE_STREAM"})});if(!e.getConnection())throw new da({code:ua.INVALID_OPERATION,message:pp({key:op})});var i=this.getRemoteMutedState().filter((function(t){return t.userId===e.getUserId()}))[0];if("small"===t&&i&&!i.hasSmall)throw new da({code:ua.INVALID_OPERATION,message:pp({key:"REMOTE_NOT_PUBLISH_SMALL_STREAM"})});this.log_.info("change video type: streamType=".concat(e.getType(),", set ").concat(t));var n=e.getConnection().getTinyId(),r=1;"big"===t&&(r=0),this.signalChannel_.send("on_change_video_type",{type:r,srctinyid:n})}},{key:"setIsEnableSmallStream",value:function(e){this.isEnableSmallStream_=e}},{key:"getIsEnableSmallStream",value:function(){return this.isEnableSmallStream_}},{key:"smallStreamConfig",get:function(){return this.smallStreamConfig_}},{key:"isPublished",value:function(){return!!this.localStream_}},{key:"getUplinkConnection",value:function(){return this.uplinkConnection_}},{key:"getLocalStream",value:function(){return this.localStream_}},{key:"getMode",value:function(){return this.mode_}},{key:"getBadCaseDetector",value:function(){return this.badCaseDetector_}},{key:"getCallDurationCalculator",value:function(){return this.callDurationCalculator_}},{key:"getAllConnections",value:function(){var e=S(this.connections_.values());return this.uplinkConnection_&&e.push(this.uplinkConnection_),e}},{key:"isRelayMaybeFailed",value:function(){var e=this.getAllConnections();if(0===e.length)return!1;for(var t=0;t<e.length;t++)if(e[t].getReconnectionCount()<6)return!1;return!0}},{key:"getUseStringRoomId",value:function(){return this.useStringRoomId_}},{key:"checkConnectionsToReconnect",value:function(){var e=this;this.getAllConnections().forEach((function(t){if(!t.getIsReconnecting()){var i=t.getPeerConnection();i&&"closed"===i.connectionState&&(e.log_.warn("[".concat(t.getUserId(),"] pc is closed but not reconnect")),t.startReconnection())}}))}}]),e}()).prototype,"join",[um,dm],Object.getOwnPropertyDescriptor(Sm.prototype,"join"),Sm.prototype),R(Sm.prototype,"leave",[lm],Object.getOwnPropertyDescriptor(Sm.prototype,"leave"),Sm.prototype),R(Sm.prototype,"publish",[hm,pm],Object.getOwnPropertyDescriptor(Sm.prototype,"publish"),Sm.prototype),R(Sm.prototype,"unpublish",[fm,mm],Object.getOwnPropertyDescriptor(Sm.prototype,"unpublish"),Sm.prototype),R(Sm.prototype,"subscribe",[vm],Object.getOwnPropertyDescriptor(Sm.prototype,"subscribe"),Sm.prototype),R(Sm.prototype,"unsubscribe",[gm],Object.getOwnPropertyDescriptor(Sm.prototype,"unsubscribe"),Sm.prototype),R(Sm.prototype,"switchRole",[_m,ym],Object.getOwnPropertyDescriptor(Sm.prototype,"switchRole"),Sm.prototype),Sm),Cm=im({retryFunction:function(){var e=o(regeneratorRuntime.mark((function e(t){var i,n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Bp()){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,Am(t);case 4:if(i=e.sent,Xu.info("getUserMedia with constraints: "+JSON.stringify(i)),!i.audio){e.next=13;break}return e.next=9,Wm.getMicrophones();case 9:if(n=e.sent,Xu.info("microphones: ".concat(JSON.stringify(n))),0!==n.length){e.next=13;break}throw new da({code:ua.DEVICE_NOT_FOUND,message:pp({key:"MICROPHONE_NOT_FOUND"})});case 13:if(!i.video){e.next=20;break}return e.next=16,Wm.getCameras();case 16:if(r=e.sent,Xu.info("cameras: ".concat(JSON.stringify(r))),0!==r.length){e.next=20;break}throw new da({code:ua.DEVICE_NOT_FOUND,message:pp({key:"CAMERA_NOT_FOUND"})});case 20:return e.next=22,navigator.mediaDevices.getUserMedia(i);case 22:return e.abrupt("return",e.sent);case 23:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),settings:{retries:3,timeout:500},onError:function(e,t,i){"NotReadableError"===e.name?t():i(e)},onRetrying:function(e){Xu.warn("getUserMedia NotReadableError observed, retrying [".concat(e,"/3]"))}});function Am(e){return Dm.apply(this,arguments)}function Dm(){return(Dm=o(regeneratorRuntime.mark((function e(t){var n,r,o,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n={echoCancellation:t.echoCancellation,autoGainControl:t.autoGainControl,noiseSuppression:t.noiseSuppression},t.audio){e.next=5;break}n=!1,e.next=15;break;case 5:if(Yh(t.microphoneId)){e.next=9;break}n=i({deviceId:{exact:t.microphoneId},sampleRate:t.sampleRate,channelCount:t.channelCount},n),e.next=15;break;case 9:return n=i({sampleRate:t.sampleRate,channelCount:t.channelCount},n),e.next=12,Wm.getMicrophones();case 12:r=e.sent,(o=r.filter((function(e){var t=e.deviceId;return t.length>0&&"default"!==t}))).length>0&&(n.deviceId={exact:o[0].deviceId});case 15:return s=!Uc(t.facingMode)&&t.video?{facingMode:t.facingMode,width:t.width,height:t.height,frameRate:t.frameRate}:!Yh(t.cameraId)&&t.video?{deviceId:{exact:t.cameraId},width:t.width,height:t.height,frameRate:t.frameRate}:!!t.video&&(!!Uc(t.width)||{width:t.width,height:t.height,frameRate:t.frameRate}),e.abrupt("return",{audio:n,video:s});case 18:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Om=function(){var e=o(regeneratorRuntime.mark((function e(t){var i,n,r,o,s,a,c,u,d;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Bp()){e.next=2;break}return e.abrupt("return");case 2:if(i=null,!(Hu&&Gu<74||Ju)){e.next=27;break}return n=xm(t),Xu.info("getDisplayMedia with constraints: "+JSON.stringify(n)),e.next=8,navigator.mediaDevices.getDisplayMedia(n);case 8:if(r=e.sent,!t.screenAudio){e.next=14;break}return Xu.warn("Your browser not support capture system audio"),e.abrupt("return",r);case 14:if(!t.audio){e.next=24;break}return o=Pm(t),Xu.info("getUserMedia with constraints: "+JSON.stringify(o)),e.next=19,navigator.mediaDevices.getUserMedia(o);case 19:return i=e.sent,r.addTrack(i.getAudioTracks()[0]),e.abrupt("return",r);case 24:return e.abrupt("return",r);case 25:e.next=53;break;case 27:if(!t.screenAudio){e.next=37;break}return t.audioConstraints={echoCancellation:!0,noiseSuppression:!0,sampleRate:44100},s=xm(t),Xu.info("getDisplayMedia with constraints: "+JSON.stringify(s)),e.next=33,navigator.mediaDevices.getDisplayMedia(s);case 33:return a=e.sent,e.abrupt("return",a);case 37:return c=xm(t),Xu.info("getDisplayMedia with constraints: "+JSON.stringify(c)),e.next=41,navigator.mediaDevices.getDisplayMedia(c);case 41:if(u=e.sent,!t.audio){e.next=52;break}return d=Pm(t),Xu.info("getUserMedia with constraints: "+JSON.stringify(d)),e.next=47,navigator.mediaDevices.getUserMedia(d);case 47:return i=e.sent,u.addTrack(i.getAudioTracks()[0]),e.abrupt("return",u);case 52:return e.abrupt("return",u);case 53:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();function Pm(e){var t={echoCancellation:e.echoCancellation,autoGainControl:e.autoGainControl,noiseSuppression:e.noiseSuppression,sampleRate:e.sampleRate,channelCount:e.channelCount};return Uc(e.microphoneId)||(t.deviceId={exact:e.microphoneId}),{audio:t,video:!1}}function xm(e){var t={},i={width:e.width,height:e.height,frameRate:e.frameRate};return Uc(e.screenSource)||(i.displaySurface=e.screenSource),t.video=i,Uc(e.audioConstraints)||(t.audio=e.audioConstraints),t}var Mm=new Map;Mm.set("120p",{width:160,height:120,frameRate:15,bitrate:200}),Mm.set("180p",{width:320,height:180,frameRate:15,bitrate:350}),Mm.set("240p",{width:320,height:240,frameRate:15,bitrate:400}),Mm.set("360p",{width:640,height:360,frameRate:15,bitrate:800}),Mm.set("480p",{width:640,height:480,frameRate:15,bitrate:900}),Mm.set("720p",{width:1280,height:720,frameRate:15,bitrate:1500}),Mm.set("1080p",{width:1920,height:1080,frameRate:15,bitrate:2e3}),Mm.set("1440p",{width:2560,height:1440,frameRate:30,bitrate:4860}),Mm.set("4K",{width:3840,height:2160,frameRate:30,bitrate:9e3});var Lm=new Map;Lm.set("480p",{width:640,height:480,frameRate:5,bitrate:900}),Lm.set("480p_2",{width:640,height:480,frameRate:30,bitrate:1e3}),Lm.set("720p",{width:1280,height:720,frameRate:5,bitrate:1200}),Lm.set("720p_2",{width:1280,height:720,frameRate:30,bitrate:3e3}),Lm.set("1080p",{width:1920,height:1080,frameRate:5,bitrate:1600}),Lm.set("1080p_2",{width:1920,height:1080,frameRate:30,bitrate:4e3});var Nm,Um,Vm=new Map;Vm.set("standard",{sampleRate:48e3,channelCount:1,bitrate:40}),Vm.set("standard-stereo",{sampleRate:48e3,channelCount:2,bitrate:64}),Vm.set("high",{sampleRate:48e3,channelCount:1,bitrate:192}),Vm.set("high-stereo",{sampleRate:48e3,channelCount:2,bitrate:192});var Fm,jm,Bm,Hm=(Nm=Ff.apply(void 0,S(Nf.LOCAL_STREAM.switchDevice)),R((Um=function(e){d(v,e);var t,r,a,u,h,p,f,m=g(v);function v(e){var t;s(this,v);var n=i(i({},e),{isRemote:!1,type:"local"});return e.screen&&(n.mirror=!1),(t=m.call(this,n)).name_=sa,t.video_=e.video,t.audio_=e.audio,t.cameraId_=e.cameraId,t.cameraGroupId_="",t.facingMode_=e.facingMode,t.microphoneId_=e.microphoneId,t.microphoneGroupId_="",t.videoSource_=e.videoSource,t.audioSource_=e.audioSource,t.screen_=e.screen,t.screenSource_=e.screenSource,t.screenAudio_=e.screenAudio,t.audioProfile_={echoCancellation:!!Uc(e.echoCancellation)||e.echoCancellation,autoGainControl:!!Uc(e.autoGainControl)||e.autoGainControl,noiseSuppression:!!Uc(e.noiseSuppression)||e.noiseSuppression,sampleRate:48e3,channelCount:1,bitrate:40},t.videoProfile_={width:640,height:480,frameRate:15,bitrate:900},t.screenProfile_={width:1920,height:1080,frameRate:5,bitrate:1600},t.videoBitrate_=t.screen_?1600:900,t.videoSetting_=null,t.mutedFlag_=0,t.beautyStatus_=!1,t.recoverCaptureCount_=0,t.initState(),t.installEvents(),t.log_.debug("stream created: "+t.id_),t}return c(v,[{key:"initState",value:function(){this.isAddingTrack_=!1,this.isRemovingTrack_=!1,this.setIsReadyToPublish(!1),this.setPublishState(-1)}},{key:"installEvents",value:function(){gf.on(_f.LOCAL_STREAM_PUBLISHED,this.onStreamPublished,this),gf.on(_f.VIDEO_TRACK_ENDED,this.onVideoTrackStopped,this),gf.on(_f.VIDEO_TRACK_MUTED,this.onVideoTrackStopped,this),gf.on(_f.AUDIO_TRACK_ENDED,this.onAudioTrackStopped,this),gf.on(_f.AUDIO_TRACK_MUTED,this.onAudioTrackStopped,this)}},{key:"uninstallEvents",value:function(){gf.off(_f.LOCAL_STREAM_PUBLISHED,this.onStreamPublished,this),gf.off(_f.VIDEO_TRACK_ENDED,this.onVideoTrackStopped,this),gf.off(_f.VIDEO_TRACK_MUTED,this.onVideoTrackStopped,this),gf.off(_f.AUDIO_TRACK_ENDED,this.onAudioTrackStopped,this),gf.off(_f.AUDIO_TRACK_MUTED,this.onAudioTrackStopped,this)}},{key:"initialize",value:function(){var e=this;return new Promise((function(t,i){if(Hp())i(new da({code:ua.INVALID_OPERATION,message:pp({key:"NOT_SUPPORTED_HTTP"})}));else{if(Uc(e.audio_)){var n=new MediaStream;return Uc(e.audioSource_)||(n.addTrack(e.audioSource_),e.updateAudioPlayingState(!0)),Uc(e.videoSource_)||(n.addTrack(e.videoSource_),e.updateVideoPlayingState(!0)),e.setMediaStream(n),Cc({eventType:Ms,kind:"custom"}),e.setIsReadyToPublish(!0),t()}e.screen_?(e.log_.info("initialize stream audio: "+e.audio_+" screenAudio: "+e.screenAudio_+" screen: "+e.screen_),Om({audio:e.audio_,screenAudio:e.screenAudio_,microphoneId:e.microphoneId_,screenSource:e.screenSource_,width:e.screenProfile_.width,height:e.screenProfile_.height,frameRate:e.screenProfile_.frameRate,sampleRate:e.audioProfile_.sampleRate,channelCount:e.audioProfile_.channelCount,autoGainControl:e.audioProfile_.autoGainControl,noiseSuppression:e.audioProfile_.noiseSuppression,echoCancellation:e.audioProfile_.echoCancellation}).then((function(i){return e.setMediaStream(i),e.updateAudioPlayingState(e.audio_||e.screenAudio_),e.updateVideoPlayingState(!0),e.listenForScreenSharingStopped(e.getVideoTrack()),e.setVideoContentHint("detail"),e.updateDeviceIdInUse(),e.setIsReadyToPublish(!0),Cc({eventType:Ms,kind:"getDisplayMedia"}),t()})).catch((function(t){Ac({eventType:Ms,kind:"getDisplayMedia",error:t}),e.log_.error("getDisplayMedia error observed "+t),i(t)}))):(gf.emit(_f.LOCAL_STREAM_INITIALIZE_START,{stream:e,audio:e.audio_,video:e.video_}),e.log_.info("initialize stream audio: "+e.audio_+" video: "+e.video_),Cm({audio:e.audio_,video:e.video_,facingMode:e.facingMode_,cameraId:e.cameraId_,microphoneId:e.microphoneId_,width:e.videoProfile_.width,height:e.videoProfile_.height,frameRate:e.videoProfile_.frameRate,sampleRate:e.audioProfile_.sampleRate,channelCount:e.audioProfile_.channelCount,autoGainControl:e.audioProfile_.autoGainControl,noiseSuppression:e.audioProfile_.noiseSuppression,echoCancellation:e.audioProfile_.echoCancellation}).then((function(i){return gf.emit(_f.LOCAL_STREAM_INITIALIZE_END,{stream:e,audio:e.audio_,video:e.video_}),"getSettings"in MediaStreamTrack.prototype&&(e.videoSetting_=i.getVideoTracks().length>0&&i.getVideoTracks()[0].getSettings()),e.setMediaStream(i),e.updateAudioPlayingState(e.audio_),e.updateVideoPlayingState(e.video_),e.updateDeviceIdInUse(),e.log_.debug("gotStream hasAudio: "+e.hasAudio()+" hasVideo: "+e.hasVideo()),e.setIsReadyToPublish(!0),Cc({eventType:Ms,kind:"getUserMedia"}),t()})).catch((function(t){gf.emit(_f.LOCAL_STREAM_INITIALIZE_FAILED,{stream:e,audio:e.audio_,video:e.video_,error:t}),Ac({eventType:Ms,kind:"getUserMedia",error:t}),e.log_.error("getUserMedia error observed "+t),i(t)})))}}))}},{key:"listenForScreenSharingStopped",value:function(e){var t=this;e.addEventListener("ended",(function(e){t.log_.info("screen sharing was stopped because the video track is ended"),t.emitter_.emit("screen-sharing-stopped")}))}},{key:"muteAudio",value:function(){var e=_(l(v.prototype),"muteAudio",this).call(this);return e&&(this.log_.info("localStream mute audio"),this.sendMutedFlag(Zs,!0)),e}},{key:"muteVideo",value:function(){var e=_(l(v.prototype),"muteVideo",this).call(this);return e&&(this.log_.info("localStream mute video"),this.sendMutedFlag(ea,!0)),e}},{key:"unmuteAudio",value:function(){var e=_(l(v.prototype),"unmuteAudio",this).call(this);return e&&(this.log_.info("localStream unmute audio"),this.sendMutedFlag(Zs,!1)),e}},{key:"unmuteVideo",value:function(){var e=_(l(v.prototype),"unmuteVideo",this).call(this);return e&&(this.log_.info("localStream unmute video"),this.sendMutedFlag(ea,!1)),e}},{key:"sendMutedFlag",value:function(e,t){this.setMutedFlag(e,t);var i=this.getConnection();if(i){i.sendMutedFlag(this.mutedFlag_);var n=i.getUserId(),r=i.getTinyId(),o="".concat(t?"mute":"unmute"," local ").concat(e," track");zh(n,{eventId:e===Zs?t?32772:32774:t?32773:32775,eventDesc:o,timestamp:Tc(),userId:n,tinyId:r})}}},{key:"setMutedFlag",value:function(e,t){e===Zs?t?this.mutedFlag_|=4:this.mutedFlag_&=-5:t?this.mutedFlag_|=1:this.mutedFlag_&=-2,this.log_.info("set ".concat(e," muted state: [").concat(t?"mute":"unmute","]"))}},{key:"setAudioProfile",value:function(e){var t;"object"===n(e)?t=e:void 0===(t=Vm.get(e))&&(t=Vm.get("standard")),this.log_.info("setAudioProfile: "+JSON.stringify(t)),this.audioProfile_=i(i({},this.audioProfile_),t)}},{key:"setVideoProfile",value:(f=o(regeneratorRuntime.mark((function e(t){var n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.connection_||jp()){e.next=2;break}throw new da({code:ua.NOT_SUPPORTED,message:pp({key:"NOT_SUPPORTED_PROFILE"})});case 2:if(Mc(t)?n=i(i({},this.videoProfile_),t):Vc(t)&&(n=Mm.get(t),Uc(n)&&(n=Mm.get("480p"))),this.log_.info("setVideoProfile "+JSON.stringify(n)),!(r=this.getVideoTrack())){e.next=8;break}return e.next=8,r.applyConstraints(n);case 8:if(this.videoBitrate_===n.bitrate){e.next=13;break}if(!this.connection_){e.next=12;break}return e.next=12,this.connection_.setBandwidth(n.bitrate,"video");case 12:this.videoBitrate_=n.bitrate;case 13:this.videoProfile_=n;case 14:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"getVideoBitrate",value:function(){return this.videoBitrate_}},{key:"getAudioBitrate",value:function(){return this.audioProfile_.bitrate}},{key:"setScreenProfile",value:function(e){var t=e;"object"!==n(e)&&void 0===(t=Lm.get(e))&&(t=Lm.get("1080p")),this.log_.info("setScreenProfile "+JSON.stringify(e)),this.screenProfile_=t,this.videoBitrate_=t.bitrate}},{key:"getVideoProfile",value:function(){return this.screen_?this.screenProfile_:this.videoProfile_}},{key:"getAudioProfile",value:function(){return this.audioProfile_}},{key:"setVideoContentHint",value:function(e){var t=this.getVideoTrack();t&&"contentHint"in t&&(this.log_.info("set video track contentHint to: "+e),t.contentHint=e,t.contentHint!==e&&this.log_.warn("Invalid video track contentHint: "+e))}},{key:"switchDevice",value:(p=o(regeneratorRuntime.mark((function e(t,i){var n,r,o,s,a,c,u,d,l,h,p,f,m,v,g,_;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!("audio"===t&&this.microphoneId_===i||"video"===t&&this.cameraId_===i)){e.next=2;break}return e.abrupt("return");case 2:if("audio"===t&&(this.microphoneId_=i,this.audio_||(this.audio_=!0)),"video"===t&&("user"===i||"environment"===i?this.facingMode_=i:this.cameraId_=i,this.video_||(this.video_=!0)),this.getMediaStream()){e.next=6;break}return e.abrupt("return");case 6:return this.setIsReadyToPublish(!1),this.log_.info("switchDevice "+t+" to: "+i),"video"===t&&(eu||Zc||tu)&&((n=this.getVideoTrack())&&n.stop(),xu&&(r=this.getAudioTrack())&&(this.log_.info("stop audio track first in huawei env"),r.stop())),"audio"===t&&tu&&(o=this.getAudioTrack(),s=this.getMicrophoneTrackMixed(),o&&o.stop(),s&&s.stop()),e.next=12,Cm({audio:this.audio_&&"audio"===t||xu,video:this.video_&&"video"===t,facingMode:"user"===i||"environment"===i?i:void 0,cameraId:this.cameraId_,microphoneId:this.microphoneId_,width:this.videoProfile_.width,height:this.videoProfile_.height,frameRate:this.videoProfile_.frameRate,sampleRate:this.audioProfile_.sampleRate,channelCount:this.audioProfile_.channelCount});case 12:if(a=e.sent,c=null,"audio"!==t){e.next=19;break}(u=a.getAudioTracks()[0])&&this.isAudioTrackMixed()?(d=this.getAudioTrack(),l=Wm.AudioMixerPlugin.getAudioTrackMap(),h=Wm.AudioMixerPlugin.mix({targetTrack:u,sourceList:l.get(d.id).sourceList,trackList:l.get(d.id).trackList}),c=h):c=u,e.next=25;break;case 19:if((c=a.getVideoTracks()[0])&&this.isVideoTrackBeautified()&&(c=this.generateBeautyTrack(c)),!(p=a.getAudioTracks()[0])||!xu){e.next=25;break}return e.next=25,this.replaceTrack_(p);case 25:return e.next=27,this.replaceTrack_(c);case 27:this.updateDeviceIdInUse(),(f=this.getConnection())&&(m=f.getUserId(),v=f.getTinyId(),g=32780,_="switch camera","audio"===t&&(g=32781,_="switch microphone"),zh(m,{eventId:g,eventDesc:_,timestamp:Tc(),userId:m,tinyId:v})),this.log_.info("switch ".concat("audio"===t?"microphone":"camera"," success ")),this.setIsReadyToPublish(!0);case 32:case"end":return e.stop()}}),e,this)}))),function(e,t){return p.apply(this,arguments)})},{key:"addTrack",value:(h=o(regeneratorRuntime.mark((function e(t){var i,n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isAddingTrack_){e.next=2;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_ADD_TRACK_REPETITIVE"})});case 2:if(!this.isRemovingTrack_){e.next=4;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_ADD_TRACK_REMOVING"})});case 4:if(0!==this.publishState_){e.next=6;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_ADD_TRACK_PUBLISHING"})});case 6:if(i=this.getMediaStream()){e.next=9;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:cp})});case 9:if(!("audio"===t.kind&&i.getAudioTracks().length>0||"video"===t.kind&&i.getVideoTracks().length>0)){e.next=11;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_ADD_TRACK_NUMBER"})});case 11:if("video"===t.kind&&"getSettings"in MediaStreamTrack.prototype&&(n=t.getSettings(),!this.videoSetting_||n.width===this.videoSetting_.width&&n.height===this.videoSetting_.height||this.log_.warn("video resolution of the track (".concat(n.width," x ").concat(n.height,") shall be kept the same as the previous: ").concat(this.videoSetting_.width," x ").concat(this.videoSetting_.height,". It may cause abnormal Cloud Recording."))),e.prev=12,this.isAddingTrack_=!0,this.keepMuteState(t),!(r=this.getConnection())){e.next=19;break}return e.next=19,r.addTrack(t);case 19:i.addTrack(t),"audio"===t.kind?(this.audio_=!0,this.updateAudioPlayingState(!0)):(this.video_=!0,this.updateVideoPlayingState(!0)),this.isAddingTrack_=!1,e.next=28;break;case 24:throw e.prev=24,e.t0=e.catch(12),this.isAddingTrack_=!1,e.t0;case 28:case"end":return e.stop()}}),e,this,[[12,24]])}))),function(e){return h.apply(this,arguments)})},{key:"removeTrack",value:(u=o(regeneratorRuntime.mark((function e(t){var i,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("audio"!==t.kind){e.next=2;break}throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_REMOVE_AUDIO_TRACK"})});case 2:if(!this.isAddingTrack_){e.next=4;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_REMOVE_AUDIO_ADDING"})});case 4:if(!this.isRemovingTrack_){e.next=6;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_REMOVE_AUDIO_ON"})});case 6:if(0!==this.publishState_){e.next=8;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_REMOVE_TRACK_PUBLISHING"})});case 8:if(i=this.getMediaStream()){e.next=11;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:cp})});case 11:if(-1!==i.getTracks().indexOf(t)){e.next=13;break}throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_REMOVE_TRACK_NOT_PUBLISHING"})});case 13:if(1!==i.getTracks().length){e.next=15;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_REMOVE_TRACK_NUMBER"})});case 15:if(e.prev=15,this.isRemovingTrack_=!0,!(n=this.getConnection())){e.next=21;break}return e.next=21,n.removeTrack(t);case 21:i.removeTrack(t),"audio"===t.kind?(this.audio_=!1,this.updateAudioPlayingState(!1)):(this.video_=!1,this.updateVideoPlayingState(!1)),this.isRemovingTrack_=!1,e.next=30;break;case 26:throw e.prev=26,e.t0=e.catch(15),this.isRemovingTrack_=!1,e.t0;case 30:case"end":return e.stop()}}),e,this,[[15,26]])}))),function(e){return u.apply(this,arguments)})},{key:"replaceTrack",value:(a=o(regeneratorRuntime.mark((function e(t){var i,n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.getMediaStream()){e.next=3;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:"INVALID_INITIALIZE_LOCAL_STREAM"})});case 3:if(0!==this.publishState_){e.next=5;break}throw new da({code:ua.INVALID_OPERATION,message:pp({key:ap})});case 5:if(!("audio"===t.kind&&i.getAudioTracks().length<=0||"video"===t.kind&&i.getVideoTracks().length<=0)){e.next=7;break}throw new da({code:ua.INVALID_PARAMETER,message:pp({key:"INVALID_REMOVE_TRACK_NOT_PUBLISHED",data:t})});case 7:if("video"===t.kind&&"getSettings"in MediaStreamTrack.prototype&&(n=t.getSettings(),!this.videoSetting_||n.width===this.videoSetting_.width&&n.height===this.videoSetting_.height||this.log_.warn("video resolution of the track (".concat(n.width," x ").concat(n.height,") shall be kept the same as the previous: ").concat(this.videoSetting_.width," x ").concat(this.videoSetting_.height,". It may cause abnormal Cloud Recording."))),this.keepMuteState(t),"audio"===t.kind?(i.removeTrack(i.getAudioTracks()[0]),i.addTrack(t),_(l(v.prototype),"restartAudio",this).call(this)):(i.removeTrack(i.getVideoTracks()[0]),i.addTrack(t),_(l(v.prototype),"restartVideo",this).call(this)),!(r=this.getConnection())){e.next=14;break}return e.next=14,r.replaceTrack(t);case 14:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"updateStream",value:(r=o(regeneratorRuntime.mark((function e(t){var i,n,r,o,s,a,c,u,d,l,h,p,f,m,v;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.mediaStream_){e.next=2;break}return e.abrupt("return");case 2:return this.log_.info("updateStream() try to recover local stream"),e.prev=3,e.next=6,Wm.getCameras();case 6:return i=e.sent,e.next=9,Wm.getMicrophones();case 9:if(n=e.sent,r=this.audio_&&t.audio,(o=this.video_&&t.video)&&0===i.length&&(o=!1,this.log_.info("updateStream() video flag is true, but no camera detected, set video to false")),r&&0===n.length&&(r=!1,this.log_.info("updateStream() audio flag is true, but no microphone detected, set audio to false")),!1!==r||!1!==o){e.next=17;break}return this.log_.info("updateStream() both audio and video are false, recover stream aborted"),e.abrupt("return");case 17:return s=t&&i.findIndex((function(e){return e.deviceId===t.cameraId}))>=0,a=t&&n.findIndex((function(e){return e.deviceId===t.microphoneId}))>=0,e.next=21,Cm({audio:r,video:o,cameraId:s?t.cameraId:void 0,microphoneId:a?t.microphoneId:void 0,facingMode:this.facingMode_,width:this.videoProfile_.width,height:this.videoProfile_.height,frameRate:this.videoProfile_.frameRate,sampleRate:this.audioProfile_.sampleRate,channelCount:this.audioProfile_.channelCount});case 21:c=e.sent,u=c.getTracks(),d=0;case 24:if(!(d<u.length)){e.next=47;break}if("audio"!==(l=u[d]).kind||!this.isAudioTrackMixed()){e.next=37;break}if(h=this.getAudioTrack(),p=Wm.AudioMixerPlugin.getAudioTrackMap(),(f=p.get(h.id)).hasMicrophone){e.next=33;break}return l.stop(),e.abrupt("continue",44);case 33:return m=Wm.AudioMixerPlugin.mix({targetTrack:l,sourceList:f.sourceList,trackList:f.trackList}),e.next=36,this.replaceTrack_(m);case 36:return e.abrupt("continue",44);case 37:if("video"!==l.kind||!this.isVideoTrackBeautified()){e.next=42;break}return v=this.generateBeautyTrack(l),e.next=41,this.replaceTrack_(v);case 41:return e.abrupt("continue",44);case 42:return e.next=44,this.replaceTrack_(l);case 44:d++,e.next=24;break;case 47:this.updateDeviceIdInUse(),Cc({eventType:Us}),this.log_.info("updateStream() recover local stream successfully"),e.next=57;break;case 52:e.prev=52,e.t0=e.catch(3),Ac({eventType:Us,error:e.t0}),this.log_.error("updateStream() failed to recover local stream, "+e.t0),this.emitter_.emit(pf,new da({code:ua.DEVICE_AUTO_RECOVER_FAILED,message:e.t0.message}));case 57:case"end":return e.stop()}}),e,this,[[3,52]])}))),function(e){return r.apply(this,arguments)})},{key:"replaceTrack_",value:(t=o(regeneratorRuntime.mark((function e(t){var i,n,r,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.mediaStream_.getAudioTracks(),n=this.mediaStream_.getVideoTracks(),!("audio"===t.kind&&i.length<=0||"video"===t.kind&&n.length<=0)){e.next=5;break}return this.log_.info("there is no previous ".concat(t.kind," track, replacement ignored")),e.abrupt("return");case 5:if(this.keepMuteState(t),"audio"===t.kind?(this.mediaStream_.removeTrack(i[0]),this.mediaStream_.addTrack(t),_(l(v.prototype),"restartAudio",this).call(this)):("getSettings"in MediaStreamTrack.prototype&&(r=t.getSettings(),!this.videoSetting_||r.width===this.videoSetting_.width&&r.height===this.videoSetting_.height||this.log_.warn("the resolution of video track to be replaced (".concat(r.width," x ").concat(r.height,") is different from the previous video settings (").concat(this.videoSetting_.width," x ").concat(this.videoSetting_.height,"). It may cause a cloud recording exception"))),this.mediaStream_.removeTrack(n[0]),this.mediaStream_.addTrack(t),_(l(v.prototype),"restartVideo",this).call(this)),!(o=this.getConnection())){e.next=11;break}return e.next=11,o.replaceTrack(t);case 11:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"updateDeviceIdInUse",value:function(){var e=this;if(!this.mediaStream_)return this.cameraId_="",this.cameraGroupId_="",this.microphoneId_="",void(this.microphoneGroupId_="");"getSettings"in MediaStreamTrack.prototype&&this.mediaStream_.getTracks().forEach((function(t){if("audio"===t.kind&&e.isAudioTrackMixed()){var i=e.getMicrophoneTrackMixed();if(i){var n=i.getSettings(),r=n.deviceId,o=n.groupId;r&&(e.microphoneId_=r,e.microphoneGroupId_=o)}}else if("video"===t.kind&&e.isVideoTrackBeautified()){var s=e.getBeautyOriginTrack();if(s){var a=s.getSettings(),c=a.deviceId,u=a.groupId;c&&(e.cameraId_=c,e.cameraGroupId_=u)}}else{var d=t.getSettings(),l=d.deviceId,h=d.groupId;l&&("audio"===t.kind?(e.microphoneId_=l,e.microphoneGroupId_=h):"video"!==t.kind||e.screen_||(e.cameraId_=l,e.cameraGroupId_=h))}}));var t=this.mediaStream_.getAudioTracks(),i=this.mediaStream_.getVideoTracks();t&&0===t.length&&(this.microphoneId_="",this.microphoneGroupId_=""),i&&0===i.length&&(this.cameraId_="",this.cameraGroupId_="")}},{key:"isAudioTrackMixed",value:function(){if(Wm.AudioMixerPlugin){var e=Wm.AudioMixerPlugin.getAudioTrackMap(),t=this.getAudioTrack();if(e&&t&&e.has(t.id))return!0}return!1}},{key:"getMicrophoneTrackMixed",value:function(){if(Wm.AudioMixerPlugin){var e=Wm.AudioMixerPlugin.getAudioTrackMap(),t=this.getAudioTrack();if(e&&t&&e.has(t.id)){var i=e.get(t.id);return i.hasMicrophone?i.microphoneTrack:null}}return null}},{key:"isVideoTrackBeautified",value:function(){if(Wm.beautyTrackMap){var e=Wm.beautyTrackMap,t=this.getVideoTrack();if(t&&e.has(t.id))return!0}return!1}},{key:"getBeautyOriginTrack",value:function(){if(Wm.beautyTrackMap){var e=Wm.beautyTrackMap,t=this.getVideoTrack();if(t&&e.has(t.id)){var i=e.get(t.id);if(i.originTrack)return i.originTrack}}return null}},{key:"generateBeautyTrack",value:function(e){var t=this.getVideoTrack(),i=Wm.beautyTrackMap.get(t.id).pluginInstance.generateBeautyTrack(e);return this.log_.info("regenerate beauty track, track id = ".concat(e.id)),i}},{key:"getScreen",value:function(){return this.screen_}},{key:"hasScreenTrack",value:function(){if(this.screen_)return!0;var e=this.getVideoTrack();return!!e&&("detail"===e.contentHint||"text"===e.contentHint)}},{key:"getVideo",value:function(){return this.video_}},{key:"getAudio",value:function(){return this.audio_}},{key:"getCameraId",value:function(){return this.cameraId_}},{key:"getMicrophoneId",value:function(){return this.microphoneId_}},{key:"getMicrophoneGroupId",value:function(){return this.microphoneGroupId_}},{key:"getIsReadyToPublish",value:function(){return this.isReadyToPublish_}},{key:"setIsReadyToPublish",value:function(e){this.isReadyToPublish_=e}},{key:"setPublishState",value:function(e){this.publishState_=e}},{key:"setBeautyStatus",value:function(e){this.beautyStatus_=!!e}},{key:"getBeautyStatus",value:function(){return this.beautyStatus_}},{key:"onStreamPublished",value:function(e){if(e.localStream===this){var t=this.getAudioTrack(),i=this.getVideoTrack();if(t){var n=!t.enabled;this.setMutedFlag(Zs,n)}if(i){var r=!i.enabled;this.setMutedFlag(ea,r)}this.connection_&&this.connection_.sendMutedFlag(this.mutedFlag_)}}},{key:"keepMuteState",value:function(e){e instanceof MediaStreamTrack&&this.mutedFlag_&(e.kind===ea?1:4)&&(e.enabled=!1,this.log_.warn("prev ".concat(e.kind," track is muted, keep mute state")))}},{key:"onVideoTrackStopped",value:function(e){var t=e.stream,i=e.type;t!==this||!this.video_||!this.cameraId_||this.recoverCaptureCount_>10||(this.recoverCaptureCount_+=1,Ic("stat-local-video-".concat(i)),this.updateStream({audio:!1,video:!0,cameraId:this.cameraId_}))}},{key:"onAudioTrackStopped",value:function(e){var t=e.stream,i=e.type;t!==this||!this.audio_||!this.microphoneId_||this.recoverCaptureCount_>10||(this.recoverCaptureCount_+=1,Ic("stat-local-audio-".concat(i)),this.updateStream({audio:!0,video:!1,microphoneId:this.microphoneId_}))}},{key:"setAudioVolume",value:function(e){_(l(v.prototype),"setAudioVolume",this).call(this,e)}},{key:"close",value:function(){_(l(v.prototype),"close",this).call(this),this.uninstallEvents()}}]),v}(Hf)).prototype,"switchDevice",[Nm],Object.getOwnPropertyDescriptor(Um.prototype,"switchDevice"),Um.prototype),Um),Gm=0,qm=0,Jm=(Fm=Vf(Nf.TRTC.createClient),jm=Vf(Nf.TRTC.createStream),R((Bm=function(){function e(){s(this,e),this.name_="TRTC",this.VERSION="4.11.7",this.Logger={LogLevel:{TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,NONE:5},setLogLevel:function(e){Xu.setLogLevel(e),"zh"===(navigator.language||navigator.userLanguage).substr(0,2)&&e<=1&&function(){if(!Ku())return!1;var e=localStorage.getItem("trtc_error_assistance");e&&!function(e){var t=(new Date).getTime()-e.saveTime>=6048e5;return e.saveTime&&t}(JSON.parse(e))||(Xu.log("request error info"),function(){var e=new XMLHttpRequest;if(e.open("GET","https://web.sdk.qcloud.com/trtc/webrtc/download/trtc-error-assistance.js",!1),e.send(null),4===e.readyState&&200===e.status){var t=document.createElement("script");t.type="text/javascript",t.text=e.responseText,document.body.appendChild(t),localStorage.setItem("trtc_error_assistance",JSON.stringify({message:e.responseText,saveTime:(new Date).getTime()})),document.body.removeChild(t)}}())}()},enableUploadLog:function(){Xu.enableUploadLog()},disableUploadLog:function(){Xu.disableUploadLog()}}}var t,n,r,a,u;return c(e,[{key:"checkSystemRequirements",value:(u=o(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Np();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))),function(){return u.apply(this,arguments)})},{key:"isScreenShareSupported",value:function(){return Up()}},{key:"isSmallStreamSupported",value:function(){return Kp()}},{key:"getDevices",value:(a=o(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Hp()&&!Bp()){e.next=2;break}return e.abrupt("return",[]);case 2:return e.next=4,navigator.mediaDevices.enumerateDevices();case 4:return t=e.sent,e.abrupt("return",t.map((function(e,t){var i=e.label;e.label||(i=e.kind+"_"+t);var n={label:i,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(n.groupId=e.groupId),n})));case 6:case"end":return e.stop()}}),e)}))),function(){return a.apply(this,arguments)})},{key:"getCameras",value:(r=o(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Hp()&&!Bp()){e.next=2;break}return e.abrupt("return",[]);case 2:return e.next=4,navigator.mediaDevices.enumerateDevices();case 4:return t=e.sent,e.abrupt("return",t.filter((function(e){return"videoinput"===e.kind})).map((function(e,t){var i=e.label;e.label||(i="camera_"+t);var n={label:i,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(n.groupId=e.groupId),n})));case 6:case"end":return e.stop()}}),e)}))),function(){return r.apply(this,arguments)})},{key:"getMicrophones",value:(n=o(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Hp()&&!Bp()){e.next=2;break}return e.abrupt("return",[]);case 2:return e.next=4,navigator.mediaDevices.enumerateDevices();case 4:return t=e.sent,e.abrupt("return",t.filter((function(e){return"audioinput"===e.kind})).map((function(e,t){var i=e.label;e.label||(i="microphone_"+t);var n={label:i,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(n.groupId=e.groupId),n})));case 6:case"end":return e.stop()}}),e)}))),function(){return n.apply(this,arguments)})},{key:"getSpeakers",value:(t=o(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Hp()&&!Bp()){e.next=2;break}return e.abrupt("return",[]);case 2:return e.next=4,navigator.mediaDevices.enumerateDevices();case 4:return t=e.sent,e.abrupt("return",t.filter((function(e){return"audiooutput"===e.kind})).map((function(e,t){var i=e.label;e.label||(i="speaker_"+t);var n={label:i,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(n.groupId=e.groupId),n})));case 6:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})},{key:"createClient",value:function(e){Hd&&(Hd=!1,Xu.getLogLevel()!=Wm.Logger.LogLevel.NONE&&(console.info("******************************************************************************"),console.info("*   欢迎使用 TRTC Web SDK - 腾讯云实时音视频通信"),console.info("*   API 文档：https://web.sdk.qcloud.com/trtc/webrtc/doc/zh-cn/index.html"),console.info("*   版本更新日志：https://cloud.tencent.com/document/product/647/38958"),console.info("*   反馈问题：https://github.com/tencentyun/TRTCSDK/issues"),console.info("******************************************************************************")),Xu.info("TRTC Web SDK Version: 4.11.7"),Xu.info("UserAgent: "+navigator.userAgent),Xu.info("URL of current page: "+location.href));var t={version:this.VERSION};return new wm(i(i(i({},t),e),{},{seq:++Gm}))}},{key:"createStream",value:function(e){return new Hm(i(i({},e),{},{seq:++qm}))}}]),e}()).prototype,"createClient",[Fm],Object.getOwnPropertyDescriptor(Bm.prototype,"createClient"),Bm.prototype),R(Bm.prototype,"createStream",[jm],Object.getOwnPropertyDescriptor(Bm.prototype,"createStream"),Bm.prototype),Bm);Hp();var Wm=new Jm;return Wm}()}).call(this,i(8))},function(e,t,i){"use strict";(function(e){var n=i(9),r=i(2);let o;typeof e===r.i&&Object(n.a)(e)&&(o=e),o=typeof MessageChannel===r.i&&Object(n.a)(MessageChannel)?function(e){const t=new MessageChannel;t.port1.onmessage=e,t.port2.postMessage(1)}:setTimeout,t.a=o}).call(this,i(14).setImmediate)},function(e,t,i){var n=i(27),r=i(28);t.write=r,t.parse=n.parse,t.parseParams=n.parseParams,t.parseFmtpConfig=n.parseFmtpConfig,t.parsePayloads=n.parsePayloads,t.parseRemoteCandidates=n.parseRemoteCandidates,t.parseImageAttributes=n.parseImageAttributes,t.parseSimulcastStreamList=n.parseSimulcastStreamList},function(e,t){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(e){"object"==typeof window&&(i=window)}e.exports=i},function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var n=i(0),r=i(3),o=i(4);function s(e){return n.d(e)&&o.a(Object(r.a)(e),"[native code]")}},function(e,t){var i=e.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w\/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%d trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:([\w_\/]*) (\S*)(?: (\S*))?/,names:["value","uri","config"],format:function(e){return null!=e.config?"extmap:%s %s %s":"extmap:%s %s"}},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_]*):(.*)/,names:["id","attribute","value"],format:"ssrc:%d %s:%s"},{push:"ssrcGroups",reg:/^ssrc-group:(\w*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{push:"invalid",names:["value"]}]};Object.keys(i).forEach((function(e){i[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))},function(e,t){var i=e.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(i).forEach((function(e){i[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))},function(e,t,i){"use strict";var n=i(18);e.exports=function(e){var t,r={stun:(e||{}).stun||i(19),turn:(e||{}).turn||i(20)},o=(e||{}).stunCount||2,s=(e||{}).turnCount||0;function a(e,t){for(var i,o=[],s=[].concat(r[e]);s.length&&o.length<t;)i=Math.random()*s.length|0,o=o.concat(s.splice(i,1));return o.map((function(t){return"string"==typeof t||t instanceof String?n(e+":"+t):t}))}return t=[].concat(a("stun",o)),s&&(t=t.concat(a("turn",s))),t}},function(e,t,i){t.Interop=i(21)},function(e,t,i){(function(e){var n=void 0!==e&&e||"undefined"!=typeof self&&self||window,r=Function.prototype.apply;function o(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new o(r.call(setTimeout,n,arguments),clearTimeout)},t.setInterval=function(){return new o(r.call(setInterval,n,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},o.prototype.unref=o.prototype.ref=function(){},o.prototype.close=function(){this._clearFn.call(n,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout((function(){e._onTimeout&&e._onTimeout()}),t))},i(15),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(this,i(8))},function(e,t,i){(function(e,t){!function(e,i){"use strict";if(!e.setImmediate){var n,r,o,s,a,c=1,u={},d=!1,l=e.document,h=Object.getPrototypeOf&&Object.getPrototypeOf(e);h=h&&h.setTimeout?h:e,"[object process]"==={}.toString.call(e.process)?n=function(e){t.nextTick((function(){f(e)}))}:!function(){if(e.postMessage&&!e.importScripts){var t=!0,i=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=i,t}}()?e.MessageChannel?((o=new MessageChannel).port1.onmessage=function(e){f(e.data)},n=function(e){o.port2.postMessage(e)}):l&&"onreadystatechange"in l.createElement("script")?(r=l.documentElement,n=function(e){var t=l.createElement("script");t.onreadystatechange=function(){f(e),t.onreadystatechange=null,r.removeChild(t),t=null},r.appendChild(t)}):n=function(e){setTimeout(f,0,e)}:(s="setImmediate$"+Math.random()+"$",a=function(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(s)&&f(+t.data.slice(s.length))},e.addEventListener?e.addEventListener("message",a,!1):e.attachEvent("onmessage",a),n=function(t){e.postMessage(s+t,"*")}),h.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),i=0;i<t.length;i++)t[i]=arguments[i+1];var r={callback:e,args:t};return u[c]=r,n(c),c++},h.clearImmediate=p}function p(e){delete u[e]}function f(e){if(d)setTimeout(f,0,e);else{var t=u[e];if(t){d=!0;try{!function(e){var t=e.callback,i=e.args;switch(i.length){case 0:t();break;case 1:t(i[0]);break;case 2:t(i[0],i[1]);break;case 3:t(i[0],i[1],i[2]);break;default:t.apply(void 0,i)}}(t)}finally{p(e),d=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,i(8),i(16))},function(e,t){var i,n,r=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function a(e){if(i===setTimeout)return setTimeout(e,0);if((i===o||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:o}catch(e){i=o}try{n="function"==typeof clearTimeout?clearTimeout:s}catch(e){n=s}}();var c,u=[],d=!1,l=-1;function h(){d&&c&&(d=!1,c.length?u=c.concat(u):l=-1,u.length&&p())}function p(){if(!d){var e=a(h);d=!0;for(var t=u.length;t;){for(c=u,u=[];++l<t;)c&&c[l].run();l=-1,t=u.length}c=null,d=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===s||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function m(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];u.push(new f(e,t)),1!==u.length||d||a(p)},f.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=m,r.addListener=m,r.once=m,r.off=m,r.removeListener=m,r.removeAllListeners=m,r.emit=m,r.prependListener=m,r.prependOnceListener=m,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(e,t){class i extends AudioWorkletProcessor{constructor(){super(),this.audioLevel=0}static get parameterDescriptors(){return[{name:"averaging",defaultValue:.95},{name:"output",defaultValue:1}]}process(e,t,i){let n,r;n=i.averaging.length?i.averaging[0]:i.averaging,r=i.output.length?i.output[0]:i.output;const o=e[0],s=t[0],a=o[0];if(!a)return!0;const c=a.length;let u,d=0;for(let e=0;e<c;e++)u=a[e],d+=u*u;const l=Math.sqrt(d/c);if(this.audioLevel=Math.max(l,this.audioLevel*n),r)for(let e=0;e<o.length;e++){const t=o[e],i=s[e];for(let e=0;e<t.length;e++)i[e]=t[e]}return this.port.postMessage(this.audioLevel),!0}}registerProcessor("meter-processor",i)},function(e,t){var i=["stun:","turn:"];e.exports=function(e){var t,n,r=(e||{}).url||e,o={};return"string"==typeof r||r instanceof String?(r=r.trim(),(t=i[i.indexOf(r.slice(0,5))])?(n=(r=r.slice(5)).split("@"),o.username=e.username,o.credential=e.credential,n.length>1&&(r=n[1],n=n[0].split(":"),o.username=n[0],o.credential=(e||{}).credential||n[1]||""),o.url=t+r,o.urls=[o.url],o):e):e}},function(e){e.exports=JSON.parse('["stun.l.google.com:19302","stun1.l.google.com:19302","stun2.l.google.com:19302","stun3.l.google.com:19302","stun4.l.google.com:19302","stun.ekiga.net","stun.ideasip.com","stun.schlund.de","stun.stunprotocol.org:3478","stun.voiparound.com","stun.voipbuster.com","stun.voipstunt.com","stun.voxgratia.org"]')},function(e){e.exports=JSON.parse("[]")},function(e,t,i){"use strict";var n=i(22),r=i(26);function o(){this.cache={mlB2UMap:{},mlU2BMap:{}}}e.exports=o,o.prototype.candidateToUnifiedPlan=function(e){var t=new RTCIceCandidate(e);return t.sdpMLineIndex=this.cache.mlB2UMap[t.sdpMLineIndex],t},o.prototype.candidateToPlanB=function(e){var t=new RTCIceCandidate(e);if(0===t.sdpMid.indexOf("audio"))t.sdpMid="audio";else{if(0!==t.sdpMid.indexOf("video"))throw new Error("candidate with "+t.sdpMid+" not allowed");t.sdpMid="video"}return t.sdpMLineIndex=this.cache.mlU2BMap[t.sdpMLineIndex],t},o.prototype.getFirstSendingIndexFromAnswer=function(e){if(!this.cache.answer)return null;var t=n.parse(this.cache.answer);if(t&&t.media&&Array.isArray(t.media))for(var i=0;i<t.media.length;i++)if(t.media[i].type==e&&(!t.media[i].direction||"sendrecv"===t.media[i].direction||"sendonly"===t.media[i].direction))return i;return null},o.prototype.toPlanB=function(e){var t=this;if("object"!=typeof e||null===e||"string"!=typeof e.sdp)return console.warn("An empty description was passed as an argument."),e;var i=n.parse(e.sdp);if(void 0===i.media||!Array.isArray(i.media)||0===i.media.length)return console.warn("The description has no media."),e;if(i.media.length<=3&&i.media.every((function(e){return-1!==["video","audio","data"].indexOf(e.mid)})))return console.warn("This description does not look like Unified Plan."),e;for(var r=e.sdp,o=!1,s=0;s<i.media.length;s++){i.media[s].rtp.forEach((function(e){if("NULL"===e.codec){o=!0;var i=n.parse(t.cache.offer);e.codec=i.media[s].rtp[0].codec}}))}o&&(r=n.write(i)),this.cache[e.type]=r;var a=i.media;i.media=[];var c={},u=[];a.forEach((function(e){if(("string"!=typeof e.rtcpMux||"rtcp-mux"!==e.rtcpMux)&&"inactive"!==e.direction)throw new Error("Cannot convert to Plan B because m-lines without the rtcp-mux attribute were found.");if(void 0!==c[e.type]&&"inactive"!==c[e.type].direction||(c[e.type]=e),e.protocol!=c[e.type].protocol)throw new Error("Cannot convert to Plan B because m-lines have different protocols and this library does not have support for that");if(e.payloads!=c[e.type].payloads)throw new Error("Cannot convert to Plan B because m-lines have different payloads and this library does not have support for that")})),a.forEach((function(e){if("application"===e.type)return i.media.push(e),void u.push(e.mid);"object"==typeof e.sources&&Object.keys(e.sources).forEach((function(t){"object"!=typeof c[e.type].sources&&(c[e.type].sources={}),c[e.type].sources[t]=e.sources[t],void 0!==e.msid&&(c[e.type].sources[t].msid=e.msid)})),void 0!==e.ssrcGroups&&Array.isArray(e.ssrcGroups)&&(void 0!==c[e.type].ssrcGroups&&Array.isArray(c[e.type].ssrcGroups)||(c[e.type].ssrcGroups=[]),c[e.type].ssrcGroups=c[e.type].ssrcGroups.concat(e.ssrcGroups)),c[e.type]===e&&(e.mid=e.type,delete e.bundleOnly,delete e.msid,e.type==a[0].type?(u.unshift(e.type),i.media.unshift(e)):(u.push(e.type),i.media.push(e)))})),void 0!==i.groups&&i.groups.some((function(e){if("BUNDLE"===e.type)return e.mids=u.join(" "),!0})),i.msidSemantic={semantic:"WMS",token:"*"};var d=n.write(i);return new RTCSessionDescription({type:e.type,sdp:d})},o.prototype.toUnifiedPlan=function(e){var t=this;if("object"!=typeof e||null===e||"string"!=typeof e.sdp)return console.warn("An empty description was passed as an argument."),e;var i=n.parse(e.sdp);if(void 0===i.media||!Array.isArray(i.media)||0===i.media.length)return console.warn("The description has no media."),e;if(i.media.length>3||!i.media.every((function(e){return-1!==["video","audio","data"].indexOf(e.mid)})))return console.warn("This description does not look like Plan B."),e;var o=[];i.media.forEach((function(e){o.push(e.mid)}));var s,a,c=!1;if(void 0!==i.groups&&Array.isArray(i.groups)&&(c=i.groups.every((function(e){return"BUNDLE"!==e.type||r.apply(e.mids.sort(),[o.sort()])}))),!c){var u=!1;if(i.media.forEach((function(e){"inactive"!==e.direction&&(u=!0)})),u)throw new Error("Cannot convert to Unified Plan because m-lines that are not bundled were found.")}if("answer"===e.type)s="offer";else{if("offer"!==e.type)throw new Error("Type '"+e.type+"' not supported.");s="answer"}void 0!==this.cache[s]&&(a=n.parse(this.cache[s]));var d,l,h,p,f={audio:{},video:{}},m={},v=0,g=0,_={},y={},S={},T={};if(i.media.forEach((function(i){if(("string"!=typeof i.rtcpMux||"rtcp-mux"!==i.rtcpMux)&&"inactive"!==i.direction)throw new Error("Cannot convert to Unified Plan because m-lines without the rtcp-mux attribute were found.");if("application"!==i.type){var n=i.sources,r=i.ssrcGroups,o=i.port;if(void 0!==i.candidates&&(d=void 0!==d?d.concat(i.candidates):i.candidates),void 0!==l&&void 0!==i.iceUfrag&&l!=i.iceUfrag)throw new Error("Only BUNDLE supported, iceUfrag must be the same for all m-lines.\n\tLast iceUfrag: "+l+"\n\tNew iceUfrag: "+i.iceUfrag);if(void 0!==i.iceUfrag&&(l=i.iceUfrag),void 0!==h&&void 0!==i.icePwd&&h!=i.icePwd)throw new Error("Only BUNDLE supported, icePwd must be the same for all m-lines.\n\tLast icePwd: "+h+"\n\tNew icePwd: "+i.icePwd);if(void 0!==i.icePwd&&(h=i.icePwd),void 0!==p&&void 0!==i.fingerprint&&(p.type!=i.fingerprint.type||p.hash!=i.fingerprint.hash))throw new Error("Only BUNDLE supported, fingerprint must be the same for all m-lines.\n\tLast fingerprint: "+JSON.stringify(p)+"\n\tNew fingerprint: "+JSON.stringify(i.fingerprint));void 0!==i.fingerprint&&(p=i.fingerprint),y[i.type]=i.payloads,S[i.type]=i.rtcpFb,T[i.type]=i.rtp;var s={};void 0!==r&&Array.isArray(r)&&r.forEach((function(e){void 0!==e.ssrcs&&Array.isArray(e.ssrcs)&&e.ssrcs.forEach((function(t){void 0===s[t]&&(s[t]=[]),s[t].push(e)}))}));var c={};if("object"==typeof n)delete i.sources,delete i.ssrcGroups,delete i.candidates,delete i.iceUfrag,delete i.icePwd,delete i.fingerprint,delete i.port,delete i.mid,Object.keys(n).forEach((function(r){var u;"offer"!==e.type||n[r].msid?(void 0!==s[r]&&Array.isArray(s[r])&&s[r].some((function(e){return e.ssrcs.some((function(e){if("object"==typeof c[e])return u=c[e],!0}))})),"object"==typeof u?(u.sources[r]=n[r],delete n[r].msid):(u=Object.create(i),c[r]=u,void 0!==n[r].msid&&(u.msid=n[r].msid,delete n[r].msid),u.sources={},u.sources[r]=n[r],u.ssrcGroups=s[r],void 0!==a&&void 0!==a.media&&Array.isArray(a.media)&&a.media.forEach((function(e){"object"==typeof e.sources&&Object.keys(e.sources).forEach((function(t){t===r&&(u.mid=e.mid)}))})),void 0===u.mid&&(u.mid=[i.type,"-",r].join("")),u.candidates=d,u.iceUfrag=l,u.icePwd=h,u.fingerprint=p,u.port=o,m[u.mid]=u,_[g]=u.sources,t.cache.mlU2BMap[g]=v,void 0===t.cache.mlB2UMap[v]&&(t.cache.mlB2UMap[v]=g),g++)):f[i.type][r]=n[r]}));else{var u=i;u.candidates=d,u.iceUfrag=l,u.icePwd=h,u.fingerprint=p,u.port=o,m[u.mid]=u,t.cache.mlU2BMap[g]=v,void 0===t.cache.mlB2UMap[v]&&(t.cache.mlB2UMap[v]=g)}v++}else m[i.mid]=i})),i.media=[],o=[],"answer"===e.type)for(var E=0;E<a.media.length;E++){var b=a.media[E];delete b.msid,delete b.sources,delete b.ssrcGroups,void 0===_[E]?b.direction&&"sendrecv"!==b.direction?"sendonly"===b.direction&&(b.direction="inactive"):b.direction="recvonly":b.direction&&"sendrecv"!==b.direction?"recvonly"===b.direction&&(b.direction="sendonly"):b.direction="sendrecv",b.sources=_[E],b.candidates=d,b.iceUfrag=l,b.icePwd=h,b.fingerprint=p,b.rtp=T[b.type],b.payloads=y[b.type],b.rtcpFb=S[b.type],i.media.push(b),"string"==typeof b.mid&&o.push(b.mid)}else void 0!==a&&void 0!==a.media&&Array.isArray(a.media)&&a.media.forEach((function(e){o.push(e.mid),void 0!==m[e.mid]?i.media.push(m[e.mid]):(delete e.msid,delete e.sources,delete e.ssrcGroups,e.direction&&"sendrecv"!==e.direction||(e.direction="sendonly"),e.direction&&"recvonly"!==e.direction||(e.direction="inactive"),function(e){void 0!==e.setup&&("active"===e.setup?e.setup="passive":"passive"===e.setup&&(e.setup="active"))}(e),i.media.push(e))})),Object.keys(m).forEach((function(e){if(-1===o.indexOf(e))if(o.push(e),"recvonly"===m[e].direction){var t=!1;i.media.some((function(i){if(("sendrecv"===i.direction||"sendonly"===i.direction)&&i.type===m[e].type)return Object.keys(m[e].sources).forEach((function(t){i.sources[t]=m[e].sources[t]})),t=!0,!0})),t||i.media.push(m[e])}else i.media.push(m[e])}));["audio","video"].forEach((function(e){if(i&&i.media&&Array.isArray(i.media)){var n=null;if(Object.keys(f[e]).length>0&&null===(n=t.getFirstSendingIndexFromAnswer(e)))for(var r=0;r<i.media.length;r++)if(i.media[r].type===e){n=r;break}if(n&&i.media.length>n){var o=i.media[n];Object.keys(f[e]).forEach((function(t){o.sources&&o.sources[t]&&console.warn("Replacing an existing SSRC."),o.sources||(o.sources={}),o.sources[t]=f[e][t]}))}}})),void 0!==i.groups&&i.groups.some((function(e){if("BUNDLE"===e.type)return e.mids=o.join(" "),!0})),i.msidSemantic={semantic:"WMS",token:"*"};var R=n.write(i);return this.cache[e.type]=R,new RTCSessionDescription({type:e.type,sdp:R})}},function(e,t,i){var n=i(23);t.write=function(e,t){return void 0!==e&&void 0!==e.media&&Array.isArray(e.media)&&e.media.forEach((function(e){void 0!==e.sources&&0!==Object.keys(e.sources).length&&(e.ssrcs=[],Object.keys(e.sources).forEach((function(t){var i=e.sources[t];Object.keys(i).forEach((function(n){e.ssrcs.push({id:t,attribute:n,value:i[n]})}))})),delete e.sources),void 0!==e.ssrcGroups&&Array.isArray(e.ssrcGroups)&&e.ssrcGroups.forEach((function(e){void 0!==e.ssrcs&&Array.isArray(e.ssrcs)&&(e.ssrcs=e.ssrcs.join(" "))}))})),void 0!==e&&void 0!==e.groups&&Array.isArray(e.groups)&&e.groups.forEach((function(e){void 0!==e.mids&&Array.isArray(e.mids)&&(e.mids=e.mids.join(" "))})),n.write(e,t)},t.parse=function(e){var t=n.parse(e);return void 0!==t&&void 0!==t.media&&Array.isArray(t.media)&&t.media.forEach((function(e){void 0!==e.ssrcs&&Array.isArray(e.ssrcs)&&(e.sources={},e.ssrcs.forEach((function(t){e.sources[t.id]||(e.sources[t.id]={}),e.sources[t.id][t.attribute]=t.value})),delete e.ssrcs),void 0!==e.ssrcGroups&&Array.isArray(e.ssrcGroups)&&e.ssrcGroups.forEach((function(e){"string"==typeof e.ssrcs&&(e.ssrcs=e.ssrcs.split(" "))}))})),void 0!==t&&void 0!==t.groups&&Array.isArray(t.groups)&&t.groups.forEach((function(e){"string"==typeof e.mids&&(e.mids=e.mids.split(" "))})),t}},function(e,t,i){var n=i(24),r=i(25);t.write=r,t.parse=n.parse,t.parseFmtpConfig=n.parseFmtpConfig,t.parsePayloads=n.parsePayloads,t.parseRemoteCandidates=n.parseRemoteCandidates},function(e,t,i){var n=function(e){return String(Number(e))===e?Number(e):e},r=function(e,t,i){var r=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:r&&!t[e.name]&&(t[e.name]={});var o=e.push?{}:r?t[e.name]:t;!function(e,t,i,r){if(r&&!i)t[r]=n(e[1]);else for(var o=0;o<i.length;o+=1)null!=e[o+1]&&(t[i[o]]=n(e[o+1]))}(i.match(e.reg),o,e.names,e.name),e.push&&t[e.push].push(o)},o=i(10),s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(e){var t={},i=[],n=t;return e.split(/(\r\n|\r|\n)/).filter(s).forEach((function(e){var t=e[0],s=e.slice(2);"m"===t&&(i.push({rtp:[],fmtp:[]}),n=i[i.length-1]);for(var a=0;a<(o[t]||[]).length;a+=1){var c=o[t][a];if(c.reg.test(s))return r(c,n,s)}})),t.media=i,t};var a=function(e,t){var i=t.split("=");return 2===i.length&&(e[i[0]]=n(i[1])),e};t.parseFmtpConfig=function(e){return e.split(/\;\s?/).reduce(a,{})},t.parsePayloads=function(e){return e.split(" ").map(Number)},t.parseRemoteCandidates=function(e){for(var t=[],i=e.split(" ").map(n),r=0;r<i.length;r+=3)t.push({component:i[r],ip:i[r+1],port:i[r+2]});return t}},function(e,t,i){var n=i(10),r=/%[sdv%]/g,o=function(e){var t=1,i=arguments,n=i.length;return e.replace(r,(function(e){if(t>=n)return e;var r=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(r);case"%d":return Number(r);case"%v":return""}}))},s=function(e,t,i){var n=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var r=0;r<t.names.length;r+=1){var s=t.names[r];t.name?n.push(i[t.name][s]):n.push(i[t.names[r]])}else n.push(i[t.name]);return o.apply(null,n)},a=["v","o","s","i","u","e","p","c","b","t","r","z","a"],c=["i","c","b","a"];e.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var i=t.outerOrder||a,r=t.innerOrder||c,o=[];return i.forEach((function(t){n[t].forEach((function(i){i.name in e&&null!=e[i.name]?o.push(s(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){o.push(s(t,i,e))}))}))})),e.media.forEach((function(e){o.push(s("m",n.m[0],e)),r.forEach((function(t){n[t].forEach((function(i){i.name in e&&null!=e[i.name]?o.push(s(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){o.push(s(t,i,e))}))}))}))})),o.join("\r\n")+"\r\n"}},function(e,t){e.exports=function e(t){if(!t)return!1;if(this.length!=t.length)return!1;for(var i=0,n=this.length;i<n;i++)if(this[i]instanceof Array&&t[i]instanceof Array){if(!e.apply(this[i],[t[i]]))return!1}else if(this[i]!=t[i])return!1;return!0}},function(e,t,i){var n=function(e){return String(Number(e))===e?Number(e):e},r=function(e,t,i){var r=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:r&&!t[e.name]&&(t[e.name]={});var o=e.push?{}:r?t[e.name]:t;!function(e,t,i,r){if(r&&!i)t[r]=n(e[1]);else for(var o=0;o<i.length;o+=1)null!=e[o+1]&&(t[i[o]]=n(e[o+1]))}(i.match(e.reg),o,e.names,e.name),e.push&&t[e.push].push(o)},o=i(11),s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(e){var t={},i=[],n=t;return e.split(/(\r\n|\r|\n)/).filter(s).forEach((function(e){var t=e[0],s=e.slice(2);"m"===t&&(i.push({rtp:[],fmtp:[]}),n=i[i.length-1]);for(var a=0;a<(o[t]||[]).length;a+=1){var c=o[t][a];if(c.reg.test(s))return r(c,n,s)}})),t.media=i,t};var a=function(e,t){var i=t.split(/=(.+)/,2);return 2===i.length?e[i[0]]=n(i[1]):1===i.length&&t.length>1&&(e[i[0]]=void 0),e};t.parseParams=function(e){return e.split(/;\s?/).reduce(a,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(e){return e.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(e){for(var t=[],i=e.split(" ").map(n),r=0;r<i.length;r+=3)t.push({component:i[r],ip:i[r+1],port:i[r+2]});return t},t.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(a,{})}))},t.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var t,i=!1;return"~"!==e[0]?t=n(e):(t=n(e.substring(1,e.length)),i=!0),{scid:t,paused:i}}))}))}},function(e,t,i){var n=i(11),r=/%[sdv%]/g,o=function(e){var t=1,i=arguments,n=i.length;return e.replace(r,(function(e){if(t>=n)return e;var r=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(r);case"%d":return Number(r);case"%v":return""}}))},s=function(e,t,i){var n=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var r=0;r<t.names.length;r+=1){var s=t.names[r];t.name?n.push(i[t.name][s]):n.push(i[t.names[r]])}else n.push(i[t.name]);return o.apply(null,n)},a=["v","o","s","i","u","e","p","c","b","t","r","z","a"],c=["i","c","b","a"];e.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var i=t.outerOrder||a,r=t.innerOrder||c,o=[];return i.forEach((function(t){n[t].forEach((function(i){i.name in e&&null!=e[i.name]?o.push(s(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){o.push(s(t,i,e))}))}))})),e.media.forEach((function(e){o.push(s("m",n.m[0],e)),r.forEach((function(t){n[t].forEach((function(i){i.name in e&&null!=e[i.name]?o.push(s(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){o.push(s(t,i,e))}))}))}))})),o.join("\r\n")+"\r\n"}},function(e,t,i){"use strict";i.r(t),i.d(t,"Logger",(function(){return Pr})),i.d(t,"Events",(function(){return xr})),i.d(t,"createStream",(function(){return Mr})),i.d(t,"createClient",(function(){return Lr})),i.d(t,"setEnvTest",(function(){return Nr})),i.d(t,"useRoomChannelType",(function(){return Ur})),i.d(t,"forcePlanBSimulcast",(function(){return Vr})),i.d(t,"addProxies",(function(){return Fr})),i.d(t,"removeProxies",(function(){return jr})),i.d(t,"checkSystemSupport",(function(){return Br})),i.d(t,"supportScreenSharing",(function(){return Hr})),i.d(t,"isSmallStreamSupported",(function(){return Gr})),i.d(t,"getPermissions",(function(){return qr})),i.d(t,"base64Decode",(function(){return Jr})),i.d(t,"enumAudioInputDevices",(function(){return Wr})),i.d(t,"enumAudioOutputDevices",(function(){return zr})),i.d(t,"enumVideoDevices",(function(){return $r})),i.d(t,"version",(function(){return Kr})),i.d(t,"RenderProcess",(function(){return Yr}));var n={};i.r(n),i.d(n,"STREAM_ADDED",(function(){return S})),i.d(n,"STREAM_REMOVED",(function(){return T})),i.d(n,"STREAM_UPDATED",(function(){return E})),i.d(n,"STREAM_PUBLISHED",(function(){return b})),i.d(n,"STREAM_SUBSCRIBED",(function(){return R})),i.d(n,"MUTE_VIDEO",(function(){return I})),i.d(n,"UNMUTE_VIDEO",(function(){return k})),i.d(n,"MUTE_AUDIO",(function(){return w})),i.d(n,"UNMUTE_AUDIO",(function(){return C})),i.d(n,"ERROR",(function(){return A})),i.d(n,"PEER_JOINED",(function(){return D})),i.d(n,"PEER_LEAVED",(function(){return O})),i.d(n,"CLIENT_BANNED",(function(){return P})),i.d(n,"USER_KICKED",(function(){return x})),i.d(n,"TOKEN_WILL_EXPIRE",(function(){return M})),i.d(n,"TOKEN_EXPIRE",(function(){return L})),i.d(n,"ROOM_CLOSED",(function(){return N}));var r={};i.r(r),i.d(r,"DEBUG",(function(){return B})),i.d(r,"INFO",(function(){return H})),i.d(r,"WARN",(function(){return G})),i.d(r,"ERROR",(function(){return q})),i.d(r,"CLOSE",(function(){return J})),i.d(r,"FATAL",(function(){return W})),i.d(r,"setLevel",(function(){return X})),i.d(r,"debug",(function(){return Z})),i.d(r,"info",(function(){return ee})),i.d(r,"warn",(function(){return te})),i.d(r,"error",(function(){return ie})),i.d(r,"fatal",(function(){return ne})),i.d(r,"enableUploadLog",(function(){return re})),i.d(r,"disableUploadLog",(function(){return oe})),i.d(r,"LogMap",(function(){return se}));var o={};i.r(o),i.d(o,"VIDEO_TRACK_ENDED",(function(){return me})),i.d(o,"AUDIO_TRACK_ENDED",(function(){return ve})),i.d(o,"VIDEO_TRACK_MUTE",(function(){return ge})),i.d(o,"AUDIO_TRACK_MUTE",(function(){return _e})),i.d(o,"VIDEO_TRACK_UNMUTE",(function(){return ye})),i.d(o,"AUDIO_TRACK_UNMUTE",(function(){return Se})),i.d(o,"TRACK_UPDATE",(function(){return Te})),i.d(o,"PLAYER_STATE_CHANGED",(function(){return Ee})),i.d(o,"CONNECT_ERROR",(function(){return be})),i.d(o,"PLAYER_VIDEO_RENDERED",(function(){return Re})),i.d(o,"PLAYER_AUDIO_RENDERED",(function(){return Ie}));var s=i(0);function a(e){return 0===e}function c(e){return 1===e}function u(e){return"video"===e.kind}function d(e){return"audio"===e.kind}let l,h=1,p=!1,f=[];function m(){return l}const v={4096:1001,4097:1002,16385:4001,16386:4002,16387:4003,16388:4e3,16389:4004,16448:4005,16449:4006,16450:4007,65535:9e3},g="contact with BaiJiaYun for more information",_={1e3:{name:"local error",message:g},1001:{name:"param invalid",message:"参数类型错误"},1002:{name:"invalid operation",message:"非法操作"},1003:{name:"not support",message:"不支持"},4e3:{name:"join channel error",message:"进入频道失败"},4001:{name:"signal setup failed",message:"信令通道建立失败"},4002:{name:"signal error",message:"信令通道错误"},4003:{name:"ice transport error",message:"ICE Tansport 连接错误"},4004:{name:"create offer failed",message:"创建 sdp offer 失败"},4005:{name:"client banned",message:"用户被踢出"},4006:{name:"media server timeout",message:"媒体传输超时"},4007:{name:"subscription timeout",message:"订阅远端流超时"},4008:{name:"media publish error",message:"推流错误"},5e3:{name:"fetch fail",message:"网络请求失败，请检查网络状态"},5001:{name:"userSig error",message:"userSig 验证失败"},9e3:{name:"unknow",message:g},1010:{name:"permission deny",message:"权限验证失败"}};class y extends Error{constructor(e,t,i,n){if(super(),this.RTCType=m(),this.code=e,this.error=i,this.BRTCErrorFlag=!0,c(this.RTCType)&&i&&i.getCode){let e=v[i.getCode()];e&&(this.code=e)}this.eName=n||(_[this.code]?_[this.code].name:"BRTCError"),this.message=`[webrtc_type: ${this.RTCType}] [code: ${this.code}] [error_name: ${this.eName}] ${t||(_[this.code]?_[this.code].message:"unkown")}`}static instanceOf(e){return!(!e||!e.BRTCErrorFlag)}getCode(){return this.code}}const S="stream-added",T="stream-removed",E="stream-updated",b="stream-published",R="stream-subscribed",I="mute-video",k="unmute-video",w="mute-audio",C="unmute-audio",A="error",D="peer-joined",O="peer-leaved",P="client-banned",x="user-kicked",M="token-will-expire",L="token-expire",N="room-closed";var U=i(5),V=i.n(U),F=i(3),j=i(1);const B=1,H=2,G=3,q=4,J=5,W=6;let z=!1;const $=void 0!==typeof console?console:null,K=/BRTC/.test(Object(F.a)((function(){})))?B:G;function Y(e,t,i,n){let r=[];return s.f(m())&&r.push(m()),i&&r.push(i),n&&r.push(n),`[${(new Date).toLocaleTimeString("chinese",{hour12:!1})}] <${e}> [${r.join("|")}] ${t}`}function Q(){if(window){const e=window.BRTC_LOG_LEVEL;if(e>=B&&e<=W)return e}return K}function X(e){window.BRTC_LOG_LEVEL=e,V.a.Logger.setLogLevel(e),j.i(e)}function Z(e,t,i,n=[]){$&&Q()<=B&&(n.unshift(Y("DEBUG",e,t,i)),$.log.apply($.log,n))}function ee(e,t,i,n=[]){$&&Q()<=H&&(n.unshift(Y("INFO",e,t,i)),$.log.apply($.log,n))}function te(e,t,i,n=[]){$&&Q()<=G&&(n.unshift(Y("WARN",e,t,i)),$.warn.apply($.warn,n))}function ie(e,t,i,n=[]){$&&Q()<=q&&(n.unshift(Y("ERROR",e,t,i)),$.error.apply($.error,n))}function ne(e,t,i){throw new y(e,t,i)}function re(){z=!0}function oe(){z=!1}const se={[B]:Z,[H]:ee,[G]:te,[q]:ie};function ae(e){return s.i(e)&&!/^0[0-9]+/.test(e)&&/^[0-9]{1,15}$/g.test(e)?+e:e}var ce=i(2);function ue(e,t,i){if(s.d(e))return s.a(i)?e.apply(t,i):t!==ce.m?e.call(t,i):i!==ce.m?e(i):e()}var de=i(6);function le(){return Date.now()}var he=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};let pe;function fe(e=0){return le()+e}const me="video-track-ended",ve="audio-track-ended",ge="video-track-mute",_e="audio-track-mute",ye="video-track-unmute",Se="audio-track-unmute",Te="track-update",Ee="player-state-changed",be="connect-error",Re="player-video-rendered",Ie="player-audio-rendered";var ke=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};class we{constructor(e,t){this.element=e,this.options=t,this.container=document.createElement("div"),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.backgroundColor="black",this.container.style.overflow="hidden",e.appendChild(this.container)}playVideo(){if(!this.video){this.video=document.createElement("video"),this.video.autoplay=!0,this.video.playsInline=!0,this.video.muted=this.options.muted,this.video.style.width="100%",this.video.style.height="100%",this.video.style.position="absolute";let e="";this.options.rotateX&&(e=`rotateX(${this.options.rotateX}deg)`),this.options.rotateY&&(e=`${e} rotateY(${this.options.rotateY}deg)`),e&&(this.video.style.transform=e),this.video.style.objectFit=this.options.fit,this.video.id="video_"+this.stream.getStreamId(),this.container.appendChild(this.video),this.video.addEventListener("playing",()=>{this.videoStatus="PLAYING",this.stream.fire(Ee,{type:"video",state:this.videoStatus,reason:"playing"}),ee("stream video playing","p",this.stream.getUserId())}),this.video.addEventListener("pause",()=>{this.videoStatus="PAUSED",this.stream.fire(Ee,{type:"video",state:this.videoStatus,reason:"pause"}),ee("stream video pause","p",this.stream.getUserId())}),this.video.addEventListener("stalled",()=>{this.videoStatus="PAUSED",this.stream.fire(Ee,{type:"video",state:this.videoStatus,reason:"stalled"}),ee("stream video stalled","p",this.stream.getUserId())}),this.video.addEventListener("loadeddata",()=>{this.stream.fire(Re),ee("stream video loadeddata","p",this.stream.getUserId())})}let e=new MediaStream;e.addTrack(this.stream.getVideoTrack()),this.video.srcObject=e,this.videoStatus="STOPPED"}playAudio(){this.audio||(this.audio=document.createElement("audio"),this.audio.autoplay=!0,this.audio.playsInline=!0,this.audio.muted=this.options.muted,this.audio.id="audio_"+this.stream.getStreamId(),this.container.appendChild(this.audio),this.stream.getAudioDeviceId()&&this.setSinkId(this.stream.getAudioDeviceId()),this.audio.volume=s.f(this.stream.getAudioVolume())?this.stream.getAudioVolume():0,this.audio.addEventListener("playing",()=>{this.audioStatus="PLAYING",this.stream.fire(Ee,{type:"audio",state:this.audioStatus,reason:"playing"}),ee("stream audio playing","p",this.stream.getUserId())}),this.audio.addEventListener("pause",()=>{this.audioStatus="PAUSED",this.stream.fire(Ee,{type:"audio",state:this.audioStatus,reason:"pause"}),ee("stream audio pause","p",this.stream.getUserId())}),this.audio.addEventListener("stalled",()=>{this.audioStatus="PAUSED",this.stream.fire(Ee,{type:"audio",state:this.audioStatus,reason:"stalled"}),ee("stream audio stalled","p",this.stream.getUserId())}),this.audio.addEventListener("loadeddata",()=>{this.stream.fire(Ie),ee("stream audio loadeddata","p",this.stream.getUserId())}));let e=new MediaStream;e.addTrack(this.stream.getAudioTrack()),this.audio.srcObject=e,this.audioStatus="STOPPED"}setSinkId(e){return ke(this,void 0,void 0,(function*(){this.audio&&s.d(this.audio.setSinkId)&&(yield this.audio.setSinkId(e))}))}setVolume(e){this.audio&&(this.audio.volume=e)}play(e){return ke(this,void 0,void 0,(function*(){this.stream=e,this.container.id="player_"+e.getStreamId(),this.stream.hasAudio()&&this.playAudio(),this.stream.hasVideo()&&this.playVideo();try{this.audio&&(yield this.audio.play()),this.video&&(yield this.video.play())}catch(e){this.stream.fire(Ee,{type:"error",reason:e})}}))}replay(e,t=!0,i=!0){return ke(this,void 0,void 0,(function*(){this.stream=e;try{this.stream.hasAudio()&&i&&this.playAudio(),this.stream.hasVideo()&&t&&this.playVideo(),this.stream.hasAudio()&&i&&(yield this.audio.play()),this.stream.hasVideo()&&t&&(yield this.video.play())}catch(e){this.stream.fire(Ee,{type:"error",reason:e})}Z("stream replay","p",this.stream.getUserId())}))}muteVideo(){this.video&&(this.video.srcObject=void 0,this.videoStatus="STOPPED")}muteAudio(){this.audio&&(this.audio.srcObject=void 0,this.audioStatus="STOPPED")}unmuteVideo(){if(this.video&&this.stream&&"STOPPED"===this.videoStatus){let e=new MediaStream;e.addTrack(this.stream.getVideoTrack()),this.video.srcObject=e}}unmuteAudio(){if(this.audio&&this.stream&&"STOPPED"===this.audioStatus){let e=new MediaStream;e.addTrack(this.stream.getAudioTrack()),this.audio.srcObject=e}}destroy(){this.element.removeChild(this.container),this.audio&&(this.audio.srcObject=null),this.video&&(this.video.srcObject=null),this.audio=null,this.video=null,this.container=null,Z("stream player destroy","p",this.stream.getUserId())}resume(){return ke(this,void 0,void 0,(function*(){this.video&&this.video.play(),this.audio&&(yield function(){return he(this,void 0,void 0,(function*(){pe&&(yield pe.resume())}))}(),this.audio.play()),Z("stream player resume","p",this.stream.getUserId())}))}getVideoFrame(){if(this.video&&"STOPPED"!==this.videoStatus){const e=document.createElement("canvas");e.width=this.video.videoWidth,e.height=this.video.videoHeight;return e.getContext("2d").drawImage(this.video,0,0),e.toDataURL("image/png")}}}function Ce(e){return e!==ce.m}function Ae(e){if(e){if(y.instanceOf(e))return null;if(s.d(e.getCode))return e.getCode();if(Ce(e.code))return e.code}return null}class De{constructor(e=10){this.queue=[],this.win=e}addData(e,t){for(;this.queue.length>=this.win;)this.queue.shift();this.queue.push([Number(e),Number(t)])}getPacketLossRate(){let e,t=this.queue.length;if(0==t)e=0;else if(t<this.win){let i=this.queue[t-1][0];e=this.queue[t-1][1]/i}else if(t===this.win){let i=Math.abs(this.queue[t-1][0]-this.queue[0][0]);e=Math.abs(this.queue[t-1][1]-this.queue[0][1])/i}else e=0;return e>=1&&(e=1),Number.isNaN(e)&&(e=0),Math.max(Math.round(100*e),0)}}class Oe{constructor(e=1){this.sample=e,this.audioPackLost=new De(2),this.videoPackLost=new De(2),this.audioBytesBefore=this.audioBytesNow=0,this.videoBytesBefore=this.videoBytesNow=0,this.frameBefore=this.frameNow=0}addData(e,t,i,n,r,o,s){this.audioPackLost.addData(i,n),this.videoPackLost.addData(r,o),this.audioBytesBefore=this.audioBytesNow,this.audioBytesNow=e,this.videoBytesBefore=this.videoBytesNow,this.videoBytesNow=t,this.frameBefore=this.frameNow,this.frameNow=s}getAudioPacketLoss(){return this.audioPackLost.getPacketLossRate()}getVideoPacketLoss(){return this.videoPackLost.getPacketLossRate()}getAudioBitrate(){return this.audioBytesBefore?Math.max(Math.round(8*(this.audioBytesNow-this.audioBytesBefore)/1e3/this.sample),0):0}getVideoBitrate(){return this.videoBytesBefore?Math.max(Math.round(8*(this.videoBytesNow-this.videoBytesBefore)/1e3/this.sample),0):0}getFrameRate(){return this.frameBefore?Math.max(Math.round((this.frameNow-this.frameBefore)/this.sample),0):0}destroy(){this.sample=null,this.audioPackLost=null,this.videoPackLost=null,this.audioBytesBefore=this.audioBytesNow=null,this.videoBytesBefore=this.videoBytesNow=null,this.frameBefore=this.frameNow=null}}function Pe(e,t,i){if(!e)return;const{length:n}=e;if(n)if(i)for(let i=n-1;i>=0&&t(e[i],i)!==ce.d;i--);else for(let i=0;i<n&&t(e[i],i)!==ce.d;i++);}function xe(e,t){e[e.length]=t}function Me(e,t,i){s.a(t)?Pe(t,(function(t){i(e,t)})):i(e,t)}function Le(e,t){Me(e,t,xe)}function Ne(e,t,i){let n=0;return Pe(e,(function(r,o){(i===ce.d?r==t:r===t)&&(e.splice(o,1),n++)}),ce.l),n}function Ue(e,t,i){return function(e,t,i){let n=ce.f;return Pe(e,(function(e,r){if(i===ce.d?e==t:e===t)return n=r,ce.d})),n}(e,t,i)>=0}function Ve(e){return s.a(e)?e:ue(ce.a.slice,e)}class Fe{constructor(e,t){this.type=e,this.phase=Fe.PHASE_CURRENT,t&&(this.originalEvent=t)}preventDefault(){const e=this;if(!e.isPrevented){const{originalEvent:t}=e;t&&t.preventDefault(),e.isPrevented=ce.l}return e}stopPropagation(){const e=this;if(!e.isStoped){const{originalEvent:t}=e;t&&t.stopPropagation(),e.isStoped=ce.l}return e}prevent(){return this.preventDefault()}stop(){return this.stopPropagation()}}Fe.PHASE_CURRENT=0,Fe.PHASE_UPWARD=1,Fe.PHASE_DOWNWARD=ce.f;var je=i(4);const Be={};function He(e,t){const i=Be.hasOwnProperty(e)?Be[e]:Be[e]=e.split(ce.h);for(let e=0,n=i.length-1;e<=n&&t(i[e],e===n)!==ce.d;e++);}function Ge(e){return Ce(e)?Object.keys(e):[]}function qe(e,t){for(let i in e)if(t(e[i],i)===ce.d)break}function Je(e,t){return s.h(e)?s.h(t)?(qe(t,(function(t,i){e[i]=t})),e):e:t}function We(e,t,i){return Je(Je(e,t),i)}function ze(e,t,i){let n;return He(t,(function(t,i){if(e==ce.g)return n=ce.m,ce.d;{let r=e[t],o=r!==ce.m;i?n=o?r:ce.m:e=r}})),n===ce.m&&(n=i),n}function $e(e){let t=[];const i=(e,i)=>{i=s.d(i)?i():null==i?"":i,t[t.length]=encodeURIComponent(e)+"="+encodeURIComponent(i)};return(s.a(e)||s.e(e))&&(s.a(e)?Pe(e,(e,t)=>{i(t,e)}):qe(e,(e,t)=>{i(t,e)})),t.join("&").replace(/%20/g,"+")}class Ke{constructor(e){this.ns=e||ce.d,this.listeners={}}fire(e,t,i){let n=this,r=s.i(e)?n.parse(e):e,o=n.listeners[r.type],a=ce.l;if(o){o=function e(t,i){let n=t;return s.a(t)?i?(n=[],Pe(t,(function(t,r){n[r]=e(t,i)}))):n=t.slice():s.h(t)&&(n={},qe(t,(function(t,r){n[r]=i?e(t,i):t}))),n}(o);const e=t&&t[0]instanceof Fe?t[0]:ce.m;Pe(o,(function(s){if(!Xe(r.ns,s,ce.l)||!Ue(o,s)||i&&!i(r,t,s))return;e&&(e.listener=s.fn);let c=ue(s.fn,s.ctx,t);return e&&(e.listener=ce.m),s.num=s.num?s.num+1:1,s.num===s.max&&n.off(r,s.fn),e&&(c===ce.d?e.prevent().stop():e.isStoped&&(c=ce.d)),c===ce.d?a=ce.d:void 0}))}return a}on(e,t){const i=this,n=i.listeners,r=s.d(t)?{fn:t}:t;if(s.h(r)&&s.d(r.fn)){const t=s.i(e)?i.parse(e):e;r.ns=t.ns,Le(n[t.type]||(n[t.type]=[]),r)}else 0;return this}one(e,t){return s.d(t)?t={fn:t,max:1}:t.max=1,this.on(e,t)}off(e,t){const i=this,n=i.listeners;if(e){const r=s.i(e)?i.parse(e):e,o=r.type,a=r.ns,c=Qe(t),u=function(e,t){Pe(e,(function(t,i){c(t)&&e.splice(i,1)}),ce.l),e.length||delete n[t]},d=function(e,t){Pe(e,(function(t,i){Xe(a,t)&&e.splice(i,1)}),ce.l),e.length||delete n[t]};o?n[o]&&u(n[o],o):a&&qe(n,d)}else i.listeners={}}has(e,t){let i=this.listeners,n=s.i(e)?this.parse(e):e,r=n.type,o=n.ns,a=ce.l,c=Qe(t),u=function(e){return Pe(e,(function(e){if(c(e))return a=ce.d})),a};return r?i[r]&&u(i[r]):o&&qe(i,u),!a}parse(e){const t={type:e,ns:ce.c};if(this.ns){const i=je.b(e,ce.h);i>=0&&(t.type=je.c(e,0,i),t.ns=je.c(e,i+1))}return t}}function Ye(){return ce.l}function Qe(e){return s.d(e)?function(t){return e===t.fn}:Ye}function Xe(e,t,i){const{ns:n}=t;return n&&e?n===e:i?ce.l:ce.d}class Ze extends class{constructor(e,t){this.audioWorkletNode=new AudioWorkletNode(e,t)}connect(e){this.audioWorkletNode.connect(e)}getNode(){return this.audioWorkletNode}disconnect(){this.audioWorkletNode.disconnect()}getParameters(e){const t=this.audioWorkletNode.parameters;if(s.d(t.get))return t.get(e);t.forEach((t,i)=>{if(i===e)return t})}}{constructor(e){super(e,"meter-processor"),this.audioLevel=0,this.audioWorkletNode.port.onmessage=e=>{this.audioLevel=e.data}}getAudioLevel(){return this.audioLevel}}const et="\nfunction webpackBootstrapFunc (modules) {\n  var installedModules = {};\n  function __webpack_require__(moduleId) {\n    if(installedModules[moduleId])\n    return installedModules[moduleId].exports;\n    var module = installedModules[moduleId] = {\n      i: moduleId,\n      l: false,\n      exports: {}\n    };\n    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n    module.l = true;\n    return module.exports;\n  }\n  __webpack_require__.m = modules;\n  __webpack_require__.c = installedModules;\n  __webpack_require__.i = function(value) { return value; };\n  __webpack_require__.d = function(exports, name, getter) {\n    if(!__webpack_require__.o(exports, name)) {\n      Object.defineProperty(exports, name, {\n        configurable: false,\n        enumerable: true,\n        get: getter\n      });\n    }\n   };\n  __webpack_require__.r = function(exports) {\n    Object.defineProperty(exports, '__esModule', { value: true });\n  };\n  __webpack_require__.n = function(module) {\n    var getter = module && module.__esModule ?\n      function getDefault() { return module['default']; } :\n      function getModuleExports() { return module; };\n    __webpack_require__.d(getter, 'a', getter);\n    return getter;\n  };\n  __webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n  __webpack_require__.p = \"/\";\n  __webpack_require__.oe = function(err) { console.error(err); throw err; };\n  var f = __webpack_require__(__webpack_require__.s = ENTRY_MODULE);\n  return f.default || f;\n}\n";function tt(e){return(e+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function it(e,t,n){const r={};r[n]=[];let o=t.toString();const s=o.match(/^function\s?\w*\(\w+,\s*\w+,\s*(\w+)\)/);if(!s)return r;const a=s[1];let c,u=new RegExp("(\\\\n|\\W)"+tt(a)+"\\(\\s*(/\\*.*?\\*/)?\\s*.*?([\\.|\\-|\\+|\\w|/|@]+).*?\\)","g");for(;c=u.exec(o);)"dll-reference"!==c[3]&&r[n].push(c[3]);for(u=new RegExp("\\("+tt(a)+'\\("(dll-reference\\s([\\.|\\-|\\+|\\w|/|@]+))"\\)\\)\\(\\s*(/\\*.*?\\*/)?\\s*.*?([\\.|\\-|\\+|\\w|/|@]+).*?\\)',"g");c=u.exec(o);)e[c[2]]||(r[n].push(c[1]),e[c[2]]=i(c[1]).m),r[c[2]]=r[c[2]]||[],r[c[2]].push(c[4]);const d=Object.keys(r);for(let e=0;e<d.length;e++)for(let t=0;t<r[d[e]].length;t++)l=r[d[e]][t],isNaN(1*l)||(r[d[e]][t]=1*r[d[e]][t]);var l;return r}function nt(e){return Object.keys(e).reduce((function(t,i){return t||e[i].length>0}),!1)}var rt=function(e,t){t=t||{};const n={main:i.m},r=t.all?{main:Object.keys(n.main)}:function(e,t){const i={main:[t]},n={main:[]},r={main:{}};for(;nt(i);){const t=Object.keys(i);for(let o=0;o<t.length;o++){let s=t[o],a=i[s].pop();if(r[s]=r[s]||{},r[s][a]||!e[s][a])continue;r[s][a]=!0,n[s]=n[s]||[],n[s].push(a);let c=it(e,e[s][a],s),u=Object.keys(c);for(let e=0;e<u.length;e++)i[u[e]]=i[u[e]]||[],i[u[e]]=i[u[e]].concat(c[u[e]])}}return n}(n,e);let o="";Object.keys(r).filter((function(e){return"main"!==e})).forEach((function(e){let t=0;for(;r[e][t];)t++;r[e].push(t),n[e][t]="(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })",o=o+"var "+e+" = ("+et.replace("ENTRY_MODULE",JSON.stringify(t))+")({"+r[e].map((function(t){return JSON.stringify(t)+": "+n[e][t].toString()})).join(",")+"});\n"})),o=t.simple?"("+n.main[e].toString().replace(/^function(module, exports) {\\n*/,"")+")(null, null)":o+"new (("+et.replace("ENTRY_MODULE",JSON.stringify(e))+")({"+r.main.map((function(e){return JSON.stringify(e)+": "+n.main[e].toString()})).join(",")+"}))(self);";const s=new window.Blob([o],{type:"text/javascript"});if(t.bare)return s;return(window.URL||window.webkitURL||window.mozURL||window.msURL).createObjectURL(s)},ot=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};const st={averaging:.95};let at;const ct="function"==typeof AudioWorkletNode;let ut;class dt{constructor(e={}){this.options=We({},st,e),this.readyed=!1,at||function(){let e=window.AudioContext||window.webkitAudioContext;if(at=new e,ct){const e=rt(17,{simple:!0});ut=at.audioWorklet.addModule(e)}}()}ready(){return ot(this,void 0,void 0,(function*(){this.readyed||(ct?yield new Promise(e=>{ut.then(()=>{this.createWorkletNode(),e()})}):this.createScriptProcessorNode(),this.node.connect(at.destination),this.readyed=!0,"suspended"===at.state&&this.resume())}))}createWorkletNode(){this.node=new Ze(at);const e=this.node.getParameters("output"),t=this.node.getParameters("averaging");e.value=0,t.value=this.options.averaging}createScriptProcessorNode(){const e=at.createScriptProcessor(2048,1,1);e.onaudioprocess=t=>{const i=t.inputBuffer.getChannelData(0);let n=0;for(let e=0;e<i.length;e++)n+=i[e]*i[e];const r=Math.sqrt(n/i.length);e.volume=Math.max(r,e.volume*e.averaging)},e.volume=0,e.averaging=this.options.averaging,this.node=e}connect(e){return ot(this,void 0,void 0,(function*(){if("audio"===e.kind){if(this.readyed||(yield this.ready()),e===this.track)return;this.disconnect(),this.track=e,this.mediaStream=new MediaStream,this.mediaStream.addTrack(this.track),this.mediaSourceNode=at.createMediaStreamSource(this.mediaStream),ct?this.mediaSourceNode.connect(this.node.getNode()):this.mediaSourceNode.connect(this.node)}}))}getVolume(){return this.node?ct?this.node.getAudioLevel():this.node.volume:0}disconnect(){this.mediaSourceNode&&(this.mediaSourceNode.disconnect(),this.mediaSourceNode=null),this.track=null,this.mediaStream=null}resume(){return ot(this,void 0,void 0,(function*(){if(at&&"suspended"===at.state)return at.resume()}))}destroy(){this.disconnect(),this.node&&(this.node.disconnect(),this.node=null),this.readyed=!1}}function lt(e,t){return s.g(e)?+e:t!==ce.m?t:0}var ht;function pt(e){return s.i(e)&&e.split(".").shift()||""}function ft(e,t,i=!1){const n=t.split("."),r=e.split(".");for(let e=0;e<r.length;e++){if(i&&e==r.length-1&&lt(r[e])>=lt(n[e]))return r.length>=n.length;if(lt(r[e])>lt(n[e]))return!0;if(lt(r[e])<lt(n[e]))return!1;if(e===n.length-1&&e===r.length-1)return i;if(e===n.length-1)return!0;if(e===r.length-1)return!1}return!0}!function(e){e.ALIPAY="alipay",e.WECHAT="wechat",e.DING_TALK="dingtalk",e.BAIDU_APP="baiduApp",e.BAIDU="baidu",e.UC="uc",e.QQ="qq",e.QQ_APP="qqApp",e.IE="ie",e.EDGE="edge",e.CHROME="chrome",e.FIREFOX="firefox",e.OPERA="opera",e.SAFARI="safari",e.NEW_EDGE="newEdge"}(ht||(ht={}));const mt=[[ht.ALIPAY,/alipay/],[ht.WECHAT,/micromessenger/],[ht.DING_TALK,/dingtalk[ \/]([\d_.]+)/],[ht.BAIDU_APP,/baiduboxapp/],[ht.BAIDU,/baidubrowser/],[ht.BAIDU,/bdbrowser/],[ht.UC,/ucbrowser/],[ht.UC,/ucweb/],[ht.QQ,/qqbrowser/],[ht.QQ_APP,/qq/],[ht.IE,/iemobile[ \/]([\d_.]+)/],[ht.IE,/msie[ \/]([\d_.]+)/],[ht.IE,/trident[ \/]([\d_.]+)/,4],[ht.EDGE,/edge[ \/]([\d_.]+)/],[ht.NEW_EDGE,/Edg[ \/]([\d_.]+)/],[ht.CHROME,/chrome[ \/]([\d_.]+)/],[ht.FIREFOX,/firefox[ \/]([\d_.]+)/],[ht.OPERA,/opera(?:.*version)?[ \/]([\d_.]+)/],[ht.SAFARI,/version[ \/]([\d_.]+) safari/],[ht.SAFARI,/version[ \/]([\d_.]+) \S* safari/],[ht.SAFARI,/safari/]],vt={},gt={};const _t=function(e){let t,i;return Pe(mt,n=>{let r=n[1].exec(e);if(r)return t=n[0],i=r[1],i&&(i=i.replace(/_/g,"."),n[2]&&(i=parseInt(i,10)+n[2]+".0")),!1}),{name:t||"",version:i||"",majorVersion:(vt[t]||pt)(i),checkVersion:gt[t]||ft}}((navigator.userAgent||"").toLowerCase());_t.name&&(_t[_t.name]=!0);var yt=_t,St=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};class Tt{constructor(e,t,i,n,r){this.uid=i,this.type=e,this.stream=r,this.webrtcType=n,this.iceStartTS=0,this.sid=t||function(){let e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){let i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?i:3&i|8).toString(16)}))}(),this.emitter=new Ke(!0),this.reportCollector=new Oe(2),this.audioTrackEventHandler={ended:()=>{this.fire(ve),ee(this.sid+" Stream audioTrack ended","s",this.uid)},mute:()=>{this.fire(_e),ee(this.sid+" Stream audioTrack mute","s",this.uid)},unmute:()=>{this.fire(Se),ee(this.sid+" Stream audioTrack unmute","s",this.uid)}},this.videoTrackEventHandler={ended:()=>{this.fire(me),ee(this.sid+" Stream videoTrack ended","s",this.uid)},mute:()=>{this.fire(ge),ee(this.sid+" Stream videoTrack mute","s",this.uid)},unmute:()=>{this.fire(ye),ee(this.sid+" Stream videoTrack unmute","s",this.uid)}},this.stream&&this.isLocalStream()&&this.addEvents(),this.debounceReplay=function(e,t,i){let n;return function(){let r=this;if(!n){const o=Ve(arguments);i&&ue(e,r,o),n=setTimeout((function(){n=ce.m,i||ue(e,r,o)}),t)}}}(()=>{this.playing&&this.player&&this.player.replay(this)},100),(this.isLocalStream()||c(this.webrtcType)||(yt.safari||yt.firefox)&&a(this.webrtcType))&&(this.soundMeter=new dt)}isStream(e){return this.stream===e}isLocalStream(){return this.type===Tt.STREAM_TYPE_LOCAL}isScreenStream(){return!1}isPlaying(){return this.playing}getWebRTCType(){return this.webrtcType}getUserId(){return this.uid}setUserId(e){this.uid=e}getStreamId(){return this.sid}setStreamId(e){this.sid=e}getStream(){return this.stream}setStream(e,t){this.removeEvents(),this.removeHandleEvents(),this.stream=t,this.webrtcType=e,this.isLocalStream()&&this.addEvents(),this.handleEvents(),this.playing&&this.player&&this.debounceReplay(),Z("setStream","s",this.uid)}getClient(){return this.client}setClient(e){this.client=e}setCollection(e){this.collection=e}getCollection(){return this.collection}setVolumeMeter(){this.audioTrack&&this.soundMeter&&this.soundMeter.connect(this.audioTrack)}hasVideo(){return!!this.videoTrack}hasAudio(){return!!this.audioTrack}getVideoOn(){if(a(this.webrtcType))return this.stream.getVideoEnable();if(c(this.webrtcType)){if(this.isLocalStream()&&this.videoTrack)return this.videoTrack.enabled;if(!this.isLocalStream()&&this.client){let e=!1;return Pe(this.client.getRemoteMutedState(),(t,i)=>{if(ae(t.userId)===this.getUserId())return e=!t.videoMuted,!1}),e}}return!1}getAudioOn(){if(a(this.webrtcType))return this.stream.getAudioEnable();if(c(this.webrtcType)){if(this.isLocalStream()&&this.audioTrack)return this.audioTrack.enabled;if(!this.isLocalStream()&&this.client){let e=!1;return Pe(this.client.getRemoteMutedState(),(t,i)=>{if(ae(t.userId)===this.getUserId())return e=!t.audioMuted,!1}),e}}return!1}get audioTrack(){return this.stream?this.stream.getAudioTrack():null}get videoTrack(){return this.stream?this.stream.getVideoTrack():null}getAudioTrack(){if(this.stream)return this.audioTrack}getVideoTrack(){if(this.stream)return this.videoTrack}getMediaStream(){if(this.stream)return a(this.webrtcType)?this.stream.getStream():c(this.webrtcType)?this.stream.mediaStream_:void 0}muteVideo(){return St(this,void 0,void 0,(function*(){if(this.hasVideo())try{return this.type===Tt.STREAM_TYPE_LOCAL?(a(this.webrtcType)?yield this.stream.muteVideo():c(this.webrtcType)&&this.stream.muteVideo(),this.fire(ge)):this.type===Tt.STREAM_TYPE_REMOTE&&this.playing&&this.player&&this.player.muteVideo(),this.reportAction("videoDisable",0,null,null,{stream:a(this.webrtcType)?this.getStreamId():Object(F.a)(this.getUserId())}),!0}catch(e){return this.reportAction("videoDisable",9e3,null,null,{stream:a(this.webrtcType)?this.getStreamId():Object(F.a)(this.getUserId())},Ae(e)),!1}return!1}))}unmuteVideo(){return St(this,void 0,void 0,(function*(){if(this.hasVideo())try{return this.type===Tt.STREAM_TYPE_LOCAL?(a(this.webrtcType)?yield this.stream.unmuteVideo():c(this.webrtcType)&&this.stream.unmuteVideo(),this.fire(ye)):this.type===Tt.STREAM_TYPE_REMOTE&&this.playing&&this.player&&this.player.unmuteVideo(),this.reportAction("videoEnable",0,null,null,{stream:a(this.webrtcType)?this.getStreamId():Object(F.a)(this.getUserId())}),!0}catch(e){return this.reportAction("videoEnable",9e3,null,null,{stream:a(this.webrtcType)?this.getStreamId():Object(F.a)(this.getUserId())},Ae(e)),!1}return!1}))}muteAudio(){return St(this,void 0,void 0,(function*(){if(this.hasAudio())try{return this.type===Tt.STREAM_TYPE_LOCAL?(a(this.webrtcType)?yield this.stream.muteAudio():c(this.webrtcType)&&this.stream.muteAudio(),this.fire(_e)):this.type===Tt.STREAM_TYPE_REMOTE&&this.playing&&this.player&&this.player.muteAudio(),this.reportAction("audioDisable",0,null,null,{stream:a(this.webrtcType)?this.getStreamId():Object(F.a)(this.getUserId())}),!0}catch(e){return this.reportAction("audioDisable",9e3,null,null,{stream:a(this.webrtcType)?this.getStreamId():Object(F.a)(this.getUserId())},Ae(e)),!1}return!1}))}unmuteAudio(){return St(this,void 0,void 0,(function*(){if(this.hasAudio())try{return this.type===Tt.STREAM_TYPE_LOCAL?(a(this.webrtcType)?yield this.stream.unmuteAudio():c(this.webrtcType)&&this.stream.unmuteAudio(),this.fire(Se)):this.type===Tt.STREAM_TYPE_REMOTE&&this.playing&&this.player&&this.player.unmuteAudio(),this.reportAction("audioEnable",0,null,null,{stream:a(this.webrtcType)?this.getStreamId():Object(F.a)(this.getUserId())}),!0}catch(e){return this.reportAction("audioEnable",9e3,null,null,{stream:a(this.webrtcType)?this.getStreamId():Object(F.a)(this.getUserId())},Ae(e)),!1}return!1}))}play(e,t){return St(this,void 0,void 0,(function*(){if(t=Object.assign({fit:"contain",muted:!1},t||{}),!this.stream)throw new y(1002,"没有流可以播放");this.playing&&te(this.sid+" stream is already playing","s",this.uid,[]),s.i(e)&&(e=document.querySelector("#"+e)),this.player=new we(e,t),this.playing=!0;try{yield this.player.play(this)}catch(e){throw ie(this.sid+" stream play error","s",this.uid,[e]),e}Z(this.sid+" stream play","s",this.uid,[e,t])}))}replay(){return St(this,void 0,void 0,(function*(){if(!this.stream)throw new y(1002,"没有流可以播放");this.playing&&this.player||te(this.sid+" stream is not playing","s",this.uid,[]),yield this.player.replay(this)}))}resume(){return St(this,void 0,void 0,(function*(){if(this.player){try{yield this.player.resume(),this.playing=!0}catch(e){throw e}Z(this.sid+" stream resume","s",this.uid)}this.soundMeter&&this.soundMeter.resume()}))}stop(){this.player&&(this.player.destroy(),this.player=null,Z(this.sid+" stream stop","s",this.uid)),this.playing=!1}close(){this.stop(),this.stream&&(a(this.webrtcType)?this.stream.destroy():c(this.webrtcType)&&this.stream.close(),Z(this.sid+" stream close","s",this.uid))}destroy(){this.stream&&(this.close(),this.removeHandleEvents(),this.removeEvents(),this.stream=null,this.client=null,this.stutter&&(this.stutter.destroy(),this.stutter=null),this.reportCollector&&(this.reportCollector.destroy(),this.reportCollector=null),this.emitter&&this.emitter.off(),Z(this.sid+" stream destroy","s",this.uid)),this.soundMeter&&this.soundMeter.destroy()}getAudioLevel(){if(!this.stream)return 0;const e=this.stream.getAudioLevel();return e||(this.soundMeter?this.soundMeter.getVolume():0)}fire(e,t){this.emitter.fire(e,t?[t]:void 0)}on(e,t){return this.emitter.on(e,{fn:t,ctx:this}),this}one(e,t){return this.emitter.on(e,{fn:t,ctx:this,max:1}),this}off(e,t){return this.emitter.off(e,t),this}getAudioDeviceId(){return this.audioDeviceId}getAudioVolume(){return this.audioVolume}getVideoFrame(){if(this.hasVideo()&&this.player&&this.playing)return this.player.getVideoFrame();throw new y(1002,"流没有 videoTrack 或者没有播放")}getMSIP(){return a(this.webrtcType)&&this.stream&&this.stream.getMsmsIP()||""}setICEStartTS(e){this.iceStartTS=e}addEvents(){this.addAudioTrackEvents(),this.addVideoTrackEvents()}removeEvents(){this.removeAudioTrackEvents(),this.removeVideoTrackEvents()}addVideoTrackEvents(){this.hasVideo()&&this.videoTrack&&qe(this.videoTrackEventHandler,(e,t)=>{this.videoTrack.addEventListener(t,e)})}removeVideoTrackEvents(){this.hasVideo()&&this.videoTrack&&qe(this.videoTrackEventHandler,(e,t)=>{this.videoTrack.removeEventListener(t,e)})}addAudioTrackEvents(){this.hasAudio()&&this.audioTrack&&qe(this.audioTrackEventHandler,(e,t)=>{this.audioTrack.addEventListener(t,e)})}removeAudioTrackEvents(){this.stream&&this.stream._volumeMeter&&(this.stream._volumeMeter.disconnect(),this.stream._volumeMeter=null),this.hasAudio()&&this.audioTrack&&qe(this.audioTrackEventHandler,(e,t)=>{this.audioTrack.removeEventListener(t,e)})}removeHandleEvents(){this.stream&&a(this.webrtcType)&&this.stream.off()}handleEvents(){this.stream&&a(this.webrtcType)&&(this.stream.on("stream-connection-error",()=>{this.stream&&this.fire(be);const e={stream:this.getStreamId(),flow:this.type===Tt.STREAM_TYPE_LOCAL?1:2};this.type===Tt.STREAM_TYPE_LOCAL?e.user=Object(F.a)(this.getUserId()):e.remote_id=Object(F.a)(this.getUserId()),this.reportAction("mediaChannelDisconnect",4003,null,null,e)}),this.stream.on("stream-disconnected",()=>{this.stream&&this.fire(be);const e={stream:this.getStreamId(),flow:this.type===Tt.STREAM_TYPE_LOCAL?1:2};this.type===Tt.STREAM_TYPE_LOCAL?e.user=Object(F.a)(this.getUserId()):e.remote_id=Object(F.a)(this.getUserId()),this.reportAction("mediaChannelDisconnect",4003,null,null,e)}),this.stream.on("stream-connection-success",()=>{const e={stream:this.getStreamId(),flow:this.type===Tt.STREAM_TYPE_LOCAL?1:2};this.type===Tt.STREAM_TYPE_LOCAL?e.user=Object(F.a)(this.getUserId()):e.remote_id=Object(F.a)(this.getUserId()),this.reportAction("mediaChannelConnect",0,this.iceStartTS,fe(),e)}),this.stream.on("stream-replaced",e=>{this.stream&&this.player&&this.player&&this.player.replay(this,!!e.video,!!e.audio),e.video&&this.fire(Te,{type:"video",track:e.video}),e.audio&&this.fire(Te,{type:"audio",track:e.audio})}),this.stream.on("video-adaptation-changed",e=>{this.reportAction("videoAdaptationChanged",0,null,null,{stream:this.getStreamId(),adaptation:JSON.stringify(e)})}))}reportAction(e,t,i,n,r,o){this.collection&&this.collection.action(e,t,i,n,r,o)}getAudioRTPStats(e){if(!e)return{};for(let t=0;t<e.rtps.length;t++)if("audio"===e.rtps[t].kind)return e.rtps[t]}getVideoRTPStats(e,t=!0){var i,n,r,o,s,a,c,u;if(e){let d;for(let l=0;l<e.rtps.length;l++)if("video"===e.rtps[l].kind){if(t&&"r1"===e.rtps[l].rid)return e.rtps[l];if(!t&&"r0"===e.rtps[l].rid)return e.rtps[l];d?t?((null===(i=d.resolution)||void 0===i?void 0:i.width)<(null===(n=e.rtps[l].resolution)||void 0===n?void 0:n.width)||(null===(r=d.resolution)||void 0===r?void 0:r.height)<(null===(o=e.rtps[l].resolution)||void 0===o?void 0:o.height))&&(d=e.rtps[l]):((null===(s=d.resolution)||void 0===s?void 0:s.width)>(null===(a=e.rtps[l].resolution)||void 0===a?void 0:a.width)||(null===(c=d.resolution)||void 0===c?void 0:c.height)>(null===(u=e.rtps[l].resolution)||void 0===u?void 0:u.height))&&(d=e.rtps[l]):d=e.rtps[l]}return d}return{}}}Tt.STREAM_TYPE_LOCAL=0,Tt.STREAM_TYPE_REMOTE=1;class Et{constructor(e,t=6){this.win=t,this.threshold=e,this.packetLoss=new De(this.win)}add(e,t){this.packetLoss.addData(e,t)}judge(){return this.packetLoss.getPacketLossRate()>this.threshold}getAvgLoss(){return this.packetLoss.getPacketLossRate()}destroy(){this.win=this.threshold=this.packetLoss=null}}class bt{constructor(e,t=6){this.win=t,this.threshold=e,this.queue=[],this.maxFrameRate=0}updateMaxFrameRate(e){e>this.maxFrameRate&&(this.maxFrameRate=e)}add(e){this.updateMaxFrameRate(e),this.queue.push(e),this.queue.length>this.win&&this.queue.shift()}judge(){if(!this.queue.length)return!1;const e=this.queue.reduce((e,t)=>e+t,0);return this.maxFrameRate<=5?e/this.queue.length<=Math.floor(.4*this.maxFrameRate):e/this.queue.length<=this.threshold}destroy(){this.win=this.threshold=this.queue=null}}class Rt{constructor(e,t=6){this.win=t,this.threshold=e,this.delayInvalidCount=0}add(e){-1===e||e>this.threshold?this.delayInvalidCount++:this.delayInvalidCount=0}judge(){return this.delayInvalidCount>this.win}destroy(){this.win=this.threshold=this.delayInvalidCount=null}}class It{constructor(e=1,t=48e3){this.channel=e,this.sampleRate=t,this.concealedSamples=0,this.totalSamplesReceived=0,this.concealmentEvents=0,this.totalAudioEnergy=0,this.totalSamplesDuration=0,this.silentConcealedSamples=0,this.samplesFactor=0,this.eventFactor=0,this.level=0,this.slientPercent=0}add(e,t,i,n,r,o){t!==this.totalSamplesReceived?this.samplesFactor=(e-this.concealedSamples)/(t-this.totalSamplesReceived):this.samplesFactor=0,i!==this.concealmentEvents?(this.eventFactor=(e-this.concealedSamples)/(i-this.concealmentEvents),this.eventFactor=1e3*this.eventFactor/(this.channel*this.sampleRate)):this.eventFactor=0,r!==this.totalSamplesDuration?this.level=(n-this.totalAudioEnergy)/(r-this.totalSamplesDuration):this.level=0,e&&(this.slientPercent=o/e),this.concealedSamples=e,this.totalSamplesReceived=t,this.concealmentEvents=i,this.totalAudioEnergy=n,this.totalSamplesDuration=r,this.silentConcealedSamples=o}judge(){return this.eventFactor>80||this.samplesFactor>.2}}class kt{constructor(e,t,i={}){this.threshold=e,this.isPush=t,this.options=i,this.audioPacketLossStutter=new Et(t?this.threshold.audio_loss_rate_threshold:this.threshold.down_audio_loss_rate_threshold),this.videoPacketLossStutter=new Et(t?this.threshold.video_loss_rate_threshold:this.threshold.down_video_loss_rate_threshold),this.frameRateStutter=new bt(this.threshold.send_frame_rate_threshold),this.audioframeDelayStutter=new Rt(this.threshold.audio_frame_render_interval_threshold),this.videoframeDelayStutter=new Rt(this.threshold.video_frame_render_interval_threshold),yt.chrome&&(this.audioStutter=new It(this.options.channel,this.options.sampleRate))}addFrameRate(e){this.frameRateStutter.add(e)}addAudioLoss(e,t){this.audioPacketLossStutter.add(e,t)}addVideoLoss(e,t){this.videoPacketLossStutter.add(e,t)}addAudioFrameDelay(e){this.audioframeDelayStutter.add(e)}addVideoFrameDelay(e){this.videoframeDelayStutter.add(e)}addAudioStutterData(e,t,i,n,r,o){this.audioStutter&&this.audioStutter.add(e,t,i,n,r,o)}judgeAudioStutter(){return!this.isPush&&this.audioStutter?this.audioStutter.judge():this.audioPacketLossStutter.judge()||this.audioframeDelayStutter.judge()}judegVideoStutter(){return this.videoPacketLossStutter.judge()||this.frameRateStutter.judge()&&this.videoPacketLossStutter.getAvgLoss()>10||this.videoframeDelayStutter.judge()}destroy(){this.audioPacketLossStutter.destroy(),this.videoPacketLossStutter.destroy(),this.frameRateStutter.destroy(),this.audioframeDelayStutter.destroy(),this.videoframeDelayStutter.destroy(),this.audioPacketLossStutter=this.videoPacketLossStutter=this.audioframeDelayStutter=this.videoframeDelayStutter=this.frameRateStutter=this.audioStutter=null}}var wt=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};class Ct extends Tt{constructor(e,t,i,n){super(Tt.STREAM_TYPE_REMOTE,n,e,t,i),this.audioVolume=1,a(this.webrtcType)&&this.handleEvents(),this.subscribed=!1,this.unpublished=!1,Z(this.sid+" RemoteStream create","s",this.uid)}isSubscribed(){return this.subscribed}isUnpublish(){return this.unpublished}getType(){var e;if(a(this.webrtcType))return/assist/.test(this.sid)?"assist":"main";if(c(this.webrtcType)){return"auxiliary"===(null===(e=this.stream)||void 0===e?void 0:e.getType())?"assist":"main"}}setAudioOutput(e){return wt(this,void 0,void 0,(function*(){this.audioDeviceId=e,this.stream&&this.playing&&this.player&&(yield this.player.setSinkId(this.audioDeviceId),this.reportAction("deviceChange",0,null,null,{type:"speaker",device_id:e,stream:this.getStreamId()}),ee(this.sid+" RemoteStream setAudioOutput","s",this.uid,[e]))}))}setAudioVolume(e){this.audioVolume=e,this.playing&&this.player&&(this.player.setVolume(this.audioVolume),ee(this.sid+" RemoteStream setAudioVolume","s",this.uid,[e]))}play(e,t={}){const i=Object.create(null,{play:{get:()=>super.play}});return wt(this,void 0,void 0,(function*(){this.audioDeviceId&&this.setAudioOutput(this.audioDeviceId);try{yield i.play.call(this,e,t),t.muted||this.setAudioVolume(this.audioVolume)}catch(e){throw e}}))}getStats(){return wt(this,void 0,void 0,(function*(){if(this.client){if(a(this.webrtcType)){let e=this.stream.getStats();const t=this.getAudioRTPStats(e),i=this.getVideoRTPStats(e);return{videoBytesReceived:ze(i,"statistics.bytesReceived",0),videoPacketsReceived:ze(i,"statistics.packetsReceived",0),videoPacketsLost:ze(i,"statistics.packetsLost",0),audioBytesReceived:ze(t,"statistics.bytesReceived",0),audioPacketsReceived:ze(t,"statistics.packetsReceived",0),audioPacketsLost:ze(t,"statistics.packetsLost",0),width:ze(i,"resolution.width",0),height:ze(i,"resolution.height",0),rtt:ze(e,"transport.0.rtt",0),framesDecoded:ze(i,"statistics.framesDecoded",0)}}if(c(this.webrtcType)){let e=yield this.client.getRemoteVideoStats();if(!this.client)throw new y(1010,"已被取消订阅");let t=yield this.client.getRemoteAudioStats();if(!this.client)throw new y(1010,"已被取消订阅");let i=yield this.client.getTransportStats(),n=e[this.uid],r=t[this.uid];return{videoBytesReceived:ze(n,"bytesReceived",0),videoPacketsReceived:ze(n,"packetsReceived",0),videoPacketsLost:ze(n,"packetsLost",0),audioBytesReceived:ze(r,"bytesReceived",0),audioPacketsReceived:ze(r,"packetsReceived",0),audioPacketsLost:ze(r,"packetsLost",0),width:ze(n,"frameWidth",0),height:ze(n,"frameHeight",0),rtt:ze(i,"rtt",0),framesDecoded:ze(n,"framesDecoded",0)}}}return{}}))}getReportStats(e){var t,i;return wt(this,void 0,void 0,(function*(){if(!this.stutter){const n=this.getAudioTrack(),r={};if(n&&s.d(n.getSettings)){const e=n.getSettings();r.channels=null!==(t=e.channelCount)&&void 0!==t?t:1,r.sampleRate=null!==(i=e.sampleRate)&&void 0!==i?i:48e3}this.stutter=new kt(e,!1,r)}let n={bandwidth:{upload:0,download:0},bitrate:{audio:{upload:0,download:0},video:{upload:0,download:0}},packetLoss:{audio:{upload:0,download:0},video:{upload:0,download:0}},resolution:{width:0,height:0},framerate:0,audioLevel:0,transport:[{ip:"",type:"",localIp:"",localCandidateType:"",remoteCandidateType:"",networkType:"",rtt:0}],quality:{audio:{jitter:0,interruptionCount:0,interruptionDuration:0},video:{jitter:0,interruptionCount:0,interruptionDuration:0}},statistics:{audio:{bytesReceived:0,bytesSent:0,packetsReceived:0,packetsSent:0,packetsLost:0},video:{bytesReceived:0,bytesSent:0,packetsReceived:0,packetsSent:0,packetsLost:0,framesEncoded:0,framesDecoded:0,framesSent:0},bweforvideo:{googAvailableReceiveBandwidth:0,googAvailableSendBandwidth:0,googRetransmitBitrate:0,googTransmitBitrate:0,googTargetEncBitrate:0}},cpu:{appCpu:0,systemCpu:0}};if(this.client)if(a(this.webrtcType)){let e=this.stream.getStats();const t=this.getAudioRTPStats(e),i=this.getVideoRTPStats(e);n.audioLevel=this.getAudioLevel(),e.bandwidth&&(n.bandwidth=e.bandwidth),e.bitrate&&(n.bitrate=e.bitrate),e.packetLoss&&(n.packetLoss=e.packetLoss),e.transport&&(n.transport=e.transport),e.bweforvideo&&(n.statistics.bweforvideo={googAvailableReceiveBandwidth:e.bweforvideo.availableReceiveBandwidth,googAvailableSendBandwidth:e.bweforvideo.availableSendBandwidth,googRetransmitBitrate:e.bweforvideo.retransmitBitrate,googTransmitBitrate:e.bweforvideo.transmitBitrate,googTargetEncBitrate:e.bweforvideo.targetEncBitrate}),t&&(n.quality.audio=t.qa,n.statistics.audio=t.statistics),i&&(n.quality.video=i.qa,n.statistics.video=i.statistics,n.resolution=i.resolution,n.framerate=i.framerate),this.stutter.addFrameRate(ze(n,"framerate",0)),this.stutter.addVideoLoss(ze(n,"statistics.video.packetsReceived",0),ze(n,"statistics.video.packetsLost",0)),this.stutter.addAudioLoss(ze(n,"statistics.audio.packetsReceived",0),ze(n,"statistics.audio.packetsLost",0)),this.stutter.addAudioFrameDelay(ze(n,"quality.audio.frameDelay",0)),this.stutter.addVideoFrameDelay(ze(n,"quality.video.frameDelay",0)),this.stutter.addAudioStutterData(ze(n,"statistics.audio.concealedSamples",0),ze(n,"statistics.audio.totalSamplesReceived",0),ze(n,"statistics.audio.concealmentEvents",0),ze(n,"statistics.audio.totalAudioEnergy",0),ze(n,"statistics.audio.totalSamplesDuration",0),ze(n,"statistics.audio.silentConcealedSamples",0)),!this.firstAudioShow&&ze(n,"statistics.audio.packetsReceived",0)>0&&(this.reportAction("firstAudioPlay",0,null,null,{stream:this.getStreamId(),duration:Math.max(le()-this.subscribeTS,0),remote_id:Object(F.a)(this.getUserId()),has_player:!!this.player,speaker_device_id:this.audioDeviceId||"default"}),this.firstAudioShow=!0),!this.firstVideoShow&&ze(n,"statistics.video.framesDecoded",0)>0&&(this.reportAction("firstVideoShow",0,null,null,{stream:this.getStreamId(),duration:Math.max(le()-this.subscribeTS,0),remote_id:Object(F.a)(this.getUserId()),has_player:!!this.player}),this.firstVideoShow=!0)}else{let e=yield this.client.getRemoteVideoStats();if(!this.client)throw new y(1010,"已被取消订阅");let t=yield this.client.getRemoteAudioStats();if(!this.client)throw new y(1010,"已被取消订阅");let i=yield this.client.getTransportStats(),r=e[this.uid],o=t[this.uid];this.reportCollector.addData(ze(o,"bytesReceived",0),ze(r,"bytesReceived",0),ze(o,"packetsReceived",0),ze(o,"packetsLost",0),ze(r,"packetsReceived",0),ze(r,"packetsLost",0),ze(r,"framesDecoded",0)),n.bitrate.audio.download=this.reportCollector.getAudioBitrate(),n.bitrate.video.download=this.reportCollector.getVideoBitrate(),n.packetLoss.audio.download=this.reportCollector.getAudioPacketLoss(),n.packetLoss.video.download=this.reportCollector.getVideoPacketLoss(),n.framerate=this.reportCollector.getFrameRate(),n.resolution.width=ze(r,"frameWidth",0),n.resolution.height=ze(r,"frameHeight",0),n.transport[0].rtt=Math.round(ze(i,"rtt",0)),n.audioLevel=this.getAudioLevel(),n.bandwidth.download=this.reportCollector.getAudioBitrate()+this.reportCollector.getVideoBitrate(),n.statistics.audio.bytesReceived=ze(o,"bytesReceived",0),n.statistics.audio.packetsReceived=ze(o,"packetsReceived",0),n.statistics.audio.packetsLost=ze(o,"packetsLost",0),n.statistics.video.bytesReceived=ze(r,"bytesReceived",0),n.statistics.video.packetsReceived=ze(r,"packetsReceived",0),n.statistics.video.framesDecoded=ze(r,"framesDecoded",0),n.statistics.video.packetsLost=ze(r,"packetsLost",0),this.stutter.addFrameRate(n.framerate),this.stutter.addVideoLoss(n.statistics.video.packetsReceived,n.statistics.video.packetsLost),this.stutter.addAudioLoss(n.statistics.audio.packetsReceived,n.statistics.audio.packetsLost),!this.firstAudioShow&&ze(o,"packetsReceived",0)>0&&(this.reportAction("firstAudioPlay",0,null,null,{stream:Object(F.a)(this.getUserId()),duration:Math.max(le()-this.subscribeTS,0),remote_id:Object(F.a)(this.getUserId()),has_player:!!this.player,speaker_device_id:this.audioDeviceId||"default"}),this.firstAudioShow=!0),!this.firstVideoShow&&ze(r,"framesDecoded",0)>0&&(this.reportAction("firstVideoShow",0,null,null,{stream:Object(F.a)(this.getUserId()),duration:Math.max(le()-this.subscribeTS,0),remote_id:Object(F.a)(this.getUserId()),has_player:!!this.player}),this.firstVideoShow=!0)}return n}))}getExtraReport(){if(this.stutter){const e=this.stutter.judgeAudioStutter(),t=this.stutter.judegVideoStutter();return{event:e||t?1:0,audio_stutter:this.getAudioOn()&&e?1:0,video_stutter:this.getVideoOn()&&t?1:0,downLink:0}}}onSubscribe(e){this.firstVideoShow=!1,this.firstAudioShow=!1,this.subscribeTS=le(),this.addEvents(),a(this.webrtcType)&&(this.mediaUpdateHandler||(this.mediaUpdateHandler=()=>{if(!this.stream)return;const t=this.stream.getVideoEnable(),i=this.stream.getAudioEnable();if(t!==this.videoOn){const i=t?k:I;ee("client event "+i,"c",this.getUserId()),e.fire(i,{stream:this})}if(i!==this.audioOn){const t=i?C:w;ee("client event "+t,"c",this.getUserId()),e.fire(t,{stream:this})}this.videoOn=t,this.audioOn=i}),this.videoOn=this.stream.getVideoEnable(),this.audioOn=this.stream.getAudioEnable(),this.stream.on("stream-update",this.mediaUpdateHandler)),this.subscribed=!0,this.player&&this.playing&&this.replay(),this.setVolumeMeter()}onUnsubscribe(){a(this.webrtcType)&&(this.stream&&this.mediaUpdateHandler&&this.stream.off("update",this.mediaUpdateHandler),this.mediaUpdateHandler=null,this.videoOn=!1,this.audioOn=!1),this.removeEvents(),this.subscribed=!1}setUnpublish(){this.unpublished=!0}}var At=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};const Dt=[S,T,E,b,R,I,k,w,C,A,D,O,P,x,M,L,N],Ot={1:{[S]:"stream-added",[T]:"stream-removed",[E]:"stream-updated",[b]:"",[R]:"stream-subscribed",[I]:"mute-video",[k]:"unmute-video",[w]:"mute-audio",[C]:"unmute-audio",[D]:"peer-join",[O]:"peer-leave",[P]:"client-banned",[A]:"error"},0:{[S]:"stream-added",[T]:"stream-removed",[E]:"",[b]:"",[R]:"",[I]:"",[k]:"",[w]:"",[C]:"",[A]:"error",[D]:"peer-joined",[O]:"peer-leaved",[P]:"peer-rejoined",[x]:"evicted",[M]:"token-will-expire",[L]:"token-expire",[N]:"room-closed"}},Pt={0:{[S]:function(e){let t=new Ct(ae(e.getUserId()),this.webrtcType,e,e.getStreamId());return this.addRemoteStream(t,e.getUserId()),ee(""+S,"c",t.getUserId()),{stream:t}},[T]:function(e){let t=this.removeRemoteStream(e.getUserId());return t||(t=new Ct(ae(e.getUserId()),this.webrtcType,null,null)),t.setUnpublish(),ee(""+T,"c",t.getUserId()),{stream:t}},[A]:function(e){let t=4002;return"error-room"===e&&(t=4001),this.reportAction("signalChannelDisconnect",t),ie(""+A,"c",null,[t]),new y(t)},[D]:function(e){const t=ae(e);return ee(""+D,"c",t),{userId:t}},[O]:function(e){let t=this.removeRemoteStream(e);t&&t.setUnpublish();const i=ae(e);return ee(""+O,"c",i),{userId:i}},[P]:function(e){return At(this,void 0,void 0,(function*(){try{yield this.leave("rejoined")}catch(e){}return ie(""+P,"c"),(null==e?void 0:e.userId)&&(e.userId=lt(e.userId)),e}))},[x]:function(e){return At(this,void 0,void 0,(function*(){try{yield this.leave("evicted")}catch(e){}return ie(""+x,"c"),new y(4009)}))},[M]:function(e){return te(""+M,"c"),{seconds:e.seconds}},[L]:function(e){return At(this,void 0,void 0,(function*(){try{yield this.leave("token_expire")}catch(e){}return ie(""+L,"c"),new y(5002)}))},[N]:function(e){return At(this,void 0,void 0,(function*(){try{yield this.leave("room_close")}catch(e){}return ie(""+N,"c"),new y(5003)}))}},1:{[S]:function(e){let t=new Ct(ae(e.stream.getUserId()),this.webrtcType,e.stream);return this.addRemoteStream(t,t.getUserId()),ee(""+S,"c",t.getUserId()),{stream:t}},[T]:function(e){let t=this.removeRemoteStream(e.stream.getUserId());return t||(t=new Ct(ae(e.stream.getUserId()),this.webrtcType,e.stream)),t.setUnpublish(),ee(""+T,"c",t.getUserId()),{stream:t}},[E]:function(e){let t=this.getRemoteStream(e.stream.getUserId());return!!t&&(t.setStream(this.webrtcType,e.stream),ee(""+E,"c",t.getUserId()),{stream:t})},[R]:function(e){let t=this.getRemoteStream(e.stream.getUserId());return t.setStream(this.webrtcType,e.stream),ee(""+R,"c",t.getUserId()),{stream:t}},[I]:function(e){let t=this.getRemoteStream(e.userId);return!!t&&(ee(""+I,"c",t.getUserId()),{stream:t})},[k]:function(e){let t=this.getRemoteStream(e.userId);return!!t&&(ee(""+k,"c",t.getUserId()),{stream:t})},[w]:function(e){let t=this.getRemoteStream(e.userId);return!!t&&(ee(""+w,"c",t.getUserId()),{stream:t})},[C]:function(e){let t=this.getRemoteStream(e.userId);return!!t&&(ee(""+C,"c",t.getUserId()),{stream:t})},[A]:function(e){let t=9e3;return/DTLS Transport connection timeout/i.test(e)&&(t=4002),this.reportAction("signalChannelDisconnect",t),ie(""+C,"c",null,[t]),new y(t,null,e)},[D]:function(e){const t=ae(e.userId);return ee(""+D,"c",t),{userId:t}},[O]:function(e){let t=this.removeRemoteStream(e.userId);t&&t.setUnpublish();const i=ae(e.userId);return ee(""+O,"c",i),{userId:i}},[P]:function(e){return At(this,void 0,void 0,(function*(){let t=(e.message||"").indexOf("account admin")>-1?"evicted":"rejoined";try{yield this.leave(t)}catch(e){}return ie(""+P,"c",null,[t]),"rejoined"===t?new y(4005):[x,new y(4009)]}))}}};class xt{constructor(e=0){this.code=65535&e}enableAuth(){return!!(1&this.code)}canPushAudio(){return!!(2&this.code)}canPushVideo(){return!!(4&this.code)}canUseWhiteboard(){return!!(8&this.code)}}const Mt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function Lt(e){let t,i,n,r,o,s,a,c="",u=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");e.length%4;)e+="=";for(;u<e.length;)r=Mt.indexOf(e.charAt(u++)),o=Mt.indexOf(e.charAt(u++)),s=Mt.indexOf(e.charAt(u++)),a=Mt.indexOf(e.charAt(u++)),t=r<<2|o>>4,i=(15&o)<<4|s>>2,n=(3&s)<<6|a,c+=String.fromCharCode(t),64!==s&&(c+=String.fromCharCode(i)),64!==a&&(c+=String.fromCharCode(n));return function(e){let t="",i=0,n=0,r=0,o=0;for(;i<e.length;)n=e.charCodeAt(i),n<128?(t+=String.fromCharCode(n),i++):n>191&&n<224?(r=e.charCodeAt(i+1),t+=String.fromCharCode((31&n)<<6|63&r),i+=2):(r=e.charCodeAt(i+1),o=e.charCodeAt(i+2),t+=String.fromCharCode((15&n)<<12|(63&r)<<6|63&o),i+=3);return t}(c)}const Nt={"120p":{width:160,height:120,frameRate:15,bitrate:100},"180p":{width:320,height:180,frameRate:15,bitrate:200},"240p":{width:320,height:240,frameRate:15,bitrate:200},"360p":{width:640,height:360,frameRate:15,bitrate:400},"480p":{width:640,height:480,frameRate:15,bitrate:500},"720p":{width:1280,height:720,frameRate:15,bitrate:1e3},"1080p":{width:1920,height:1080,frameRate:15,bitrate:2e3},"1440p":{width:2560,height:1440,frameRate:30,bitrate:4680},"4k":{width:3840,height:2160,frameRate:30,bitrate:9e3}},Ut={1:{standard:{sampleRate:48e3,channelCount:1,bitrate:40},high:{sampleRate:48e3,channelCount:1,bitrate:192},"standard-stereo":{sampleRate:48e3,channelCount:2,bitrate:64},"high-stereo":{sampleRate:48e3,channelCount:2,bitrate:192}},0:{standard:{sampleRate:48e3,channelCount:1,bitrate:40},high:{sampleRate:48e3,channelCount:1,bitrate:128},"standard-stereo":{sampleRate:48e3,channelCount:2,bitrate:64},"high-stereo":{sampleRate:48e3,channelCount:2,bitrate:192}}},Vt={"480p":{width:640,height:480,frameRate:5,bitrate:500},"480p_2":{width:640,height:480,frameRate:30,bitrate:600},"720p":{width:1280,height:720,frameRate:5,bitrate:800},"720p_2":{width:1280,height:720,frameRate:30,bitrate:2e3},"1080p":{width:1920,height:1080,frameRate:5,bitrate:1200},"1080p_2":{width:1920,height:1080,frameRate:30,bitrate:3e3}},Ft={19200:{max:300,min:30},76800:{max:500,min:50},307200:{max:1e3,min:100},921600:{max:3e3,min:300},2073600:{max:5e3,min:500},3686400:{max:8e3,min:1e3},8294400:{max:15e3,min:3e3}},jt={bitrate:70,height:120,width:160};function Bt(e,t,i,n){if(!s.f(t)||!s.f(i)||0===t||0===i)return e;const r=e.getVideoTracks()[0];if(!r||"function"!=typeof r.getCapabilities)return e;const o=r.getConstraints();return o.frameRate=n||o.frameRate,r.applyConstraints(o),e}const Ht=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices):navigator&&navigator.getUserMedia?navigator.getUserMedia.bind(window.navigator):null;var Gt=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};const qt=navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia?navigator.mediaDevices.getDisplayMedia.bind(navigator.mediaDevices):navigator&&navigator.getDisplayMedia?navigator.getDisplayMedia.bind(window.navigator):null;var Jt=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};function Wt(e){return Jt(this,void 0,void 0,(function*(){if(!qt)throw new Error("not support");const t={video:{frameRate:e.fps},audio:!!e.audio},i=yield qt(t);return s.c(e.video)?i:s.h(e.video)?Bt(i,e.video.width,e.video.height,e.fps):i}))}var zt=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};var $t=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};var Kt=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};function Yt(e){return Kt(this,void 0,void 0,(function*(){if(e.screen){if(yt.chrome){if(yt.checkVersion(yt.majorVersion,"72",!0))return yield Wt(e);if(yt.checkVersion(yt.majorVersion,"55"))return yield function(e){return $t(this,void 0,void 0,(function*(){throw new Error("not support")}))}()}else{if(yt.firefox&&yt.checkVersion(yt.majorVersion,"60",!0))return yield function(e){return zt(this,void 0,void 0,(function*(){if(!Ht)throw new Error("not support");const t={video:{mediaSource:"window",width:null,height:null,frameRate:null},audio:!!e.audio};s.i(e.mediaSource)&&(t.video.mediaSource=e.mediaSource),!s.c(e.video)&&s.f(e.video.width)&&e.video.width>0&&(t.video.width={min:e.video.width,max:e.video.width}),!s.c(e.video)&&s.f(e.video.height)&&e.video.height>0&&(t.video.height={min:e.video.height,max:e.video.height}),s.f(e.fps)&&e.fps>0&&(t.video.frameRate={min:e.fps,max:e.fps});const i=yield Ht(t);return s.c(e.video)?i:Bt(i,e.video.width,e.video.height,e.fps)}))}(e);if(yt.edge&&yt.checkVersion(yt.majorVersion,"11"))return yield Wt(e)}throw new Error("not support")}return yield function(e){return Gt(this,void 0,void 0,(function*(){if(!Ht)throw new Error("not support");!s.c(e.video)&&s.i(e.video.deviceId)&&(e.video.deviceId={exact:e.video.deviceId}),!s.c(e.audio)&&s.i(e.audio.deviceId)&&(e.audio.deviceId={exact:e.audio.deviceId});const t=yield Ht(e);return s.c(e.video)?t:s.h(e.video)?Bt(t,e.video.width,e.video.height,e.fps):t}))}(e)}))}function Qt(){let e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){let i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?i:3&i|8).toString(16)}))}class Xt extends Ke{constructor(e){var t,i,n,r,o;super(!0),this.client=e.client,this.userId=e.userId,this.streamId=null!==(t=e.streamId)&&void 0!==t?t:Qt(),this.videoOn=null!==(i=e.videoOn)&&void 0!==i&&i,this.audioOn=null!==(n=e.audioOn)&&void 0!==n&&n,this.videoEnable=null!==(r=e.videoEnable)&&void 0!==r&&r,this.audioEnable=null!==(o=e.audioEnable)&&void 0!==o&&o,this.msms=""}getUserId(){return this.userId}getStreamId(){return this.streamId}hasVideo(){return this.videoOn}hasAudio(){return this.audioOn}getVideoEnable(){return this.videoEnable}getAudioEnable(){return this.audioEnable}getMsmsIP(){return this.msms}update(e){s.c(e.videoOn)&&(this.videoOn=e.videoOn),s.c(e.audioOn)&&(this.audioOn=e.audioOn),s.c(e.video_enable)&&(this.videoEnable=e.video_enable),s.c(e.audio_enable)&&(this.audioEnable=e.audio_enable),this.fire("stream-update")}getVideoTrack(){const e=this.getStream();if(e)return e.getVideoTracks()[0]}getAudioTrack(){const e=this.getStream();if(e)return e.getAudioTracks()[0]}getValueFromStats(e,t){if(this.stats)for(let i of this.stats.rtps)if(i.ssrc===e)return ze(i,t)}getStats(){var e;if(this.collector){const t=this.collector.getStats();for(let i of t.rtps)"video"===i.kind&&(!this.stats&&"none"!==i.qualityLimitationReason||this.stats&&(null===(e=this.stats.rtps)||void 0===e?void 0:e.length)&&i.qualityLimitationReason!==this.getValueFromStats(i.ssrc,"qualityLimitationReason"))&&this.fire("video-adaptation-changed",[{rid:i.rid,reason:i.qualityLimitationReason}]);this.stats=t}return this.stats}startCollecting(){this.collector&&this.collector.start()}stopCollecting(){this.collector&&this.collector.stop()}getAudioLevel(){var e;return this.collector&&null!==(e=this.collector.getAudioLevel())&&void 0!==e?e:0}handlerEvent(){let e;this.peer.oniceconnectionstatechange=t=>{e&&(clearTimeout(e),e=null),"disconnected"===t?e=setTimeout(()=>{j.d(`userId: ${this.getUserId()}, streamId: ${this.getStreamId()} ice disconnected`),this.fire("stream-connection-error"),e=null},1e4):"failed"===t?(j.d(`userId: ${this.getUserId()}, streamId: ${this.getStreamId()} ice failed`),this.fire("stream-connection-error")):"connected"===t&&(j.f(`userId: ${this.getUserId()}, streamId: ${this.getStreamId()} ice connected`),this.fire("stream-connection-success"))},this.peer.onicecandidate=e=>{this.client&&this.client.syncIcecandidate(this,e)}}close(){this.peer&&(this.peer.destroy(),this.peer=null),this.collector&&(this.stopCollecting(),this.collector.destroy(),this.collector=null)}}const Zt=[["iphone",/iphone os ([\d_.]+)/],["ipad",/ipad; cpu os ([\d_.]+)/],["itouch",/itouch; cpu os ([\d_.]+)/],["android",/android ([\d_.]+)/],["wp",/windows phone ([\d_.]+)/],["windows",/windows nt ([\d_.]+)/],["linux",/linux/],["mac",/mac os x ([\d_.]+)/]],ei={iphone:1,ipad:1,itouch:1};const ti=function(e){let t,i;return Pe(Zt,n=>{let r=n[1].exec(e);if(r)return t=n[0],i=r[1],i&&(i=i.replace(/_/g,".")),!1}),{name:t||"",version:i||""}}((navigator.userAgent||"").toLowerCase());ti.name&&(ti[ti.name]=!0,ei[ti.name]&&(ti.ios=!0));var ii=ti,ni=i(12),ri=i.n(ni),oi=i(13);const si=new(i.n(oi).a.Interop);var ai,ci,ui,di;!function(e){e.SEND_ONLY="sendonly",e.RECV_ONLY="recvonly",e.SEND_RECV="sendrecv",e.INACTIVE="inactive"}(ai||(ai={})),function(e){e.VIDEO="video",e.AUDIO="audio"}(ci||(ci={})),function(e){e[e.ADD=0]="ADD",e[e.REMOVE=1]="REMOVE"}(ui||(ui={})),function(e){e.VIDEO_INPUT="videoinput",e.AUDIO_INPUT="audioinput",e.AUDIO_OUTPUT="audiooutput"}(di||(di={}));var li,hi=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};!function(e){e[e.PLAN_B=0]="PLAN_B",e[e.UNIFIED_PLAN=1]="UNIFIED_PLAN"}(li||(li={}));class pi extends Ke{constructor(e={},t=li.UNIFIED_PLAN){var i;super(!0);const n=null!==(i=e.iceServers)&&void 0!==i?i:[];this.options=We({},{iceServers:n.concat(ri()())},e),this.sdpType=t,this.candidategatheringdone=!1,this.localIcecandidatePadding=[],this.remoteIcecandidatePadding=[],this.uuid=Qt(),this.direction=ai.SEND_RECV,this.pc=new RTCPeerConnection(this.options),this.pc.onicecandidate=e=>{let t=e.candidate;t&&(this.sdpType===li.PLAN_B&&(t=si.candidateToUnifiedPlan(t)),this._onicecandidate&&this.candidategatheringdone?this._onicecandidate(t):this.localIcecandidatePadding.push(t))},this.pc.onsignalingstatechange=e=>{if("stable"===this.signalingState)for(;this.remoteIcecandidatePadding.length;)this.pc.addIceCandidate(this.remoteIcecandidatePadding.shift())},this.pc.onnegotiationneeded=e=>{this.onnegotiationneeded&&this.onnegotiationneeded()},this.pc.oniceconnectionstatechange=e=>{this.oniceconnectionstatechange&&this.oniceconnectionstatechange(this.iceConnectionState)}}getLocalSessionDescriptor(){return this.pc.localDescription}getRemoteSessionDescriptor(){return this.pc.remoteDescription}setOffer(e){return hi(this,void 0,void 0,(function*(){let t=new RTCSessionDescription({type:"offer",sdp:e});yield this.pc.setLocalDescription(t)}))}setAnwser(e){return hi(this,void 0,void 0,(function*(){let t=new RTCSessionDescription({type:"answer",sdp:e});this.sdpType===li.PLAN_B&&(t=si.toPlanB(t)),yield this.pc.setRemoteDescription(t)}))}resetAnswer(e){return hi(this,void 0,void 0,(function*(){const t=this.getLocalSessionDescriptor();yield this.pc.createOffer(),yield this.pc.setLocalDescription(t),yield this.setAnwser(e)}))}addIceCandidate(e){"stable"===this.signalingState?this.pc.addIceCandidate(e):this.remoteIcecandidatePadding.push(e)}offer(e){return hi(this,void 0,void 0,(function*(){let t=yield this.pc.createOffer(e);return this.sdpType===li.PLAN_B&&(t=si.toPlanB(t)),t.sdp}))}answer(e){return hi(this,void 0,void 0,(function*(){let t=new RTCSessionDescription({type:"offer",sdp:e});this.sdpType===li.PLAN_B&&(t=si.toPlanB(t)),yield this.pc.setRemoteDescription(t);let i=yield this.pc.createAnswer();return this.sdpType===li.PLAN_B&&(t=si.toPlanB(t)),i.sdp}))}getMediaStream(){return this.stream}getSenders(){return this.pc.getSenders()}getReceivers(){return this.pc.getReceivers()}getPeerConnection(){return this.pc}destroy(e=!1){this.pc&&(e&&this.stream&&this.stream.getTracks().forEach(e=>{e.stop()}),this.pc.onicecandidate=null,this.pc.onsignalingstatechange=null,this.pc.onnegotiationneeded=null,this.pc.oniceconnectionstatechange=null,this.pc.close(),this.pc=null,this.stream=null)}get onicecandidate(){return this._onicecandidate}set onicecandidate(e){if(this._onicecandidate=e,!this.candidategatheringdone)for(;this.localIcecandidatePadding.length;)this._onicecandidate(this.localIcecandidatePadding.shift());this.candidategatheringdone=!0}get signalingState(){var e;return null===(e=this.pc)||void 0===e?void 0:e.signalingState}get iceConnectionState(){var e;return null===(e=this.pc)||void 0===e?void 0:e.iceConnectionState}}var fi,mi=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};class vi extends pi{constructor(e={}){super(e),this.direction=ai.SEND_ONLY}addStream(e,t,i=49152){var n;if(this.stream=e,!this.pc.addTransceiver||yt.chrome&&!yt.checkVersion(yt.majorVersion,"72",!0))if(this.pc.addTrack){const e=this.stream.getAudioTracks()[0],t=this.stream.getVideoTracks()[0];e&&this.pc.addTrack(e,this.stream),t&&this.pc.addTrack(t,this.stream)}else this.pc.addStream(this.stream);else{const e=this.stream.getAudioTracks()[0],r=this.stream.getVideoTracks()[0];if(e&&this.pc.addTransceiver(e,{streams:[this.stream],sendEncodings:[{active:!0,maxBitrate:i}]}),r){const e=[];if(s.a(t))for(let i=0;i<t.length;i++)e.push({active:!0,scaleResolutionDownBy:t[i].scale,maxBitrate:t[i].bitrate,rid:null!==(n=t[i].rid)&&void 0!==n?n:"r"+i});this.pc.addTransceiver(r,{direction:ai.SEND_ONLY,streams:[this.stream],sendEncodings:e})}}}setEncodings(e){const t=this.pc.getSenders();if(!t.length)return;const i=t.find(e=>e.track.kind===ci.VIDEO);if(!i)return;if(!i.track)return;const n=i.getParameters();if(!n)return;const r=n.encodings;r.length!==e.length&&j.j("encodings length not match to parameters");const o=Math.min(r.length,e.length);for(let t=0;t<o;t++)s.f(e[t].scale)&&(r[t].scaleResolutionDownBy=e[t].scale),s.f(e[t].bitrate)&&(r[t].maxBitrate=e[t].bitrate);n.encodings=r,i.setParameters(n)}offer(){const e=Object.create(null,{offer:{get:()=>super.offer}});return mi(this,void 0,void 0,(function*(){return e.offer.call(this,{offerToReceiveAudio:!1,offerToReceiveVideo:!1})}))}replaceTrack(e){return mi(this,void 0,void 0,(function*(){const t=this.getSenders().find(t=>t.track.kind===e.kind);if(t&&(yield t.replaceTrack(e)),this.stream){const t="video"===e.kind?this.stream.getVideoTracks()[0]:this.stream.getAudioTracks()[0];this.stream.removeTrack(t),this.stream.addTrack(e)}}))}}!function(e){e[e.RECEIVE_BANDWIDTH=0]="RECEIVE_BANDWIDTH",e[e.SEND_BANDWIDTH=1]="SEND_BANDWIDTH",e[e.REMOTE_ADDRESS=2]="REMOTE_ADDRESS",e[e.TRANSPORT_TYPE=3]="TRANSPORT_TYPE",e[e.LOCAL_ADDRESS=4]="LOCAL_ADDRESS",e[e.ACTIVE_CONNECTION=5]="ACTIVE_CONNECTION",e[e.SSRC=6]="SSRC",e[e.PACKETS_RECEIVED=7]="PACKETS_RECEIVED",e[e.PACKETS_SENT=8]="PACKETS_SENT",e[e.PACKETS_LOST=9]="PACKETS_LOST",e[e.BYTES_RECEIVED=10]="BYTES_RECEIVED",e[e.BYTES_SENT=11]="BYTES_SENT",e[e.FRAME_HEIGHT_RECEIVED=12]="FRAME_HEIGHT_RECEIVED",e[e.FRAME_WIDTH_RECEIVED=13]="FRAME_WIDTH_RECEIVED",e[e.FRAME_HEIGHT_SENT=14]="FRAME_HEIGHT_SENT",e[e.FRAME_WIDTH_SENT=15]="FRAME_WIDTH_SENT",e[e.FRAME_RATE_RECEIVED=16]="FRAME_RATE_RECEIVED",e[e.FRAME_RATE_SENT=17]="FRAME_RATE_SENT",e[e.AUDIO_INPUT_LEVEL=18]="AUDIO_INPUT_LEVEL",e[e.AUDIO_OUTPUT_LEVEL=19]="AUDIO_OUTPUT_LEVEL",e[e.AUDIO_LEVEL=20]="AUDIO_LEVEL",e[e.CURRENT_ROUND_TRIP_TIME=21]="CURRENT_ROUND_TRIP_TIME",e[e.REMOTE_CANDIDATE_TYPE=22]="REMOTE_CANDIDATE_TYPE",e[e.LOCAL_CANDIDATE_TYPE=23]="LOCAL_CANDIDATE_TYPE",e[e.IP=24]="IP",e[e.PORT=25]="PORT",e[e.PROTOCOL=26]="PROTOCOL",e[e.JITTER_BUFFER_DELAY=27]="JITTER_BUFFER_DELAY",e[e.JITTER_BUFFER_EMITTED_COUNT=28]="JITTER_BUFFER_EMITTED_COUNT",e[e.MEDIA_TYPE=29]="MEDIA_TYPE",e[e.JITTER_BUFFER_MS=30]="JITTER_BUFFER_MS",e[e.INTER_FRAME_DELAY_MAX=31]="INTER_FRAME_DELAY_MAX",e[e.CURRENT_DELAY_MS=32]="CURRENT_DELAY_MS",e[e.AVAILABLE_RECEIVE_BANDWIDTH=33]="AVAILABLE_RECEIVE_BANDWIDTH",e[e.AVAILABLE_SEND_BANDWIDTH=34]="AVAILABLE_SEND_BANDWIDTH",e[e.RETRANSMIT_BITRATE=35]="RETRANSMIT_BITRATE",e[e.TRANSMIT_BITRATE=36]="TRANSMIT_BITRATE",e[e.TARGET_ENC_BITRATE=37]="TARGET_ENC_BITRATE",e[e.FRAME_RATE_INPUT=38]="FRAME_RATE_INPUT",e[e.ENCODE_USAGE_PERCENT=39]="ENCODE_USAGE_PERCENT",e[e.RENDER_DELAY_MS=40]="RENDER_DELAY_MS",e[e.TARGET_DELAY_MS=41]="TARGET_DELAY_MS",e[e.FRAME_RATE_OUTPUT=42]="FRAME_RATE_OUTPUT",e[e.RID=43]="RID",e[e.FRAMERATE_MEAN=44]="FRAMERATE_MEAN",e[e.AVAILABLE_INCOMING_BITRATE=45]="AVAILABLE_INCOMING_BITRATE",e[e.AVAILABLE_OUTGOING_BITRATE=46]="AVAILABLE_OUTGOING_BITRATE",e[e.ROUND_TRIP_TIME=47]="ROUND_TRIP_TIME",e[e.JITTER=48]="JITTER",e[e.PLI_COUNT=49]="PLI_COUNT",e[e.NACK_COUNT=50]="NACK_COUNT",e[e.TIMESTAMP=51]="TIMESTAMP",e[e.FRAME_DECODED=52]="FRAME_DECODED",e[e.FRAME_ENCODED=53]="FRAME_ENCODED",e[e.FRAME_PER_SECOND=54]="FRAME_PER_SECOND",e[e.FRAME_SENT=55]="FRAME_SENT",e[e.FRAME_RECEIVED=56]="FRAME_RECEIVED",e[e.FRAME_WIDTH=57]="FRAME_WIDTH",e[e.FRAME_HEIGHT=58]="FRAME_HEIGHT",e[e.HUGE_FRAMES_SENT=59]="HUGE_FRAMES_SENT",e[e.ACCELERATE_RATE=60]="ACCELERATE_RATE",e[e.DECODING_PLC=61]="DECODING_PLC",e[e.DECODING_PLCCNG=62]="DECODING_PLCCNG",e[e.CONCEALED_SAMPLES=63]="CONCEALED_SAMPLES",e[e.TOTAL_SAMPLES_RECEIVED=64]="TOTAL_SAMPLES_RECEIVED",e[e.CONCEALMENT_EVENTS=65]="CONCEALMENT_EVENTS",e[e.TOTAL_AUDIO_ENERGY=66]="TOTAL_AUDIO_ENERGY",e[e.TOTAL_SAMPLES_DURATION=67]="TOTAL_SAMPLES_DURATION",e[e.SILENT_CONCEALED_SAMPLES=68]="SILENT_CONCEALED_SAMPLES",e[e.INSERTED_SAMPLES_FOR_DECELERATION=69]="INSERTED_SAMPLES_FOR_DECELERATION",e[e.REMOVED_SAMPLES_FOR_ACCELERATION=70]="REMOVED_SAMPLES_FOR_ACCELERATION",e[e.QUALITY_LIMITATION_REASON=71]="QUALITY_LIMITATION_REASON",e[e.QUALITY_LIMITATION_DURATIONS=72]="QUALITY_LIMITATION_DURATIONS"}(fi||(fi={}));const gi={[fi.SSRC]:"ssrc",[fi.PACKETS_RECEIVED]:"packetsReceived",[fi.PACKETS_LOST]:"packetsLost",[fi.PACKETS_SENT]:"packetsSent",[fi.BYTES_RECEIVED]:"bytesReceived",[fi.BYTES_SENT]:"bytesSent",[fi.FRAMERATE_MEAN]:"framerateMean",[fi.IP]:"ipAddress",[fi.PORT]:"portNumber",[fi.PROTOCOL]:"transport",[fi.CURRENT_ROUND_TRIP_TIME]:"currentRoundTripTime",[fi.RID]:"rid",[fi.AVAILABLE_INCOMING_BITRATE]:"availableIncomingBitrate",[fi.AVAILABLE_OUTGOING_BITRATE]:"availableOutgoingBitrate",[fi.ROUND_TRIP_TIME]:"roundTripTime",[fi.JITTER]:"jitter",[fi.PLI_COUNT]:"pliCount",[fi.NACK_COUNT]:"nackCount",[fi.TIMESTAMP]:"timestamp",[fi.FRAME_DECODED]:"framesDecoded",[fi.FRAME_ENCODED]:"framesEncoded",[fi.FRAME_PER_SECOND]:"framesPerSecond",[fi.FRAME_SENT]:"framesSent",[fi.FRAME_RECEIVED]:"framesReceived",[fi.FRAME_WIDTH]:"frameWidth",[fi.FRAME_HEIGHT]:"frameHeight",[fi.HUGE_FRAMES_SENT]:"hugeFramesSent",[fi.CONCEALED_SAMPLES]:"concealedSamples",[fi.TOTAL_SAMPLES_RECEIVED]:"totalSamplesReceived",[fi.CONCEALMENT_EVENTS]:"concealmentEvents",[fi.TOTAL_AUDIO_ENERGY]:"totalAudioEnergy",[fi.TOTAL_SAMPLES_DURATION]:"totalSamplesDuration",[fi.SILENT_CONCEALED_SAMPLES]:"silentConcealedSamples",[fi.INSERTED_SAMPLES_FOR_DECELERATION]:"insertedSamplesForDeceleration",[fi.REMOVED_SAMPLES_FOR_ACCELERATION]:"removedSamplesForAcceleration",[fi.QUALITY_LIMITATION_REASON]:"qualityLimitationReason",[fi.QUALITY_LIMITATION_DURATIONS]:"qualityLimitationDurations"},_i={[fi.RECEIVE_BANDWIDTH]:"googAvailableReceiveBandwidth",[fi.SEND_BANDWIDTH]:"googAvailableSendBandwidth",[fi.REMOTE_ADDRESS]:"googRemoteAddress",[fi.TRANSPORT_TYPE]:"googTransportType",[fi.LOCAL_ADDRESS]:"googLocalAddress",[fi.ACTIVE_CONNECTION]:"googActiveConnection",[fi.SSRC]:"ssrc",[fi.PACKETS_RECEIVED]:"packetsReceived",[fi.PACKETS_SENT]:"packetsSent",[fi.PACKETS_LOST]:"packetsLost",[fi.BYTES_RECEIVED]:"bytesReceived",[fi.BYTES_SENT]:"bytesSent",[fi.FRAME_HEIGHT_RECEIVED]:"googFrameHeightReceived",[fi.FRAME_WIDTH_RECEIVED]:"googFrameWidthReceived",[fi.FRAME_HEIGHT_SENT]:"googFrameHeightSent",[fi.FRAME_WIDTH_SENT]:"googFrameWidthSent",[fi.FRAME_RATE_RECEIVED]:"googFrameRateReceived",[fi.FRAME_RATE_SENT]:"googFrameRateSent",[fi.AUDIO_INPUT_LEVEL]:"audioInputLevel",[fi.AUDIO_OUTPUT_LEVEL]:"audioInputLevel",[fi.AUDIO_LEVEL]:"audioLevel",[fi.CURRENT_ROUND_TRIP_TIME]:"currentRoundTripTime",[fi.REMOTE_CANDIDATE_TYPE]:"googRemoteCandidateType",[fi.LOCAL_CANDIDATE_TYPE]:"googLocalCandidateType",[fi.IP]:"ip",[fi.PORT]:"port",[fi.PROTOCOL]:"protocol",[fi.JITTER_BUFFER_DELAY]:"jitterBufferDelay",[fi.JITTER_BUFFER_EMITTED_COUNT]:"jitterBufferEmittedCount",[fi.MEDIA_TYPE]:"mediaType",[fi.JITTER_BUFFER_MS]:"googJitterBufferMs",[fi.INTER_FRAME_DELAY_MAX]:"googInterframeDelayMax",[fi.CURRENT_DELAY_MS]:"googCurrentDelayMs",[fi.AVAILABLE_RECEIVE_BANDWIDTH]:"googAvailableReceiveBandwidth",[fi.AVAILABLE_SEND_BANDWIDTH]:"googAvailableSendBandwidth",[fi.RETRANSMIT_BITRATE]:"googRetransmitBitrate",[fi.TRANSMIT_BITRATE]:"googTransmitBitrate",[fi.TARGET_ENC_BITRATE]:"googTargetEncBitrate",[fi.FRAME_RATE_INPUT]:"googFrameRateInput",[fi.ENCODE_USAGE_PERCENT]:"googEncodeUsagePercent",[fi.RENDER_DELAY_MS]:"googRenderDelayMs",[fi.TARGET_DELAY_MS]:"googTargetDelayMs",[fi.FRAME_RATE_OUTPUT]:"googFrameRateOutput",[fi.RID]:"rid",[fi.AVAILABLE_INCOMING_BITRATE]:"availableIncomingBitrate",[fi.AVAILABLE_OUTGOING_BITRATE]:"availableOutgoingBitrate",[fi.ROUND_TRIP_TIME]:"roundTripTime",[fi.JITTER]:"jitter",[fi.PLI_COUNT]:"pliCount",[fi.NACK_COUNT]:"nackCount",[fi.TIMESTAMP]:"timestamp",[fi.FRAME_DECODED]:"framesDecoded",[fi.FRAME_ENCODED]:"framesEncoded",[fi.FRAME_PER_SECOND]:"framesPerSecond",[fi.FRAME_SENT]:"framesSent",[fi.FRAME_RECEIVED]:"framesReceived",[fi.FRAME_WIDTH]:"frameWidth",[fi.FRAME_HEIGHT]:"frameHeight",[fi.FRAMERATE_MEAN]:"framerateMean",[fi.HUGE_FRAMES_SENT]:"hugeFramesSent",[fi.ACCELERATE_RATE]:"googAccelerateRate",[fi.DECODING_PLC]:"googDecodingPLC",[fi.DECODING_PLCCNG]:"googDecodingPLCCNG",[fi.CONCEALED_SAMPLES]:"concealedSamples",[fi.TOTAL_SAMPLES_RECEIVED]:"totalSamplesReceived",[fi.CONCEALMENT_EVENTS]:"concealmentEvents",[fi.TOTAL_AUDIO_ENERGY]:"totalAudioEnergy",[fi.TOTAL_SAMPLES_DURATION]:"totalSamplesDuration",[fi.SILENT_CONCEALED_SAMPLES]:"silentConcealedSamples",[fi.INSERTED_SAMPLES_FOR_DECELERATION]:"insertedSamplesForDeceleration",[fi.REMOVED_SAMPLES_FOR_ACCELERATION]:"removedSamplesForAcceleration",[fi.QUALITY_LIMITATION_REASON]:"qualityLimitationReason",[fi.QUALITY_LIMITATION_DURATIONS]:"qualityLimitationDurations"},yi={[fi.RECEIVE_BANDWIDTH]:"googAvailableReceiveBandwidth",[fi.SEND_BANDWIDTH]:"googAvailableSendBandwidth",[fi.REMOTE_ADDRESS]:"googRemoteAddress",[fi.TRANSPORT_TYPE]:"googTransportType",[fi.LOCAL_ADDRESS]:"googLocalAddress",[fi.ACTIVE_CONNECTION]:"googActiveConnection",[fi.SSRC]:"ssrc",[fi.PACKETS_RECEIVED]:"packetsReceived",[fi.PACKETS_SENT]:"packetsSent",[fi.PACKETS_LOST]:"packetsLost",[fi.BYTES_RECEIVED]:"bytesReceived",[fi.BYTES_SENT]:"bytesSent",[fi.FRAME_HEIGHT_RECEIVED]:"googFrameHeightReceived",[fi.FRAME_WIDTH_RECEIVED]:"googFrameWidthReceived",[fi.FRAME_HEIGHT_SENT]:"googFrameHeightSent",[fi.FRAME_WIDTH_SENT]:"googFrameWidthSent",[fi.FRAME_RATE_RECEIVED]:"googFrameRateReceived",[fi.FRAME_RATE_SENT]:"googFrameRateSent",[fi.AUDIO_INPUT_LEVEL]:"audioInputLevel",[fi.AUDIO_OUTPUT_LEVEL]:"audioOutputLevel",[fi.AUDIO_LEVEL]:"audioLevel",[fi.CURRENT_ROUND_TRIP_TIME]:"currentRoundTripTime",[fi.REMOTE_CANDIDATE_TYPE]:"googRemoteCandidateType",[fi.LOCAL_CANDIDATE_TYPE]:"googLocalCandidateType",[fi.IP]:"address",[fi.PORT]:"port",[fi.PROTOCOL]:"protocol",[fi.JITTER_BUFFER_DELAY]:"jitterBufferDelay",[fi.JITTER_BUFFER_EMITTED_COUNT]:"jitterBufferEmittedCount",[fi.MEDIA_TYPE]:"mediaType",[fi.JITTER_BUFFER_MS]:"googJitterBufferMs",[fi.INTER_FRAME_DELAY_MAX]:"googInterframeDelayMax",[fi.CURRENT_DELAY_MS]:"googCurrentDelayMs",[fi.AVAILABLE_RECEIVE_BANDWIDTH]:"googAvailableReceiveBandwidth",[fi.AVAILABLE_SEND_BANDWIDTH]:"googAvailableSendBandwidth",[fi.RETRANSMIT_BITRATE]:"googRetransmitBitrate",[fi.TRANSMIT_BITRATE]:"googTransmitBitrate",[fi.TARGET_ENC_BITRATE]:"googTargetEncBitrate",[fi.FRAME_RATE_INPUT]:"googFrameRateInput",[fi.ENCODE_USAGE_PERCENT]:"googEncodeUsagePercent",[fi.RENDER_DELAY_MS]:"googRenderDelayMs",[fi.TARGET_DELAY_MS]:"googTargetDelayMs",[fi.FRAME_RATE_OUTPUT]:"googFrameRateOutput",[fi.RID]:"rid",[fi.AVAILABLE_INCOMING_BITRATE]:"availableIncomingBitrate",[fi.AVAILABLE_OUTGOING_BITRATE]:"availableOutgoingBitrate",[fi.ROUND_TRIP_TIME]:"roundTripTime",[fi.JITTER]:"jitter",[fi.PLI_COUNT]:"pliCount",[fi.NACK_COUNT]:"nackCount",[fi.TIMESTAMP]:"timestamp",[fi.FRAME_DECODED]:"framesDecoded",[fi.FRAME_ENCODED]:"framesEncoded",[fi.FRAME_PER_SECOND]:"framesPerSecond",[fi.FRAME_SENT]:"framesSent",[fi.FRAME_RECEIVED]:"framesReceived",[fi.FRAME_WIDTH]:"frameWidth",[fi.FRAME_HEIGHT]:"frameHeight",[fi.FRAMERATE_MEAN]:"framerateMean",[fi.HUGE_FRAMES_SENT]:"hugeFramesSent",[fi.CONCEALED_SAMPLES]:"concealedSamples",[fi.TOTAL_SAMPLES_RECEIVED]:"totalSamplesReceived",[fi.CONCEALMENT_EVENTS]:"concealmentEvents",[fi.TOTAL_AUDIO_ENERGY]:"totalAudioEnergy",[fi.TOTAL_SAMPLES_DURATION]:"totalSamplesDuration",[fi.SILENT_CONCEALED_SAMPLES]:"silentConcealedSamples",[fi.INSERTED_SAMPLES_FOR_DECELERATION]:"insertedSamplesForDeceleration",[fi.REMOVED_SAMPLES_FOR_ACCELERATION]:"removedSamplesForAcceleration",[fi.QUALITY_LIMITATION_REASON]:"qualityLimitationReason",[fi.QUALITY_LIMITATION_DURATIONS]:"qualityLimitationDurations"};const Si={[ht.FIREFOX]:gi,[ht.CHROME]:_i,[ht.SAFARI]:yi,[ht.OPERA]:_i,[ht.WECHAT]:_i}[yt.name];function Ti(e,t){if(e){const i=function(e){const t=Si[e];if(t)return t;j.j(`The property '${e}' isn't supported!`)}(t);if(i)return s.d(e.stat)?e.stat(i):e[i]}return 0}function Ei(e,t){let i=Ti(e,t);return s.f(i)||(i=Number(i)),isNaN(i)?0:Math.max(0,i)}function bi(e,t,i,n=1e3){let r=Ei(e,i),o=Ei(t,i),s=Math.max(0,r-o);return Math.round(8*s/n)}class Ri{constructor(e,t,i){this.id=e,this.kind=t,this.interval=i,this.stats={type:"",loss:{packetsTotal:0,packetsLost:0,packetsTotalLost:0},bitrate:{download:0,upload:0},resolution:{width:0,height:0},framerate:0,jitter:0,interruptionCount:0,interruptionDuration:0,bytesSent:0,bytesReceived:0,packetsSent:0,packetsReceived:0,framesEncoded:0,framesSent:0,framesDecoded:0,interframeDelayMax:0,currentDelayMs:0,rtt:0,sentPacketRate:0,recvPacketRate:0,pliCount:0,nacksCount:0,frameRateInput:0,encodeUsagePercent:0,targetDelayMs:0,renderDelayMs:0,frameRateOutput:0,frameRateDecoded:0,frameRateEncoded:0,jitterReceived:0,rid:"",accelerateRate:0,decodingPLC:0,decodingPLCCNG:0,hugeFramesSent:0,concealedSamples:0,totalSamplesReceived:0,concealmentEvents:0,totalAudioEnergy:0,totalSamplesDuration:0,silentConcealedSamples:0,insertedSamplesForDeceleration:0,removedSamplesForAcceleration:0,qualityLimitationReason:"none",qualityLimitationDurations:{bandwidth:0,cpu:0,other:0,none:0}},this.supportExtra=!1}getKind(){return this.kind}getId(){return this.id}processOutboundRTP(e,t){const i=Ti(e,fi.RID);i&&(this.stats.rid=i);const n=Ei(e,fi.PACKETS_SENT);this.stats.packetsSent=n,this.stats.packetsReceived=0;const r=Ei(t,fi.PACKETS_SENT),o=Math.max(0,n-r);if(!this.supportExtra){const i=Ei(e,fi.PACKETS_LOST),n=Ei(t,fi.PACKETS_LOST),r=Math.max(0,i-n);this.stats.loss={packetsTotal:o+r,packetsLost:r,packetsTotalLost:i}}if(this.stats.sentPacketRate=o/this.interval*1e3,this.stats.pliCount=Ei(e,fi.PLI_COUNT),this.stats.nacksCount=Ei(e,fi.NACK_COUNT),this.stats.bytesSent=Ei(e,fi.BYTES_SENT),this.stats.bytesReceived=0,this.stats.bitrate={download:0,upload:bi(e,t,fi.BYTES_SENT,this.interval)},"video"===this.kind){const i=Ei(e,fi.FRAME_ENCODED),n=Ei(t,fi.FRAME_ENCODED);this.stats.framesEncoded=i,this.stats.framesSent=Ei(e,fi.FRAME_SENT),this.stats.frameRateEncoded=Math.round(Math.max(i-n,0)/this.interval*1e3),this.stats.hugeFramesSent=Ei(e,fi.HUGE_FRAMES_SENT);const r={height:Ei(e,fi.FRAME_HEIGHT),width:Ei(e,fi.FRAME_WIDTH)};r.width&&r.height&&(this.stats.resolution=r);const o=Ei(e,fi.FRAMERATE_MEAN);if(o)this.stats.framerate=Math.round(o);else{let i=Ei(e,fi.FRAME_PER_SECOND);if(!i){let n=Ei(e,fi.TIMESTAMP)-Ei(t,fi.TIMESTAMP);if(n>0){const r=Ei(e,fi.FRAME_SENT),o=Ei(e,fi.FRAME_ENCODED);r?i=(r-Ei(t,fi.FRAME_SENT))/n*1e3:o&&(i=(o-Ei(t,fi.FRAME_ENCODED))/n*1e3)}}this.stats.framerate=Math.round(i||0)}this.stats.qualityLimitationReason=Ti(e,fi.QUALITY_LIMITATION_REASON)||"none";const s=Ti(e,fi.QUALITY_LIMITATION_DURATIONS);s&&(this.stats.qualityLimitationDurations=s)}}processInboundRTP(e,t){const i=Ei(e,fi.PACKETS_RECEIVED);this.stats.packetsReceived=i,this.stats.packetsSent=0;const n=Ei(t,fi.PACKETS_RECEIVED),r=Math.max(0,i-n),o=Ei(e,fi.PACKETS_LOST),s=Ei(t,fi.PACKETS_LOST),a=Math.max(0,o-s);if(this.stats.loss={packetsTotal:r+a,packetsLost:a,packetsTotalLost:o},this.stats.recvPacketRate=r/this.interval*1e3,this.stats.pliCount=Ei(e,fi.PLI_COUNT),this.stats.nacksCount=Ei(e,fi.NACK_COUNT),this.stats.bytesReceived=Ei(e,fi.BYTES_RECEIVED),this.stats.bytesSent=0,this.stats.bitrate={upload:0,download:bi(e,t,fi.BYTES_RECEIVED,this.interval)},"video"===this.kind){const i=Ei(e,fi.FRAME_DECODED),n=Ei(t,fi.FRAME_DECODED);this.stats.framesDecoded=i,this.stats.frameRateDecoded=Math.round(Math.max(i-n,0)/this.interval*1e3);const r={height:Ei(e,fi.FRAME_HEIGHT),width:Ei(e,fi.FRAME_WIDTH)};r.width&&r.height&&(this.stats.resolution=r);const o=Ei(e,fi.FRAMERATE_MEAN);if(o)this.stats.framerate=Math.round(o);else{let i=Ei(e,fi.FRAME_PER_SECOND);if(!i){let n=Ei(e,fi.TIMESTAMP)-Ei(t,fi.TIMESTAMP);if(n>0){const r=Ei(e,fi.FRAME_RECEIVED),o=Ei(e,fi.FRAME_DECODED);r?i=(r-Ei(t,fi.FRAME_RECEIVED))/n*1e3:o&&(i=(o-Ei(t,fi.FRAME_DECODED))/n*1e3)}}this.stats.framerate=Math.round(i||0)}}}processRemoteInboundRTP(e){this.stats.rtt=Math.floor(1e3*Ei(e,fi.ROUND_TRIP_TIME)),"audio"===this.kind&&(this.stats.jitterReceived=Ei(e,fi.JITTER))}processTrack(e,t){const i=Ei(e,fi.JITTER_BUFFER_DELAY);if(i&&t){const n=-Ei(t,fi.JITTER_BUFFER_DELAY)+i,r=-Ei(t,fi.JITTER_BUFFER_EMITTED_COUNT)+Ei(e,fi.JITTER_BUFFER_EMITTED_COUNT);r>0&&(this.stats.jitter=Math.round(1e3*n/r))}if("video"===this.kind){const t={height:Ei(e,fi.FRAME_HEIGHT),width:Ei(e,fi.FRAME_WIDTH)};t.width&&t.height&&(this.stats.resolution=t)}else"audio"===this.kind&&(this.stats.concealedSamples=Ei(e,fi.CONCEALED_SAMPLES),this.stats.totalSamplesReceived=Ei(e,fi.TOTAL_SAMPLES_RECEIVED),this.stats.concealmentEvents=Ei(e,fi.CONCEALMENT_EVENTS),this.stats.totalAudioEnergy=Ei(e,fi.TOTAL_AUDIO_ENERGY),this.stats.totalSamplesDuration=Ei(e,fi.TOTAL_SAMPLES_DURATION),this.stats.silentConcealedSamples=Ei(e,fi.SILENT_CONCEALED_SAMPLES),this.stats.insertedSamplesForDeceleration=Ei(e,fi.INSERTED_SAMPLES_FOR_DECELERATION),this.stats.removedSamplesForAcceleration=Ei(e,fi.REMOVED_SAMPLES_FOR_ACCELERATION))}processExtraOutboundRTP(e,t){const i=Ei(e,fi.PACKETS_SENT),n=Ei(t,fi.PACKETS_SENT),r=Math.max(0,i-n),o=Ei(e,fi.PACKETS_LOST),s=Ei(t,fi.PACKETS_LOST),a=Math.max(0,o-s);this.stats.loss={packetsTotal:r+a,packetsLost:a,packetsTotalLost:o},"video"===this.kind&&(this.stats.frameRateInput=Ei(e,fi.FRAME_RATE_INPUT),this.stats.encodeUsagePercent=Ei(e,fi.ENCODE_USAGE_PERCENT)),this.supportExtra=!0}processExtraInboundRTP(e,t){"video"===this.kind?(this.stats.interframeDelayMax=Ei(e,fi.INTER_FRAME_DELAY_MAX),this.stats.renderDelayMs=Ei(e,fi.RENDER_DELAY_MS),this.stats.targetDelayMs=Ei(e,fi.TARGET_DELAY_MS),this.stats.frameRateOutput=Ei(e,fi.FRAME_RATE_OUTPUT)):(this.stats.currentDelayMs=Ei(e,fi.CURRENT_DELAY_MS),this.stats.accelerateRate=Ei(e,fi.ACCELERATE_RATE),this.stats.decodingPLC=Ei(e,fi.DECODING_PLC),this.stats.decodingPLCCNG=Ei(e,fi.DECODING_PLCCNG)),this.supportExtra=!0}getStats(e){const t={packetsSent:this.stats.packetsSent,packetsReceived:this.stats.packetsReceived,bytesSent:this.stats.bytesSent,bytesReceived:this.stats.bytesReceived,packetsLost:this.stats.loss.packetsTotalLost,recvPacketRate:this.stats.recvPacketRate,sentPacketRate:this.stats.sentPacketRate,googRtt:this.stats.rtt};e?"video"===this.kind?(t.googEncodeUsagePercent=this.stats.encodeUsagePercent,t.googFrameRateInput=this.stats.frameRateInput,t.googNacksReceived=this.stats.nacksCount,t.googPlisReceived=this.stats.pliCount,t.framesEncoded=this.stats.framesEncoded,t.framesSent=this.stats.framesSent,t.hugeFramesSent=this.stats.hugeFramesSent):t.googJitterReceived=this.stats.jitterReceived:"video"===this.kind?(t.googInterframeDelayMax=this.stats.interframeDelayMax,t.googPlisSent=this.stats.pliCount,t.googFrameRateDecoded=this.stats.frameRateDecoded,t.googFrameRateOutput=this.stats.frameRateOutput,t.googNacksSent=this.stats.nacksCount,t.googJitterBufferMs=this.stats.jitter,t.googRenderDelayMs=this.stats.renderDelayMs,t.googTargetDelayMs=this.stats.targetDelayMs,t.framesDecoded=this.stats.framesDecoded):(t.googAccelerateRate=this.stats.accelerateRate,t.googDecodingPLC=this.stats.decodingPLC,t.googDecodingPLCCNG=this.stats.decodingPLCCNG,t.concealedSamples=this.stats.concealedSamples,t.concealmentEvents=this.stats.concealmentEvents,t.totalSamplesReceived=this.stats.totalSamplesReceived,t.totalAudioEnergy=this.stats.totalAudioEnergy,t.totalSamplesDuration=this.stats.totalSamplesDuration,t.silentConcealedSamples=this.stats.silentConcealedSamples,t.insertedSamplesForDeceleration=this.stats.insertedSamplesForDeceleration,t.removedSamplesForAcceleration=this.stats.removedSamplesForAcceleration);const i={ssrc:this.id,rid:this.stats.rid,kind:this.kind,loss:this.stats.loss,statistics:t,bitrate:this.stats.bitrate,qa:{jitter:this.stats.jitter,interruptionCount:0,interruptionDuration:0,frameDelay:"video"===this.kind?this.stats.interframeDelayMax:this.stats.currentDelayMs}};return"video"===this.kind&&(i.framerate=this.stats.framerate,i.resolution=this.stats.resolution,i.qualityLimitationReason=this.stats.qualityLimitationReason,i.qualityLimitationDurations=this.stats.qualityLimitationDurations),i}}class Ii{constructor(e,t,i){this.task=e,this.timeout=t,this.interval=i,this.count=0}start(){const e=this;e.stop();let t=e.timeout;const i=e.interval,n=function(){e.count++,!1!==e.task()&&e.timer?e.timer=setTimeout(n,i):e.stop()};null==t&&(t=i),e.timer=setTimeout(n,t)}stop(){this.timer&&(clearTimeout(this.timer),this.timer=null,this.count=0)}updateInterval(e){this.interval=e}isStarted(){return!!this.timer}destroy(){this.stop(),this.task=this.timeout=this.interval=null}}function ki(e,t){return!t||t<=0||!e||e<=0?0:Math.round(e/t*100)}var wi=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};class Ci{constructor(e,t=1e3,i=!0){this.pc=e,this.interval=t,this.isPush=i,this.rtpsMap=new Map,this.conferenceStats={bandwidth:{download:0,upload:0},transport:[],bitrate:{download:0,upload:0,audio:{download:0,upload:0},video:{download:0,upload:0}},packetLoss:{audio:{total:0,download:0,upload:0},video:{total:0,download:0,upload:0}}},this.bweforvideo={availableReceiveBandwidth:0,availableSendBandwidth:0,targetEncBitrate:0,transmitBitrate:0,retransmitBitrate:0},this.previousReport=null,this.audioLevel=0,this.statsTimer=new Ii(()=>{this.collectStats()},0,this.interval),this.extraTimer=new Ii(()=>{this.collectExtraStats()},this.interval,this.interval)}getKind(e){return e.kind||e.mediaType}processCandidate(e,t){let i=Ei(t,fi.AVAILABLE_INCOMING_BITRATE),n=Ei(t,fi.AVAILABLE_OUTGOING_BITRATE);if((i||n)&&(this.conferenceStats.bandwidth={upload:Math.max(Math.round(n/1e3),0),download:Math.max(Math.round(i/1e3),0)}),s.d(e.get)){let i=e.get(t.remoteCandidateId),n=e.get(t.localCandidateId);if(i&&n){let e=`${Ti(i,fi.IP)}:${Ti(i,fi.PORT)}`,r=`${Ti(n,fi.IP)}:${Ti(n,fi.PORT)}`,o=Ti(i,fi.PROTOCOL),s=this.conferenceStats.transport.find(t=>t.ip===e&&t.type===o&&t.localIp===r);s?(s.localCandidateType=n.candidateType,s.remoteCandidateType=i.candidateType,s.networkType=n.networkType,s.rtt=Math.round(1e3*Ei(t,fi.CURRENT_ROUND_TRIP_TIME))):this.conferenceStats.transport.push({ip:e,type:o,localIp:r,localCandidateType:n.candidateType,remoteCandidateType:i.candidateType,networkType:n.networkType,rtt:Math.round(1e3*Ei(t,fi.CURRENT_ROUND_TRIP_TIME))})}}}processReport(e){e.forEach(t=>{if("candidate-pair"===t.type&&t.nominated&&"succeeded"===t.state)this.processCandidate(e,t);else if(this.isPush&&"outbound-rtp"===t.type){const e=this.previousReport.get(t.id),i=Ei(t,fi.SSRC);if(i){let n=this.rtpsMap.get(i);n||(n=new Ri(i,this.getKind(t),this.interval),this.rtpsMap.set(i,n)),n.processOutboundRTP(t,e)}}else if(this.isPush||"inbound-rtp"!==t.type){if("track"===t.type){const e=this.previousReport.get(t.id);if(this.rtpsMap.forEach(i=>{i.getKind()===this.getKind(t)&&i.processTrack(t,e)}),"audio"===this.getKind(t)){const e=Ti(t,fi.AUDIO_LEVEL);Ce(e)&&(this.audioLevel=lt(e))}}else if("remote-inbound-rtp"===t.type){const e=Ei(t,fi.SSRC);if(e){let i=this.rtpsMap.get(e);i||(i=new Ri(e,this.getKind(t),this.interval),this.rtpsMap.set(e,i)),i.processRemoteInboundRTP(t)}}else if("media-source"===t.type&&"audio"===this.getKind(t)){const e=Ti(t,fi.AUDIO_LEVEL);Ce(e)&&(this.audioLevel=lt(e))}}else{const e=this.previousReport.get(t.id),i=Ei(t,fi.SSRC);if(i){let n=this.rtpsMap.get(i);n||(n=new Ri(i,this.getKind(t),this.interval),this.rtpsMap.set(i,n)),n.processInboundRTP(t,e)}}})}processExtraStats(e){for(let t in e){if(!e.hasOwnProperty(t))continue;const i=e[t];if(!i)continue;if("VideoBwe"===i.type&&(this.bweforvideo.availableReceiveBandwidth=Ei(i,fi.AVAILABLE_RECEIVE_BANDWIDTH),this.bweforvideo.availableSendBandwidth=Ei(i,fi.AVAILABLE_SEND_BANDWIDTH),this.bweforvideo.retransmitBitrate=Ei(i,fi.RETRANSMIT_BITRATE),this.bweforvideo.targetEncBitrate=Ei(i,fi.TARGET_ENC_BITRATE),this.bweforvideo.transmitBitrate=Ei(i,fi.TRANSMIT_BITRATE)),"ssrc"!==i.type&&"outboundrtp"!==i.type&&"inboundrtp"!==i.type&&"track"!==i.type)continue;if(i.isRemote||i.remoteSource)continue;const n=this.previousExtraReport[t];let r=Ei(i,fi.SSRC);if("track"===i.type&&Array.isArray(i.ssrcIds)&&(r=Number(i.ssrcIds[0])),r){const e=this.rtpsMap.get(r);e&&(this.isPush?e.processExtraOutboundRTP(i,n):e.processExtraInboundRTP(i,n))}}}collectStats(){return wi(this,void 0,void 0,(function*(){let e=yield this.pc.getStats();e&&(s.d(e.result)&&(e=e.result()),this.previousReport&&this.processReport(e),this.previousReport=e)}))}collectExtraStats(){this.pc.getStats(e=>{if(e){if(s.d(e.result)&&(e=e.result()),s.d(e.forEach)){const t=[];e.forEach(e=>{t.push(e)}),e=t}this.previousExtraReport&&this.processExtraStats(e),this.previousExtraReport=e}},e=>{this.extraTimer.stop()})}start(){this.statsTimer.isStarted()||this.statsTimer.start(),yt.chrome&&(this.extraTimer.isStarted()||this.extraTimer.start())}stop(){this.statsTimer&&this.statsTimer.stop(),this.extraTimer&&this.extraTimer.stop()}destroy(){this.stop(),this.statsTimer&&this.statsTimer.destroy(),this.extraTimer&&this.extraTimer.destroy(),this.statsTimer=null,this.extraTimer=null,this.pc=null,this.previousReport=null,this.previousExtraReport=null,this.rtpsMap&&this.rtpsMap.clear(),this.conferenceStats={bandwidth:{download:0,upload:0},transport:[],bitrate:{download:0,upload:0,audio:{download:0,upload:0},video:{download:0,upload:0}},packetLoss:{audio:{total:0,download:0,upload:0},video:{total:0,download:0,upload:0}}},this.bweforvideo={availableReceiveBandwidth:0,availableSendBandwidth:0,targetEncBitrate:0,transmitBitrate:0,retransmitBitrate:0}}getAudioLevel(){return this.audioLevel}getStats(){let e=0,t=0,i=0,n=0,r=0,o=0,s={audio:{download:0,upload:0},video:{download:0,upload:0}},a={audio:{download:0,upload:0},video:{download:0,upload:0}};const c=[];this.rtpsMap.forEach(u=>{const d=u.getStats(this.isPush);e+=d.bitrate.download,t+=d.bitrate.upload,"video"===d.kind?(r+=d.bitrate.download,o+=d.bitrate.upload,this.isPush?(s.video.upload+=d.loss.packetsTotal,a.video.upload+=d.loss.packetsLost):(s.video.download+=d.loss.packetsTotal,a.video.download+=d.loss.packetsLost)):(i+=d.bitrate.download,n+=d.bitrate.upload,this.isPush?(s.audio.upload+=d.loss.packetsTotal,a.audio.upload+=d.loss.packetsLost):(s.audio.download+=d.loss.packetsTotal,a.audio.download+=d.loss.packetsLost)),c.push(d)});let u={availableSendBandwidth:this.bweforvideo.availableSendBandwidth,retransmitBitrate:this.bweforvideo.retransmitBitrate,transmitBitrate:this.bweforvideo.transmitBitrate,targetEncBitrate:this.bweforvideo.targetEncBitrate};const d=this.conferenceStats.transport;return{bandwidth:this.conferenceStats.bandwidth,bitrate:{upload:t,download:e,audio:{upload:n,download:i},video:{upload:o,download:r}},packetLoss:{audio:{total:ki(a.audio.download+a.audio.upload,s.audio.download+s.audio.upload),download:ki(a.audio.download,s.audio.download),upload:ki(a.audio.upload,s.audio.upload)},video:{total:ki(a.video.download+a.video.upload,s.video.download+s.video.upload),download:ki(a.video.download,s.video.download),upload:ki(a.video.upload,s.video.upload)}},transport:d,bweforvideo:u,rtps:c}}}var Ai=i(7);function Di(e=[],t=!0){return function(i){return s.a(i.media)&&(Pe(i.media,i=>{s.a(i.candidates)&&Pe(i.candidates,i=>{je.d(i.ip,"172")||je.d(i.ip,"192")?t&&!Ue(e,i.ip)&&e.push(i.ip):Ue(e,i.ip)||e.push(i.ip)})}),j.c(`[sdpOperator msmsIP] hold: ${JSON.stringify(e)}, hasLocal: ${t}`)),i}}function Oi(e,t,i,n,r){return function(o){return s.a(o.media)&&Pe(o.media,o=>{if(o.type===i){let i;if("*"===r){const t=[],i=[];Pe(o.rtcpFb,r=>{if(!Ue(t,r.payload)){const o={payload:r.payload,type:e};n&&(o.subtype=n),i.push(o),t.push(r.payload)}}),o.rtcpFb=o.rtcpFb.concat(i).sort((e,t)=>e.payload-t.payload)}else{const a=o.payloads.split(" ");if(!a.length)return!0;if(i=lt(a[0]),s.i(r)&&Pe(o.rtp,e=>{if(e.codec.toLocaleLowerCase()===r.toLocaleLowerCase())return i=e.payload,!1}),t===ui.ADD){let t=!1;if(Pe(o.rtcpFb,r=>{if(r.payload===i&&r.type===e&&r.subtype==n)return t=!0,!1}),!t){const t={payload:i,type:e};n&&(t.subtype=n),o.rtcpFb?o.rtcpFb.push(t):o.rtcpFb=[t]}}else t===ui.REMOVE&&s.a(o.rtcpFb)&&(o.rtcpFb=o.rtcpFb.filter(t=>!(t.payload===i&&t.type===e&&t.subtype==n)))}j.c(`[sdpOperator rtcpFB] payload: ${i}, attr: ${e}, operator: ${t}, mediaType: ${o.type}, subAttr: ${n}, codec: ${r}`)}}),o}}function Pi(e,t){return function(i){return s.a(i.media)&&Pe(i.media,i=>{i.type===t&&(i.bandwidth=[{type:"AS",limit:e}],j.c(`[sdpOperator bandwidth] bandwidth: ${e}, mediaType: ${i.type}`))}),i}}function xi(e,t){return function(i){return i.direction&&(i.direction=e),s.a(i.media)&&Pe(i.media,i=>{t&&i.type!==t||(i.direction=e,j.c(`[sdpOperator direction] direction: ${e}, mediaType: ${i.type}`))}),i}}function Mi(e,t,i){return function(n){return s.a(n.media)&&Pe(n.media,n=>{i&&i!==n.type||(s.a(n.ext)?n.ext.push({value:e,uri:t}):n.ext=[{value:e,uri:t}],j.c(`[sdpOperator addExtmap] id: ${e}, uri: ${t}, mediaType: ${n.type}`))}),n}}function Li(e,t="&"){const i={};if(s.i(e)&&e.indexOf("=")>=0){let n=e.charAt(0),r="?"===n||"#"===n?1:0;r>0&&(e=e.substr(r)),Pe(function(e,t){const i=[];return s.f(e)&&(e+=""),e&&s.i(e)&&Pe(e.split(t),(e,t)=>{(e=e.trim())&&i.push(e)}),i}(e,t),e=>{var t;let n=e.split("=");if(2===n.length){let e=null===(t=n[0])||void 0===t?void 0:t.trim();e&&(i[e]=decodeURIComponent(n[1]))}})}return i}function Ni(e,t="&"){const i=[];return s.e(e)&&qe(e,(e,t)=>{i.push(t+"="+encodeURIComponent(s.h(e)?JSON.stringify(e):e))}),i.join(t)}function Ui(...e){return function(t){if(!e||!e.length)return t;let i=Ai.parse(t);for(let t=0;t<e.length;t++)e[t]&&(i=e[t](i));return Ai.write(i)}}function Vi(e,t,i){return function(n){return s.a(n.media)&&Pe(n.media,n=>{if(n.type===t){let t=[];if(Pe(n.rtp,i=>{i.codec.toLocaleLowerCase()===e.toLocaleLowerCase()&&t.push(i.payload)}),!t.length)return!0;let r=t[0];i&&Pe(n.fmtp,e=>{if(Ue(t,e.payload)&&je.b(e.config,i)>-1)return r=e.payload,!1});const o=n.payloads.split(" ");Ne(o,Object(F.a)(r),!0),o.unshift(Object(F.a)(r)),n.payloads=o.join(" "),j.c(`[sdpOperator preferCodec] codec: ${e}, mediaType: ${n.type}, fmpt: ${i}`)}}),n}}function Fi(e,t,i){return function(n){return s.a(n.media)&&Pe(n.media,n=>{t&&t!==n.type||(n.ext=n.ext.filter(t=>(!s.f(i)||t.value!==i)&&!(je.b(t.uri,e)>-1)),j.c(`[sdpOperator removeExtmap] ext: ${e}, mediaType: ${n.type}, value: ${i}`))}),n}}var ji=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};const Bi={acodec:"opus",vcodec:"h264",audioBitrate:40960,simulcast:1,encodings:[{scale:1,bitrate:512e3,fps:15}],usePlanBSimulcast:yt.chrome&&!yt.checkVersion(yt.majorVersion,"87",!0),redAudio:!1};let Hi;function Gi(){let e=Hi||(AudioContext?(Hi=new AudioContext,Hi):void 0);if(e){return e.createMediaStreamDestination().stream.getAudioTracks()[0]}return!1}class qi extends Xt{constructor(e,t){if(super({client:t,userId:e.userId,streamId:e.streamId,videoOn:e.videoOn,audioOn:e.audioOn,videoEnable:e.videoEnable,audioEnable:e.audioEnable}),this.options=We({},Bi,e),this.published=!1,this.options.mediaStream){const e=this.getVideoTrack(),t=this.getAudioTrack();this.videoOn=!!e,this.videoOn?this.videoEnable=e.enabled:this.videoEnable=!1,this.audioOn=!!t,this.audioOn?this.audioEnable=t.enabled:this.audioEnable=!1}}addStream(e){const t=this.options.mediaStream;return this.options.mediaStream=e,t}getStream(){if(this.options)return this.options.mediaStream}setEncodings(e){this.options.encodings=e,this.options.simulcast=e.length}getSimulcast(){return this.options.simulcast}processOffer(e,t=[]){return ji(this,void 0,void 0,(function*(){if(!this.options.mediaStream)throw new Error("not has mediaStream to publish!");e&&(this.client=e),this.peer&&this.peer.destroy(),this.collector&&this.collector.destroy(),this.peer=new vi({iceServers:t,rtcpMuxPolicy:"require"}),this.handlerEvent(),this.peer.addStream(this.options.mediaStream,this.options.simulcast>1&&!this.options.usePlanBSimulcast?this.options.encodings:null,this.options.audioBitrate);let i=yield this.peer.offer(),n=0;for(let e=0;e<this.options.encodings.length;e++)n+=this.options.encodings[e].bitrate;this.options.encodings.length>1&&(n=Math.ceil(1.2*n));var r,o,a,c,u;return i=Ui(Vi(this.options.acodec,ci.AUDIO),Vi(this.options.vcodec,ci.VIDEO),Pi(Math.ceil(this.options.audioBitrate/1024),ci.AUDIO),Pi(Math.ceil(n/1024),ci.VIDEO),xi(ai.SEND_ONLY),(r=ci.AUDIO,o="usedtx",a=1,c=this.options.acodec,function(e){return s.a(e.media)&&Pe(e.media,e=>{if(e.type!==r)return!0;if(!s.f(u)&&c){let t=!1;if(Pe(e.rtp,e=>{if(e.codec.toLocaleLowerCase()===c.toLocaleLowerCase())return t=!0,!1}),!t)return!0;u=lt(e.payloads.split(" ").shift())}if(!s.f(u))return!0;let t=null;if(Pe(e.fmtp,e=>{e.payload===u&&(t=e)}),t){const e=Li(t.config,";");e[o]=Object(F.a)(a),t.config=Ni(e,";")}else e.fmtp?e.fmtp.push({payload:u,config:`${o}=${Object(F.a)(a)}`}):e.fmtp=[{payload:u,config:`${o}=${Object(F.a)(a)}`}];j.c(`[sdpOperator fmptConfig] key: ${o}, value: ${a}, codec: ${c}, payload: ${u},  mediaType: ${e.type}`)}),e}),this.options.redAudio?Mi(6,"urn:boom:audio-stacked-rtp",ci.AUDIO):null,Fi("urn:ietf:params:rtp-hdrext:sdes:mid"),Oi("nack",ui.ADD,ci.AUDIO),this.options.simulcast>1&&this.options.usePlanBSimulcast?function(e=2){return function(t){return e<2||Pe(t.media,t=>{if(t.type===ci.VIDEO){const i=(t.ssrcs||[]).find(e=>"msid"===e.attribute);if(!i)return;const[n,r]=i.value.split(" "),o=lt(i.id);let s;Pe(t.ssrcGroups||[],e=>{if("FID"===e.semantics){const t=e.ssrcs.split(/\s+/);if(lt(t[0])===o)return s=lt(t[1]),!1}});const a=t.ssrcs.find(e=>"cname"===e.attribute);if(!a)return;const c=a.value,u=[],d=[];for(let t=0;t<e;t++)u.push(o+t),s&&d.push(s+t);t.ssrcGroups=[],t.ssrcs=[],t.ssrcGroups.push({semantics:"SIM",ssrcs:u.join(" ")});for(let e=0;e<u.length;e++)t.ssrcs.push({id:u[e],attribute:"cname",value:c}),t.ssrcs.push({id:u[e],attribute:"msid",value:`${n} ${r}`}),t.ssrcs.push({id:u[e],attribute:"label",value:r}),t.ssrcs.push({id:u[e],attribute:"mslabel",value:n});for(let e=0;e<d.length;e++){const i=u[e],o=d[e];t.ssrcs.push({id:o,attribute:"cname",value:c}),t.ssrcs.push({id:o,attribute:"msid",value:`${n} ${r}`}),t.ssrcs.push({id:o,attribute:"label",value:r}),t.ssrcs.push({id:o,attribute:"mslabel",value:n}),t.ssrcGroups.push({semantics:"FID",ssrcs:`${i} ${o}`})}j.c("[sdpOperator planBSimulcast] simulcast: "+e)}}),t}}():null,yt.firefox&&this.options.simulcast>1?function(e){return s.a(e.media)&&Pe(e.media,e=>{e.type===ci.VIDEO&&e.simulcast&&(delete e.ssrcs,delete e.ssrcGroups,j.c("[sdpOperator removeSSRC]"))}),e}:null,(yt.safari||yt.wechat&&ii.ios)&&"h264"===this.options.vcodec?function(e="640c1f",t="42e01f"){return function(i){return s.a(i.media)&&Pe(i.media,i=>{i.type===ci.VIDEO&&(Pe(i.fmtp,i=>{i.config&&i.config.indexOf("profile-level-id="+e)>-1&&(i.config=i.config.replace(e,t))}),j.c(`[sdpOperator profileReplace] profile: ${e}, replace: ${t}`))}),i}}("640c1f","42e01f"):null)(i),yield this.peer.setOffer(i),this.options.simulcast>1&&this.options.usePlanBSimulcast&&this.peer.setEncodings(this.options.encodings),this.collector=new Ci(this.peer.getPeerConnection(),1e3,!0),j.c("localstream offer: "+("\n"+i)),i}))}processAnswer(e){return ji(this,void 0,void 0,(function*(){const t=[],i=Ui(Di(t,!1));e=i(e),this.msms=t.join(","),j.c("localstream answer: "+("\n"+e)),yield this.peer.setAnwser(e)}))}muteVideo(){return ji(this,void 0,void 0,(function*(){this.hasVideo()&&this.getVideoEnable()&&(this.emptyVideoTrack||(this.emptyVideoTrack=function(){let e=document.createElement("canvas");return!!e.captureStream&&e.captureStream().getTracks()[0]}()),this.emptyVideoTrack&&(this.sourceVideoTrack=yield this.replaceTrack(this.emptyVideoTrack),this.sourceVideoTrack.enabled=!1,this.emptyVideoTrack.enabled=!1,this.videoEnable=!1,this.peer&&this.published&&this.client&&this.client.updateStream(this,{video_enable:!1})),j.f("muteVideo"))}))}unmuteVideo(){return ji(this,void 0,void 0,(function*(){this.hasVideo()&&!this.getVideoEnable()&&this.sourceVideoTrack&&(yield this.replaceTrack(this.sourceVideoTrack,!0),this.sourceVideoTrack.enabled=!0,this.emptyVideoTrack&&(this.emptyVideoTrack.enabled=!0),this.sourceVideoTrack=null,this.videoEnable=!0,this.peer&&this.published&&this.client&&this.client.updateStream(this,{video_enable:!0}),j.f("unmuteVideo"))}))}muteAudio(){return ji(this,void 0,void 0,(function*(){this.hasAudio()&&this.getAudioEnable()&&(this.emptyAudioTrack||(this.emptyAudioTrack=Gi()),this.emptyAudioTrack&&(this.sourceAudioTrack=yield this.replaceTrack(this.emptyAudioTrack),this.sourceAudioTrack.enabled=!1,this.emptyAudioTrack.enabled=!1,this.audioEnable=!1,this.peer&&this.published&&this.client&&this.client.updateStream(this,{audio_enable:!1})),j.f("muteAudio"))}))}unmuteAudio(){return ji(this,void 0,void 0,(function*(){this.hasAudio()&&!this.getAudioEnable()&&this.sourceAudioTrack&&(yield this.replaceTrack(this.sourceAudioTrack,!0),this.sourceAudioTrack.enabled=!0,this.emptyAudioTrack&&(this.emptyAudioTrack.enabled=!0),this.sourceAudioTrack=null,this.audioEnable=!0,this.peer&&this.published&&this.client&&this.client.updateStream(this,{audio_enable:!0}),j.f("unmuteAudio"))}))}addTrack(){return ji(this,void 0,void 0,(function*(){}))}removeTrack(){return ji(this,void 0,void 0,(function*(){}))}replaceTrack(e,t=!1){return ji(this,void 0,void 0,(function*(){const i="video"===e.kind;let n;const r=i?this.getVideoTrack():this.getAudioTrack();if(!i||this.getVideoEnable()||t)if(i||this.getAudioEnable()||t)if(n=r,this.peer)yield this.peer.replaceTrack(e);else{const t=this.getStream();t.removeTrack(r),t.addTrack(e)}else n=this.sourceAudioTrack,this.sourceAudioTrack=e,e.enabled=this.getAudioEnable();else n=this.sourceVideoTrack,this.sourceVideoTrack=e,e.enabled=this.getVideoEnable();const o={};return"audio"===e.kind?o.audio=e:"video"===e.kind&&(o.video=e),this.fire("stream-replaced",[o]),j.f(`replaceTrack: ${e.kind} force: ${t}`),n}))}destroy(){const e=this.getVideoTrack(),t=this.getAudioTrack();e&&e.stop(),t&&t.stop(),this.sourceVideoTrack&&this.sourceVideoTrack!==e&&this.sourceVideoTrack.stop(),this.emptyVideoTrack&&this.emptyVideoTrack!==e&&this.emptyVideoTrack.stop(),this.sourceAudioTrack&&this.sourceAudioTrack!==t&&this.sourceAudioTrack.stop(),this.emptyAudioTrack&&this.emptyAudioTrack!==t&&this.emptyAudioTrack.stop(),this.close(),this.options=null,this.emptyVideoTrack=null,this.sourceVideoTrack=null,this.emptyAudioTrack=null,this.sourceAudioTrack=null}getOptions(){return this.options}setOptions(e){We(this.options,e)}getVideoEnable(){const e=this.getVideoTrack();return!!e&&e.enabled}getAudioEnable(){const e=this.getAudioTrack();return!!e&&e.enabled}resetEncodings(e){if(this.peer){if(e.length!==this.options.encodings.length)throw j.d(`the length of encodings must be equals before, encodings: ${JSON.stringify(e)}, before: ${JSON.stringify(this.options.encodings)}`),new Error("the length of encodings must be equals before");this.peer.setEncodings(e);const t=e.reduce((e,t)=>e+Math.ceil(t.bitrate/1e3),0),i=Ai.parse(this.peer.getRemoteSessionDescriptor().sdp);Pe(i.media,e=>{var i;"video"===e.type&&((null===(i=e.bandwidth[0])||void 0===i?void 0:i.limit)&&(e.bandwidth[0].limit=t),Pe(e.fmtp,e=>{e.config.indexOf("x-google-max-bitrate")>-1&&(e.config=e.config.split(";").map(e=>e.indexOf("x-google-max-bitrate")>-1?"x-google-max-bitrate="+t:e.indexOf("x-google-start-bitrate")>-1?"x-google-start-bitrate="+t:e.indexOf("x-google-min-bitrate")>-1?"x-google-min-bitrate="+Math.floor(.8*t):e).join(";"))}))}),this.peer.resetAnswer(Ai.write(i))}}}var Ji=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};class Wi extends Tt{constructor(e,t){super(Tt.STREAM_TYPE_LOCAL,t),this.streamDeviceOption=e,this.videoProfile="480p",this.audioProfile="standard",this.screenProfile="1080p",e.screen?(this.streamCodecOption=Nt["1080p"],this.streamCodecOption.width=null,this.streamCodecOption.height=null):this.streamCodecOption=Nt["480p"],Z(this.sid+" create LocalStream","s",this.uid,[e])}constraintBitrate(){let e,t=this.streamCodecOption.width*this.streamCodecOption.height;qe(Ft,(i,n)=>{if(t<=+n)return e=i,!1}),e&&(this.streamCodecOption.bitrate<e.min&&(this.streamCodecOption.bitrate=e.min),this.streamCodecOption.bitrate>e.max&&(this.streamCodecOption.bitrate=e.max))}setPrivileges(e){this.privileges=e}isScreenStream(){return!!this.streamDeviceOption.screen}setVideoProfile(e){this.videoProfile=e,We(this.streamCodecOption,Nt[e]||{}),Z(this.sid+" LocalStream setVideoProfile","s",this.uid,[e])}setScreenProfile(e){this.screenProfile=e,We(this.streamCodecOption,Vt[e]||{}),Z(this.sid+" LocalStream setScreenProfile","s",this.uid,[e])}setAudioProfile(e){this.audioProfile=e,Z(this.sid+" LocalStream setAudioProfile","s",this.uid,[e])}setVideoEncoderConfiguration(e){if(qe(e,(t,i)=>{if(!s.f(t))throw new y(1001,i+" 的值不是 number 类型");if(t<=0)throw new y(1001,i+" 的值非法，必须是大于 0 的整数");e[i]=Math.floor(t)}),We(this.streamCodecOption,e),this.streamCodecOption.width*this.streamCodecOption.height>8294400)throw this.streamCodecOption=Nt["480p"],new y(1001,"暂不支持4k以上分辨率");this.constraintBitrate(),Z(this.sid+" LocalStream setVideoEncoderConfiguration","s",this.uid,[e])}getAudioBandwidth(){return Ut[this.webrtcType||0][this.audioProfile].bitrate}init(){return Ji(this,void 0,void 0,(function*(){let e,t=m();s.f(t)||(t=0);let i=Ut[t],n=new MediaStream;if(this.streamDeviceOption.audioSource||this.streamDeviceOption.videoSource)this.streamDeviceOption.audioSource?(n.addTrack(this.streamDeviceOption.audioSource),this.streamDeviceOption.audio=!0):this.streamDeviceOption.audio=!1,this.streamDeviceOption.videoSource?(n.addTrack(this.streamDeviceOption.videoSource),this.streamDeviceOption.video=!0):this.streamDeviceOption.video=!1;else{let e;this.streamDeviceOption.screen?e={screen:!0,audio:this.streamDeviceOption.audio,width:this.streamCodecOption.width,height:this.streamCodecOption.height,fps:this.streamCodecOption.frameRate}:(e={audio:!1,video:!1,fps:this.streamCodecOption.frameRate},this.streamDeviceOption.video&&(e.video={width:this.streamCodecOption.width,height:this.streamCodecOption.height,deviceId:this.streamDeviceOption.cameraId}),this.streamDeviceOption.audio&&(e.audio={deviceId:this.streamDeviceOption.microphoneId,sampleRate:i[this.audioProfile].sampleRate,echoCancellation:!0,channelCount:i[this.audioProfile].channelCount},s.c(this.streamDeviceOption.autoGainControl)&&(e.audio.autoGainControl=this.streamDeviceOption.autoGainControl),s.c(this.streamDeviceOption.echoCancellation)&&(e.audio.echoCancellation=this.streamDeviceOption.echoCancellation),s.c(this.streamDeviceOption.noiseSuppression)&&(e.audio.noiseSuppression=this.streamDeviceOption.noiseSuppression))),n=yield Yt(e)}if(a(t))e=new qi({userId:Object(F.a)(this.uid),streamId:this.sid,mediaStream:n,audioOn:this.streamDeviceOption.audio,videoOn:this.streamDeviceOption.video,usePlanBSimulcast:!(yt.firefox||yt.chrome&&yt.checkVersion(yt.majorVersion,"86"))||p});else if(c(t)){let t={};(this.streamDeviceOption.video||this.streamDeviceOption.screen)&&(t.videoSource=n.getVideoTracks()[0]),this.streamDeviceOption.audio&&(t.audioSource=n.getAudioTracks()[0]),e=V.a.createStream(t),e.setAudioProfile(this.audioProfile),e.setVideoProfile(this.streamCodecOption),yield e.initialize()}Z(this.sid+" LocalStream init success","s",this.uid,[this.streamDeviceOption,this.streamCodecOption,this.audioProfile]),this.setStream(t,e),this.soundMeter&&(yield this.soundMeter.ready()),this.setVolumeMeter()}))}switchWebRTC(e){return Ji(this,void 0,void 0,(function*(){if(this.webrtcType!==e&&c(e)){let t=Ut[e],i=this.audioTrack,n={videoSource:this.videoTrack,audioSource:i},r=V.a.createStream(n);r.setAudioProfile(t[this.audioProfile]),r.setVideoProfile(this.streamCodecOption),yield r.initialize(),Z(this.sid+" LocalStream switch success","s",this.uid,[this.streamDeviceOption,this.streamCodecOption,this.audioProfile]),this.stream.destroy(),this.setStream(e,r)}}))}addTrack(e){return Ji(this,void 0,void 0,(function*(){if(this.privileges&&this.privileges.enableAuth()){if(d(e)&&!this.privileges.canPushAudio())throw new y(1011,"没有音频推送权限");if(u(e)&&!this.privileges.canPushVideo())throw new y(1012,"没有视频推送权限")}if(!this.stream)throw new y(1002,"流未初始化");if(d(e)&&this.hasAudio())throw new y(1002,"当前已有一个 audioTrack");if(u(e)&&this.hasVideo())throw new y(1002,"当前已有一个 videoTrack");try{yield this.stream.addTrack(e),d(e)?this.addAudioTrackEvents():u(e)&&this.addVideoTrackEvents(),Z(this.sid+" LocalStream addTrack","s",this.uid,[e])}catch(e){throw new y(9e3,"addTrack 失败",e)}}))}removeTrack(e){return Ji(this,void 0,void 0,(function*(){if(!this.stream)throw new y(1002,"流未初始化");if(d(e)&&!this.hasAudio())throw new y(1002,"当前没有 audioTrack 可以移除");if(u(e)&&!this.hasVideo())throw new y(1002,"当前没有 videoTrack 可以移除");d(e)?this.removeAudioTrackEvents():u(e)&&this.removeVideoTrackEvents();try{yield this.stream.removeTrack(e),Z(this.sid+" LocalStream removeTrack","s",this.uid,[e])}catch(e){throw new y(9e3,"removeTrack 失败",e)}}))}replaceTrack(e){return Ji(this,void 0,void 0,(function*(){if(!this.stream)throw new y(1002,"流未初始化");if(d(e)){if(!this.hasAudio())throw new y(1002,"流没有 audioTrack");this.removeAudioTrackEvents()}else if(u(e)){if(!this.hasVideo())throw new y(1002,"流没有 videoTrack");this.removeVideoTrackEvents()}(a(this.webrtcType)||c(this.webrtcType))&&(yield this.stream.replaceTrack(e)),d(e)?(this.addAudioTrackEvents(),this.setVolumeMeter()):u(e)&&this.addVideoTrackEvents(),this.fire(Te,{type:e.kind,track:e}),Z(this.sid+" LocalStream replaceTrack","s",this.uid,[e])}))}switchDevice(e,t){return Ji(this,void 0,void 0,(function*(){if(!s.i(t))throw new y(1001,"deviceId 类型错误");if("audio"===e&&!this.streamDeviceOption.microphoneId)throw new y(1002,"当前的 audioTrack 不是来自于麦克风设备");if("video"===e&&!this.streamDeviceOption.cameraId)throw new y(1002,"当前的 videoTrack 不是来自于摄像头设备");if(!this.stream)throw new y(1002,"流未初始化");{let i,n;if("audio"===e?this.removeAudioTrackEvents():"video"===e&&this.removeVideoTrackEvents(),"audio"===e){let e=m();s.f(e)||(e=0);let r=Ut[e];const o={deviceId:t,sampleRate:r[this.audioProfile].sampleRate,echoCancellation:!0,channelCount:r[this.audioProfile].channelCount};s.c(this.streamDeviceOption.autoGainControl)&&(o.autoGainControl=this.streamDeviceOption.autoGainControl),s.c(this.streamDeviceOption.echoCancellation)&&(o.echoCancellation=this.streamDeviceOption.echoCancellation),s.c(this.streamDeviceOption.noiseSuppression)&&(o.noiseSuppression=this.streamDeviceOption.noiseSuppression);const a=yield Yt({audio:o,video:!1});this.streamDeviceOption.microphoneId=t,i=a.getAudioTracks()[0],n=this.getAudioTrack(),this.reportAction("deviceChange",0,null,null,{type:"microphone",device_id:t,stream:this.getStreamId()})}else if("video"===e){const e=yield Yt({audio:!1,video:{width:this.streamCodecOption.width,height:this.streamCodecOption.height,deviceId:t},fps:this.streamCodecOption.frameRate});this.streamDeviceOption.cameraId=t,i=e.getVideoTracks()[0],n=this.getVideoTrack(),this.reportAction("deviceChange",0,null,null,{type:"camera",device_id:t,stream:this.getStreamId()})}yield this.replaceTrack(i),n&&n.stop(),"audio"===e?this.addAudioTrackEvents():"video"===e&&this.addVideoTrackEvents(),this.playing&&this.player&&("audio"===e?this.player.replay(this,!1,!0):"video"===e&&this.player.replay(this,!0,!1)),Z(this.sid+" LocalStream switchDevice","s",this.uid,[e,t])}}))}play(e,t={}){const i=Object.create(null,{play:{get:()=>super.play}});return Ji(this,void 0,void 0,(function*(){t.muted=!0,yield i.play.call(this,e,t)}))}getStats(){return Ji(this,void 0,void 0,(function*(){if(this.client){if(a(this.webrtcType)){let e=this.stream.getStats();const t=this.getAudioRTPStats(e),i=this.getVideoRTPStats(e);return{videoBytesSent:ze(i,"statistics.bytesSent",0),videoPacketsSent:ze(i,"statistics.packetsSent",0),videoPacketsLost:ze(i,"statistics.packetsLost",0),audioBytesSent:ze(t,"statistics.bytesSent",0),audioPacketsSent:ze(t,"statistics.packetsSent",0),audioPacketsLost:ze(t,"statistics.packetsLost",0),width:ze(i,"resolution.width",0),height:ze(i,"resolution.height",0),rtt:ze(e,"transport.0.rtt",0),framesEncoded:ze(i,"statistics.framesEncoded",0),framesSent:ze(i,"statistics.framesSent",0)}}if(c(this.webrtcType)){let e=yield this.client.getLocalVideoStats();if(!this.client)throw new y(1010,"已被取消推流");let t=yield this.client.getLocalAudioStats();if(!this.client)throw new y(1010,"已被取消推流");let i=yield this.client.getTransportStats(),n=e[this.uid],r=t[this.uid];return{videoBytesSent:ze(n,"bytesSent",0),videoPacketsSent:ze(n,"packetsSent",0),videoPacketsLost:ze(n,"packetsLost",0),audioBytesSent:ze(r,"bytesSent",0),audioPacketsSent:ze(r,"packetsSent",0),audioPacketsLost:ze(r,"packetsLost",0),width:ze(n,"frameWidth",0),height:ze(n,"frameHeight",0),rtt:ze(i,"rtt",0),framesEncoded:ze(n,"framesEncoded",0),framesSent:ze(n,"framesSent",0)}}}return{}}))}getReportStats(e){return Ji(this,void 0,void 0,(function*(){this.stutter||(this.stutter=new kt(e,!0));let t={bandwidth:{upload:0,download:0},bitrate:{audio:{upload:0,download:0},video:{upload:0,download:0}},packetLoss:{audio:{upload:0,download:0},video:{upload:0,download:0}},resolution:{width:0,height:0},framerate:0,audioLevel:0,transport:[{ip:"",type:"",localIp:"",localCandidateType:"",remoteCandidateType:"",networkType:"",rtt:0}],quality:{audio:{jitter:0,interruptionCount:0,interruptionDuration:0},video:{jitter:0,interruptionCount:0,interruptionDuration:0}},statistics:{audio:{bytesReceived:0,bytesSent:0,packetsReceived:0,packetsSent:0,packetsLost:0},video:{bytesReceived:0,bytesSent:0,packetsReceived:0,packetsSent:0,packetsLost:0,framesEncoded:0,framesDecoded:0,framesSent:0},bweforvideo:{googAvailableReceiveBandwidth:0,googAvailableSendBandwidth:0,googRetransmitBitrate:0,googTransmitBitrate:0,googTargetEncBitrate:0}},cpu:{appCpu:0,systemCpu:0}};if(this.client)if(a(this.webrtcType)){let e=this.stream.getStats();const i=this.getAudioRTPStats(e),n=this.getVideoRTPStats(e);t.audioLevel=this.getAudioLevel(),e.bandwidth&&(t.bandwidth=e.bandwidth),e.bitrate&&(t.bitrate=e.bitrate),e.packetLoss&&(t.packetLoss=e.packetLoss),e.transport&&(t.transport=e.transport),e.bweforvideo&&(t.statistics.bweforvideo={googAvailableReceiveBandwidth:e.bweforvideo.availableReceiveBandwidth,googAvailableSendBandwidth:e.bweforvideo.availableSendBandwidth,googRetransmitBitrate:e.bweforvideo.retransmitBitrate,googTransmitBitrate:e.bweforvideo.transmitBitrate,googTargetEncBitrate:e.bweforvideo.targetEncBitrate}),i&&(t.quality.audio=i.qa,t.statistics.audio=i.statistics),n&&(t.quality.video=n.qa,t.statistics.video=n.statistics,t.resolution=n.resolution,t.framerate=n.framerate),this.stutter.addFrameRate(ze(t,"framerate",0)),this.stutter.addVideoLoss(ze(t,"statistics.video.packetsSent",0),ze(t,"statistics.video.packetsLost",0)),this.stutter.addAudioLoss(ze(t,"statistics.audio.packetsSent",0),ze(t,"statistics.audio.packetsLost",0))}else{let e=yield this.client.getLocalVideoStats();if(!this.client)throw new y(1010,"已被取消推流");let i=yield this.client.getLocalAudioStats();if(!this.client)throw new y(1010,"已被取消推流");let n=yield this.client.getTransportStats(),r=e[this.uid],o=i[this.uid];this.reportCollector.addData(ze(o,"bytesSent",0),ze(r,"bytesSent",0),ze(o,"packetsSent",0),0,ze(r,"packetsSent",0),0,ze(r,"framesEncoded",0)),t.bitrate.audio.upload=this.reportCollector.getAudioBitrate(),t.bitrate.video.upload=this.reportCollector.getVideoBitrate(),t.packetLoss.audio.upload=this.reportCollector.getAudioPacketLoss(),t.packetLoss.video.upload=this.reportCollector.getVideoPacketLoss(),t.audioLevel=this.getAudioLevel(),t.framerate=this.reportCollector.getFrameRate(),t.resolution.width=ze(r,"frameWidth",0),t.resolution.height=ze(r,"frameHeight",0),t.transport[0].rtt=ze(n,"rtt",0),t.bandwidth.upload=this.reportCollector.getAudioBitrate()+this.reportCollector.getVideoBitrate(),t.statistics.audio.bytesSent=ze(o,"bytesSent",0),t.statistics.audio.packetsSent=ze(o,"packetsSent",0),t.statistics.video.bytesSent=ze(r,"bytesSent",0),t.statistics.video.packetsSent=ze(r,"packetsSent",0),t.statistics.video.framesSent=ze(r,"framesSent",0),t.statistics.video.framesEncoded=ze(r,"framesEncoded",0),this.stutter.addFrameRate(ze(t,"framerate",0)),this.stutter.addVideoLoss(ze(t,"statistics.video.packetsSent",0),ze(t,"statistics.video.packetsLost",0)),this.stutter.addAudioLoss(ze(t,"statistics.audio.packetsSent",0),ze(t,"statistics.audio.packetsLost",0))}return t}))}getExtraReport(){if(this.stutter){const e=this.stutter.judgeAudioStutter(),t=this.stutter.judegVideoStutter();return{event:e||t?1:0,audio_stutter:this.getAudioOn()&&e?1:0,video_stutter:this.getVideoOn()&&t?1:0,blockOp:0}}}getStreamCodecOption(){return this.streamCodecOption}destroy(){this.stream&&(this.videoTrack&&this.videoTrack.stop(),this.audioTrack&&this.audioTrack.stop(),super.destroy())}}class zi{constructor(e){this.timeout=e}then(e,t){this.resolve=e,this.reject=t,this.startTime=Date.now(),this.timer=setTimeout(()=>{this.resolve(Date.now()-this.startTime),this.timer=null},1e3*this.timeout)}stop(e=!0){this.timer&&(clearTimeout(this.timer),this.timer=null,this.resolve&&e?this.resolve(Date.now()-this.startTime):this.reject&&!e&&this.reject(Date.now()-this.startTime))}}let $i,Ki;const Yi=navigator.userAgent||"";$i=Yi.match(/NetType\/\w+/)?Yi.match(/NetType\/\w+/)[0]:"NetType/other",$i=$i.toLowerCase().replace("nettype/","");const Qi={ethernet:"ethernet",wifi:"wifi","5g":"5g","4g":"4g","3g":"3g","3gnet":"3g","2g":"2g","slow-2g":"2g"};if(Ki=Qi[$i],!Ki){let e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;e&&(Ki=Qi[e.type],Ki||(Ki=Qi[e.effectiveType]))}Ki||(Ki="unknown");var Xi={name:Ki},Zi=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};let en="production";function tn(e){let t="https://brtc-api.baijiayun.com";return"development"===en?t="https://brtc-apitest.baijiayun.com":"beta"===en&&(t="https://brtc-apibeta.baijiayun.com"),t+e}function nn(e){return Ni(e)||""}function rn(e,t){return Zi(this,void 0,void 0,(function*(){return new Promise((i,n)=>{let r=0;!function o(){return Zi(this,void 0,void 0,(function*(){r++;try{let n=yield fetch(e,{body:JSON.stringify(t),cache:"no-cache",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",mode:"cors",redirect:"follow",referrer:"no-referrer"});i(n.json())}catch(e){r<3?(yield new zi(1),o()):n(e)}}))}()})}))}function on(e,t){return Zi(this,void 0,void 0,(function*(){return new Promise((i,n)=>{let r=0;!function o(){return Zi(this,void 0,void 0,(function*(){r++;try{let n=yield fetch(`${e}?${nn(t)}`,{cache:"no-cache",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},method:"GET",mode:"cors",redirect:"follow",referrer:"no-referrer"});i(n.json())}catch(e){r<3?(yield new zi(1),o()):n(e)}}))}()})}))}function sn(e,t,i,n,r){return Zi(this,void 0,void 0,(function*(){const o={sig:e,room_id:t,user_id:i,ts:Math.floor((new Date).getTime()/1e3)};return n&&(o.comments=n),r&&(o.client_ip=r),rn(tn("/vrm/api/auth/token/vt"),o)}))}function an(e){return e&&y.instanceOf(e)?e.getCode():9e3}var cn,un=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};class dn extends pi{constructor(e,t){if(super(),this.url=e,this.channelOptions=t,!s.d(null==t?void 0:t.processOffer))throw new Error("processOffer required");this.channel=this.pc.createDataChannel(this.uuid,this.channelOptions),this.channel.onopen=e=>{this.onopen&&ue(this.onopen,this,[e])},this.channel.onclose=e=>{this.onclose&&ue(this.onclose,this,[e])},this.channel.onmessage=e=>{this.onmessage&&ue(this.onmessage,this,[e])},this.channel.onerror=e=>{this.onerror&&ue(this.onerror,this,[e])},this.channel.onbufferedamountlow=e=>{this.channelOptions.onbufferedamountlow&&ue(this.channelOptions.onbufferedamountlow,this,[e])},this.oniceconnectionstatechange=e=>{"disconnected"!==e&&"failed"!==e||this.onclose&&ue(this.onclose,this,[new Event("ice "+e)])},this.connect()}connect(){return un(this,void 0,void 0,(function*(){try{const e=yield this.offer({offerToReceiveAudio:!1,offerToReceiveVideo:!1});yield this.setOffer(e);const t=yield this.channelOptions.processOffer(this.url,e);yield this.setAnwser(t)}catch(e){j.d("DataChannel request answer failed"),this.close(),this.onerror&&this.onerror(e)}}))}send(e){this.channel?this.channel.send(s.i(e)||s.b(e)?e:JSON.stringify(e)):j.d("can not send data because of no channel in DataChannel")}close(){this.channel&&(this.channel.close(),this.channel=null),this.destroy()}clear(){this.close()}}!function(e){e[e.NONE=0]="NONE",e[e.OPEN=1]="OPEN",e[e.ERROR=2]="ERROR",e[e.CLOSE=3]="CLOSE",e[e.CLOSING=4]="CLOSING",e[e.TIMEOUT=5]="TIMEOUT",e[e.CONNECTING=6]="CONNECTING"}(cn||(cn={}));const ln="open",hn="close",pn="error",fn="send",mn="message",vn="timeout",gn="reconnecting";var _n=class extends Ke{constructor(e){var t;super(!0),We(this,e),this.status=cn.NONE,this.queue=[],this.isReconnect=!1,e.retryCount>0&&(this.retryIndex=0),this.logLevel=null!==(t=this.logLevel)&&void 0!==t?t:j.b}isOpen(){return this.status===cn.OPEN}isConnecting(){return this.status===cn.CONNECTING}connect(e,t){const i=this;if(this.server=e,this.proxys=t,i.status===cn.OPEN||i.status===cn.CONNECTING||i.status===cn.CLOSING)return;let n=[e];t&&t.length&&(n=n.concat(t));let r=-1;const o=function(){i.nextStartTimer=null,i.status===cn.CONNECTING?function(e,t){let n=i.nativeOptions;i.native===WebSocket&&(n=i.nativeOptions.protocols),j.c(`${i.tag||"Transport"} connecting url: ${e.url}`);const r=new i.native(e.url,n);let o,s=function(i){o&&clearTimeout(o),r.onopen=r.onerror=null,t(r,e,i)};r.onopen=function(){s(cn.OPEN)},r.onerror=function(){s(cn.ERROR)},i.timeout>0&&(o=setTimeout((function(){o=null,s(cn.TIMEOUT)}),i.timeout))}(n[++r],(function(e,o,c){if(i.status===cn.CONNECTING)if(c===cn.OPEN){if(i.url=o.url,i.socket=e,i.status=cn.OPEN,e.onmessage=function(e){i.status===cn.OPEN&&(j.g(i.logLevel,`${i.tag||"Transport"} Received: ${s.i(e.data)?e.data:"binary"}`),i.onReceive&&s.i(e.data)&&i.onReceive(JSON.parse(e.data)),i.onmessage&&i.onmessage(e.data),i.fire(mn,[e.data]))},e.onclose=function(n){i.status===cn.OPEN&&(i.connectOnClose?(i.status=cn.NONE,i.onReconnecting&&i.onReconnecting(),i.fire(gn),i.isReconnect=!0,j.j((i.tag||"Transport")+" reconnecting"),e.clear&&e.clear(),i.connect(o,t)):(i.onClose&&i.onClose(n),i.fire(hn,[n])))},i.retryCount>0&&(i.retryIndex=0),i.onOpen&&(j.c(`${i.tag||"Transport"} ${i.isReconnect?"reconnect":"connect"} success`),i.onOpen({server:o,reconnect:i.isReconnect})),i.fire(ln,[{server:o,reconnect:i.isReconnect}]),i.queue.length)for(;i.queue.length;){const t=i.queue.shift(),n=s.i(t)||s.b(t)?t:JSON.stringify(t);e.send(n),j.g(i.logLevel,`${i.tag||"Transport"} Sent: ${s.b(t)?"binary":n}`),i.onSend&&i.onSend(n),i.fire(fn,[n])}}else if(r===n.length-1){if(i.retryCount>0&&i.retryIndex++<i.retryCount-1)return r=-1,void a();switch(i.status=c){case cn.ERROR:j.d(`${i.tag||"Transport"} ${i.isReconnect?"reconnect":"connect"} error`),i.onError&&i.onError({server:o}),i.fire(pn,[{server:o}]);break;case cn.TIMEOUT:j.d(`${i.tag||"Transport"} ${i.isReconnect?"reconnect":"connect"} timeout`),i.onTimeout&&i.onTimeout({server:o}),i.fire(vn,[{server:o}])}}else a();else if(i.status===cn.CLOSING){let t=!1;if(c===cn.OPEN&&i.refreshQueueOnClose&&i.queue.length){for(;i.queue.length;){const t=i.queue.shift(),n=s.i(t)||s.b(t)?t:JSON.stringify(t);e.send(n),j.g(i.logLevel,`${i.tag||"Transport"} Sent: ${s.b(t)?"binary":n}`),i.onSend&&i.onSend(n),i.fire(fn,[n])}t=!0}t?setTimeout(()=>{e.close(),i.status=cn.CLOSE},1e3):(e.close(),i.status=cn.CLOSE)}})):i.status===cn.CLOSING&&(i.status=cn.CLOSE)},a=function(){i.interval>0?i.nextStartTimer=setTimeout(o,i.interval):o()};i.status=cn.CONNECTING,o()}send(e){if(this.status!==cn.OPEN&&this.status!==cn.CLOSING)return this.queueMax>0&&this.queue.length===this.queueMax&&this.queue.shift(),void this.queue.push(e);const t=this.socket;if(t){const i=s.i(e)||s.b(e)?e:JSON.stringify(e);t.send(i),j.g(this.logLevel,`${this.tag||"Transport"} Sent: ${s.b(e)?"binary":i}`),this.onSend&&this.onSend(i),this.fire(fn,[i])}}close(){const e=this.socket;if(this.socket=null,this.status=cn.CLOSING,e){let t=!1;if(this.refreshQueueOnClose&&this.queue.length){for(;this.queue.length;)this.send(this.queue.shift());t=!0}e.onmessage=e.onclose=null,t?setTimeout(()=>{e.close(),this.status=cn.CLOSE},1e3):(e.close(),this.status=cn.CLOSE)}this.nextStartTimer&&(clearTimeout(this.nextStartTimer),this.nextStartTimer=null)}reconnect(){this.status!==cn.CONNECTING&&(this.close(),this.status===cn.CLOSING?setTimeout(()=>{this.status=cn.CLOSE,this.connect(this.server,this.proxys)},1e3):this.connect(this.server,this.proxys))}getSocket(){return this.socket}},yn=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};let Sn,Tn;const En={};let bn=[];const Rn={sniffer:function(e){const t=fe();return{result:{receiver:e,send:t,costTime:Math.max(t-e,0)}}}};function In(){(function(){return Zi(this,void 0,void 0,(function*(){return on(tn("/vrm/api/proxies/sniffers"),{})}))})().then(e=>{bn=e.data.sniffers,s.a(bn)&&(qe(En,(e,t)=>{Ue(bn,t)||(e.close(),delete En[t])}),Pe(bn,e=>{if(!En[e]){const t=new _n({tag:"Probe "+e,retryCount:0,onClose:()=>{t.close(),delete En[e]},native:dn,nativeOptions:{processOffer:function(e,t){return yn(this,void 0,void 0,(function*(){return rn(e,{type:"offer",sdp:t}).then(e=>e.sdp)}))}}});t.onmessage=e=>yn(this,void 0,void 0,(function*(){if(e){const i=fe(),n=JSON.parse(e);if(Rn[null==n?void 0:n.method]){let e=yield Rn[n.method](i);e=We({id:n.id,version:"2.0"},e),t.send(JSON.stringify(e))}}})),En[e]=t,t.connect({url:e})}}))}).catch(e=>{!function(){Tn&&(Tn.destroy(),Tn=null);Sn=!1}()})}function kn(){return!!(yt.chrome&&yt.checkVersion(yt.majorVersion,"69")||yt.firefox&&yt.checkVersion(yt.majorVersion,"46")||yt.newEdge&&yt.checkVersion(yt.majorVersion,"80"))}var wn=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};const Cn={maxRetry:0,requestTimeout:5e3,responseTimeout:5e3,duplicatesTimeout:5e3};function An(...e){let t="";for(let i=0;i<e.length;i++)e[i]&&(t+=e[i]);return t}class Dn extends Ke{constructor(e,t,i={}){super(!1),this.packer=e,this.options=We({},Cn,i),this.requestID=0,this.reqMap=new Map,this.resMap=new Map,this.onmessageHandler=e=>{this.onmessage(e)},t&&this.handlTransport(t)}handlTransport(e){this.transport&&(Object(s.d)(this.transport.removeListener)?this.transport.removeListener(this.onmessageHandler):Object(s.d)(this.transport.removeEventListener)?this.transport.removeEventListener(this.onmessageHandler):Object(s.d)(this.transport.onmessage)&&(this.transport.onmessage=null)),e&&(Object(s.d)(e.addListener)?e.addListener("onmessage",this.onmessageHandler):Object(s.d)(e.addEventListener)?e.addEventListener("onmessage",this.onmessageHandler):e.onmessage=this.onmessageHandler,this.transport=e)}send(e){Object(s.d)(this.transport.send)?this.transport.send(e):Object(s.d)(this.transport.write)?this.transport.write(e):Object(s.d)(this.transport.postMessage)&&this.transport.postMessage(e)}request(e,t={},i){return wn(this,void 0,void 0,(function*(){if(!this.transport)throw new Error(`request ${e}, params: ${JSON.stringify(t)} failed, transport has closed`);return new Promise((n,r)=>{const o=this.requestID++;i&&(t.dest=i),this.options.peerId&&(t.from=this.options.peerId);const s={resolve:n,reject:r,id:o,dest:i,timer:null,retryCount:0,message:this.packer.pack({method:e,params:t},o)},a=()=>{s.retryCount>=this.options.maxRetry?(this.reqMap.delete(An(s.id)),j.d(`request ${e}, params: ${JSON.stringify(t)} timeout`),r(new Error("request timeout"))):(s.retryCount++,s.timer=setTimeout(a,this.options.requestTimeout),j.j(`retry request ${e}, params: ${JSON.stringify(t)}, count: ${s.retryCount}`),this.send(s.message))};s.timer=setTimeout(a,this.options.requestTimeout),this.reqMap.set(An(s.id),s),this.send(s.message)})}))}reply(e,t,i){var n;this.options.peerId&&(t&&(t.from=this.options.peerId),i&&(i.from=this.options.peerId));const r=this.packer.pack({result:t,error:i},e.id),o={id:e.id,message:r,timer:null},s=An(e.id,null===(n=e.params)||void 0===n?void 0:n.from);this.options.responseTimeout&&(o.timer=setTimeout(()=>{this.resMap.delete(s)},this.options.responseTimeout),this.resMap.set(s,o)),this.send(o.message)}onmessage(e){var t;if(this.transport)if(Ce(e))if(Object(s.i)(e)){let i;try{i=this.packer.unpack(e)}catch(e){return void j.d(e,"RpcBuilder")}const n=i.id,r=i.method,o=null!==(t=i.params)&&void 0!==t?t:{},s=o.dest;o.dest;if(Ce(this.options.peerId)&&this.options.peerId===s)return;if(Ce(n))if(r){const t=this.resMap.get(An(n,s));t?(j.j(`request: ${e} has replyed in ${this.options.responseTimeout}ms, send same again`),this.send(t.message)):this.fire("request",[i])}else{const t=i.error,r=i.result;if((null==t?void 0:t.dest)!==this.options.peerId||(null==r?void 0:r.dest)!==this.options.peerId)return;const o=An(n),s=this.reqMap.get(o);s?(clearTimeout(s.timer),t?(j.d(`[request error] request: ${s.message}, response: ${e}`),s.reject(t)):s.resolve(r),this.reqMap.delete(o)):j.j("no request for the response: "+e)}else this.fire("notify",[r,o,i.seq])}else this.fire("binary",[e]);else j.j("Message is not defined","RpcBuilder")}destroy(){this.off(),this.handlTransport(),this.reqMap.forEach(e=>{clearTimeout(e.timer),e.reject("transport closed")}),this.reqMap.clear(),this.reqMap=null,this.resMap.forEach(e=>{clearTimeout(e.timer)}),this.resMap.clear(),this.resMap=null,this.packer=null,this.transport=null}getPacker(){return this.packer}getTransport(){return this.transport}setTransport(e){this.handlTransport(e)}}var On=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};const Pn={heartbeat:15e3,requestTimeout:15e3,maxRetry:3,packer:class extends class{constructor(){}}{constructor(){super()}pack(e,t){const i={jsonrpc:"2.0"};if(e.method)i.method=e.method,e.params&&(i.params=e.params),Ce(t)&&(i.id=t);else if(Ce(t)){if(e.error){if(e.result)throw new TypeError("Both result and error are defined");i.error=e.error}else{if(!e.result)throw new TypeError("No result or error is defined");i.result=e.result}i.id=t}return JSON.stringify(i)}unpack(e){const t=JSON.parse(e);if("2.0"!==t.jsonrpc)throw new TypeError(`Invalid JsonRPC version ${t.jsonrpc}: ${e}`);if(!Ce(t.method)){if(!Ce(t.id))throw new TypeError("Invalid message: "+e);const i=Ce(t.error),n=Ce(t.result);if(n&&i)throw new TypeError("Both result and error are defined: "+e);if(!n&&!i)throw new TypeError("No result or error is defined: "+e)}return t}},retryInterval:500,connectTimeout:1e4};class xn extends Ke{constructor(e,t,i){var n,r;super(!0),this.server=e,this.proxys=i,this.options=We({},Pn,t),this.heartbeatTimer=new Ii(()=>{this.heartbeat()},this.options.heartbeat,this.options.heartbeat),this.packer=new this.options.packer,this.transport=new _n({native:null!==(n=this.options.transport)&&void 0!==n?n:WebSocket,onSend:e=>{this.fire("onsend",[e])},onReceive:e=>{this.fire("onreceive",[e])},onOpen:e=>{this.fire(e.reconnect?"reconnected":"connected"),this.heartbeatTimer.start()},onClose:()=>{this.fire("close"),this.heartbeatTimer&&this.heartbeatTimer.stop()},onError:()=>{this.fire("error"),this.heartbeatTimer&&this.heartbeatTimer.stop()},onTimeout:()=>{this.fire("timeout"),this.heartbeatTimer&&this.heartbeatTimer.stop()},onReconnecting:()=>{this.fire("reconnecting"),this.heartbeatTimer&&this.heartbeatTimer.stop()},connectOnClose:!0,retryCount:this.options.maxRetry,nativeOptions:null!==(r=this.options.transportOptions)&&void 0!==r?r:{},tag:this.options.tag,interval:this.options.retryInterval,timeout:this.options.connectTimeout,logLevel:this.options.logLevel}),this.rpc=new Dn(this.packer,this.transport,{requestTimeout:this.options.requestTimeout,responseTimeout:this.options.requestTimeout,peerId:this.options.peerId}),this.rpc.on("binary",e=>{this.fire("binary",[e])}),this.rpc.on("notify",(e,t,i)=>{this.fire("notify",[e,t,i])}),this.rpc.on("request",e=>{this.fire("request",[e])}),Object(de.a)(()=>{this.transport&&this.transport.connect(this.server,this.proxys)})}request(e,t={}){return On(this,void 0,void 0,(function*(){return this.rpc.request(e,t)}))}reply(e,t,i){return this.rpc.reply(e,t,i)}sendBinary(e){const t=this.transport.getSocket();t&&t.send(e)}destroy(){this.off(),this.rpc&&this.rpc.destroy(),this.transport&&this.transport.close(),this.transport=null,this.rpc=null,this.packer=null,this.heartbeatTimer&&this.heartbeatTimer.destroy(),this.heartbeatTimer=null}}var Mn=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};class Ln extends xn{constructor(e,t,i){super({url:e},t),this.notified=-1,this.seq=0,this.sessionId=null,this.needSyncNotify=!1,this.syncRoomLock=!1,this.retryQueue=[],this.proxy=i}resetTimeout(){this.resetTimer&&clearTimeout(this.resetTimer),this.resetTimer=setTimeout(()=>{this.fire("timeout"),this.destroy()},4*this.options.heartbeat)}syncNotify(){return Mn(this,void 0,void 0,(function*(){return this.request("recover",{sessionId:this.sessionId,notified:this.notified})}))}request(e,t){const i=Object.create(null,{request:{get:()=>super.request}});return Mn(this,void 0,void 0,(function*(){const n=this.seq++;return this.syncRoomLock&&"syncRoom"!==e?(j.j(`session closed, waiting for sync room, method: ${e}, params: ${JSON.stringify(t)}`),new Promise((i,r)=>{this.retryQueue.push({method:e,params:t,resolve:i,reject:r,id:n})})):i.request.call(this,e,t).then(t=>(!this.sessionId&&t.sessionId&&(this.sessionId=t.sessionId),"syncRoom"===e&&(this.retryQueue.length&&(this.retryQueue.sort((e,t)=>e.id-t.id),Pe(this.retryQueue,e=>{e.params.sessionId=this.sessionId,j.f(`retry the retryQueue request, ${e.method}, params: ${JSON.stringify(e.params)}`),this.request(e.method,e.params).then(t=>{e.resolve(t)}).catch(t=>{e.reject(t)})}),this.retryQueue=[]),this.syncRoomLock=!1),t)).catch(i=>{if(99===(null==i?void 0:i.code))return this.sessionId&&this.sessionId!==t.sessionId?(j.j(`the request session has closed but the seesion is update after sync room, retry request again, ${e}, params: ${JSON.stringify(t)}`),t.sessionId=this.sessionId,this.request(e,t)):(this.syncRoomLock||(this.sessionId=null,this.syncRoomLock=!0,this.fire("session-close")),j.j(`the session has closed, push the request into retry queue, ${e}, params: ${JSON.stringify(t)}`),new Promise((i,r)=>{this.retryQueue.push({method:e,params:t,resolve:i,reject:r,id:n})}));throw i})}))}heartbeat(){this.request("ping",{sessionId:this.sessionId}).then(e=>{this.resetTimeout(),this.needSyncNotify&&(this.syncNotify(),this.needSyncNotify=!1)}).catch(e=>{this.needSyncNotify=!0,j.d("channel heartbeat error: "+JSON.stringify(e))})}destroy(){this.seq=null,this.notified=null,this.sessionId=null,this.retryQueue=null,this.syncRoomLock=null,this.needSyncNotify=null,this.resetTimeout&&(clearTimeout(this.resetTimer),this.resetTimeout=null),super.destroy()}getProxy(){return this.proxy}}var Nn=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};function Un(e){return $e(e)||""}function Vn(e,t){return"application/x-www-form-urlencoded"===e?Un(t):"multipart/form-data"===e?function(e){const t=new FormData;return e&&qe(e,(e,i)=>{t.append(encodeURIComponent(i),encodeURIComponent(e))}),t}(t):JSON.stringify(t)}function Fn(e,t,i){return Nn(this,void 0,void 0,(function*(){return new Promise((n,r)=>{let o=0;!function a(){return Nn(this,void 0,void 0,(function*(){o++;try{const r=yield Promise.race([fetch(e,{body:Vn(i,t),cache:"no-cache",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":null!=i?i:"application/json"},method:"POST",mode:"cors",redirect:"follow",referrer:"no-referrer"}),new zi(8)]);if(s.f(r))throw new Error(`fetch ${e}, data: ${JSON.stringify(t)} timeout`);n(r.json())}catch(e){o<3?(yield new zi(1),a()):r(e)}}))}()})}))}const jn={joinUser:"peer-joined",leaveUser:"peer-leaved",roomClosed:"room-closed",roomError:"error",updateStats:"update-stats",updateUser:"peer-update",publishStream:"stream-added",unpublishStream:"stream-removed",onIceCandidate:"ice-candidate",streamUpdate:"stream-update",streamError:"stream-error",streamDisconnected:"stream-disconnected",evicted:"evicted",userRejoined:"peer-rejoined",tokenWillExpire:"token-will-expire",tokenExpire:"token-expire"};var Bn=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};class Hn extends Ke{constructor(e,t=!1,i=!0,n={}){super(!1),this.proxies=e,this.forceWS=t,this.enableRace=i,this.closed=!1,this.icefull=!1,this.isConnecting=!1,this.rpc=n}isDataChannel(e){return 0!==e.indexOf("wss:")&&0!==e.indexOf("ws:")}getTransport(e){return this.isDataChannel(e)?dn:null}getTransportOptions(e){return this.isDataChannel(e)?{processOffer:(e,t)=>Bn(this,void 0,void 0,(function*(){return Fn(e,{type:"offer",sdp:t}).then(e=>e.sdp)}))}:{}}raceConnect(){return Bn(this,void 0,void 0,(function*(){let e=this.proxies;if(this.forceWS){const t=e.filter(e=>!!e.url);t.length&&(e=t)}this.connectingTimers={};const t=".connecting"+Math.random();return new Promise((i,n)=>{let r=!1;const o=(e,o)=>{r?e.destroy():this.closed?(qe(this.connectingTimers,e=>{clearTimeout(e.timer),e.channel&&e.channel.destroy()}),this.connectingTimers={},j.j("signal open after call close function, reject"),n("signal has already closed")):(r=!0,qe(this.connectingTimers,(e,t)=>{clearTimeout(e.timer),e.channel&&t!=o&&e.channel.destroy()}),this.connectingTimers={},e.off(t),i(e))};let s=0;const a=()=>{++s===e.length&&(qe(this.connectingTimers,e=>{e.channel&&e.channel.destroy()}),this.connectingTimers={},j.d("connect all proxies failed"),n("connect all proxies failed"))},c=(e,i)=>{const n=new Ln(e,{maxRetry:5,transport:this.getTransport(e),transportOptions:this.getTransportOptions(e),tag:"Signal"},i);n.one("connected"+t,()=>{o(n,e)}).one("reconnected"+t,()=>{o(n,e)}).one("error"+t,()=>{a()}).one("timeout"+t,()=>{a()}),this.connectingTimers[e].channel=n};Pe(e,e=>{const t=e.delay?lt(e.delay):0,i=`${e.url||e.dcurl}${e.suffix}`;this.connectingTimers[i]={timer:setTimeout(()=>{c(i,e)},t)}})})}))}queueConnect(){return Bn(this,void 0,void 0,(function*(){let e=this.proxies;if(this.forceWS){const t=e.filter(e=>!!e.url);t.length&&(e=t)}const t=".connecting"+Math.random();return new Promise((i,n)=>{let r=0;const o=()=>{this.closed&&n("signal has closed");const s=e[r],a=`${s.url||s.dcurl}${s.suffix}`,c=this.connectingChannel=new Ln(a,{maxRetry:3,transport:this.getTransport(a),transportOptions:this.getTransportOptions(a),tag:"Signal"},s);c.one("connected"+t,()=>{c.off(t),this.connectingChannel=null,i(c)}).one("reconnected"+t,()=>{c.off(t),this.connectingChannel=null,i(c)}).one("error"+t,()=>{c.destroy(),this.connectingChannel=null,j.d(`queue connect proxy: ${r} ${a} error`),this.fire("state-notify",[{level:j.a,msg:`queue connect proxy: ${r} ${a} error`}]),r++,r>=e.length?(j.d("connect all proxies failed"),r=0,n("connect all proxies failed")):setTimeout(()=>{o()},1e3)}).one("timeout"+t,()=>{c.destroy(),this.connectingChannel=null,j.d(`queue connect proxy: ${r} ${a} timeout`),this.fire("state-notify",[{level:j.a,msg:`queue connect proxy: ${r} ${a} timeout`}]),r++,r>=e.length?(j.d("connect all proxies failed"),r=0,n("connect all proxies failed")):setTimeout(()=>{o()},1e3)})};o()})}))}tryConnectOtherProxy(e){this.proxies.length>1?(Ne(this.proxies,this.getProxy()),Le(this.proxies,this.getProxy()),j.f("try to connect other proxies"),this.connect().then(()=>{this.fire("reconnected"),this.channel.syncNotify()}).catch(t=>{j.d("connect other proxies failed"),this.fire(e)})):this.fire(e)}connect(){return Bn(this,void 0,void 0,(function*(){if(!this.proxies.length)return new Error("not has any proxy to connect");this.isConnecting=!0,this.enableRace?this.channel=yield this.raceConnect():this.channel=yield this.queueConnect(),this.channel.on("error",()=>{j.d("proxy connect error, proxy: "+JSON.stringify(this.getProxy())),this.fire("error")}).on("close",()=>{j.d("proxy connect close, proxy: "+JSON.stringify(this.getProxy())),this.fire("close")}).on("timeout",()=>{j.d("proxy connect timeout, proxy: "+JSON.stringify(this.getProxy())),this.fire("timeout")}).on("connected",()=>{this.fire("connected")}).on("reconnecting",()=>{this.fire("reconnecting")}).on("reconnected",()=>{this.fire("reconnected"),this.channel.syncNotify()}).on("notify",(e,t,i)=>{i&&i<this.channel.notified?j.j(`skip notify: ${i}, now notified: ${this.channel.notified}`):(this.channel.notified=i,jn[e]?this.fire(jn[e],[t]):this.fire("notify",[{method:e,params:t}]))}).on("request",e=>Bn(this,void 0,void 0,(function*(){if(this.rpc[e.method]){const{error:t,result:i}=yield this.rpc[e.method](e);this.channel.reply(e,i,t)}}))).on("session-close",()=>{this.fire("session-close")}),this.isConnecting=!1}))}request(e,t){return Bn(this,void 0,void 0,(function*(){return this.channel.request(e,t)}))}join(e){return Bn(this,void 0,void 0,(function*(){return this.channel.request("joinRoom",e).then(e=>(this.icefull=e.icefull,e))}))}leave(e){return Bn(this,void 0,void 0,(function*(){return this.channel.request("leaveRoom",e)}))}evictUser(e){return Bn(this,void 0,void 0,(function*(){return this.channel.request("evictUser",e)}))}publish(e){return Bn(this,void 0,void 0,(function*(){return this.channel.request("publishStream",e)}))}unpublish(e){return Bn(this,void 0,void 0,(function*(){return this.channel.request("unpublishStream",e)}))}controlStream(e){return Bn(this,void 0,void 0,(function*(){return this.channel.request("controlStream",e)}))}subscribe(e){return Bn(this,void 0,void 0,(function*(){return this.channel.request("subscribeStream",e)}))}unsubscribe(e){return Bn(this,void 0,void 0,(function*(){return this.channel.request("unsubscribeStream",e)}))}addIceCandidate(e){return Bn(this,void 0,void 0,(function*(){return this.icefull?this.channel.request("addIceCandidate",e):Promise.resolve({})}))}syncRoom(e){return Bn(this,void 0,void 0,(function*(){return this.channel.sessionId=null,this.channel.request("syncRoom",e).then(e=>(this.icefull=e.icefull,e))}))}setBitrate(e){return Bn(this,void 0,void 0,(function*(){return this.channel.request("setrate",e)}))}close(){this.connectingChannel&&this.connectingChannel.destroy(),Ge(this.connectingTimers).length&&(qe(this.connectingTimers,e=>{clearTimeout(e.timer),e.channel&&e.channel.destroy()}),this.connectingTimers={}),this.channel&&this.channel.destroy(),this.closed=!0,this.off()}getSessionId(){var e;return null===(e=this.channel)||void 0===e?void 0:e.sessionId}getProxy(){var e;return null===(e=this.channel)||void 0===e?void 0:e.getProxy()}}class Gn{constructor(e,t){this.userId=e,this.info=t,this.streams=new Map}getUserId(){return this.userId}getUserInfo(){return this.info}getStreams(){return this.streams}getStream(e){return this.streams.get(e)}addStream(e){this.streams.set(e.getStreamId(),e)}removeStream(e){if(!this.streams)return;const t=this.streams.get(e);return t?(this.streams.delete(e),t):void 0}updateInfo(e){this.info=e}destroy(){this.streams.forEach(e=>{e.close()}),this.streams.clear(),this.streams=null,this.info=null,this.userId=null}}function qn(e=[]){return function(t){return Pe(t.media,t=>{const i=[],n=[],r=[],o=lt(t.payloads.split(" ").shift()),s="apt="+o;Pe(t.rtp,t=>{(t.payload===o||Ue(e,t.codec))&&i.push(t)}),Pe(t.fmtp,e=>{e.payload===o?n.push(e):e.config===s&&(n.push(e),Pe(t.rtp,t=>{t.payload===e.payload&&i.push(t)}))}),Pe(t.rtcpFb,e=>{e.payload===o&&r.push(e)});const a=[o];Pe(i,e=>{e.payload!==o&&a.push(e.payload)}),t.payloads=a.join(" "),t.rtp=i,t.fmtp=n,t.rtcpFb=r}),j.c("[sdpOperator shrink]: holdCodec: "+JSON.stringify(e)),t}}class Jn extends pi{constructor(e={}){super(e),this.direction=ai.RECV_ONLY,"ontrack"in this.pc?this.pc.ontrack=e=>{this.stream=e.streams[0]}:"onaddstream"in this.pc&&(this.pc.onaddstream=e=>{this.stream=e.stream})}getMediaStream(){if(this.stream)return this.stream;if(this.pc)if(this.pc.getReceivers){this.stream=new MediaStream;const e=this.pc.getReceivers();let t=!1,i=!1;e.forEach(e=>{e.track&&"video"===e.track.kind&&!t&&(this.stream.addTrack(e.track),t=!0),e.track&&"audio"===e.track.kind&&!i&&(this.stream.addTrack(e.track),i=!0)})}else this.stream=this.pc.getRemoteStreams()[0];return this.stream}}var Wn=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};const zn={videoOn:!1,audioOn:!1,videoEnable:!1,audioEnable:!1,simulcast:1,redAudio:!1};class $n extends Xt{constructor(e,t){super({client:t,userId:e.userId,streamId:e.streamId,videoOn:e.videoOn,audioOn:e.audioOn,videoEnable:e.videoEnable,audioEnable:e.audioEnable}),this.options=We({},zn,e)}getStream(){if(this.peer)return this.peer.getMediaStream()}getProfile(){return this.profile}setProfile(e){this.profile=e}processOffer(e=!0,t=!0,i=[]){return Wn(this,void 0,void 0,(function*(){if(!this.options.audioOn&&!this.options.videoOn)throw new Error("not has any media track");this.peer&&this.peer.destroy(),this.collector&&this.collector.destroy(),this.peer=new Jn({iceServers:i,rtcpMuxPolicy:"require"}),this.handlerEvent();let n=yield this.peer.offer({offerToReceiveAudio:this.options.audioOn&&e,offerToReceiveVideo:this.options.videoOn&&t});return n=Ui(Vi(this.options.acodec,ci.AUDIO),Vi(this.options.vcodec,ci.VIDEO),xi(ai.RECV_ONLY),Oi("rrtr",ui.ADD,ci.VIDEO),Fi("urn:ietf:params:rtp-hdrext:sdes:mid",ci.AUDIO),this.options.redAudio?Mi(6,"urn:boom:audio-stacked-rtp",ci.AUDIO):null,Oi("nack",ui.ADD,ci.AUDIO))(n),yield this.peer.setOffer(n),this.collector=new Ci(this.peer.getPeerConnection(),1e3,!1),j.c(`remotestream ${this.getUserId()} ${this.getStreamId()} offer: ${"\n"+n}`),n}))}processAnswer(e){return Wn(this,void 0,void 0,(function*(){const t=[],i=Ui(Di(t,!1));e=i(e),this.msms=t.join(","),j.c(`remotestream ${this.getUserId()} ${this.getStreamId()} answer: ${"\n"+e}`),yield this.peer.setAnwser(e)}))}destroy(){this.close(),this.options=null}getOptions(){return this.options}}function Kn(e){if(s.i(e))return e;if(s.h(e)){if(s.i(e.message))return e.message;if(s.i(e.msg))return e.msg;if(s.d(e.toString))return e.toString()}return"unknow"}var Yn=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};const Qn={forceWS:!1,enableRace:!1},Xn=["red","ulpfec","rtx","flexfec-03"];class Zn extends Ke{constructor(e){super(!0),this.options=We({},Qn,e),this.joined=!1,this.userMap=new Map,this.iceServers=[]}parseUser(e){const t=e.value,i=[];Pe(t,e=>{var t;const n=new Gn(e.userId,e.info.userinfo);(null===(t=e.streams)||void 0===t?void 0:t.length)&&Pe(e.streams,t=>{var r;const o=new $n({userId:e.userId,streamId:t.streamId,acodec:t.params.acodec,vcodec:t.params.vcodec,videoOn:t.params.video,audioOn:t.params.audio,videoEnable:t.params.video_enable,audioEnable:t.params.audio_enable,simulcast:null!==(r=t.params.simulcast)&&void 0!==r?r:1},this);i.push(o),n.addStream(o)}),this.userMap.set(n.getUserId(),n)}),Object(de.a)(()=>{Pe(i,e=>{const t=this.userMap.get(e.getUserId());t&&t.getStream(e.getStreamId())&&this.fire("stream-added",[e])})})}join(e,t,i,n=null){var r,o;return Yn(this,void 0,void 0,(function*(){if(this.roomId=e,this.userId=t.id,i&&(this.options.token=i),!(null===(r=this.options.proxies)||void 0===r?void 0:r.length))throw new Error("not has any proxy to connect");if(!this.options.token)throw new Error("not has token to connect");if(this.joined)throw new Error("has already connected");Pe(this.options.proxies,e=>{e.suffix=`?token=${this.options.token}${this.options.ip?"&ip="+this.options.ip:""}`}),this.signal=new Hn(this.options.proxies,this.options.forceWS,this.options.enableRace,this.getRpc()),this.handleEvents(),yield this.signal.connect();const a=We({},t.info);a.create=!0,a.network=Xi.name,a.platform="Web";try{const e=yield this.signal.join({roomId:this.roomId,userId:this.userId,info:a,sessionId:n});s.a(e.iceservers)&&Pe(e.iceservers,e=>{e.urls||(e.urls=e.url),this.iceServers.push(e)}),this.joined=!0,this.callId=(null===(o=e.raw)||void 0===o?void 0:o.callId)||"";const i=new Gn(this.userId,t.info);return this.userMap.set(i.getUserId(),i),this.parseUser(e),j.f(`joined: sessionId: ${e.sessionId}, callId: ${e.raw.callId}`),{sessionId:e.sessionId,callId:e.raw.callId}}catch(e){throw j.d(`join room failed: ${Kn(e)}, proxy: ${JSON.stringify(this.getActiveProxy())}`),this.signal.close(),e}}))}leave(){var e;return Yn(this,void 0,void 0,(function*(){this.signal&&(j.f("leaved: sessionId: "+((null===(e=this.signal)||void 0===e?void 0:e.getSessionId())||"")),yield this.signal.leave({roomId:this.roomId,userId:this.userId,sessionId:this.signal.getSessionId()||""}),this.signal.close(),this.signal=null,this.joined=!1)}))}publish(e,t){var i;return Yn(this,void 0,void 0,(function*(){if(!this.joined)throw new Error("client not joined");j.f(`publish: ${this.userId} ${e.getStreamId()} options: ${JSON.stringify(t)}`),t&&e.setOptions(t);let n=yield e.processOffer(this,this.iceServers);const r=Ui(qn(Xn));e.published=!0,t=e.getOptions();const o={};if(e.hasAudio()&&(o.audio={codec:t.acodec&&t.acodec.toLocaleUpperCase()||"OPUS",bitrate:Math.ceil(t.audioBitrate/1024)}),e.hasVideo()&&t.encodings.length){let e=0,n=-1,r=-1,s=-1;for(let o=0;o<t.encodings.length;o++)e+=null!==(i=t.encodings[o].bitrate)&&void 0!==i?i:0,n<t.encodings[o].width&&(n=t.encodings[o].width,s=t.encodings[o].fps),r<t.encodings[o].height&&(r=t.encodings[o].height);o.video={w:n,h:r,fps:s,codec:t.vcodec&&t.vcodec.toLocaleUpperCase()||"H264",bitrate:Math.ceil(e/1024)}}const{sdpAnswer:s}=yield this.signal.publish({roomId:this.roomId,userId:this.userId,streamId:e.getStreamId(),sessionId:this.signal.getSessionId(),options:{sdpOffer:r(n),audio:e.hasAudio(),video:e.hasVideo(),audio_enable:e.getAudioEnable(),video_enable:e.getVideoEnable(),attribute:o,simulcast:t.simulcast}});yield e.processAnswer(s);this.userMap.get(this.userId).addStream(e),e.startCollecting()}))}unpublish(e){return Yn(this,void 0,void 0,(function*(){if(!this.joined)throw new Error("client not joined");j.f(`unpublish: ${e.getUserId()} ${e.getStreamId()}`),e.published=!1,yield this.signal.unpublish({roomId:this.roomId,userId:this.userId,sessionId:this.signal.getSessionId(),streamId:e.getStreamId()}),e.close();this.userMap.get(this.userId).removeStream(e.getStreamId())}))}updateStream(e,t){return Yn(this,void 0,void 0,(function*(){if(!this.joined)throw new Error("client not joined");j.f(`updateStream: ${e.getUserId()} ${e.getStreamId()} options: ${JSON.stringify(t)}`),yield this.signal.controlStream({roomId:this.roomId,userId:this.userId,streamId:e.getStreamId(),sessionId:this.signal.getSessionId(),options:t})}))}preferProfile(e,t){return Yn(this,void 0,void 0,(function*(){if(!(e instanceof $n))throw new Error("stream not remotestream instance");return this.updateStream(e,{profile:t})}))}subscribe(e,t={audio:!0,video:!0,profile:0}){return Yn(this,void 0,void 0,(function*(){if(!this.joined)throw new Error("client not joined");if(!(e instanceof $n))throw new Error("stream not remotestream instance");j.f(`subscribe: ${e.getUserId()} ${e.getStreamId()} options: ${JSON.stringify(t)}`);const i=e.getOptions();let n=yield e.processOffer(t.audio,t.video,this.iceServers);const r={sdpOffer:Ui(qn(Xn))(n),audio:e.hasAudio()&&t.audio,video:e.hasVideo()&&t.video};i.simulcast>1&&(r.profile=s.f(t.profile)?t.profile:i.simulcast-1);const{sdpAnswer:o}=yield this.signal.subscribe({roomId:this.roomId,userId:this.userId,streamId:e.getStreamId(),sessionId:this.signal.getSessionId(),options:r});yield e.processAnswer(o),e.startCollecting()}))}unsubscribe(e){return Yn(this,void 0,void 0,(function*(){if(!this.joined)throw new Error("client not joined");j.f(`unsubscribe: ${e.getUserId()} ${e.getStreamId()}`),yield this.signal.unsubscribe({roomId:this.roomId,userId:this.userId,sessionId:this.signal.getSessionId(),streamId:e.getStreamId()}),e.close()}))}resetEncodings(e,t){return Yn(this,void 0,void 0,(function*(){if(!this.joined)throw new Error("client not joined");const i=e.getOptions();if(null==i?void 0:i.encodings){j.f(`setEncodings: ${e.getUserId()} ${e.getStreamId()}`);const n=i.encodings.reduce((e,t)=>e+Math.ceil(t.bitrate/1e3),0),r=t.reduce((e,t)=>e+Math.ceil(t.bitrate/1e3),0);e.resetEncodings(t),n!==r&&(yield this.signal.setBitrate({roomId:this.roomId,userId:this.userId,sessionId:this.signal.getSessionId(),streamId:e.getStreamId(),rate:r}))}else j.j(`can not resetEncodings because of stream not publish, ${e.getUserId()} ${e.getStreamId()}`)}))}syncIcecandidate(e,t){return Yn(this,void 0,void 0,(function*(){if(!this.joined)throw new Error("client not joined");yield this.signal.addIceCandidate({roomId:this.roomId,userId:this.userId,sessionId:this.signal.getSessionId(),streamId:e.getStreamId(),candidate:t})}))}syncRoom(){return Yn(this,void 0,void 0,(function*(){if(!this.joined)throw new Error("client not joined");const e=this.userMap.get(this.userId);if(e){const t=We({},e.getUserInfo());t.create=!0,t.network=Xi.name,t.platform="Web";try{yield this.signal.syncRoom({roomId:this.roomId,userId:this.userId,sessionId:null,info:t})}catch(e){this.fire("error"),this.destroy()}}}))}request(e,t){return Yn(this,void 0,void 0,(function*(){return this.signal.request(e,t)}))}getCallId(){return this.callId}destroy(){this.userMap&&(this.userMap.forEach(e=>{e.destroy()}),this.userMap.clear()),this.userMap=null,this.signal&&(this.signal.close(),this.signal=null),this.joined=!1,this.off()}handleEvents(){this.signal.on("error",()=>{j.d("signal error"),this.fire("error")}).on("close",()=>{j.d("signal close"),this.fire("error")}).on("timeout",()=>{j.d("signal timeout"),this.fire("error")}).on("reconnected",()=>{this.fire("reconnected")}).on("peer-joined",e=>{let t=this.userMap.get(e.userId);t?t.updateInfo(e.info||{}):(t=new Gn(e.userId,e.info),this.userMap.set(t.getUserId(),t)),j.c("peer joined: "+t.getUserId()),this.fire("peer-joined",[t.getUserId()])}).on("peer-leaved",e=>{if(e.userId===this.userId)return;const t=this.userMap.get(e.userId);this.userMap.delete(t.getUserId()),t.getStreams().forEach(e=>{this.fire("stream-removed",[e])}),j.c("peer leaved: "+t.getUserId()),this.fire("peer-leaved",[t.getUserId()]),t&&t.destroy()}).on("room-closed",()=>{j.d("room closed"),this.fire("room-closed"),this.destroy()}).on("error",()=>{j.d("room error"),this.fire("error"),this.destroy()}).on("stream-added",e=>{if(e.userId===this.userId)return;let t=this.userMap.get(e.userId);t||(t=new Gn(e.userId,e.info),this.userMap.set(t.getUserId(),t)),j.c(`stream added: ${t.getUserId()} ${e.streamId}`);const i=new $n({userId:t.getUserId(),streamId:e.streamId,acodec:e.params.acodec,vcodec:e.params.vcodec,audioOn:e.params.audio,videoOn:e.params.video,audioEnable:e.params.audio_enable,videoEnable:e.params.video_enable,simulcast:e.params.simulcast},this);t.addStream(i),this.fire("stream-added",[i])}).on("stream-removed",e=>{if(e.userId===this.userId)return;let t=this.userMap.get(e.userId);if(t){const i=e.streams||[];e.streamId&&!Ue(i,e.streamId)&&i.push(e.streamId),j.c(`stream removed: ${t.getUserId()} ${JSON.stringify(i)}`),Pe(i,e=>{const i=t.removeStream(e);i&&(this.fire("stream-removed",[i]),i.close())})}}).on("stream-update",e=>{const t=this.userMap.get(e.userId);if(t){const i=t.getStream(e.streamId);i&&(i.update(e.params),j.c(`stream updated: ${t.getUserId()} ${e.streamId} options: ${JSON.stringify(e.params)}`),this.fire("stream-update",[i]))}}).on("stream-error",e=>{j.d("stream error "+JSON.stringify(e.error)),this.fire("media-error",[e.error])}).on("stream-disconnected",e=>{if(e.userId!==this.userId)return;const t=this.userMap.get(e.userId),i=t.getStream(e.streamId);i&&(j.d(`stream disconnection: ${t.getUserId()} ${e.streamId}`),i.fire("stream-disconnected"))}).on("evicted",e=>{if(e.userId===this.userId)return void this.fire("evicted");const t=this.userMap.get(e.userId);t&&(t.getStreams().forEach(e=>{this.fire("stream-removed",[e])}),j.d("peer evicted: "+t.getUserId()),this.userMap.delete(t.getUserId()),t.destroy())}).on("peer-rejoined",e=>{this.fire("peer-rejoined",[{userId:e.userId,platform:e.info.platform,device:e.info.device,ip:e.info.ip}]),j.j("peer rejoied: "+e.userId)}).on("token-expire",()=>{j.d("token expire"),this.fire("token-expire")}).on("token-will-expire",e=>{j.j("token will expire"),this.fire("token-will-expire",[e.seconds])}).on("session-close",()=>{j.d("session closed, retry syncRoom"),this.syncRoom()}).on("notify",e=>{j.c("notify: "+JSON.stringify(e)),this.fire("notify",[e])}).on("state-notify",e=>{this.fire("state-notify",[e])})}getRpc(){return{sessionClosed:()=>(Object(de.a)(()=>{this.syncRoom()}),{result:0})}}getActiveProxy(){return this.signal.getProxy()}}class er{constructor(e=500,t=50){this.interval=e,this.threshold=t,this.lastTime=le(),this.cpu=[0],this.delay=0,this.timer=new Ii(()=>{this.process()},0,this.interval)}process(){let e=1,t=le();this.delay=Math.max(t-this.lastTime-this.interval,0);let i=this.threshold;this.delay>this.interval+500&&(i*=this.delay/this.interval);let n=1;for(;n<100;)t>this.lastTime+n*i&&e++,n++;this.cpu.push(e),this.cpu.length>20&&this.cpu.shift(),this.lastTime=t}getCPU(){return Math.max(...this.cpu)}getDelay(){return this.delay}start(){this.timer.start()}stop(){this.timer.stop(),this.cpu=[0]}destroy(){this.timer.destroy(),this.cpu=[0]}}var tr=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};const ir={callId:"",diffNTP:0,comments:""};class nr{constructor(e){this.url=e.url,this.options=We({},ir,e),this.seq=0,this.transport=new _n({tag:"Collection",interval:500,connectOnClose:!0,native:dn,nativeOptions:{processOffer:(e,t)=>tr(this,void 0,void 0,(function*(){const i={type:"offer",sdp:t};return this.options.clientIp&&(i.client_ip=this.options.clientIp),Fn(e,i).then(e=>e.sdp).catch(e=>{var t;throw this.options.report&&this.options.report({code:1,msg:"Collection request answer failed, error: "+(null!==(t=null==e?void 0:e.message)&&void 0!==t?t:"")}),e})}))},onReceive:e=>{this.resetTimeout()},onClose:()=>{this.options.report&&this.options.report({code:2,msg:"Collection channel closed"})},onError:()=>{this.options.report&&this.options.report({code:3,msg:"Collection channel error"})},onTimeout:()=>{this.options.report&&this.options.report({code:4,msg:"Collection channel timeout"})},onOpen:e=>{this.options.report&&this.options.report({code:0,msg:"Collection channel opened"})},retryCount:2e3,refreshQueueOnClose:!0,timeout:1e4,queueMax:1800}),this.cpuSimulator=new er,this.cpuSimulator.start(),this.transport.connect({url:`${this.url}/${Qt()}`})}resetTimeout(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null)}setTimeout(){this.timeout||(this.timeout=setTimeout(()=>{this.transport&&(this.transport.reconnect(),this.options.report&&this.options.report({code:5,msg:"Collection reconnect"})),this.timeout=null},2e4))}setCallId(e){this.options.callId=e}heartbeat(){const e={type:"heart",room:this.options.roomId,callId:this.options.callId,user:this.options.userId,ts:le()+this.options.diffNTP,seq:this.seq++,platform:"Web",version:this.options.version,webrtcType:this.options.webrtcType,appid:this.options.appId};this.transport.send(JSON.stringify(e)),this.setTimeout()}action(e,t,i,n,r,o){if(!this.transport)return;const s=le(),a={type:"action",room:this.options.roomId,callId:this.options.callId,user:this.options.userId,ts:s+this.options.diffNTP,action:e,sendTs:(i||s)+this.options.diffNTP,receiveTs:(n||s)+this.options.diffNTP,success:t>0?0:1,eid:Qt(),platform:"Web",version:this.options.version,webrtcType:this.options.webrtcType,appid:this.options.appId,seq:this.seq++,comments:this.options.comments};t>0&&(a.errorCode=t),null!=o&&(a.vErrorCode=o),r&&(a.options=r),this.transport.send(JSON.stringify(a)),this.setTimeout()}stats(e,t,i,n,r,o=0){if(!this.transport)return;t&&(t.cpu={systemCpu:this.cpuSimulator.getCPU(),systemDelay:this.cpuSimulator.getDelay()});const s={type:"stats",room:this.options.roomId,callId:this.options.callId,user:this.options.userId,stream:e,flow:i?"push":"pull",ts:le()+this.options.diffNTP,platform:"Web",version:this.options.version,webrtcType:this.options.webrtcType,appid:this.options.appId,seq:this.seq++,comments:this.options.comments,stats:t};i||(s.remote=n),r&&qe(r,(e,t)=>{s[t]=e}),this.transport.send(JSON.stringify(s)),this.setTimeout()}destroy(){this.transport&&(this.transport.close(),this.transport=null),this.cpuSimulator&&(this.cpuSimulator.destroy(),this.cpuSimulator=null)}}function rr(e){return new Promise((t,i)=>{navigator.mediaDevices.enumerateDevices().then(i=>{t(function(e,t){const i=[];let n=0;for(let r of t)if(r.kind==e||"all"==e){let e={label:"",groupId:r.groupId,deviceId:r.deviceId,kind:r.kind};""===r.label?(n++,"videoinput"==r.kind?e.label="Camera-"+n:"audioinput"==r.kind?e.label="Mic-"+n:"audiooutput"==r.kind?e.label="Speaker-"+n:(n--,e.label="unknown device")):e.label=r.label,e.deviceId&&i.push(e)}return i}(e,i))}).catch(e=>{i(e)})})}var or=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};function sr(){return or(this,void 0,void 0,(function*(){let e=yield rr(di.AUDIO_INPUT),t={};return e.filter(e=>("default"===e.deviceId&&(t=e),"default"!==e.deviceId&&"communications"!==e.deviceId)).map((e,i)=>({name:e.label,deviceId:e.deviceId,groupId:e.groupId,index:i,kind:"audioinput",default:e.groupId===t.groupId&&t.label&&t.label.indexOf(e.label)>-1}))}))}var ar=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};function cr(){return ar(this,void 0,void 0,(function*(){const e=yield rr(di.VIDEO_INPUT);let t={};return e.filter(e=>("default"===e.deviceId&&(t=e),"default"!==e.deviceId&&"communications"!==e.deviceId)).map((e,i)=>({name:e.label,deviceId:e.deviceId,groupId:e.groupId,index:i,kind:"videoinput",default:e.groupId===t.groupId&&t.label&&t.label.indexOf(e.label)>-1}))}))}var ur=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};function dr(){return ur(this,void 0,void 0,(function*(){let e=yield rr(di.AUDIO_OUTPUT),t={};return e.filter(e=>("default"===e.deviceId&&(t=e),"default"!==e.deviceId&&"communications"!==e.deviceId)).map((e,i)=>({name:e.label,deviceId:e.deviceId,groupId:e.groupId,index:i,kind:"audiooutput",default:e.groupId===t.groupId&&t.label&&t.label.indexOf(e.label)>-1}))}))}var lr=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};class hr{constructor(e){var t,i;if(this.mode="rtc",this.codec="h264",this.audioCodec="opus",this.comments="",!e||!s.i(e.appId))throw new y(1001,"appId 类型错误，请检查");e.comments&&(this.comments=e.comments.substr(0,64)),this.brtcAppId=e.appId,this.codec=null!==(t=e.codec)&&void 0!==t?t:"h264",this.webrtcType=0,this.emitter=new Ke(!0),this.promiseHoldMap={},this.remoteStreamMap={},this.publishStream=null,this.sessionId=null,this.publishOnly=!1,this.isJoinning=!1,this.role=null!==(i=e.role)&&void 0!==i?i:"anchor",this.diffNTP=0,this.isEnableSmallStream=!1,this.smallStreamCodecOption=We({},jt),this.destroyed=!1,this.reportTimer=new Ii(this.reportStats.bind(this),2e3,2e3),this.ondevicechangeHandler=e=>{this.reportDeviceList()};try{navigator.mediaDevices.addEventListener("devicechange",this.ondevicechangeHandler)}catch(e){ie("bing devicechange event handler failed","c",this.userId,[this.mode,this.codec])}ee("create client","c",this.userId,[this.mode,this.codec])}reportDeviceList(){return lr(this,void 0,void 0,(function*(){if(this.collection){const[e,t,i]=yield Promise.all([sr(),dr(),cr()]),n=i.concat(e).concat(t);this.reportAction("deviceEnumerate",0,null,null,{list:n.map(e=>({device_id:e.deviceId,group_id:e.groupId,name:e.name,kind:e.kind,default:e.default}))})}}))}getBRTCRoomId(){return`${this.roomId}@${this.brtcAppId}`}clearObject(){a(this.webrtcType)&&this.client?this.client.destroy():c(this.webrtcType)&&this.client&&this.client.off("*"),this.client=null,this.sessionId=null,this.publishStream=null,this.remoteStreamMap={},this.reportTimer&&this.reportTimer.stop(),this.collection&&(this.collection.destroy(),this.collection=null)}joinFailReport(e=0,t="",i){const n={appid:this.brtcAppId,rid:this.getBRTCRoomId(),uid:this.userId,sig:this.userSig,err_code:e,msg:t};i&&(n.ext=i),function(e){Zi(this,void 0,void 0,(function*(){const t=We({os:ii.name,sdk_ver:"1.0.7",os_ver:ii.version,network_type:Xi.name,device:`${ii.name}/${ii.version} ${yt.name}/${yt.version}`},e);return fetch(`${"production"===en?"https://qs.baijiayun.com/brtcsdkreport":"https://test-qs.baijiayun.com/brtcsdkreport"}?${nn(t)}`,{cache:"no-cache",credentials:"same-origin",headers:{Accept:"text/plain","Content-Type":"text/plain"},method:"GET",mode:"cors",redirect:"follow",referrer:"no-referrer"})}))}(n)}getVT(){return lr(this,void 0,void 0,(function*(){let e=yield sn(this.userSig,this.roomId,this.userId,this.comments,this.clientIP).catch(e=>{throw this.joinFailReport(5e3,"userSig 验证接口请求失败"),new y(5e3,"userSig 验证接口请求失败")});if(200!==e.code)throw this.joinFailReport(5e3,"userSig 验证接口请求失败",{code:e.code,msg:e.msg}),new y(5e3,e.msg);return this.token=e.data.ut,this.reportThreshold=e.data.report.rtc,this.reportTimer.updateInterval(1e3*this.reportThreshold.meet_call_quality_upload_rate_interval),e}))}join(e,t,i,n={}){var r,o,u,d;return lr(this,void 0,void 0,(function*(){if(this.destroyed)throw new y(1002,"client 已调用 destroy 方法");if(this.isJoinning)throw new y(1002,"正在 join，请勿重复调用");if(this.client)throw new y(1002,"重复 join，请先调用 leave");if(!s.i(e))throw this.joinFailReport(1001,"roomId 类型错误，请检查",{roomId:e}),new y(1001,"roomId 类型错误，请检查");if(!s.f(t))throw this.joinFailReport(1001,"userId 类型错误，请检查",{userId:t}),new y(1001,"userId 类型错误，请检查");if(t>Math.pow(2,31)-1||t<-Math.pow(2,31)||Math.floor(t)!==t)throw this.joinFailReport(1001,"userId 为 int32 整型",{userId:t}),new y(1001,"userId 为 int32 整型");if(!s.i(i))throw new y(1001,"sig 类型错误，请检查");this.roomId=e,this.userId=t,this.userSig=i,this.joinConfig=n;let p,m=yield this.getVT();this.joinConfig.role&&(this.role=this.joinConfig.role),this.isJoinning=!0;try{let e=this.token.split(".");if(3!==e.length||!s.i(e[1])||!e[1])throw ie("client join fail","c",this.userId),this.joinFailReport(5001,"ut 格式错误",{ut:this.token}),new y(5001,this.userSig);if(p=JSON.parse(Lt(e[1])),!s.f(p.sub)&&!/^[0-9]+$/.test(p.sub))throw this.joinFailReport(5001,"ut user_id 类型错误，请检查",{sub:p.sub}),new y(5001,"user_id 类型错误，请检查");if(this.userId!==ae(p.sub))throw this.joinFailReport(5001,"签名的 userId 与传入的 userId 不符",{userId:this.userId,sub:p.sub}),new y(5001,"签名的 userId 与传入的 userId 不符");if(this.brtcAppId!==p.u)throw this.joinFailReport(5001,"签名的 appId 与传入的 appId 不符",{appId:this.brtcAppId,u:p.u}),new y(5001,"签名的 appId 与传入的 appId 不符");if(this.roomId!==p.r)throw this.joinFailReport(5001,"签名的 roomId 与传入的 roomId 不符",{roomId:this.roomId,r:p.r}),new y(5001,"签名的 roomId 与传入的 roomId 不符");if(this.vloudProxy=p.s,this.webrtcAppId=p.c,this.webrtcType=p.m,this.sign=p.sig,a(this.webrtcType)&&(this.sign=this.token),c(this.webrtcType)&&s.i(this.webrtcAppId)&&!/^[0-9]+$/.test(this.webrtcAppId))throw this.joinFailReport(5001,"trtc appId 类型错误",{appId:this.webrtcAppId}),new y(5001,"trtc appId 类型错误，请检查");this.privileges=new xt(s.f(p.p)?p.p:0),v=this.webrtcType,l=v}catch(e){if(this.isJoinning=!1,y.instanceOf(e))throw new y(e.code,e.message);throw this.joinFailReport(5001,"userSig 验证失败"),new y(5001,"userSig 验证请求失败")}var v;let g=fe();try{let e=m.data.services;if(!1===e.ip_accurate&&e.ip_url)try{const t=yield on(e.ip_url,{});if(200!==t.code||!(null===(r=t.data)||void 0===r?void 0:r.ip))throw new y(5004,"ip 请求失败");this.clientIP=t.data.ip;e=(yield this.getVT()).data.services}catch(t){this.joinFailReport(5004,"ip request failed, use before",{ip:e.ip}),te("ip request failed, use before")}if(e.timestamp&&(this.diffNTP=e.timestamp-fe()),e.collection&&(this.collection=new nr({url:e.collection,appId:this.brtcAppId,roomId:this.getBRTCRoomId(),callId:null,userId:Object(F.a)(this.userId),diffNTP:this.diffNTP,webrtcType:this.webrtcType,version:"1.0.7",comments:this.comments,clientIp:this.clientIP,report:e=>{this.joinFailReport(6e3+(s.f(e.code)?e.code:0),"collection 连接错误",e)}})),this.destroyed)throw new y(4013,"client 已调用 destroy 方法");if(a(this.webrtcType)){const t=f||[];this.client=new Zn({proxies:t.concat(e.proxies),forceWS:0===h,enableRace:!1}),this.handleEvent();let i=yield this.client.join(this.getBRTCRoomId(),{id:Object(F.a)(this.userId),info:{version:"1.0.7",device:`${ii.name}/${ii.version} ${yt.name}/${yt.version}`,ua:navigator.userAgent,role:this.role,comments:this.comments}},this.token,this.sessionId);this.sessionId=i.sessionId,this.collection&&this.collection.setCallId(i.callId);const n=this.client.getActiveProxy();this.reportAction("signalChannelConnect",0,g,fe(),{url:n.url||n.dcurl,location:null!==(o=n.location)&&void 0!==o?o:""})}else c(this.webrtcType)&&(this.collection&&this.collection.setCallId(p.l),this.client=V.a.createClient({mode:this.mode,sdkAppId:+this.webrtcAppId,userId:Object(F.a)(this.userId),userSig:this.sign,useStringRoomId:!0,autoSubscribe:!1}),this.isEnableSmallStream?this.client.enableSmallStream():this.client.disableSmallStream(),this.handleEvent(),yield this.client.join({roomId:this.getBRTCRoomId()}),this.reportAction("signalChannelConnect",0,g,fe()));if(this.destroyed)throw new y(4013,"client 已调用 destroy 方法");this.reportTimer.isStarted()||this.reportTimer.start(),this.reportAction("joinRoom",0,g,fe(),{version:"1.0.7",device:`${ii.name}/${ii.version} ${yt.name}/${yt.version}`,network:Xi.name,platform:"Web",role:this.role,ua:navigator.userAgent||"",joinConsume:Math.max(fe()-g,0)}),ee("client join suceess","c",this.userId,[this.userId,this.userSig]),this.isJoinning=!1,this.reportDeviceList();try{Sn||(Sn=!0,Tn&&Tn.destroy(),Tn=new Ii(In,0,18e5),Tn.start())}catch(e){}}catch(e){this.isJoinning=!1;let t=Kn(e),i=function(e,t){return y.instanceOf(e)?e.getCode():t}(e,4e3);if("request timeout"===t?i=4011:"connect all proxies failed"===t&&(i=4012),a(this.webrtcType)){const e=null===(u=this.client)||void 0===u?void 0:u.getActiveProxy();e&&(t=`error: ${t}, url: ${e.url||e.dcurl}, location: ${null!==(d=e.location)&&void 0!==d?d:""}`)}throw this.reportAction("joinRoom",i,g,fe(),{version:"1.0.7",device:`${ii.name}/${ii.version} ${yt.name}/${yt.version}`,network:Xi.name,platform:"Web",role:this.role,ua:navigator.userAgent||"",msg:t},Ae(e)),this.clearObject(),this.joinFailReport(i,"client join failed, "+t,{vError:Ae(e)}),ie("client join fail","c",this.userId,[e]),new y(4e3,"client join 失败",e)}return this.token}))}leave(e="none"){return lr(this,void 0,void 0,(function*(){if(!this.client)throw new y(1002,"没有 joined");let t=fe();try{if(this.publishStream&&("rejoined"!==e&&"evicted"!==e&&"room_close"!==e&&(yield this.unpublish(this.publishStream)),this.publishStream.close()),Ge(this.remoteStreamMap).length)for(let e in this.remoteStreamMap){this.remoteStreamMap[e].destroy()}}catch(e){}try{a(this.webrtcType)?"rejoined"!==e&&"evicted"!==e&&"room_close"!==e&&(yield this.client.leave()):c(this.webrtcType)&&(yield this.client.leave()),this.reportAction("leaveRoom",0,t,fe(),{reason:e}),ee("client leave success","c",this.userId),this.clearObject()}catch(i){throw this.reportAction("leaveRoom",an(i),t,fe(),{reason:e},Ae(i)),ie("client leave fail","c",this.userId,[i]),this.clearObject(),new y(an(i),"client leave 失败",i)}}))}clear(){try{if(this.publishStream){if(a(this.webrtcType)){let e=this.publishStream.getStream();this.client.unpublish(e)}else c(this.webrtcType)&&this.client&&this.client.unpublish(this.publishStream.getStream());this.publishStream.setClient(null),this.publishStream.setCollection(null),this.publishStream.setPrivileges(null),this.publishStream=null}if(Ge(this.remoteStreamMap).length)for(let e in this.remoteStreamMap){this.remoteStreamMap[e].destroy()}a(this.webrtcType)?this.client&&this.client.leave():c(this.webrtcType)&&this.client&&this.client.leave()}catch(e){}this.clearObject()}_publish(e,t=0){var i,n;return lr(this,void 0,void 0,(function*(){let r=e.getStream();try{yield this.client.publish(r,{acodec:this.audioCodec,vcodec:this.codec,simulcast:this.isEnableSmallStream?2:1,encodings:this.getEncodings(e),audioBitrate:1024*e.getAudioBandwidth()})}catch(r){if(t>=(null!==(i=this.reportThreshold.brtc_flow_retry_times)&&void 0!==i?i:3)-1)throw r;yield new zi(null!==(n=this.reportThreshold.brtc_flow_retry_interval)&&void 0!==n?n:1),yield this._publish(e,++t)}}))}publish(e){return lr(this,void 0,void 0,(function*(){if(!this.client)throw new y(1002,"client 未 join，请先执行 join");if("audience"===this.role)throw new y(1002,"audience（观众）不支持推流，请先执行 switchRole 切换角色为 anchor（主播）");if(!(e instanceof Wi))throw new y(1001,"stream 参数错误");if(e.hasAudio()&&this.privileges.enableAuth()&&!this.privileges.canPushAudio())throw new y(1011,"没有音频推送权限");if(e.hasVideo()&&this.privileges.enableAuth()&&!this.privileges.canPushVideo())throw new y(1012,"没有视频推送权限");if(!e.getStream())throw new y(1002,"LocalStream 未初始化");if(!e.hasAudio()&&!e.hasVideo())throw new y(1002,"LocalStream 至少需要一个媒体轨道");e.setUserId(this.userId),this.webrtcType!==e.getWebRTCType()&&(yield e.switchWebRTC(this.webrtcType));let t=fe();e.setICEStartTS(t);let i={};e.hasAudio()&&(i.audio={codec:this.audioCodec.toLocaleUpperCase(),bitrate:e.getAudioBandwidth()}),e.hasVideo()&&(i.video={w:e.streamCodecOption.width,h:e.streamCodecOption.height,fps:e.streamCodecOption.frameRate,bitrate:e.streamCodecOption.bitrate,codec:this.codec.toLocaleUpperCase()});try{e.getAudioOn()&&this.reportAction("audioEnable",0,null,null,{stream:a(this.webrtcType)?e.getStreamId():Object(F.a)(e.getUserId())}),e.getVideoOn()&&this.reportAction("videoEnable",0,null,null,{stream:a(this.webrtcType)?e.getStreamId():Object(F.a)(e.getUserId())}),a(this.webrtcType)?(yield this._publish(e),this.fire(b,{stream:e})):c(this.webrtcType)&&(this.isEnableSmallStream&&this.client.setSmallStreamProfile({width:this.smallStreamCodecOption.width,height:this.smallStreamCodecOption.height,framerate:e.getStreamCodecOption().frameRate,bitrate:this.smallStreamCodecOption.bitrate}),yield this.client.publish(e.getStream()),this.fire(b,{stream:e})),this.publishStream=e,e.setClient(this.client),e.setCollection(this.collection),e.setPrivileges(this.privileges),this.reportAction("publish",0,t,fe(),{cameraId:e.streamDeviceOption.cameraId||"track",microphoneId:e.streamDeviceOption.microphoneId||"track",stream:a(this.webrtcType)?e.getStreamId():Object(F.a)(e.getUserId()),audio:e.hasAudio(),video:e.hasVideo(),audio_enable:e.getAudioOn(),video_enable:e.getVideoOn(),attribute:i,msip:e.getMSIP()}),ee("client publish success","c",this.userId)}catch(n){throw this.reportAction("publish",an(n),t,fe(),{cameraId:e.streamDeviceOption.cameraId,microphoneId:e.streamDeviceOption.microphoneId,stream:a(this.webrtcType)?e.getStreamId():Object(F.a)(e.getUserId()),audio:e.hasAudio(),video:e.hasVideo(),audio_enable:e.getAudioOn(),video_enable:e.getVideoOn(),attribute:i,msip:e.getMSIP()},Ae(n)),ie("client publish fail","c",this.userId,[n]),new y(an(n),"推流失败",n)}}))}unpublish(e){return lr(this,void 0,void 0,(function*(){if(!this.client)throw new y(1002,"client 未 join，请先执行 join");if(!(e instanceof Wi))throw new y(1001,"stream 参数错误");if(!this.publishStream)throw new y(1002,"stream 未发布");let t=fe(),i=a(this.webrtcType)?e.getStreamId():Object(F.a)(e.getUserId());try{if(a(this.webrtcType)){let t=e.getStream();yield this.client.unpublish(t)}else c(this.webrtcType)&&(yield this.client.unpublish(e.getStream()));this.reportAction("unpublish",0,t,fe(),{stream:i}),e.setClient(null),e.setCollection(null),e.setPrivileges(null),this.publishStream=null,ee("client unpublish success","c",this.userId)}catch(e){throw this.publishStream=null,this.reportAction("unpublish",an(e),t,fe(),{stream:i},Ae(e)),ie("client unpublish fail","c",this.userId,[e]),new y(an(e),"取消推流失败",e)}}))}_subscribe(e,t,i=0){var n,r;return lr(this,void 0,void 0,(function*(){let o=e.getStream();if(!o)throw new y(4010,"stream 已被销毁");try{yield Promise.race([yield this.client.subscribe(o,{audio:t.audio,video:t.video}).then(()=>(e.onSubscribe(this),0)),new zi(10)]).then(t=>{if(t)throw new y(4007,`订阅流 ${e.getUserId()} 超时`)})}catch(o){if(i>=(null!==(n=this.reportThreshold.brtc_flow_retry_times)&&void 0!==n?n:3)-1||o&&!1===o.retry)throw o;yield new zi(null!==(r=this.reportThreshold.brtc_flow_retry_interval)&&void 0!==r?r:1),yield this._subscribe(e,t,++i)}}))}subscribe(e,t={audio:!0,video:!0}){return lr(this,void 0,void 0,(function*(){if(!this.client)throw new y(1002,"client 未 join，请先执行 join");if(!(e instanceof Ct))throw new y(1001,"stream 参数错误");if(!e.getStream())throw new y(1002,"stream 已被销毁");if(this.publishOnly)throw new y(1002,"当前 client 已被设置为只能 publish 流");if(!t.audio&&!t.video)throw new y(1002,"音频和视频至少需要订阅一个");if(e.isUnpublish())throw new y(1002,"stream 已不存在，无法再次订阅");let i=fe();e.setICEStartTS(i),e.onUnsubscribe();try{a(this.webrtcType)?(yield this._subscribe(e,t),this.fire(R,{stream:e}),this.reportAction("subscribe",0,i,fe(),{audio:t.audio,video:t.video,stream:e.getStreamId(),msip:e.getMSIP(),remote_id:Object(F.a)(e.getUserId())}),this.fire(E,{stream:e})):c(this.webrtcType)&&(yield Promise.race([new Promise((i,n)=>{this.promiseHoldMap[e.getUserId()]={resolve:i,reject:n},this.client.subscribe(e.getStream(),t)}),new zi(10)]).then(t=>{if(t)throw delete this.promiseHoldMap[e.getUserId()],new y(4007,`订阅流 ${e.getUserId()} 超时`)}),e.onSubscribe(this),this.reportAction("subscribe",0,i,fe(),{audio:t.audio,video:t.video,stream:Object(F.a)(e.getUserId()),msip:e.getMSIP(),remote_id:Object(F.a)(e.getUserId())})),ee("client subscribe success","c",e.getUserId(),[t])}catch(n){if(ie("client subscribe fail","c",e.getUserId(),[n]),this.reportAction("subscribe",an(n),i,fe(),{audio:t.audio,video:t.video,stream:a(this.webrtcType)?e.getStreamId():Object(F.a)(e.getUserId()),msip:e.getMSIP(),remote_id:Object(F.a)(e.getUserId())},Ae(n)),y.instanceOf(n))throw new y(n.code,n.message);throw new y(an(n),null,n)}}))}unsubscribe(e){return lr(this,void 0,void 0,(function*(){if(!this.client)throw new y(1002,"client 未 join，请先执行 join");if(!(e instanceof Ct))throw new y(1001,"stream 参数错误");if(!e.getStream())throw new y(1002,"stream 已被销毁");if(this.publishOnly)throw new y(1002,"当前 client 已被设置为只能 publish 流");let t=fe(),i=a(this.webrtcType)?e.getStreamId():Object(F.a)(e.getUserId());try{if(a(this.webrtcType)){let t=e.getStream();yield this.client.unsubscribe(t)}else c(this.webrtcType)&&(yield this.client.unsubscribe(e.getStream()));e.onUnsubscribe(),this.reportAction("unsubscribe",0,t,fe(),{stream:i,remote_id:Object(F.a)(e.getUserId())}),ee("client unsubscribe success","c",e.getUserId())}catch(n){throw e.onUnsubscribe(),this.reportAction("unsubscribe",an(n),t,fe(),{stream:i,remote_id:Object(F.a)(e.getUserId())},Ae(n)),ie("client unsubscribe fail","c",e.getUserId(),[n]),new y(an(n),"unsubscribe",n)}}))}enableSmallStream(){return lr(this,void 0,void 0,(function*(){if(!kn())throw new y(1002,"不支持大小流");this.publishStream&&te("enableSmallStream 不支持在 publish 之后设置"),this.isEnableSmallStream=!0,this.client&&c(this.webrtcType)&&this.client.enableSmallStream()}))}disableSmallStream(){return lr(this,void 0,void 0,(function*(){if(this.publishStream)throw new y(1002,"不支持在 publish 之后设置");this.isEnableSmallStream=!1,this.client&&c(this.webrtcType)&&this.client.disableSmallStream()}))}setRemoteVideoStreamType(e,t){return lr(this,void 0,void 0,(function*(){if(!e.isSubscribed())throw new y(1002,"只能在订阅之后设置");if(!e.getStream())throw new y(1002,"流已不存在");try{if(a(this.webrtcType)){let i=e.getStream();yield this.client.preferProfile(i,"big"===t?1:0)}else c(this.webrtcType)&&(yield this.client.setRemoteVideoStreamType(e.getStream(),t))}catch(t){throw ie("client setRemoteVideoStreamType fail","c",e.getUserId(),[t]),new y(9e3,"setRemoteVideoStreamType",t)}}))}setSmallStreamProfile(e){We(this.smallStreamCodecOption,e)}switchRole(e){return lr(this,void 0,void 0,(function*(){this.role=e}))}handleEvent(){let e=this,t=Ot[e.webrtcType],i=Pt[e.webrtcType],n=this.publishOnly?[]:Dt;function r(t,n){e.client.on(t,(function(){let t=ue(i[n],e,Ve(arguments));t&&s.d(t.then)?t.then(t=>{!1!==t&&(s.a(t)&&2===t.length?e.fire(t[0],t[1]):e.fire(n,t),Z("client event "+n,"c",e.userId,[t]))}):!1!==t&&(s.a(t)&&2===t.length?e.fire(t[0],t[1]):e.fire(n,t),Z("client event "+n,"c",e.userId,[t]))}))}Pe(n,e=>{t[e]&&(s.a(t[e])?Pe(t[e],(t,i)=>{r(t,e)}):s.i(t[e])&&t[e]&&r(t[e],e))}),a(e.webrtcType)?e.client.on("media-error",t=>{e.fire(A,new y(4008))}).on("reconnected",()=>{var t;const i=e.client.getActiveProxy();e.reportAction("signalChannelConnect",0,0,0,{url:i.url||i.dcurl,location:null!==(t=i.location)&&void 0!==t?t:""})}).on("state-notify",e=>{this.joinFailReport(8e3,"state notify, "+e.msg,e)}):c(e.webrtcType)&&e.on(R,t=>{e.promiseHoldMap[t.stream.getUserId()]&&(e.promiseHoldMap[t.stream.getUserId()].resolve(0),delete e.promiseHoldMap[t.stream.getUserId()])}),e.publishOnly&&(a(e.webrtcType)?e.client.on("stream-added",e=>{e.destroy()}):c(this.webrtcType)&&e.client.on(S,e=>{e.stream.close()})),Z("add event hanlder success","c",this.userId,[n.join(",")])}fire(e,t){this.emitter&&(e===A&&this.clear(),this.emitter.fire(e,t?[t]:void 0))}on(e,t){return this.emitter.on(e,{fn:t,ctx:this}),Z("client on","c",this.userId,[e]),this}one(e,t){return this.emitter.on(e,{fn:t,ctx:this,max:1}),Z("client one","c",this.userId,[e]),this}off(e,t){return this.emitter&&(this.emitter.off(e,t),Z("client off","c",this.userId,[e])),this}setPublishOnly(e){this.publishOnly=e,ee("client publish only","c",this.userId,[e])}destroy(e){return lr(this,void 0,void 0,(function*(){if(this.emitter&&(this.emitter.off(),this.emitter=null),e?this.clear():this.client&&(yield this.leave()),this.publishStream=null,this.remoteStreamMap={},this.reportTimer&&(this.reportTimer.destroy(),this.reportTimer=null),this.ondevicechangeHandler)try{navigator.mediaDevices.removeEventListener("devicechange",this.ondevicechangeHandler),this.ondevicechangeHandler=null}catch(e){}this.destroyed=!0,ee("client destroy","c",this.userId)}))}addRemoteStream(e,t){e.setClient(this.client),e.setCollection(this.collection),this.remoteStreamMap[t]&&this.remoteStreamMap[t].destroy(),this.remoteStreamMap[t]=e}removeRemoteStream(e){let t=this.remoteStreamMap[e];return t&&(t.destroy(),delete this.remoteStreamMap[e]),t}getRemoteStream(e){return this.remoteStreamMap[e]}reportStats(){if(!this.collection)return;let e=!0;if(this.publishStream&&(e=!1,this.publishStream.getReportStats(this.reportThreshold).then(e=>{this.collection.stats(a(this.webrtcType)?this.publishStream.getStreamId():Object(F.a)(this.publishStream.getUserId()),e,!0,null,this.publishStream.getExtraReport())}).catch((function(e){}))),Ge(this.remoteStreamMap).length){e=!1;for(let e in this.remoteStreamMap){let t=this.remoteStreamMap[e];t.isSubscribed()&&t.getReportStats(this.reportThreshold).then(e=>{this.collection.stats(a(this.webrtcType)?t.getStreamId():Object(F.a)(t.getUserId()),e,!1,Object(F.a)(t.getUserId()),t.getExtraReport())}).catch((function(e){}))}}e&&this.collection.heartbeat()}reportAction(e,t,i,n,r,o){this.collection&&this.collection.action(e,t,i,n,r,o)}getEncodings(e){const t=e.getStreamCodecOption();if(this.isEnableSmallStream){const e=Math.min(Math.max(Math.max(lt((t.width/this.smallStreamCodecOption.width).toFixed(2)),lt((t.height/this.smallStreamCodecOption.height).toFixed(2))),1),10);return[{scale:e,bitrate:1024*this.smallStreamCodecOption.bitrate,fps:t.frameRate,width:Math.ceil(t.width/e),height:Math.ceil(t.height/e),rid:"r0"},{scale:1,bitrate:1024*t.bitrate,fps:t.frameRate,width:t.width,height:t.height,rid:"r1"}]}return[{scale:1,bitrate:1024*t.bitrate,fps:t.frameRate,width:t.width,height:t.height}]}}var pr=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};class fr extends class{constructor(e,t,i){this.gl=e,this.width=t,this.height=i,this.texture=this.gl.createTexture()}getTexture(){return this.texture}bind(e){s.f(e)&&this.gl.activeTexture(this.gl.TEXTURE0+e),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture)}setSize(e,t){this.width=e,this.height=t}setUnpackAlignment(){this.width%8==0?this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,8):this.width%4==0?this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,4):this.width%2==0?this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,2):this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1)}destroy(){this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)}}{constructor(e,t,i,n=!1){super(e,t,i),this.useMultisample=n}init(){this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.width,this.height,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),this.useMultisample?(this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR)):(this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE))}fill(e){this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.setUnpackAlignment(),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e)}}class mr{constructor(e,t,i,n){this.gl=e,this.width=t,this.height=i,this.useMultisample=n,this.init()}init(){this.framebuffer=this.gl.createFramebuffer(),this.colorBuffer=this.gl.createRenderbuffer(),this.texture=new fr(this.gl,this.width,this.height,this.useMultisample),this.texture.bind(),this.texture.init(),this.useMultisample?(this.renderbuffer=this.gl.createFramebuffer(),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.colorBuffer),this.gl.renderbufferStorageMultisample(this.gl.RENDERBUFFER,4,this.gl.RGBA8,this.width,this.height),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.renderbuffer),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.RENDERBUFFER,this.colorBuffer),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.framebuffer),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.texture.getTexture(),0)):(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.colorBuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,this.width,this.height),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.framebuffer),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.texture.getTexture(),0),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.colorBuffer)),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)}toVertices(){return[-1,1,0,0,1,0,0,-1,-1,0,0,0,0,0,1,1,0,1,1,0,0,1,-1,0,1,0,0,0]}length(){return 4}viewport(){this.gl.viewport(0,0,this.width,this.height)}destroy(){this.framebuffer&&(this.gl.deleteFramebuffer(this.framebuffer),this.framebuffer=null),this.renderbuffer&&(this.gl.deleteFramebuffer(this.renderbuffer),this.renderbuffer=null),this.colorBuffer&&(this.gl.deleteRenderbuffer(this.colorBuffer),this.colorBuffer=null),this.texture&&this.texture.destroy()}getTexture(){return this.texture}getFrameBuffer(){return this.useMultisample?this.renderbuffer:this.framebuffer}getResolution(){return[1/this.width,1/this.height]}getWidth(){return this.width}getHeight(){return this.height}bind(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.getFrameBuffer())}clear(){this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}resize(e,t){this.width===e&&this.height===t||(this.width=e,this.height=t,this.destroy(),this.init())}}var vr=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};class gr{constructor(e){this.gl=e.getGL(),this.width=e.getWidth(),this.height=e.getHeight(),this.frame=new mr(this.gl,this.width,this.height,!1),this.enabled=!0}ready(){return vr(this,void 0,void 0,(function*(){return!0}))}resize(e,t){this.width=e,this.height=t,this.frame.resize(e,t)}getTarget(){return this.frame}setEnabled(e){this.enabled=e}getEnabled(){return this.enabled}getVertices(){return[-1,1,0,0,1,0,0,-1,-1,0,0,0,0,0,1,1,0,1,1,0,0,1,-1,0,1,0,0,0]}}class _r extends class{constructor(e,t,i){this.gl=e,this.vertexShader=t,this.fragmentShader=i,this.vertexShader&&this.vertexShader.compile(e),this.fragmentShader&&this.fragmentShader.compile(e)}link(){this._program=this.gl.createProgram(),this.gl.attachShader(this._program,this.vertexShader.shader),this.gl.attachShader(this._program,this.fragmentShader.shader),this.gl.linkProgram(this._program)}stop(){this.vertexShader.stop(this.gl),this.fragmentShader.stop(this.gl),this.gl.deleteProgram(this._program),this.vertexShader=null,this.fragmentShader=null,this._program=null}bind(){this.gl.useProgram(this._program)}get program(){return this._program}}{constructor(e,t,i,n=!0){super(e,t,i),this.enableColor=n}link(){super.link(),this.aPoint=this.gl.getAttribLocation(this.program,"point"),this.aColor=this.gl.getAttribLocation(this.program,"color"),this.enableColor?(this.gl.enableVertexAttribArray(this.aPoint),this.gl.enableVertexAttribArray(this.aColor)):this.gl.enableVertexAttribArray(this.aPoint)}bind(){super.bind(),this.enableColor?(this.gl.vertexAttribPointer(this.aPoint,3,this.gl.FLOAT,!1,7*Float32Array.BYTES_PER_ELEMENT,0),this.gl.vertexAttribPointer(this.aColor,4,this.gl.FLOAT,!1,7*Float32Array.BYTES_PER_ELEMENT,3*Float32Array.BYTES_PER_ELEMENT)):this.gl.vertexAttribPointer(this.aPoint,3,this.gl.FLOAT,!1,7*Float32Array.BYTES_PER_ELEMENT,0)}}class yr{constructor(e,t){this.type=e,this._shader=null,this._source=t,this.compiled=!1}compile(e){this.compiled||(this._shader=e.createShader(this.type),e.shaderSource(this._shader,this._source),e.compileShader(this._shader),this.compiled=!0)}stop(e){e.deleteShader(this._shader),this._shader=null}get shader(){return this._shader}}class Sr extends yr{constructor(e,t){super(e.VERTEX_SHADER,t)}}class Tr extends yr{constructor(e,t){super(e.FRAGMENT_SHADER,t)}}class Er extends _r{constructor(e){super(e,new Sr(e,"precision highp float;\n#define GLSLIFY 1\n\nattribute vec3 point;\nattribute vec4 color;\nvarying vec4 v_color;\n\nvoid main(void){\n  gl_Position = vec4(point, 1.0);\n  v_color = color;\n}\n"),new Tr(e,"precision highp float;\n#define GLSLIFY 1\n\nvarying vec4 v_color;\nuniform sampler2D u_Sampler;\n\nuniform vec2 singleStepOffset;\nuniform vec4 params;\nuniform float brightness;\n\nconst vec3 W = vec3(0.299, 0.587, 0.114);\n\nconst mat3 saturateMatrix = mat3(\n  1.1102, -0.0598, -0.061,\n  -0.0774, 1.0826, -0.1186,\n  -0.0228, -0.0228, 1.1772);\n\nvec2 blurCoordinates[24];\n\nfloat hardLight(float color) {\n  if (color <= 0.5) {\n    color = color * color * 2.0;\n  }\n  else {\n    color = 1.0 - ((1.0 - color)*(1.0 - color) * 2.0);\n  }\n  return color;\n}\n\nvoid main() {\n\n  vec2 coord = v_color.xy;\n  \n  vec3 centralColor = texture2D(u_Sampler, coord).rgb;\n  blurCoordinates[0] = coord.xy + singleStepOffset * vec2(0.0, -10.0);\n  blurCoordinates[1] = coord.xy + singleStepOffset * vec2(0.0, 10.0);\n  blurCoordinates[2] = coord.xy + singleStepOffset * vec2(-10.0, 0.0);\n  blurCoordinates[3] = coord.xy + singleStepOffset * vec2(10.0, 0.0);\n  blurCoordinates[4] = coord.xy + singleStepOffset * vec2(5.0, -8.0);\n  blurCoordinates[5] = coord.xy + singleStepOffset * vec2(5.0, 8.0);\n  blurCoordinates[6] = coord.xy + singleStepOffset * vec2(-5.0, 8.0);\n  blurCoordinates[7] = coord.xy + singleStepOffset * vec2(-5.0, -8.0);\n  blurCoordinates[8] = coord.xy + singleStepOffset * vec2(8.0, -5.0);\n  blurCoordinates[9] = coord.xy + singleStepOffset * vec2(8.0, 5.0);\n  blurCoordinates[10] = coord.xy + singleStepOffset * vec2(-8.0, 5.0);\n  blurCoordinates[11] = coord.xy + singleStepOffset * vec2(-8.0, -5.0);\n  blurCoordinates[12] = coord.xy + singleStepOffset * vec2(0.0, -6.0);\n  blurCoordinates[13] = coord.xy + singleStepOffset * vec2(0.0, 6.0);\n  blurCoordinates[14] = coord.xy + singleStepOffset * vec2(6.0, 0.0);\n  blurCoordinates[15] = coord.xy + singleStepOffset * vec2(-6.0, 0.0);\n  blurCoordinates[16] = coord.xy + singleStepOffset * vec2(-4.0, -4.0);\n  blurCoordinates[17] = coord.xy + singleStepOffset * vec2(-4.0, 4.0);\n  blurCoordinates[18] = coord.xy + singleStepOffset * vec2(4.0, -4.0);\n  blurCoordinates[19] = coord.xy + singleStepOffset * vec2(4.0, 4.0);\n  blurCoordinates[20] = coord.xy + singleStepOffset * vec2(-2.0, -2.0);\n  blurCoordinates[21] = coord.xy + singleStepOffset * vec2(-2.0, 2.0);\n  blurCoordinates[22] = coord.xy + singleStepOffset * vec2(2.0, -2.0);\n  blurCoordinates[23] = coord.xy + singleStepOffset * vec2(2.0, 2.0);\n\n  float sampleColor = centralColor.g * 22.0;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[0]).g;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[1]).g;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[2]).g;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[3]).g;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[4]).g;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[5]).g;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[6]).g;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[7]).g;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[8]).g;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[9]).g;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[10]).g;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[11]).g;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[12]).g * 2.0;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[13]).g * 2.0;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[14]).g * 2.0;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[15]).g * 2.0;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[16]).g * 2.0;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[17]).g * 2.0;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[18]).g * 2.0;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[19]).g * 2.0;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[20]).g * 3.0;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[21]).g * 3.0;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[22]).g * 3.0;\n  sampleColor += texture2D(u_Sampler, blurCoordinates[23]).g * 3.0;\n\n  sampleColor = sampleColor / 62.0;\n\n  float highPass = centralColor.g - sampleColor + 0.5;\n\n  for (int i = 0; i < 5; i++) {\n    highPass = hardLight(highPass);\n  }\n  float lumance = dot(centralColor, W);\n  float alpha = pow(lumance, params.r);\n  vec3 smoothColor = centralColor + (centralColor - vec3(highPass)) * alpha * 0.1;\n\n  smoothColor.r = clamp(pow(smoothColor.r, params.g), 0.0, 1.0);\n  smoothColor.g = clamp(pow(smoothColor.g, params.g), 0.0, 1.0);\n  smoothColor.b = clamp(pow(smoothColor.b, params.g), 0.0, 1.0);\n\n  vec3 screen = vec3(1.0) - (vec3(1.0) - smoothColor) * (vec3(1.0) - centralColor);\n  vec3 lighten = max(smoothColor, centralColor);\n  vec3 softLight = 2.0 * centralColor * smoothColor + centralColor * centralColor - 2.0 * centralColor * centralColor * smoothColor;\n\n  gl_FragColor = vec4(mix(centralColor, screen, alpha), 1.0);\n  gl_FragColor.rgb = mix(gl_FragColor.rgb, lighten, alpha);\n  gl_FragColor.rgb = mix(gl_FragColor.rgb, softLight, params.b);\n\n  vec3 satcolor = gl_FragColor.rgb * saturateMatrix;\n  gl_FragColor.rgb = mix(gl_FragColor.rgb, satcolor, params.a);\n  gl_FragColor.rgb = vec3(gl_FragColor.rgb + vec3(brightness));\n}"))}link(){super.link(),this.samplerLocation=this.gl.getUniformLocation(this.program,"u_Sampler"),this.paramsLocation=this.gl.getUniformLocation(this.program,"params"),this.brightnessLocation=this.gl.getUniformLocation(this.program,"brightness"),this.singleStepOffsetLocation=this.gl.getUniformLocation(this.program,"singleStepOffset")}bindTexture(e=0){this.gl.uniform1i(this.samplerLocation,e)}setBrightness(e){this.gl.uniform1f(this.brightnessLocation,.37*(-.5+e))}setParams(e,t){this.gl.uniform4fv(this.paramsLocation,[1-.8*e,1-.6*e,.1+.45*t,.1+.45*t])}setSize(e,t){this.gl.uniform2fv(this.singleStepOffsetLocation,[2/e,2/t])}setOpacity(e=.5){this.gl.uniform1f(this.opacityLocation,e)}}class br extends _r{constructor(e){super(e,new Sr(e,"precision highp float;\n#define GLSLIFY 1\n\nattribute vec3 point;\nattribute vec4 color;\nvarying vec4 v_color;\n\nvoid main(void){\n  gl_Position = vec4(point, 1.0);\n  v_color = color;\n}\n"),new Tr(e,"precision highp float;\n#define GLSLIFY 1\n\nvarying vec4 v_color;\nuniform sampler2D u_Sampler;\nuniform float opacity;\n\nvoid main () {\n  vec4 color = texture2D(u_Sampler, v_color.xy);\n  color.a = color.a * opacity;\n  gl_FragColor = color;\n}\n"))}link(){super.link(),this.samplerLocation=this.gl.getUniformLocation(this.program,"u_Sampler"),this.opacityLocation=this.gl.getUniformLocation(this.program,"opacity")}bindTexture(e=0){this.gl.uniform1i(this.samplerLocation,e)}setOpacity(e=1){(e<0||e>1)&&(e=1),this.gl.uniform1f(this.opacityLocation,e)}}class Rr{constructor(e){this.started=!1,this.interval=e,this.a=.2,this.b=4,this.equivalent=50,this.timestamp=0,this.locked=!1,this.compute(),this.messageChannel=new MessageChannel,this.handleEvent()}compute(e=!0){this.interval>0&&(this.beta=Math.ceil(this.equivalent*(1-this.b/this.interval)/(this.a-this.b)),this.alpha=Math.floor(this.equivalent/this.interval-this.beta),e&&(this.count=0))}timeoutTick(){this.timer=setTimeout(()=>{this.count++,this.onClock&&this.onClock(),this.nextTick()},this.interval)}nextTick(){if(this.started)if(this.interval>4)this.timeoutTick();else if(this.interval<=0||this.locked)this.messageChannel.port1.postMessage(null);else{const e=le();e-this.timestamp>this.equivalent&&(this.count=0,this.timestamp=e),this.count<this.beta?this.messageChannel.port1.postMessage(null):this.timeoutTick()}}start(){this.started||(this.started=!0,this.timestamp=le(),this.nextTick())}stop(){this.started=!1,this.timer&&(clearTimeout(this.timer),this.timer=null)}isStarted(){return this.started}setInterval(e){this.interval=Math.max(e,0),this.compute()}getInterval(){return this.interval}isZeroTimeout(){return this.interval<4}lock(){this.locked=!0}unlock(){this.locked=!1}handleEvent(){this.messageChannel.port2.onmessage=()=>{this.count++,this.onClock&&this.onClock(),this.nextTick()}}}class Ir{constructor(e,t=0,i=0){this.task=e,this.timeout=t,this.interval=i,this.count=0,this.emptyCount=0,this.timestamp=0,this.started=!1,this.locked=!1,this.clock=new Rr(this.interval),this.clock.onClock=()=>{if(!this.started)return;this.count++,!1===this.task()&&this.stop();const e=le();if(e-this.timestamp>1e3&&!this.locked){const r=this.emptyCount/this.count;0===this.emptyCount?this.clock.setInterval(Math.max(this.clock.getInterval()>>1,this.interval)):r<.05?this.clock.setInterval(this.clock.getInterval()-1):r>.5?this.clock.setInterval((t=this.clock.getInterval()<<1,n=500,t<(i=4)?t=i:t>n&&(t=n),t)):r>.1&&this.clock.setInterval(this.clock.getInterval()+1),this.count=0,this.emptyCount=0,this.timestamp=e}var t,i,n}}start(){this.started=!0,this.timeout?this.startTimer=setTimeout(()=>{this.count=0,this.emptyCount=0,this.timestamp=le(),this.clock.start(),this.startTimer=null},this.timeout):(this.count=0,this.emptyCount=0,this.timestamp=le(),this.clock.start())}stop(){this.started=!1,this.startTimer&&(clearTimeout(this.startTimer),this.startTimer=null),this.clock.stop()}isStarted(){return this.started}emptyTask(){this.emptyCount++}isZeroTimeout(){var e;return null===(e=this.clock)||void 0===e?void 0:e.isZeroTimeout()}lock(){var e;this.locked=!0,null===(e=this.clock)||void 0===e||e.lock()}unlock(){var e;this.locked=!1,null===(e=this.clock)||void 0===e||e.unlock()}restart(){this.clock&&(this.stop(),this.clock.setInterval(this.interval),this.start())}destroy(){this.stop(),this.task=null,this.timeout=null,this.interval=null}}class kr extends _r{constructor(e){super(e,new Sr(e,"precision highp float;\n#define GLSLIFY 1\n\nattribute vec3 point;\nattribute vec4 color;\nvarying vec4 v_color;\n\nvoid main(void){\n  gl_Position = vec4(point, 1.0);\n  v_color = color;\n}\n"),new Tr(e,"precision highp float;\n#define GLSLIFY 1\n\nvarying vec4 v_color;\nuniform sampler2D u_Sampler;\n\nvoid main () {\n  gl_FragColor = texture2D(u_Sampler, v_color.xy);\n}\n"))}link(){super.link(),this.samplerLocation=this.gl.getUniformLocation(this.program,"u_Sampler")}bindTexture(e=0){this.gl.uniform1i(this.samplerLocation,e)}}class wr extends gr{constructor(e){super(e),this.program=new kr(this.gl),this.program.link()}render(e,t,i=0){return this.program.bind(),e.bind(i),this.program.bindTexture(i),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,t,4),{nextUnit:i+1,nextStartIndex:t+4}}destroy(){this.program.stop()}}var Cr,Ar=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};!function(e){e.I420="I420",e.NV12="NV12",e.ABGR="ABGR",e.IMAGE_BIT_MAP="IMAGE_BIT_MAP"}(Cr||(Cr={}));class Dr{constructor(e=300,t=150){this.width=e,this.height=t,this.sourceHeight=e,this.sourceHeight=t,this.cropTop=0,this.cropLeft=0,this.renders=[],this.verticalFlipEnabled=!1,this.horizontalFlipEnabled=!1,this.generateVertex(),this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=t,yt.safari&&(document.body.appendChild(this.canvas),this.canvas.style.position="absolute",this.canvas.style.left="-99999px"),this.gl=this.canvas.getContext("webgl2",{alpha:!0,antialias:!0,preserveDrawingBuffer:!0}),this.gl||(this.gl=this.canvas.getContext("webgl",{alpha:!0,antialias:!0,preserveDrawingBuffer:!0})),this.VAO=this.gl.createBuffer(),this.VAO||j.e("顶点缓冲区创建失败"),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.VAO),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,1),this.gl.enable(this.gl.BLEND),this.gl.clearColor(0,0,0,0),this.gl.clearDepth(1),this.gl.viewport(0,0,e,t),this.gl.blendFuncSeparate(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.sourceTexture=new fr(this.gl,this.sourceWidth,this.sourceHeight),this.sourceTexture.bind(0),this.sourceTexture.init(),this.supportTrackProcessor="undefined"!=typeof MediaStreamTrackProcessor&&!1,this.supportTrackProcessor||(this.video=document.createElement("video"),this.video.loop=!0,this.video.autoplay=!0,this.video.onloadedmetadata=()=>{this.renderTimer&&this.renderTimer.start()}),this.copyRender=new wr(this)}generateVertex(){this.verticalFlipEnabled&&this.horizontalFlipEnabled?this.vertex=[-1,1,0,1,0,0,0,-1,-1,0,1,1,0,0,1,1,0,0,0,0,0,1,-1,0,0,1,0,0]:this.verticalFlipEnabled?this.vertex=[-1,1,0,0,0,0,0,-1,-1,0,0,1,0,0,1,1,0,1,0,0,0,1,-1,0,1,1,0,0]:this.horizontalFlipEnabled?this.vertex=[-1,1,0,1,1,0,0,-1,-1,0,1,0,0,0,1,1,0,0,1,0,0,1,-1,0,0,0,0,0]:this.vertex=[-1,1,0,0,1,0,0,-1,-1,0,0,0,0,0,1,1,0,1,1,0,0,1,-1,0,1,0,0,0]}bufferVertices(){let e=[-1,1,0,0+this.cropLeft,1-this.cropTop,0,0,-1,-1,0,0+this.cropLeft,0+this.cropTop,0,0,1,1,0,1-this.cropLeft,1-this.cropTop,0,0,1,-1,0,1-this.cropLeft,0+this.cropTop,0,0,-1,1,0,0,1,0,0,-1,-1,0,0,0,0,0,1,1,0,1,1,0,0,1,-1,0,1,0,0,0];e=e.concat(this.vertex),this.waterMarkProgram&&this.waterMarkTexture&&this.waterMarkEnabled&&(e=e.concat(this.waterMarkVertex)),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(e),this.gl.STATIC_DRAW)}generateWaterMarkVertex(){let e=this.waterMark.width,t=this.waterMark.height;const i=e>1||t>1;e&&!t?(t=this.imageElement.height*e/this.imageElement.width,t<1&&(t=t*this.width/this.height)):!e&&t?(e=this.imageElement.width*t/this.imageElement.height,e<1&&(e=e*this.height/this.width)):e||t||(e=100,t=this.imageElement.height*e/this.imageElement.width,t<1&&(t=t*this.width/this.height));let n=this.waterMark.left||0,r=this.waterMark.top||0;i?e=e/this.width*2:e*=2,i?t=t/this.height*2:t*=2,n<=1&&n>=0?n*=2:n=n/this.width*2,r<=1&&r>=0?r*=2:r=r/this.height*2,this.waterMarkVertex=[-1+n,1-r,0,0,1,0,0,-1+n,1-r-t,0,0,0,0,0,-1+n+e,1-r,0,1,1,0,0,-1+n+e,1-r-t,0,1,0,0,0]}resize(e,t,i,n){this.width=e,this.height=t,this.supportTrackProcessor&&i&&n?(this.sourceWidth=i,this.sourceHeight=n):(this.sourceWidth=e,this.sourceHeight=t),this.canvas.width=e,this.canvas.height=t,this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.sourceTexture&&(this.sourceTexture.setSize(this.sourceWidth,this.sourceHeight),this.sourceTexture.init()),this.rgbaFrame&&this.rgbaFrame.resize(e,t);for(let i=0;i<this.renders.length;i++)this.renders[i].resize(e,t);this.copyRender.resize(e,t),this.generateWaterMarkVertex(),this.waterMarkTexture.fill(this.imageElement)}render(e,t,i){const n=this.renders.filter(e=>e.getEnabled());if(n.length)for(let t=0;t<n.length;t++)t===n.length-1?this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null):this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,n[t].getTarget()),n[t].render(e,t===n.length-1?8:0===t?0:4,i++),e=n[t].getTarget().getTexture();else this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.copyRender.render(e,8,i++),e=this.copyRender.getTarget().getTexture();this.waterMarkProgram&&this.waterMarkTexture&&this.waterMarkEnabled&&0!==this.waterMark.width&&0!==this.waterMark.height&&(this.waterMarkProgram.bind(),this.waterMarkTexture.bind(this.format===Cr.IMAGE_BIT_MAP?0:3),this.waterMarkProgram.bindTexture(this.format===Cr.IMAGE_BIT_MAP?0:3),this.waterMarkProgram.setOpacity(s.f(this.waterMark.opacity)?this.waterMark.opacity:1),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,12,4))}readVideoFrame(){return Ar(this,void 0,void 0,(function*(){if(!this.abortRequest)try{const{done:e,value:t}=yield this.videoFrameReader.read();if(e)return;t&&(yield this.renderVideoFrame(t)),this.readVideoFrame()}catch(e){throw console.log(e),new y(9e3,"read videoFrame failed!")}}))}renderVideoFrame(e){return Ar(this,void 0,void 0,(function*(){e.displayWidth===this.width&&e.displayHeight===this.height&&e.codedWidth===this.sourceWidth&&e.codedHeight===this.sourceHeight||(this.resize(e.displayWidth,e.displayHeight,e.codedWidth,e.codedHeight),this.cropLeft=e.visibleRegion.left/e.visibleRegion.width,this.cropTop=e.visibleRegion.top/e.visibleRegion.height),this.bufferVertices(),this.sourceTexture.fill(e),e.close(),this.render(this.sourceTexture,0,1)}))}renderHTMLVideoElement(e){return Ar(this,void 0,void 0,(function*(){(e.videoWidth>10&&e.videoWidth!==this.width||e.videoHeight>10&&e.videoHeight!==this.height)&&this.resize(e.videoWidth,e.videoHeight),this.bufferVertices(),this.sourceTexture.fill(e),this.render(this.sourceTexture,0,1)}))}addRender(e){this.renders.push(e)}removeRender(e){for(let t=0;t<this.renders.length;t++)if(this.renders[t]===e)return void this.renders.splice(t,1)}getGL(){return this.gl}getWidth(){return this.width}getHeight(){return this.height}enableVerticalFlip(e){this.verticalFlipEnabled=e,this.generateVertex()}enableHorizontalFlip(e){this.horizontalFlipEnabled=e,this.generateVertex()}onWaterMarkLoaded(){this.waterMarkProgram||(this.waterMarkProgram=new br(this.gl),this.waterMarkProgram.link()),this.waterMarkTexture?(this.waterMarkTexture.setSize(this.imageElement.width,this.imageElement.height),this.waterMarkTexture.init()):(this.waterMarkProgram.bind(),this.waterMarkTexture=new fr(this.gl,this.imageElement.width,this.imageElement.height,!1),this.waterMarkTexture.bind(this.format===Cr.IMAGE_BIT_MAP?0:3),this.waterMarkTexture.init(),this.waterMarkProgram.bindTexture(this.format===Cr.IMAGE_BIT_MAP?0:3)),this.waterMarkTexture.fill(this.imageElement),this.generateWaterMarkVertex()}setWaterMark(e){const t=!this.waterMark||this.waterMark.url!==e.url;this.waterMark=We(this.waterMark||{},e),this.waterMark.url&&t?(this.imageElement||(this.imageElement=document.createElement("img"),this.imageElement.crossOrigin="Anonymous",this.imageElement.onload=this.onWaterMarkLoaded.bind(this)),this.imageElement.src=this.waterMark.url):this.generateWaterMarkVertex(),Ce(this.waterMarkEnabled)||(this.waterMarkEnabled=!0)}enableWaterMark(e){this.waterMarkEnabled=e}pipe(e,t){var i;if("video"!==e.kind)throw new y(1002,"track 不是一个 video track");if(this.inputTrack=e,this.abortRequest=!1,t)this.trackFps=t;else{const t=e.getConstraints();this.trackFps=null!==(i=t.frameRate)&&void 0!==i?i:15}if(this.captureStream=this.canvas.captureStream(this.trackFps),this.outputTrack=this.captureStream.getVideoTracks()[0],this.supportTrackProcessor)this.mediaStreamTrackProcessor=new MediaStreamTrackProcessor({track:this.inputTrack}),this.videoFrameReader=this.mediaStreamTrackProcessor.readable.getReader(),this.readVideoFrame();else{let e=new MediaStream;e.addTrack(this.inputTrack),this.video.srcObject=e,this.video.play().catch(e=>{j.d("play video failed")}),this.renderTimer&&this.renderTimer.destroy(),this.renderTimer=new Ir(()=>{this.renderHTMLVideoElement(this.video)},0,Math.max(1e3/this.trackFps,30))}}getOutputTrack(){return this.outputTrack}stop(){this.renderTimer&&this.renderTimer.stop(),this.captureStream&&(this.captureStream=null),this.mediaStreamTrackProcessor&&(this.mediaStreamTrackProcessor=null),this.video&&(this.video.srcObject=null)}static isSupport(){const e=document.createElement("canvas"),t=e.getContext("webgl");return!!e.captureStream&&!!t}}Dr.VIDEO_FORMAT=Cr,Dr.Renders={BeautyRender:class extends gr{constructor(e){super(e),this.program=new Er(this.gl),this.program.link(),this.opacity=.99,this.ruddy=.5,this.beauty=.5,this.brightness=.5}render(e,t,i=0){return this.program.bind(),e.bind(i),this.program.bindTexture(i),this.program.setSize(this.width,this.height),this.program.setParams(this.beauty,this.ruddy),this.program.setBrightness(this.brightness),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,t,4),{nextUnit:i+1,nextStartIndex:t+4}}setOpacity(e){this.opacity=e}setBrightness(e){this.brightness=e}setBeauty(e){this.beauty=e}setRuddy(e){this.ruddy=e}destroy(){this.program.stop()}}};var Or=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};Object(j.h)("brtc");const Pr=r,xr={Client:n,Stream:o};function Mr(e){return new Wi(e)}function Lr(e){return new hr(e)}function Nr(){en="development",ee("set env development")}function Ur(e){!function(e){h=e}(e),ee("set roomChannelType "+e)}function Vr(e){!function(e){p=e}(e),ee("set forcePlanBSimulcast "+e)}function Fr(e){!function(e=[]){f=f.concat(e)}(e),ee("set proxies "+e)}function jr(){f=[],ee("remove proxies")}function Br(){return Or(this,void 0,void 0,(function*(){return yield V.a.checkSystemRequirements()}))}function Hr(){return function(){if(yt.chrome){if(yt.checkVersion(yt.majorVersion,"72",!0))return!0;if(yt.checkVersion(yt.majorVersion,"55"))return!1}else{if(yt.firefox&&yt.checkVersion(yt.majorVersion,"60",!0))return!0;if(yt.edge&&yt.checkVersion(yt.majorVersion,"11"))return!0}return!1}()}function Gr(){return kn()}const qr=function(){return pr(this,void 0,void 0,(function*(){if("permissions"in navigator)try{if((yield Promise.all([navigator.permissions.query({name:"camera"}),navigator.permissions.query({name:"microphone"})])).some(e=>"prompt"===e.state)){(yield navigator.mediaDevices.getUserMedia({video:!0,audio:!0})).getTracks().forEach(e=>e.stop())}}catch(e){if("permission dismissed"===e.message.toLocaleLowerCase())throw new y(1010,"获取设备权限失败",e)}else try{(yield navigator.mediaDevices.getUserMedia({video:!0,audio:!0})).getTracks().forEach(e=>e.stop())}catch(e){if("permission dismissed"===e.message.toLocaleLowerCase())throw new y(1010,"获取设备权限失败",e)}}))},Jr=Lt,Wr=sr,zr=dr,$r=cr;window.brtcLogPlugin=function(e,t,i){Pr.LogMap[t]?Pr.LogMap[t](i,"TencentLog"):Pr.info(i,"TencentLog")},X(G);const Kr="1.0.7",Yr=Dr;console.log("******************************************************************************\n*   欢迎使用 BRTC(v1.0.7) Web SDK - 百家云实时音视频通信\n*   API 文档：https://docs.baijiayun.com/open/\n******************************************************************************")}])}));